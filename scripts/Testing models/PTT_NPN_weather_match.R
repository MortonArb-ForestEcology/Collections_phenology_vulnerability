#----------------------------------------------------------------------------------------------------------------------------------#
# Script by: Lucien Fitzpatrick
# Project: Collection phenology vulnerability
# Purpose: This script combines the predicted GDD5.cum for a species and matches that with a yday as a validation
# Inputs: NPN data for relevant species as downloaded in script 6
#         Daymet data for NPN sites as downloaded in script 7
# Outputs: Data frame matching the weather with the sites
# Notes: 
#-----------------------------------------------------------------------------------------------------------------------------------#
#Read this in to give the NPN sites their names
library(rnpn)
library(dplyr)
#site_names <- npn_stations()

#Reading in the npn data we are going to predict
dat.budburst <- read.csv("../data_raw/Raw_Phenology_NPN_combined_budburst.csv")


dat.leaf <- read.csv("../data_raw/Raw_Phenology_NPN_combined_leaf.csv")


#Reading in the weather data
dat.met <- read.csv("../data_processed/New_Daymet_clean_data.csv")
dat.met$Freeze <- ifelse(dat.met$tmin..deg.c.<0, 1, 0)
dat.met$site <- as.character(dat.met$site)
dat.met$TMEAN <- (dat.met$tmax..deg.c. + dat.met$tmin..deg.c.)/2

#dat.budburst$Date <- as.Date(dat.budburst$Date)
#dat.leaf$Date <- as.Date(dat.leaf$Date)
#dat.met$Date <- as.Date(dat.met$Date)

#Read in all the species outputs into one dataframe
bud.files <- list.files(path = "../data_processed/model_output", pattern = "PTT_model_budburst.csv", full.names = T)
bud.stats <- as.data.frame(sapply(bud.files, read.csv, simplify=FALSE) %>% 
                             bind_rows(.id = "id"))

bud.stats <- bud.stats[,c(2:length(bud.stats))]

#Seperating columns to help match with npn data
bud.stats <- tidyr::separate(bud.stats, col = "species", into=c("genus", "species"))


pred.list <- list()
for(YR in unique(dat.budburst$year)){
  for(LOC in unique(dat.budburst[dat.budburst$year==YR, "site_id"])){
    #Pulling out daymet data matching the year and site
    met.now <- dat.met[dat.met$year==YR & dat.met$site==LOC,]
    dat.loc <- dat.budburst[dat.budburst$year == YR & dat.budburst$site_id == LOC,]
    for(SP in unique(dat.loc$species)){
      #Pulling out the posterior distribution for our species
      dat.sp <- dat.loc[dat.loc$species ==SP,]
      bud.SP <- bud.stats[bud.stats$species == SP,]
      for(IND in unique(dat.sp$individual_id)){
        #Randomly sample 500 from that distribution
        npn.samp <- bud.SP[sample(1:nrow(bud.SP), 100),]
        pred.list[[paste(YR, LOC, SP, IND, sep="-")]] <- npn.samp
        pred.list[[paste(YR, LOC, SP, IND, sep="-")]]$year <- as.factor(YR)
        pred.list[[paste(YR, LOC, SP, IND, sep="-")]]$site <- as.factor(LOC)
        pred.list[[paste(YR, LOC, SP, IND, sep="-")]]$species <- as.factor(SP)
        pred.list[[paste(YR, LOC, SP, IND, sep="-")]]$ind <- as.factor(IND)
        pred.list[[paste(YR, LOC, SP, IND, sep="-")]]$yday.pred <- apply(npn.samp, 1, FUN=function(x){
            met.now$PTTGDD <- ifelse(met.now$TMEAN > as.numeric(x["Tbase"]), (met.now$TMEAN - as.numeric(x["Tbase"])) * (met.now$dayl..s./86400), 0)
            met.now$PTTGDD.cum <- cumsum(met.now$PTTGDD)
            min(met.now[met.now$PTTGDD.cum>=as.numeric(x["THRESH"]), "yday"])
            })
        #pred.list[[paste(YR, LOC, SP, sep="-")]]$freeze.prob <- apply(pred.list[[paste(YR, LOC, SP, sep="-")]], 1, FUN=function(x){met.now$Freeze[met.now$yday==round(as.numeric(x["yday.pred"]))]})
      }
    }
  }
}
pred.burst <- dplyr::bind_rows(pred.list)
summary(pred.burst)

summary(pred.burst[pred.burst$yday.pred < Inf,])

# Save dat.burst 
write.csv(pred.burst, "../data_processed/PTT_Budburst_Phenology_NPN_prediction.csv", row.names=F)

#----------------------------------------------------#
#Now starting with leaf out
#----------------------------------------------------#
#Read in all the species outputs into one dataframe
leaf.files <- list.files(path = "../data_processed/Arb_Pheno", pattern = "NewTT_model_leaf.csv", full.names = T)
leaf.stats <- as.data.frame(sapply(leaf.files, read.csv, simplify=FALSE) %>% 
                              bind_rows(.id = "id"))

leaf.stats <- leaf.stats[,c(2:5)]


leaf.stats$pred <- apply(as.matrix(leaf.stats), 1 , function(x) rnorm(1, mean=as.numeric(x["THRESH"]), sd=as.numeric(x["sd"])))

#Seperating columns to help match with npn data
leaf.stats <- tidyr::separate(leaf.stats, col = "species", into=c("genus", "species"))

pred.list <- list()
for(YR in unique(dat.leaf$year)){
  for(LOC in unique(dat.leaf[dat.leaf$year==YR, "site_id"])){
    #Pulling out daymet data matching the year and site
    met.now <- dat.met[dat.met$year==YR & dat.met$site==LOC,]
    dat.loc <- dat.leaf[dat.leaf$year == YR & dat.leaf$site_id == LOC,]
    for(SP in unique(dat.loc$species)){
      #Pulling out the posterior distribution for our species
      dat.sp <- dat.loc[dat.loc$species ==SP,]
      leaf.SP <- leaf.stats[leaf.stats$species == SP,]
      for(IND in unique(dat.sp$individual_id)){
        #Randomly sample 500 from that distribution
        npn.samp <- leaf.SP[sample(1:nrow(leaf.SP), 500),]
        pred.list[[paste(YR, LOC, SP, IND, sep="-")]] <- npn.samp
        pred.list[[paste(YR, LOC, SP, IND, sep="-")]]$year <- as.factor(YR)
        pred.list[[paste(YR, LOC, SP, IND, sep="-")]]$site <- as.factor(LOC)
        pred.list[[paste(YR, LOC, SP, IND, sep="-")]]$species <- as.factor(SP)
        pred.list[[paste(YR, LOC, SP, IND, sep="-")]]$ind <- as.factor(IND)
        pred.list[[paste(YR, LOC, SP, IND, sep="-")]]$yday.pred <- apply(npn.samp, 1, FUN=function(x){
          met.now$PTTGDD <- ifelse(met.now$TMEAN > as.numeric(x["Tbase"]), met.now$TMEAN - as.numeric(x["Tbase"]), 0)
          met.now$PTTGDD.cum <- cumsum(met.now$PTTGDD)
          min(met.now[met.now$PTTGDD.cum>=as.numeric(x["THRESH"]), "yday"])
        })
        #pred.list[[paste(YR, LOC, SP, sep="-")]]$freeze.prob <- apply(pred.list[[paste(YR, LOC, SP, sep="-")]], 1, FUN=function(x){met.now$Freeze[met.now$yday==round(as.numeric(x["yday.pred"]))]})
      }
    }
  }
}
pred.leaf <- dplyr::bind_rows(pred.list)
summary(pred.leaf)

# Save dat.leaves 
write.csv(pred.leaf, "../data_processed/PTT_Leaf_Phenology_NPN_prediction.csv", row.names=F)

