library(phenor)
data("phenocam_DB")
# phenocam_par <- model_calibration(
#   model = "TT",
#   data = phenocam_DB$shalehillsczo,
#   method = "bayesiantools",
#   control = list(max.call = 4000),
#   par_ranges = sprintf("%s/extdata/parameter_ranges.csv", path.package("phenor")),
#   plot = TRUE)

# pr_dl_phenocam(vegetation = "DB",
#                site = "bartlett",
#                phenophase = TRUE)
# 
# # process phenocam transition files into a consistent format
# phenocam_data <- pr_fm_phenocam("/foo/bar/transition_dates/")

dat <- phenocam_DB$shalehillsczo

path <- sprintf("%s/extdata/parameter_ranges.csv",path.package("phenor"))
par_ranges <- read.table(path,
                         header = TRUE,
                         sep = ",")
# optim.par <- pr_fit_parameters(par = NULL,
#                                data = dat,
#                                cost = rmse,
#                                model = TT,
#                                method = "GenSA",
#                                lower = c(1,-5,0),
#                                upper = c(365,10,2000))

data=phenocam_DB$shalehillsczo
cost=rmse
model=TT
lower = c(1,-5,0)
upper = c(365,10,2000)
# setup the bayes run, no message forwarding is provided
# so wrap the function in a do.call
setup <- BayesianTools::createBayesianSetup(
  likelihood = function(random_par){
    do.call("likelihood",
            list(par = random_par,
                 data = data,
                 model = TT
            ))},
  lower = c(lower, 1),
  upper = c(upper, 14)#,
  # ...
)

# calculate the runs
out <- BayesianTools::runMCMC(bayesianSetup = setup,
                              sampler = "Metropolis")
# ,
#                                settings = control$settings)

summary(out)

# par 1 = t0 = day that you start counting?
# par 2 = T_base = base temperature for GDD calculation
# par 3 = F_crit = GDD Threshold for budburst
# par 4 = ???

# drop last value
bt_par <- BayesianTools::MAP(out)$parametersMAP
bt_par <- bt_par[1:(length(bt_par)-1)]

# correct formatting in line with other outputs
optim_par <- list("par" = bt_par,
                  "opt_out" = out)
