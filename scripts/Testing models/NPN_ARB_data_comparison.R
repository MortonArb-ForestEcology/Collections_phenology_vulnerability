# Read in output of previous script
dat.b <- read.csv("../data_processed/Oak_collection_budburst.csv")
dat.b$Accession <- unlist(lapply(strsplit(paste(dat.b$PlantNumber), "-"), function(x){x[1]}))
dat.b$Date <- as.Date(dat.b$Date)

#Reading in our cleaned NPN data
dat.budburst <- read.csv("../data_raw/Raw_Phenology_NPN_combined_budburst.csv")

#Putting a filter on reports after August 1st since we are interested in spring phenology
dat.budburst <- dat.budburst[dat.budburst$Yday < 213,]



dat.met <- read.csv("../data_processed/Daymet_clean_data.csv")

dat.met$Date <- as.Date(dat.met$Date)
dat.budburst$Date <- as.Date(dat.budburst$Date)

burst.match <- data.frame()
for(LOC in unique(as.numeric(dat.budburst$site_id))){
  npn.tmp <- dat.budburst[dat.budburst$site_id == LOC,]
  lat.tmp <- dat.met[dat.met$site == LOC,]
  npn.tmp$GDD5.cum <- lat.tmp$GDD5.cum[match(npn.tmp$Date, lat.tmp$Date)]
  npn.tmp$GDD0.cum <- lat.tmp$GDD0.cum[match(npn.tmp$Date, lat.tmp$Date)]
  npn.tmp$NCD <- lat.tmp$NCD[match(npn.tmp$Date, lat.tmp$Date)]
  npn.tmp$GTmean <- lat.tmp$GTmean[match(npn.tmp$Date, lat.tmp$Date)]
  burst.match <- rbind(burst.match, npn.tmp)
}

summary(burst.match)

npn.budburst <- aggregate(burst.match[,c("GDD5.cum", "Yday")],
                          by = list(burst.match$species),
                          FUN=mean, na.action = na.omit)

arb.budburst <- aggregate(dat.b[,c("GDD5.cum", "Yday")],
                          by = list(dat.b$Species),
                          FUN=mean, na.action = na.omit)

arb.budburst <- tidyr::separate(arb.budburst, col = "Group.1", into=c("genus", "species"))


npn.budburst$arbYday <- arb.budburst$Yday[match(npn.budburst$Group.1, arb.budburst$species,)]

npn.budburst$arbGDD5.cum <- arb.budburst$GDD5.cum[match(npn.budburst$Group.1, arb.budburst$species)]




# Read in output of previous script
dat.l <- read.csv("../data_processed/Oak_collection_leaf.csv")
dat.l$Accession <- unlist(lapply(strsplit(paste(dat.l$PlantNumber), "-"), function(x){x[1]}))
dat.l$Date <- as.Date(dat.l$Date)

dat.leaf <- read.csv("../data_raw/Raw_Phenology_NPN_combined_leaf.csv")

npn.leaf <- aggregate(Yday~species, data=dat.leaf,
                          FUN=mean, na.action = na.omit)

arb.leaf <- aggregate(Yday~Species, data=dat.l,
                      FUN=mean, na.action = na.omit)

arb.leaf <- tidyr::separate(arb.leaf, col = "Species", into=c("genus", "species"))

npn.leaf$arbYday <- arb.leaf$Yday[match(npn.leaf$species, arb.leaf$species)]

leaf.match <- data.frame()
for(LOC in unique(as.numeric(dat.leaf$site_id))){
  npn.tmp <- dat.leaf[dat.leaf$site_id == LOC,]
  lat.tmp <- dat.met[dat.met$site == LOC,]
  npn.tmp$GDD5.cum <- lat.tmp$GDD5.cum[match(npn.tmp$Date, lat.tmp$Date)]
  npn.tmp$GDD0.cum <- lat.tmp$GDD0.cum[match(npn.tmp$Date, lat.tmp$Date)]
  npn.tmp$NCD <- lat.tmp$NCD[match(npn.tmp$Date, lat.tmp$Date)]
  npn.tmp$GTmean <- lat.tmp$GTmean[match(npn.tmp$Date, lat.tmp$Date)]
  leaf.match <- rbind(leaf.match, npn.tmp)
}

summary(leaf.match)

npn.leaf <- aggregate(dat.leaf[,c("GDD5.cum", "Yday")],
                          by = list(dat.leaf$species),
                          FUN=mean, na.action = na.omit)

arb.leaf <- aggregate(data=dat.l[,c("GDD5.cum", "Yday")],
                          by = list(dat.l$Species),
                          FUN=mean, na.action = na.omit)
