library(rjags)
library(coda)
library(dplyr)
library(tidyr)
library(rnpn)

# Read in output of previous script
dat.b <- read.csv("../data_processed/Oak_collection_budburst.csv")
dat.b$Accession <- unlist(lapply(strsplit(paste(dat.b$PlantNumber), "-"), function(x){x[1]}))
dat.b$Date <- as.Date(dat.b$Date)
dat.b$Species <- as.character(dat.b$Species)


# Read in output of previous script
dat.l <- read.csv("../data_processed/Oak_collection_leaf.csv")
dat.l$Accession <- unlist(lapply(strsplit(paste(dat.l$PlantNumber), "-"), function(x){x[1]}))
dat.l$Date <- as.Date(dat.l$Date)

met.all <- read.csv("../data_processed/Daymet_clean_data.csv")
met.all$TMEAN <- (met.all$tmax..deg.c. + met.all$tmin..deg.c.)/2


#Pulling out the number of observations we have for each species
SP.burst <- as.data.frame(table(dat.b[, "Species"]))
colnames(SP.burst) <- c("Species", "Freq")

#Pulling out the number of observations we have for each species
SP.leaf <- as.data.frame(table(dat.l[, "Species"]))
colnames(SP.leaf) <- c("Species", "Freq")

#CHecking which species we don't have budburst information for
setdiff(SP.leaf$Species, SP.burst$Species)

#SP.burst <- SP.burst[(1:5),]

#Creating a data frame to check the model output
Check <- data.frame()
l <- 1


for(SP in as.character(SP.burst$Species)){
  
  Check[l, "species"] <- SP
  Check[l, "burst.nObs"] <- SP.burst[SP.burst$Species == SP, "Freq"]
  dat.burst <- dat.b[dat.b$Species == SP, ]
  
  burst.ind <- aggregate(Species~PlantNumber, data=dat.burst,
                         FUN=min)
  
  hierarchical_regression <- "
  model{
  for(k in 1:n){
    sum[1, k] <- 0 #Initializing our cumulative value to play nice
    for(j in 1:365){
      GDD[j, k] <- ifelse(met[j,k]>5, met[j,k]-5, 0) #Standard GDD calculation line
      
      GDD.day[j, k] <- ifelse(GDD[j, k] + sum[j, k] >= ind.In[pln[k]] + ind.Sl[pln[k]]*exp(ind.Sc[pln[k]] * NCD[j,k]), -999, j-1) #Any day before the Threshold becomes 999                                                               #Any day after the Threshold becomes yday-1 (-1 because of the way the sum works)
    
      sum[j+1, k] <- GDD[j, k] + sum[j, k] #Creating the cumulative value to build over time. Actually 1 day ahead so we take j-1
    }
    mu[k] <- max(GDD.day[,k]) #Earliest day that passes the Threshold
    y[k] ~ dnorm(mu[k], sPrec) # Normalized by our observation uncertainty
  }
    
    for(j in 1:nSp){
     Intercept[j] <-  a[j]
     Slope[j] <- b[j]
     Scale[j] <- c[j]
      
      a ~ dnorm(aPrior, aPrec)
      b ~ dnorm(bPrior, bPrec)
      c ~ dnorm(cPrior, cPrec)
      
      aPrec ~ dgamma(0.1, 0.1)
      bPrec ~ dgamma(0.1, 0.1)
      cPrec ~ dgamma(0.1, 0.1)
      
      aPrior ~ dunif(-1000,1000)
      bPrior ~ dunif(0, 5000)
      cPrior ~ dunif(-5, 0)
    }
    
    for(i in 1:nPln){
        ind.In[i] <-  Intercept[sp[i]] + d[i]
        d[i] ~ dnorm(0, dPrec)
        
        ind.Sl[i] <-  Slope[sp[i]] + e[i]
        e[i] ~ dnorm(0, ePrec)
        
        ind.Sc[i] <-  Scale[sp[i]] + f[i]
        f[i] ~ dnorm(0, fPrec)
        
    }
    
    sPrec ~ dgamma(0.1, 0.1)
    dPrec ~ dgamma(0.1, 0.1)
    ePrec ~ dgamma(0.1, 0.1)
    fPrec ~ dgamma(0.1, 0.1)

  }
  "
  
  burst.list <- list(y = dat.burst$Yday, n = length(dat.burst$Yday), yr = dat.burst$Year,
                     pln = as.numeric(factor(dat.burst$PlantNumber)), nPln = length(unique(dat.burst$PlantNumber)),
                     sp = as.numeric(factor(burst.ind$Species)), nSp = length(unique(dat.burst$Species)))
  
  burst.list$met <- matrix(nrow=365, ncol=length(burst.list$yr))
  
  
  #for(i in 1:length(burst.list$yr)){
  #  burst.list$met[,i] <- (met.all[met.all$year == burst.list$yr[i], "TMEAN"])
  #}
  
  done <- data.frame(nrow=365)
  for(i in 1:length(burst.list$yr)){
    met <- (met.all[met.all$year == burst.list$yr[i], "TMEAN"])
    done <- cbind(done, met)
  }
  
  done <- subset(done, select = -c(1))
  colnames(done) <- c(dat.burst$Year)
  
  NCD.tmp <- data.frame(nrow=365)
  for(i in 1:length(burst.list$yr)){
    NCD <- (met.all[met.all$year == burst.list$yr[i], "NCD"])
    NCD.tmp <- cbind(NCD.tmp, NCD)
  }
  
  NCD.tmp <- subset(NCD.tmp, select = -c(1))
  colnames(NCD.tmp) <- c(dat.burst$Year)
  
  burst.list$met <- done
  burst.list$NCD <- NCD.tmp
  #Setting the number of MCMC chains and their parameters
  nchain = 3
  inits <- list()
  for(i in 1:nchain){
    inits[[i]] <- list(  #Added length equal to number of species
      Tbase = runif(1,2,7))
  }
  
  #---------------------------------------------------------#
  #This section actually runs the model and then provides ways to check the output and clean it
  #---------------------------------------------------------#
  burst.model   <- jags.model (file = textConnection(hierarchical_regression),
                               data = burst.list,
                               n.chains = 3)
  
  #Converting the ooutput into a workable format
  burst.out   <- coda.samples (model = burst.model,
                               variable.names = c("Intercept", "Slope", "Scale"),
                               n.iter = 70000)
  
  
  bud.con <- gelman.diag(burst.out)
  Check[l, "burst.Tbase.converge"] <- bud.con[[1]][1]
  Check[l, "burst.Thresh.converge"] <- bud.con[[1]][2]
  
  burnin = 60000                                ## determine convergence from GBR output
  burst.burn <- window(burst.out,start=burnin)  ## remove burn-in
  summary(burst.burn)
  
  
  burst.df <- as.data.frame(as.matrix(burst.burn))
  
  burst.df$species <- SP
  bud.ci <- apply(as.matrix(burst.df$THRESH),2,quantile,c(0.025,0.5,0.975))
  budbase.ci <- apply(as.matrix(burst.df$Tbase),2,quantile,c(0.025,0.5,0.975))
  
  
  Check[l, "burstThresh 2.5%"] <- bud.ci[1]
  Check[l, "burstThresh 50%"] <- bud.ci[2]
  Check[l, "burstThresh 97.5%"] <- bud.ci[3]
  Check[l, "burstTbase 2.5%"] <- budbase.ci[1]
  Check[l, "burstTbase 50%"] <- budbase.ci[2]
  Check[l, "burstTbase 97.5%"] <- budbase.ci[3]
  
  write.csv(burst.df, file.path("../data_processed/", paste0(SP, "NewTT_model_budburst.csv")), row.names=F)
  
  l <- l + 1
}

Check
write.csv(Check, file.path("../data_processed/NewTT_model_budburst.csv"), row.names=F)


for(k in 1:n){
  cum[1, k] <- 0 #Initializing our cumulative value to play nice
  for(j in 1:365){
    GDD[j, k] <- ifelse(done[j,k]>5, done[j,k]-5, 0) #Standard GDD calculation line
    
    GDD.day[j, k] <- ifelse(GDD[j, k] + cum[j, k] >= a + b*exp(c * NCD.tmp[j,k]), -999, j-1) #Any day before the Threshold becomes 999                                                               #Any day after the Threshold becomes yday-1 (-1 because of the way the sum works)
    
    cum[j+1, k] <- GDD[j, k] + cum[j, k] #Creating the cumulative value to build over time. Actually 1 day ahead so we take j-1
  }
  mu[k] <- max(GDD.day[,k]) #Earliest day that passes the Threshold
 # Normalized by our observation uncertainty
}

a <- 0
b <- 2000
c <- -4
j <- 1
k <- 2

GDD <- data.frame(nrow=365)
GDD.day <- data.frame(nrow=365)
cum <- data.frame(nrow=365)
mu <- data.frame(nrow=365)

