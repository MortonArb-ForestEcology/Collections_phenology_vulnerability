#----------------------------------------------------------------------------------------------------------------------------------#
# Script by : Lucien Fitzpatrick
# Project: Collection phenology vulnerability
# Purpose: To use arb weather data and phenology monitoring data to create a predicitve model of bud burst timing
#          This script is the actual model predicting the GDD5.cum value at which b udburst or leaf out occur
# Inputs: Oak_collection_budburst.csv
#         Oak_collection_leaf.csv
# Outputs: Posterior distributions for bud burst and leaf out for every species in our collection
# Notes: This script can be made into a loop for each species but is currently manual to allow for checks as it runs
#-----------------------------------------------------------------------------------------------------------------------------------#
library(rjags)
library(coda)
library(data.table)
library(dplyr)
library(tidyr)

# Read in output of previous script
dat.burst <- read.csv("../data_processed/Oak_collection_budburst.csv")
dat.burst$Accession <- unlist(lapply(strsplit(paste(dat.burst$PlantNumber), "-"), function(x){x[1]}))
dat.burst$Date <- as.Date(dat.burst$Date)

# Read in output of previous script
dat.leaf <- read.csv("../data_processed/Oak_collection_leaf.csv")
dat.leaf$Accession <- unlist(lapply(strsplit(paste(dat.leaf$PlantNumber), "-"), function(x){x[1]}))
dat.leaf$Date <- as.Date(dat.leaf$Date)

#Pulling out the number of observations we have for each species
SP.burst <- as.data.frame(table(dat.burst[dat.burst$Species %like% "Quercus", "Species"]))
colnames(SP.burst) <- c("Species", "Freq")

#Pulling out the number of observations we have for each species
SP.leaf <- as.data.frame(table(dat.leaf[dat.leaf$Species %like% "Quercus", "Species"]))
colnames(SP.leaf) <- c("Species", "Freq")

#Selecting the species
#Eventually this will be an automated loop when I feel 100% confident in the output
species <- c("Quercus alba")

dat.burst <- dat.burst[dat.burst$Species == species, ]
dat.leaf <- dat.leaf[dat.leaf$Species == species, ]

#Checking the mean
mean(dat.burst$GDD5.cum)
mean(dat.leaf$GDD5.cum)

#Creating indexes so the hierarchy can properly function
burst.ind <- aggregate(Accession~PlantNumber, data=dat.burst,
                    FUN=min)

burst.acc <- aggregate(Species~Accession, data=dat.burst,
                    FUN=min)

leaf.ind <- aggregate(Accession~PlantNumber, data=dat.leaf,
                       FUN=min)

leaf.acc <- aggregate(Species~Accession, data=dat.leaf,
                       FUN=min)



hierarchical_regression <- "
  model{
    for(k in 1:n){
        mu[k] <- ind[pln[k]]  
        y[k] ~ dnorm(mu[k], sPrec)
    }
    
    for(k in 1:n){
        munew[k] <- ind[pln[k]]  
        Ynew[k] ~ dnorm(munew[k], sPrec)
    }
      
    for(j in 1:nSp){
      THRESH[j] <-  a[j]
      a[j] ~ dnorm(Tprior, aPrec[j])
      aPrec[j] ~ dgamma(0.5, 0.1)
      Tprior[j] ~ dunif(1, 400)
    }

    for(t in 1:nAcc){
      Accession[t] <-  THRESH[sp[t]] + b[t]
      b[t] ~ dnorm(0, bPrec[t])
      bPrec[t] ~ dgamma(0.1, 0.1)
    }
    
    for(i in 1:nPln){
        ind[i] <-  Accession[acc[i]] + c[i]
        c[i] ~ dnorm(0, cPrec)
    }
    sPrec ~ dgamma(0.1, 0.1)
    cPrec ~ dgamma(0.1, 0.1)
    
    d[1] <- max(Ynew[])
    d[2] <- min(Ynew[])
    d[3] <- max(Ynew[])-min(Ynew[])
    d[4] <- mean(Ynew[])
    #d[5] <- sd(Ynew[])
  }
  "

burst.list <- list(y = dat.burst$GDD5.cum, n = length(dat.burst$GDD5.cum),
                   pln = as.numeric(factor(dat.burst$PlantNumber)), nPln = length(unique(dat.burst$PlantNumber)),
                   acc = as.numeric(factor(burst.ind$Accession)), nAcc = length(unique(dat.burst$Accession)),
                   sp = as.numeric(factor(burst.acc$Species)), nSp = length(unique(dat.burst$Species)))

leaf.list <- list(y = dat.leaf$GDD5.cum, n = length(dat.leaf$GDD5.cum),
                   pln = as.numeric(factor(dat.leaf$PlantNumber)), nPln = length(unique(dat.leaf$PlantNumber)),
                   acc = as.numeric(factor(leaf.ind$Accession)), nAcc = length(unique(dat.leaf$Accession)),
                   sp = as.numeric(factor(leaf.acc$Species)), nSp = length(unique(dat.leaf$Species)))


#Setting the number of MCMC chains and their parameters
nchain = 3
inits <- list()
for(i in 1:nchain){
  inits[[i]] <- list(  #Added length equal to number of species
    Tprior = runif(1,100,200))
}

#---------------------------------------------------------#
#This section actually runs the model and then provides ways to check the output and clean it
#---------------------------------------------------------#
burst.model   <- jags.model (file = textConnection(hierarchical_regression),
                             data = burst.list,
                             inits = inits,
                             n.chains = 3)

leaf.model   <- jags.model (file = textConnection(hierarchical_regression),
                             data = leaf.list,
                             inits = inits,
                             n.chains = 3)


#Converting the ooutput into a workable format
burst.out   <- coda.samples (model = burst.model,
                             variable.names = c("THRESH", "aPrec"),
                             n.iter = 300000)

#Converting the ooutput into a workable format
leaf.out   <- coda.samples (model = leaf.model,
                             variable.names = c("THRESH", "aPrec"),
                             n.iter = 300000)


# #Checking that convergence happened
gelman.diag(burst.out)
gelman.diag(leaf.out)

# #Checking where convergence occured
#GBR <- gelman.plot(burst.out)
#GBR <- gelman.plot(leaf.out)

#Removing burnin before convergence occurred
burnin = 290000                                ## determine convergence from GBR output
burst.burn <- window(burst.out,start=burnin)  ## remove burn-in
summary(burst.burn)

leaf.burn <- window(leaf.out, start = burnin)
summary(leaf.burn)

#converting them into a dataframe 
burst.df <- as.data.frame(as.matrix(burst.burn))
leaf.df <- as.data.frame(as.matrix(leaf.burn))

#calculating sd from the precison
burst.df$sd <- 1/sqrt(burst.df[,"aPrec"])
summary(burst.df)
leaf.df$sd <- 1/sqrt(leaf.df[,"aPrec"])
summary(leaf.df)


bud.density <- as.data.frame(apply(as.matrix(burst.df), 1 , function(x) rnorm(1, mean=x[1], sd=x[3])))
burst.df$species <- species
bud.ci <- apply(as.matrix(bud.density),2,quantile,c(0.025,0.5,0.975))

leaf.density <- as.data.frame(apply(as.matrix(leaf.df), 1 , function(x) rnorm(1, mean=x[1], sd=x[3])))
leaf.df$species <- species
leaf.ci <- apply(as.matrix(leaf.density),2,quantile,c(0.025,0.5,0.975))

bud.ci
leaf.ci

write.csv(burst.df, file.path("../data_processed/Arb_Pheno", paste0(species, "_model_budburst.csv")), row.names=F)
write.csv(leaf.df, file.path("../data_processed/Arb_Pheno", paste0(species, "_leaf_.csv")), row.names=F)
