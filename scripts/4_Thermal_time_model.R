#----------------------------------------------------------------------------------------------------------------------------------#
# Script by : Lucien Fitzpatrick
# Project: Collection phenology vulnerability
# Purpose: This script is the actual model predicting the GDD5.cum value at which budburst or leaf out occur
# Inputs: Oak_collection_budburst.csv
#         Oak_collection_leaf.csv
# Outputs: Posterior distributions for bud burst and leaf out for every species in our collection
#         A data.frame with information on the model run to check convergence  
# Notes: This script can be made into a loop for each species but is currently manual to allow for checks as it runs
#-----------------------------------------------------------------------------------------------------------------------------------#
library(rjags)
library(coda)
library(dplyr)
library(tidyr)


dir.create("../data_processed/model_output", recursive = T, showWarnings = F)

dat.burst <- read.csv("../data_raw/Raw_Phenology_NPN_combined_budburst.csv")
dat.burst <- dat.burst[!is.na(dat.burst$Yday),]
dat.burst <- dat.burst[!is.infinite(dat.burst$Yday),]

#Putting a filter on reports after August 1st since we are interested in spring phenology
dat.burst <- dat.burst[dat.burst$Yday < 213,]

dat.burst$Date <- as.Date(dat.burst$Date)
dat.burst$species <- as.character(dat.burst$species)


#reading in the leafout dataframe with residuals
dat.leaf <- read.csv("../data_raw/Raw_Phenology_NPN_combined_leaf.csv")
dat.leaf <- dat.leaf[!is.na(dat.leaf$Yday),]
dat.leaf <- dat.leaf[!is.infinite(dat.leaf$Yday),]

dat.leaf <- dat.leaf[dat.leaf$Yday < 213,]

dat.leaf$species <- as.character(dat.leaf$species)


#Calculting the number of sites so we can filter for our second step of evaluation
for(SP in unique(dat.burst$species)){
  dat.sp <- dat.burst[dat.burst$species == SP,]
  dat.burst[dat.burst$species == SP, "nsites"] <- length(unique(dat.sp$site_id))
}

dat.burst <- dat.burst[dat.burst$nsites > 10,]


#Calculting the number of sites so we can filter for our second step of evaluation
for(SP in unique(dat.leaf$species)){
  dat.sp <- dat.leaf[dat.leaf$species == SP,]
  dat.leaf[dat.leaf$species == SP, "nsites"] <- length(unique(dat.sp$site_id))
}

dat.leaf <- dat.leaf[dat.leaf$nsites > 10,]

#Reading in the weather data
dat.met <- read.csv("../data_processed/Daymet_clean_data.csv")
dat.met$Freeze <- ifelse(dat.met$tmin..deg.c.<0, 1, 0)
dat.met$site <- as.character(dat.met$site)
dat.met$Date <- as.Date(dat.met$Date)


dat.npnbud <- merge(dat.burst, dat.met, by.x = c("year", "Yday", "site_id"), by.y = c("year", "yday", "site"))
dat.npnbud <- subset(dat.npnbud, select = c("genus", "species", "GDD5.cum", "year", "Yday", "individual_id", "site_id", "latitude.x", "longitude.x", "GTmean"))
colnames(dat.npnbud) <- c("Genus", "Species", "GDD5.cum", "Year", "Yday", "PlantNumber", "Site", "Latitude", "Longitude", "GTmean")
dat.npnbud$Source <- "npn" 

dat.npnleaf <- merge(dat.leaf, dat.met, by.x = c("year", "Yday", "site_id"), by.y = c("year", "yday", "site"))
dat.npnleaf <- subset(dat.npnleaf, select = c("genus", "species", "GDD5.cum", "year", "Yday", "individual_id", "site_id", "latitude.x", "longitude.x", "GTmean"))
colnames(dat.npnleaf) <- c("Genus", "Species", "GDD5.cum", "Year", "Yday", "PlantNumber", "Site", "Latitude", "Longitude", "GTmean")
dat.npnleaf$Source <- "npn"


# Read in output of previous script
dat.b <- read.csv("../data_processed/Oak_collection_budburst.csv")
dat.b$Accession <- unlist(lapply(strsplit(paste(dat.b$PlantNumber), "-"), function(x){x[1]}))
dat.b$Date <- as.Date(dat.b$Date)

dat.b <- dat.b %>%
  separate(Species, c("Genus", "Species"), " ")

dat.arbb <- subset(dat.b, select = c("Genus", "Species", "GDD5.cum", "Year", "Yday", "PlantNumber", "Site", "Latitude", "Longitude", "GTmean"))
dat.arbb$Source <- "arb"

# Read in output of previous script
dat.l <- read.csv("../data_processed/Oak_collection_leaf.csv")
dat.l$Accession <- unlist(lapply(strsplit(paste(dat.l$PlantNumber), "-"), function(x){x[1]}))
dat.l$Date <- as.Date(dat.l$Date)
dat.l <- dat.l %>%
  separate(Species, c("Genus", "Species"), " ")

dat.arbl <- subset(dat.l, select = c("Genus", "Species", "GDD5.cum", "Year", "Yday", "PlantNumber", "Site", "Latitude", "Longitude", "GTmean"))
dat.arbl$Source <- "arb"

dat.budcomb <- rbind(dat.npnbud, dat.arbb)
dat.leafcomb <- rbind(dat.npnleaf, dat.arbl)

write.csv(dat.budcomb, "../data_processed/Full_Bud_Obs.csv", row.names = F)
write.csv(dat.leafcomb, "../data_processed/Full_Leaf_Obs.csv", row.names = F)

#Pulling out the number of observations we have for each species
SP.burst <- as.data.frame(table(dat.budcomb[, "Species"]))
colnames(SP.burst) <- c("Species", "Freq")

#Pulling out the number of observations we have for each species
SP.leaf <- as.data.frame(table(dat.leafcomb[, "Species"]))
colnames(SP.leaf) <- c("Species", "Freq")

#CHecking which species we don't have budburst information for
setdiff(SP.leaf$Species, SP.burst$Species)

#SP.burst <- SP.burst[(1:5),]

#Creating a data frame to check the model output
Check <- data.frame()
l <- 1

#We are using burst to determine the species becasue it is missing two species: fusiformis and laurifolia
for(SP in SP.burst$Species){
  
  #Creating the row for this species information
  Check[l, "species"] <- SP
  Check[l, "burst.nObs"] <- SP.burst[SP.burst$Species == SP, "Freq"]
  Check[l, "leaf.nObs"] <- SP.leaf[SP.leaf$Species == SP, "Freq"]
  
  dat.burst <- dat.budcomb[dat.budcomb$Species == SP, ]
  dat.leaf <- dat.leafcomb[dat.leafcomb$Species == SP, ]
  
  #Checking the mean
  Check[l, "mean.burst"] <- mean(dat.burst$GDD5.cum)
  Check[l, "mean.leaf"] <- mean(dat.leaf$GDD5.cum)
  
  #Creating indexes so the hierarchy can properly function
  burst.ind <- aggregate(Site~PlantNumber, data=dat.burst,
                         FUN=min)
  
  burst.loc <- aggregate(Species~PlantNumber, data=dat.burst,
                         FUN=min)
  
  
  leaf.ind <- aggregate(Site~PlantNumber, data=dat.leaf,
                        FUN=min)
  
  leaf.loc <- aggregate(Species~PlantNumber, data=dat.leaf,
                        FUN=min)
  
  hierarchical_regression <- "
  model{
    for(k in 1:n){
        mu[k] <- ind[pln[k]]  
        y[k] ~ dnorm(mu[k], sPrec)
    }
    
    for(j in 1:nSp){
      THRESH <-  a
      a ~ dnorm(Tprior, aPrec)
      aPrec ~ dgamma(0.2, 0.1)
      Tprior ~ dunif(1, 600)
    }
    
    for(t in 1:nLoc){
      Site[t] <-  THRESH[sp[t]] + b[t]
      b[t] ~ dnorm(0, bPrec[t])
      bPrec[t] ~ dgamma(0.1, 0.1)
    }

    for(i in 1:nPln){
        ind[i] <-  Site[loc[i]] + c[i]
        c[i] ~ dnorm(0, cPrec)
    }
    sPrec ~ dgamma(0.1, 0.1)
    cPrec ~ dgamma(0.1, 0.1)

  }
  "
  
  burst.list <- list(y = dat.burst$GDD5.cum, n = length(dat.burst$GDD5.cum),
                     pln = as.numeric(factor(dat.burst$PlantNumber)), nPln = length(unique(dat.burst$PlantNumber)),
                     loc = as.numeric(factor(burst.ind$Site)), nLoc = length(unique(dat.burst$Site)),
                     sp = as.numeric(factor(burst.loc$Species)), nSp = length(unique(dat.burst$Species)))
  
  leaf.list <- list(y = dat.leaf$GDD5.cum, n = length(dat.leaf$GDD5.cum),
                    pln = as.numeric(factor(dat.leaf$PlantNumber)), nPln = length(unique(dat.leaf$PlantNumber)),
                    loc = as.numeric(factor(leaf.ind$Site)), nLoc = length(unique(dat.leaf$Site)),
                    sp = as.numeric(factor(leaf.loc$Species)), nSp = length(unique(dat.leaf$Species)))
  
  
  #Setting the number of MCMC chains and their parameters
  nchain = 3
  inits <- list()
  for(i in 1:nchain){
    inits[[i]] <- list(  #Added length equal to number of species
      Tprior = runif(1,100,200))
  }
  
  #---------------------------------------------------------#
  #This section actually runs the model and then provides ways to check the output and clean it
  #---------------------------------------------------------#
  burst.model   <- jags.model (file = textConnection(hierarchical_regression),
                               data = burst.list,
                               inits = inits,
                               n.chains = 3)
  
  leaf.model   <- jags.model (file = textConnection(hierarchical_regression),
                              data = leaf.list,
                              inits = inits,
                              n.chains = 3)
  
  
  #Converting the ooutput into a workable format
  burst.out   <- coda.samples (model = burst.model,
                               variable.names = c("THRESH", "aPrec"),
                               n.iter = 700000)
  
  #Converting the ooutput into a workable format
  leaf.out   <- coda.samples (model = leaf.model,
                              variable.names = c("THRESH", "aPrec"),
                              n.iter = 700000)
  
  
  # #Checking that convergence happened
  bud.con <- gelman.diag(burst.out)
  Check[l, "burst.converge"] <- bud.con[[1]][1]
  leaf.con <- gelman.diag(leaf.out[,"THRESH"])
  Check[l, "leaf.converge"] <- leaf.con[[1]][1]
  
  #Removing burnin before convergence occurred
  burnin = 690000                                ## determine convergence from GBR output
  burst.burn <- window(burst.out,start=burnin)  ## remove burn-in
  summary(burst.burn)
  
  leaf.burn <- window(leaf.out, start = burnin)
  summary(leaf.burn)
  
  #converting them into a dataframe 
  burst.df <- as.data.frame(as.matrix(burst.burn))
  leaf.df <- as.data.frame(as.matrix(leaf.burn))
  
  #calculating sd from the precison
  burst.df$sd <- 1/sqrt(burst.df[,"aPrec"])
  summary(burst.df)
  leaf.df$sd <- 1/sqrt(leaf.df[,"aPrec"])
  summary(leaf.df)
  
  
  burst.df$species <- SP
  bud.ci <- apply(as.matrix(burst.df$THRESH),2,quantile,c(0.025,0.5,0.975))
  
  leaf.df$species <- SP
  leaf.ci <- apply(as.matrix(leaf.df$THRESH),2,quantile,c(0.025,0.5,0.975))
  
  Check[l, "burst 2.5%"] <- bud.ci[1]
  Check[l, "burst 50%"] <- bud.ci[2]
  Check[l, "burst 97.5%"] <- bud.ci[3]
  
  Check[l, "leaf 2.5%"] <- leaf.ci[1]
  Check[l, "leaf 50%"] <- leaf.ci[2]
  Check[l, "leaf 97.5%"] <- leaf.ci[3]
  
  write.csv(burst.df, file.path("../data_processed/model_output", paste0(SP, "_TT_model_budburst.csv")), row.names=F)
  write.csv(leaf.df, file.path("../data_processed/model_output", paste0(SP, "_TT_model_leaf.csv")), row.names=F)
  
  l <- l + 1
}

#Checking convergence and confidence interval of all species
Check

#If they are below 1.1 then they are consider converged (I'll get the right citation for that I've seen it in a few papers)
Close <- Check[(Check$burst.converge > 1.05 | Check$leaf.converge > 1.05) , ]
Close
