#----------------------------------------------------------------------------------------------------------------------------------#
# Script by: Lucien Fitzpatrick
# Project: Collection phenology vulnerability
# Purpose: This script combines the predicted GDD5.cum for a species and matches that with a yday as a validation then acounts for bias
# Inputs: NPN data for relevant species as downloaded in script 6
#         Daymet data for NPN sites as downloaded in script 7
#         Arb weather data from script 2
#         Model output from the Relative GTmean model
# Outputs: Data frame matching the sites with their bias corrected prediction
# Notes: 
#-----------------------------------------------------------------------------------------------------------------------------------#
#Read this in to give the NPN sites their names
library(rnpn)
library(dplyr)
#site_names <- npn_stations()

#Reading in the weather data
dat.met <- read.csv("../data_processed/Daymet_clean_data.csv")
dat.met$Freeze <- ifelse(dat.met$tmin..deg.c.<0, 1, 0)
dat.met$site <- as.character(dat.met$site)
dat.met$Date <- as.Date(dat.met$Date)

#Reading in arb specific weather for relative GTmean
met.arb <- read.csv("../data_processed/Arb_Daymet_clean_data.csv")

#Creating a dataframe that matches year with that years GTmean. I use aggregate and a mean function but there is only one value per year anyway
met.arb <- aggregate(GTmean~year, data=met.arb, 
                     FUN=mean)

#Reading in the NPN data
dat.burst <- read.csv("../data_raw/Raw_Phenology_NPN_combined_budburst.csv")

#Putting a filter on reports after August 1st since we are interested in spring phenology
dat.burst <- dat.burst[dat.burst$Yday < 213,]

dat.burst$Date <- as.Date(dat.burst$Date)

#Calculting the number of sites so we can filter for our second step of evaluation
for(SP in unique(dat.burst$species)){
  dat.sp <- dat.burst[dat.burst$species == SP,]
  dat.burst[dat.burst$species == SP, "nsites"] <- length(unique(dat.sp$site_id))
}

dat.burst <- dat.burst[dat.burst$nsites < 10,]


bud.bias <- read.csv(file.path("../data_processed/model_output/Rel_GTmean_model_budburst.csv"))

#Read in all the species outputs into one dataframe
bud.files <- list.files(path = "../data_processed/Arb_pheno", pattern = "OldTT_model_budburst.csv", full.names = T)
bud.stats <- as.data.frame(sapply(bud.files, read.csv, simplify=FALSE) %>% 
                             bind_rows(.id = "id"))


#Seperating columns to help match with npn data
bud.stats <- tidyr::separate(bud.stats, col = "species", into=c("genus", "species"))

pred.list <- list()
for(YR in unique(dat.burst$year)){
  for(LOC in unique(dat.burst[dat.burst$year==YR, "site_id"])){
    #Pulling out daymet data matching the year and site
    met.now <- dat.met[dat.met$year==YR & dat.met$site==LOC,]
    dat.loc <- dat.burst[dat.burst$year == YR & dat.burst$site_id == LOC,]
    for(SP in unique(dat.loc$species)){
      #Pulling out the posterior distribution for our species
      dat.sp <- dat.loc[dat.loc$species ==SP,]
      bud.SP <- bud.stats[bud.stats$species == SP,]
      for(IND in unique(dat.sp$individual_id)){
        #Randomly sample 500 from that distribution
        dat.ind <- dat.sp[dat.sp$individual_id == IND,]
        bias.samp <- bud.bias[sample(1:nrow(bud.bias), 25),]
        day.samp <- bud.SP[sample(1:nrow(bud.SP), 25),]
        pred.list[[paste(YR, LOC, SP, IND, sep="-")]] <- day.samp
        pred.list[[paste(YR, LOC, SP, IND, sep="-")]]$year <- as.factor(YR)
        pred.list[[paste(YR, LOC, SP, IND, sep="-")]]$site <- as.factor(LOC)
        pred.list[[paste(YR, LOC, SP, IND, sep="-")]]$species <- as.factor(SP)
        pred.list[[paste(YR, LOC, SP, IND, sep="-")]]$ind <- as.factor(IND)
        pred <- apply(day.samp, 1, FUN=function(x){min(met.now[met.now$GDD5.cum>=as.numeric(x["THRESH"]), "yday"])})
        pred.list[[paste(YR, LOC, SP, IND, sep="-")]]$pred <- pred
        pred.list[[paste(YR, LOC, SP, IND, sep="-")]]$bias <- bias.samp[["bias"]]
        pred.list[[paste(YR, LOC, SP, IND, sep="-")]]$yday.adj <- pred + (bias.samp[["bias"]] * (unique(met.now$GTmean))- met.arb[met.arb$year == YR, "GTmean"])
      }
    }
  }
}
pred.burst <- dplyr::bind_rows(pred.list)
summary(pred.burst)

# Save dat.burst 
write.csv(pred.burst, "../data_processed/Rel_GT_Budburst_Phenology_NPN_prediction.csv", row.names=F)

#----------------------------------------------------#
#Now starting with leaf out
#----------------------------------------------------#
#Read in all the species outputs into one dataframe
dat.leaf <- read.csv("../data_processed/Leaf_Prediction_Evaluation_all.csv")

#Putting a filter on reports after August 1st since we are interested in spring phenology
dat.leaf <- dat.leaf[dat.leaf$Yday < 213,]

dat.leaf$Date <- as.Date(dat.leaf$Date)

#Calculting the number of sites so we can filter for our second step of evaluation
for(SP in unique(dat.leaf$species)){
  dat.sp <- dat.leaf[dat.leaf$species == SP,]
  dat.leaf[dat.leaf$species == SP, "nsites"] <- length(unique(dat.sp$site_id))
}

dat.leaf <- dat.leaf[dat.leaf$nsites < 10,]

leaf.bias <- read.csv(file.path("../data_processed/model_output/Rel_GTmean_model_leaf.csv"))


leaf.files <- list.files(path = "../data_processed/Arb_pheno", pattern = "OldTT_model_leaf.csv", full.names = T)
leaf.stats <- as.data.frame(sapply(leaf.files, read.csv, simplify=FALSE) %>% 
                              bind_rows(.id = "id"))

#Seperating columns to help match with npn data
leaf.stats <- tidyr::separate(leaf.stats, col = "species", into=c("genus", "species"))

pred.list <- list()
for(YR in unique(dat.leaf$year)){
  for(LOC in unique(dat.leaf[dat.leaf$year==YR, "site_id"])){
    #Pulling out daymet data matching the year and site
    met.now <- dat.met[dat.met$year==YR & dat.met$site==LOC,]
    dat.loc <- dat.leaf[dat.leaf$year == YR & dat.leaf$site_id == LOC,]
    for(SP in unique(dat.loc$species)){
      #Pulling out the posterior distribution for our species
      dat.sp <- dat.loc[dat.loc$species ==SP,]
      leaf.SP <- leaf.stats[leaf.stats$species == SP,]
      for(IND in unique(dat.sp$individual_id)){
        #Randomly sample 500 from that distribution
        dat.ind <- dat.sp[dat.sp$individual_id == IND,]
        bias.samp <- leaf.bias[sample(1:nrow(leaf.bias), 25),]
        day.samp <- leaf.SP[sample(1:nrow(leaf.SP), 25),]
        pred.list[[paste(YR, LOC, SP, IND, sep="-")]] <- day.samp
        pred.list[[paste(YR, LOC, SP, IND, sep="-")]]$year <- as.factor(YR)
        pred.list[[paste(YR, LOC, SP, IND, sep="-")]]$site <- as.factor(LOC)
        pred.list[[paste(YR, LOC, SP, IND, sep="-")]]$species <- as.factor(SP)
        pred.list[[paste(YR, LOC, SP, IND, sep="-")]]$ind <- as.factor(IND)
        pred <- apply(day.samp, 1, FUN=function(x){min(met.now[met.now$GDD5.cum>=as.numeric(x["THRESH"]), "yday"])})
        pred.list[[paste(YR, LOC, SP, IND, sep="-")]]$pred <- pred
        pred.list[[paste(YR, LOC, SP, IND, sep="-")]]$bias <- bias.samp[["bias"]]
        pred.list[[paste(YR, LOC, SP, IND, sep="-")]]$yday.adj <- pred + (bias.samp[["bias"]] * unique(met.now$GTmean))
      }
    }
  }
}

pred.leaf <- dplyr::bind_rows(pred.list)
summary(pred.leaf)

# Save dat.leaves 
write.csv(pred.leaf, "../data_processed/Rel_GTmean_Leaf_Phenology_NPN_prediction.csv", row.names=F)

