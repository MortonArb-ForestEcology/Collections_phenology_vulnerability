wd()
dat.b <- read.csv("/data/Oak_collection_budburst.csv")
getwd()
dat.b <- read.csv("../data/Oak_collection_budburst.csv")
#----------------------------------------------------------------------------------------------------------------------------------#
# Script by : Lucien Fitzpatrick
# Project: Collection phenology vulnerability
# Purpose: This script is the actual model predicting the GDD5.cum value at which budburst or leaf out occur
# Inputs: Oak_collection_budburst.csv
#         Oak_collection_leaf.csv
# Outputs: Posterior distributions for bud burst and leaf out for every species in our collection
#         A data.frame with information on the model run to check convergence
# Notes: This script can be made into a loop for each species but is currently manual to allow for checks as it runs
#-----------------------------------------------------------------------------------------------------------------------------------#
library(rjags)
library(rjags)
library(coda)
library(dplyr)
library(tidyr)
# Read in output of previous script
dat.b <- read.csv("../data_processed/Oak_collection_budburst.csv")
dat.b$Accession <- unlist(lapply(strsplit(paste(dat.b$PlantNumber), "-"), function(x){x[1]}))
dat.b$Date <- as.Date(dat.b$Date)
# Read in output of previous script
dat.l <- read.csv("../data_processed/Oak_collection_leaf.csv")
dat.l$Accession <- unlist(lapply(strsplit(paste(dat.l$PlantNumber), "-"), function(x){x[1]}))
dat.l$Date <- as.Date(dat.l$Date)
met.all <- read.csv("../data_processed/Arb_Pheno/Daymet_clean_data.csv")
met.all$TMEAN <- (met.all$tmax..deg.c. + met.all$tmin..deg.c.)/2
#Pulling out the number of observations we have for each species
SP.burst <- as.data.frame(table(dat.b[, "Species"]))
colnames(SP.burst) <- c("Species", "Freq")
#Pulling out the number of observations we have for each species
SP.leaf <- as.data.frame(table(dat.l[, "Species"]))
colnames(SP.leaf) <- c("Species", "Freq")
#CHecking which species we don't have budburst information for
setdiff(SP.leaf$Species, SP.burst$Species)
#SP.burst <- SP.burst[(1:5),]
#Creating a data frame to check the model output
Check <- data.frame()
l <- 1
SP.burst <- SP.burst[1:3,]
# Read in output of previous script
dat.b <- read.csv("../data_processed/Oak_collection_budburst.csv")
path.hub <- "C:/Users/lucie/Documents/GitHub/Collections_phenology_vulnerability"
# path.hub <- ".."
dat.burst <- read.csv(paste0(path.hub, "/data/Oak_collection_budburst_raw.csv"))
dat.leaf <- read.csv(paste0(path.hub, "/data/Oak_collection_leaf_raw.csv"))
for(SP in unique(dat.burst$Species)){
dat.sp <- dat.burst[dat.burst$Species == SP,]
for(YR in unique(dat.sp$Year)){
dat.yr <- dat.sp[dat.sp$Year == YR,]
dat.sp[dat.sp$Year == YR, "sp_ind_per_year"] <- length(unique(dat.yr$PlantNumber))
#setting the Threshold. Current need 2 individuals budburst or leaf out per year
if(length(unique(dat.yr$PlantNumber))<2){
#0 notating it doesn't meet the threshold
dat.sp[dat.sp$Year == YR, "obs_check"] <- 0
}
else{
dat.sp[dat.sp$Year == YR, "obs_check"] <- 1
}
}
dat.burst[dat.burst$Species == SP, "sp_ind_per_year"] <- dat.sp$sp_ind_per_year
dat.burst[dat.burst$Species == SP, "nIndividuals"] <- max(dat.sp$sp_ind_per_year)
#Making sure the whole species is removed even if only one year is bad
dat.burst[dat.burst$Species == SP, "obs_check"] <- min(dat.sp$obs_check)
}
dat.burst <- dat.burst[dat.burst$obs_check > 0,]
for(SP in unique(dat.leaf$Species)){
dat.sp <- dat.leaf[dat.leaf$Species == SP,]
for(YR in unique(dat.sp$Year)){
dat.yr <- dat.sp[dat.sp$Year == YR,]
dat.sp[dat.sp$Year == YR, "sp_ind_per_year"] <- length(unique(dat.yr$PlantNumber))
#setting the Threshold. Current need 2 individuals budburst or leaf out per year
if(length(unique(dat.yr$PlantNumber))<2){
#0 notating it doesn't meet the threshold
dat.sp[dat.sp$Year == YR, "obs_check"] <- 0
}
else{
dat.sp[dat.sp$Year == YR, "obs_check"] <- 1
}
}
dat.leaf[dat.leaf$Species == SP, "sp_ind_per_year"] <- dat.sp$sp_ind_per_year
dat.leaf[dat.leaf$Species == SP, "nIndividuals"] <- max(dat.sp$sp_ind_per_year)
#Making sure the whole species is removed even if only one year is bad
dat.leaf[dat.leaf$Species == SP, "obs_check"] <- min(dat.sp$obs_check)
}
dat.leaf <- dat.leaf[dat.leaf$obs_check > 0,]
# Save modified data
write.csv(dat.burst,  "../data_processed/Oak_collection_budburst.csv", row.names=F)
write.csv(dat.leaf,  "../data_processed/Oak_collection_leaf.csv", row.names=F)
