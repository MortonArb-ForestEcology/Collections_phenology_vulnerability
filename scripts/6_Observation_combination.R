#----------------------------------------------------------------------------------------------------------------------------------#
# Script by : Lucien Fitzpatrick
# Project: Collection phenology vulnerability
# Purpose: This script is for combining the NPN data and the ARB data into one dataframe
# Inputs: Oak_collection_budburst.csv
#         Oak_collection_leaf.csv
#         Daymet_clean_data.csv
#         Raw_Phenology_NPN_combined_budburst.csv
#         Raw_Phenology_NPN_combined_leaf.csv
# Outputs:Full_Bud_Obs.csv
#         Full_Leaf_Obs.csv
# Notes: 
#-----------------------------------------------------------------------------------------------------------------------------------#
library(dplyr)
library(tidyr)
dir.create("../data_processed/model_output", recursive = T, showWarnings = F)

dat.burst <- read.csv("../data_raw/Raw_Phenology_NPN_combined_budburst.csv")
dat.burst <- dat.burst[!is.na(dat.burst$Yday),]
dat.burst <- dat.burst[!is.infinite(dat.burst$Yday),]

#Putting a filter on reports after August 1st since we are interested in spring phenology
dat.burst <- dat.burst[dat.burst$Yday < 181,]

dat.burst$Date <- as.Date(dat.burst$Date)
dat.burst$species <- as.character(dat.burst$species)


#reading in the leafout dataframe with residuals
dat.leaf <- read.csv("../data_raw/Raw_Phenology_NPN_combined_leaf.csv")
dat.leaf <- dat.leaf[!is.na(dat.leaf$Yday),]
dat.leaf <- dat.leaf[!is.infinite(dat.leaf$Yday),]

dat.leaf <- dat.leaf[dat.leaf$Yday < 213,]

dat.leaf$species <- as.character(dat.leaf$species)


#Calculting the number of sites so we can filter for our second step of evaluation
for(SP in unique(dat.burst$species)){
  dat.sp <- dat.burst[dat.burst$species == SP,]
  dat.burst[dat.burst$species == SP, "nsites"] <- length(unique(dat.sp$site_id))
}

dat.burst <- dat.burst[dat.burst$nsites > 10,]


#Calculting the number of sites so we can filter for our second step of evaluation
for(SP in unique(dat.leaf$species)){
  dat.sp <- dat.leaf[dat.leaf$species == SP,]
  dat.leaf[dat.leaf$species == SP, "nsites"] <- length(unique(dat.sp$site_id))
}

dat.leaf <- dat.leaf[dat.leaf$nsites > 10,]

#Reading in the weather data
dat.met <- read.csv("../data_processed/Daymet_clean_data.csv")
dat.met$Freeze <- ifelse(dat.met$tmin..deg.c.<0, 1, 0)
dat.met$site <- as.character(dat.met$site)
dat.met$Date <- as.Date(dat.met$Date)


dat.npnbud <- merge(dat.burst, dat.met, by.x = c("year", "Yday", "site_id"), by.y = c("year", "yday", "site"))
dat.npnbud <- subset(dat.npnbud, select = c("genus", "species", "GDD5.cum", "year", "Yday", "individual_id", "site_id", "latitude.x", "longitude.x", "GTmean"))
colnames(dat.npnbud) <- c("Genus", "Species", "GDD5.cum", "Year", "Yday", "PlantNumber", "Site", "Latitude", "Longitude", "GTmean")
dat.npnbud$Source <- "npn" 

dat.npnleaf <- merge(dat.leaf, dat.met, by.x = c("year", "Yday", "site_id"), by.y = c("year", "yday", "site"))
dat.npnleaf <- subset(dat.npnleaf, select = c("genus", "species", "GDD5.cum", "year", "Yday", "individual_id", "site_id", "latitude.x", "longitude.x", "GTmean"))
colnames(dat.npnleaf) <- c("Genus", "Species", "GDD5.cum", "Year", "Yday", "PlantNumber", "Site", "Latitude", "Longitude", "GTmean")
dat.npnleaf$Source <- "npn"


# Read in output of previous script
dat.b <- read.csv("../data_processed/Oak_collection_budburst.csv")
dat.b$Accession <- unlist(lapply(strsplit(paste(dat.b$PlantNumber), "-"), function(x){x[1]}))
dat.b$Date <- as.Date(dat.b$Date)

dat.b <- dat.b %>%
  separate(Species, c("Genus", "Species"), " ")

dat.arbb <- subset(dat.b, select = c("Genus", "Species", "GDD5.cum", "Year", "Yday", "PlantNumber", "Site", "Latitude", "Longitude", "GTmean"))
dat.arbb$Source <- "arb"

# Read in output of previous script
dat.l <- read.csv("../data_processed/Oak_collection_leaf.csv")
dat.l$Accession <- unlist(lapply(strsplit(paste(dat.l$PlantNumber), "-"), function(x){x[1]}))
dat.l$Date <- as.Date(dat.l$Date)
dat.l <- dat.l %>%
  separate(Species, c("Genus", "Species"), " ")

dat.arbl <- subset(dat.l, select = c("Genus", "Species", "GDD5.cum", "Year", "Yday", "PlantNumber", "Site", "Latitude", "Longitude", "GTmean"))
dat.arbl$Source <- "arb"

dat.budcomb <- rbind(dat.npnbud, dat.arbb)
dat.leafcomb <- rbind(dat.npnleaf, dat.arbl)

write.csv(dat.budcomb, "../data_processed/Full_Bud_Obs.csv", row.names = F)
write.csv(dat.leafcomb, "../data_processed/Full_Leaf_Obs.csv", row.names = F)