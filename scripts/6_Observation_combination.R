#----------------------------------------------------------------------------------------------------------------------------------#
# Script by : Lucien Fitzpatrick
# Project: Collection phenology vulnerability
# Purpose: This script is for combining the NPN data and the ARB data into one dataframe
# Inputs: Oak_collection_budburst.csv
#         Oak_collection_leaf.csv
#         Daymet_clean_data.csv
#         Raw_Phenology_NPN_combined_budburst.csv
#         Raw_Phenology_NPN_combined_leaf.csv
# Outputs:Full_Bud_Obs.csv
#         Full_Leaf_Obs.csv
# Notes: 
#-----------------------------------------------------------------------------------------------------------------------------------#
library(dplyr)
library(tidyr)
dir.create("../data_processed/model_output", recursive = T, showWarnings = F)

dat.burst <- read.csv("../data_raw/CLEAN_Phenology_NPN_combined_budburst.csv")
dat.burst$date <- as.Date(paste(dat.burst$year, dat.burst$yday), format="%Y %j")
dat.burst$species <- as.character(dat.burst$species)
# dat.burst <- dat.burst[!dat.burst$flag.3sig,]
summary(dat.burst)
summary(as.factor(dat.burst$obs.type))
summary(as.factor(dat.burst$spp.type))


#reading in the leafout dataframe 
dat.leaf <- read.csv("../data_raw/CLEAN_Phenology_NPN_combined_leaf.csv")
dat.leaf$date <- as.Date(paste(dat.leaf$year, dat.leaf$yday), format="%Y %j")
dat.leaf$species <- as.character(dat.leaf$species)
# dat.leaf <- dat.leaf[!dat.leaf$flag.3sig,]
summary(dat.leaf)

#Reading in the weather data
dat.met <- read.csv("../data_processed/Daymet_clean_data.csv")
dat.met$Freeze <- ifelse(dat.met$tmin..deg.c.<0, 1, 0)
dat.met$site <- as.character(dat.met$site)
# dat.met$date <- as.Date(dat.met$date)

# Merging met into the phenology data
dat.npnbud <- merge(dat.burst, dat.met[,c("year", "yday", "site", "GDD5.cum", "GTmean")], by.x = c("year", "yday", "site_id"), by.y = c("year", "yday", "site"))
summary(dat.npnbud)
summary(dat.npnbud[!dat.npnbud$flag.3sig,])

dat.npnleaf <- merge(dat.leaf, dat.met[,c("year", "yday", "site", "GDD5.cum", "GTmean")], by.x = c("year", "yday", "site_id"), by.y = c("year", "yday", "site"))
summary(dat.npnleaf)
summary(dat.npnleaf[!dat.npnleaf$flag.3sig,])


# Bring Arb Data back in; Arb data will need spp.type and obs.type (all = calib) based on the NPN data
spp.calib  <- unique(dat.npnleaf$species[dat.npnleaf$spp.type=="calibration"])
spp.valid1 <- unique(dat.npnleaf$species[dat.npnleaf$spp.type=="validation"])
spp.valid2 <- unique(dat.npnleaf$species[dat.npnleaf$spp.type=="validation-tier2"])
spp.weird <- unique(dat.npnleaf$species[dat.npnleaf$spp.type=="weird"])

arb.burst <- read.csv("../data_processed/Oak_collection_budburst.csv")
arb.burst$flag.3sig <- F
arb.burst$flag.4sig <- F
arb.burst$obs.type <- "calibration"
arb.burst$spp.type[arb.burst$species %in% spp.calib] <- "calibration"
arb.burst$spp.type[arb.burst$species %in% spp.valid1] <- "validation"
arb.burst$spp.type[arb.burst$species %in% spp.valid2] <- "validation-tier2"
arb.burst$spp.type[arb.burst$species %in% spp.weird] <- "weird"


arb.leaf <- read.csv("../data_processed/Oak_collection_leaf.csv")
arb.leaf$flag.3sig <- F
arb.leaf$flag.4sig <- F
arb.leaf$obs.type <- "calibration"
arb.leaf$spp.type[arb.leaf$species %in% spp.calib] <- "calibration"
arb.leaf$spp.type[arb.leaf$species %in% spp.valid1] <- "validation"
arb.leaf$spp.type[arb.leaf$species %in% spp.valid2] <- "validation-tier2"
arb.leaf$spp.type[arb.leaf$species %in% spp.weird] <- "weird"

# names(arb.burst)[names(arb.burst) %in% names(dat.npnbud)]
cols.keep <- c("genus", "species", "site_id", "latitude", "longitude", "individual_id", "date", "year", "yday", "GDD5.cum", "GTmean", "flag.3sig", "flag.4sig", "obs.type", "spp.type")

bud.all <- rbind(arb.burst[,cols.keep], dat.npnbud[,cols.keep])
length(which(bud.all$site_id=="Morton"))/nrow(bud.all) # % budburst obs in the Morton data
summary(bud.all)

leaf.all <- rbind(arb.leaf[,cols.keep], dat.npnleaf[,cols.keep])
length(which(leaf.all$site_id=="Morton"))/nrow(leaf.all) # % budburst obs in the Morton data
summary(leaf.all)


write.csv(bud.all, "../data_processed/Full_Bud_Obs.csv", row.names = F)
write.csv(leaf.all, "../data_processed/Full_Leaf_Obs.csv", row.names = F)
