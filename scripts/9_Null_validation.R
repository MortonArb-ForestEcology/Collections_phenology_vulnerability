#----------------------------------------------------------------------------------------------------------------------------------#
# Script by: Lucien Fitzpatrick
# Project: Collection phenology vulnerability
# Purpose: This script is used to validate our first round of predictions
# Inputs: Budburst data frame with weather metrics as created by script 3
#         Leaf out data frame with weather metrics as created by script 3 
# Outputs:Validation data frames needed to fit the bias correction models 
#         Tables containing summary statistics of the GDD5.cum Thresholds for each species and site
# Notes: This scripts looks at the output of the NUll GDD model
#-----------------------------------------------------------------------------------------------------------------------------------#
library(ggplot2)
library(dplyr)


#reading daymet to attach GTmean
# dat.met <- read.csv("../data_processed/Daymet_clean_data.csv")
# dat.met$site <- as.character(dat.met$site)
# dat.met$Date <- as.Date(dat.met$Date)

#Reading in our cleaned NPN data
dat.budburst <- read.csv("../data_processed/Full_Bud_Obs.csv")
dat.budburst <- dat.budburst[!dat.budburst$flag.3sig & dat.budburst$spp.type %in% c("calibration", "validation"),]
dat.budburst <- dat.budburst[dat.budburst$site_id!="Morton",]
# dat.budburst$date <- as.Date(paste(dat.budburst$date))
summary(dat.budburst)

#Reading in the predictions for npn sites
pred.burst <- read.csv("../data_processed/TT_Budburst_Phenology_NPN_prediction.csv")


#aggregating our predictions
pred.burst.ci <- aggregate(yday.pred~species+site+year, data=pred.burst,
                          FUN=function(x) quantile(x,c(0.025, 0.5, 0.975)), na.action = na.omit)

#Pulling out the quantiles from our aggregate function
pred.burst.ci$tail <- pred.burst.ci$yday.pred[,1]
pred.burst.ci$mid <- pred.burst.ci$yday.pred[,2]
pred.burst.ci$head <- pred.burst.ci$yday.pred[,3]

# pred.burst.ci$yday.pred <- pred.burst.ci$mid

#Merging our two data frames so we can compare
comb.burst <- merge(dat.budburst, pred.burst.ci[,c("species", "site", "year", "tail", "mid", "head")], by.x = c("species", "site_id", "year"), by.y = c("species", "site", "year"), all.x=T) # Note: this may introduce NAs, but that's okay
comb.burst[is.na(comb.burst$mid), c("tail", "mid", "head")] <- -9999
summary(comb.burst)

#Calculating the difference
comb.burst$diff <- comb.burst$yday - comb.burst$mid

#Absolute value of that difference
comb.burst$absdiff <- abs(comb.burst$diff)

#1 = yes error, 0 = no error
comb.burst$error <- ifelse((comb.burst$yday < comb.burst$tail | comb.burst$yday > comb.burst$head), 1, 0)

comb.burst$expdiff <- comb.burst$diff ^ 2

bad <- comb.burst[comb.burst$absdiff >= 30,]
summary(as.factor(bad$species))

burst.diff <- stack(summary(as.factor(comb.burst$species)))[,c("ind", "values")]
names(burst.diff) <- c("species", "n")

# adding in the species type
spp.type <- data.frame(species=unique(comb.burst$species))
for(SPP in spp.type$species){
  spp.type[spp.type$species==SPP, "type"] <- unique(comb.burst$spp.type[comb.burst$species==SPP])
}

burst.diff <- merge(burst.diff, spp.type)

#Filling data frame with summary stats of interest
burst.diff[,c("median_abs_diff")] <- aggregate(absdiff~species, data = comb.burst,
                                               FUN=median, na.rm=F)[,c("absdiff")] 

burst.diff[,c("mean_abs_diff")] <- aggregate(absdiff~species, data = comb.burst,
                                             FUN=mean, na.rm=F)[,c("absdiff")]

burst.diff[,c("RMSE")] <- aggregate(expdiff~species, data = comb.burst,
                                    FUN=mean, na.rm=F)[,c("expdiff")]

burst.diff$RMSE <- sqrt(burst.diff$RMSE)

burst.diff[,c("error_rate")] <- aggregate(error~species, data = comb.burst,
                                          FUN=mean, na.rm=F)[,c("error")]

# Clearing out the ridonculous values that are from making sure we don't drop species; 182 is half a year -- that should be safe, yah?
burst.diff[burst.diff$RMSE>182,c("median_abs_diff", "mean_abs_diff", "RMSE", "error_rate")] <- NA

comb.burst[comb.burst$mid==-9999, c("tail", "mid", "head", "diff", "absdiff", "error", "expdiff")] <- NA
summary(comb.burst)

#Creating data frame that contains the summary stats for all oaks
oak.burst <- data.frame("Oaks")
colnames(oak.burst) <- "species"
oak.burst$n <- nrow(comb.burst[!is.na(comb.burst$mid),])
oak.burst$median_abs_diff <- median(comb.burst$absdiff, na.rm=T)
oak.burst$mean_abs_diff <- mean(comb.burst$absdiff, na.rm=T)
oak.burst$error_rate <- mean(comb.burst$error, na.rm=T)
oak.burst$RMSE <- sqrt(mean(comb.burst$expdiff, na.rm=T))
oak.burst$type <- ""

#Writing our summary table for sharing/storing
path.data <- "../data_processed"
burst.diff <- rbind(oak.burst, burst.diff)
burst.diff <- burst.diff[order(burst.diff$type),]
write.csv(burst.diff, file.path(path.data, 'TT_Budburst_Prediction_summary.csv'), row.names = F)

summary(comb.burst)
write.csv(comb.burst, file.path(path.data, 'TT_Budburst_Prediction_Evaluation_all.csv'), row.names = F)

#---------------------------------------------#
#Here begins the leaf out section
#---------------------------------------------#
#This section is identical to the above section save for being about leaf out data

dat.leaf <- read.csv("../data_processed/Full_Leaf_Obs.csv")
dat.leaf <- dat.leaf[!dat.leaf$flag.3sig & dat.leaf$spp.type %in% c("calibration", "validation"),]
dat.leaf <- dat.leaf[dat.leaf$site_id!="Morton",]
# dat.leaf$date <- as.Date(dat.leaf$date)
summary(dat.leaf)


pred.leaf <- read.csv("../data_processed/TT_Leaf_Phenology_NPN_prediction.csv")

pred.leaf.ci <- aggregate(yday.pred~species+site+year, data=pred.leaf,
                          FUN=function(x) quantile(x,c(0.025, 0.5, 0.975)), na.action = na.omit)

pred.leaf.ci$tail <- pred.leaf.ci$yday.pred[,1]
pred.leaf.ci$mid <- pred.leaf.ci$yday.pred[,2]
pred.leaf.ci$head <- pred.leaf.ci$yday.pred[,3]

# pred.leaf.ci$yday.pred <- NULL

comb.leaf <- merge(dat.leaf, pred.leaf.ci[,c("species", "site", "year", "tail", "mid", "head")], by.x = c("species", "site_id", "year"), by.y = c("species", "site", "year"), all.x=T) # Note: this may introduce NAs, but that's okay
comb.leaf[is.na(comb.leaf$mid), c("tail", "mid", "head")] <- -9999

comb.leaf$diff <- comb.leaf$yday - comb.leaf$mid

comb.leaf$absdiff <- abs(comb.leaf$diff)

#1 = yes error, 0 = no error
comb.leaf$error <- ifelse((comb.leaf$yday < comb.leaf$tail | comb.leaf$yday > comb.leaf$head), 1, 0)

comb.leaf$expdiff <- comb.leaf$diff ^ 2

leaf.diff <- stack(summary(as.factor(comb.leaf$species)))[,c("ind", "values")]
names(leaf.diff) <- c("species", "n")

# adding in the species type
spp.type <- data.frame(species=unique(comb.leaf$species))
for(SPP in spp.type$species){
  spp.type[spp.type$species==SPP, "type"] <- unique(comb.leaf$spp.type[comb.leaf$species==SPP])
}

leaf.diff <- merge(burst.diff, spp.type)


#Filling data frame with summary stats of interest
leaf.diff[,c("median_abs_diff")] <- aggregate(absdiff~species, data = comb.leaf,
                                              FUN=median, na.rm=F)[,c("absdiff")] 

leaf.diff[,c("mean_abs_diff")] <- aggregate(absdiff~species, data = comb.leaf,
                                            FUN=mean, na.rm=F)[,c("absdiff")]

leaf.diff[,c("RMSE")] <- aggregate(expdiff~species, data = comb.leaf,
                                   FUN=mean, na.rm=F)[,c("expdiff")]

leaf.diff$RMSE <- sqrt(leaf.diff$RMSE)

leaf.diff[,c("error_rate")] <- aggregate(error~species, data = comb.leaf,
                                         FUN=mean, na.rm=F)[,c("error")]

# Clearing out the ridonculous values that are from making sure we don't drop species; 182 is half a year -- that should be safe, yah?
leaf.diff[leaf.diff$RMSE>182,c("median_abs_diff", "mean_abs_diff", "RMSE", "error_rate")] <- NA

comb.leaf[comb.leaf$mid==-9999, c("tail", "mid", "head", "diff", "absdiff", "error", "expdiff")] <- NA
summary(comb.leaf)


#Creating general oak data frame to later be combined
oak.leaf <- data.frame("Oaks")
colnames(oak.leaf) <- "species"
oak.leaf$n <- nrow(comb.leaf[!is.na(comb.leaf$mid),])
oak.leaf$median_abs_diff <- median(comb.leaf$absdiff, na.rm=T)
oak.leaf$mean_abs_diff <- mean(comb.leaf$absdiff, na.rm=T)
oak.leaf$error_rate <- mean(comb.leaf$error, na.rm=T)
oak.leaf$RMSE <- sqrt(mean(comb.leaf$expdiff, na.rm=T))
oak.leaf$type <- ""


path.data <- "../data_processed"
leaf.diff <- rbind(oak.leaf, leaf.diff)
leaf.diff <- leaf.diff[order(leaf.diff$type),]
write.csv(leaf.diff, file.path(path.data, 'TT_Leaf_Prediction_summary.csv'), row.names = F)

# comb.leaf$type <- ifelse(comb.leaf$species %in% val, "validation", "calibration")
write.csv(comb.leaf, file.path(path.data, 'TT_Leaf_Prediction_Evaluation_all.csv'), row.names = F)

