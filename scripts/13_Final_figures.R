#----------------------------------------------------------------------------------------------------------------------------------#
# Script by: Lucien Fitzpatrick
# Project: Collection phenology vulnerability
# Purpose: This script is used to validate our GTmean model
# Inputs: Null GDD Model output from script 8
#         First_Budburst_Prediction_Evaluation_all.csv
#         RevLat_Budburst_Prediction_Evaluation_all.csv
#         RevGT_Budburst_Prediction_Evaluation_all.csv
#         First_Leaf_Prediction_Evaluation_all.csv
#         RevLat_Leaf_Prediction_Evaluation_all.csv
#         RevGT_Leaf_Prediction_Evaluation_all.csv
# Outputs: Four major figures for our paper
# Notes: 
#-----------------------------------------------------------------------------------------------------------------------------------#
library(ggplot2)
library(cowplot)
library(Rmisc)
library(dplyr)
library(tidyverse)
path.data <- "../data_processed"
path.figures <- "../figures"
paht.hub <- "../data"

if(!dir.exists(path.figures)) dir.create(path.figures, recursive=T)

#------------------#
# ~~~ FIGURE 1 ~~~ #
#------------------#

#Using inputs only for Fig 1.
oaks.bud <- read.csv("../data_processed/Full_Bud_Obs.csv")
oaks.bud <- oaks.bud[!oaks.bud$flag.3sig & oaks.bud$spp.type %in% c("calibration", "validation"),]
summary(as.factor(oaks.bud$spp.type))

oaks.leaf <- read.csv("../data_processed/Full_Leaf_Obs.csv")
oaks.leaf <- oaks.leaf[!oaks.leaf$flag.3sig & oaks.leaf$spp.type %in% c("calibration", "validation"),]
summary(as.factor(oaks.leaf$spp.type))
summary(as.factor(oaks.leaf$obs.type))


# spp.use <- unique(oaks.bud$species)

oaks.occur <- data.frame()
oak.files <- dir("../data/occurrence", ".csv", full.names = T)

for(i in oak.files){
  spp.now <- strsplit(i, "_")[[1]][2]
  spp.now <- gsub(".csv", "", spp.now)
  if(!spp.now %in% unique(oaks.bud$species)) next 
  
  temp <- read.csv(i)
  oaks.occur <- rbind(oaks.occur, temp)
}

oaks.occur <- tidyr::separate(oaks.occur, col = "species_name_acc", into=c("genus", "species"))
  
#Assigning NPN status to each species

oaks.occur$spp.type <- ifelse(oaks.occur$species %in% unique(oaks.bud$species[oaks.bud$spp.type=="validation"]), "validation", "calibration")

#Putting the x-axis in decreasing order of species latitude centroid

#list of species (rubra has 3 because of file size)
# species <- c("alba", "gambellii", "ilicifolia", "imbricaria", "macrocarpa",
#              "marilandica", "montana", "palustris",
#              "rubra_1", "rubra_2", "rubra_3", "shumardii", "stellata", "velutina")
# 
# 
# oaks.occur$species <- factor(oaks.occur$species, levels = c("shumardii", "stellata", "marilandica", "montana", "gambelii", "alba", "velutina", "imbricaria", "palustris","ilicifolia", "macrocarpa", "rubra"))

#bud.clean$species <- factor(bud.clean$species, levels = c("lyrata", "pagoda", "michauxii", "georgiana", "shumardii", "stellata", "marilandica", "montana", "gambelii", "alba", "velutina", "muehlenbergii", "imbricaria", "palustris", "prinoides", "bicolor", "ilicifolia", "macrocarpa", "ellipsoidalis", "rubra"))
#leaf.clean$species <- factor(leaf.clean$species, levels = c("lyrata", "pagoda", "michauxii", "georgiana", "shumardii", "stellata", "marilandica", "montana", "gambelii", "alba", "velutina", "muehlenbergii", "imbricaria", "palustris", "prinoides", "bicolor", "ilicifolia", "macrocarpa", "ellipsoidalis", "rubra"))

bud.1a <- ggplot(data=oaks.occur[oaks.occur$decimalLatitude>0,], aes(x=species, y=decimalLatitude, fill=spp.type))+
  geom_hline(yintercept = 41.8, linetype = "dashed") +
  geom_violin(alpha=0.5, scale="width") +
  geom_boxplot(width=0.075, lwd=0.3, color="light grey", alpha=0.75, outlier.shape=NA)+
  geom_jitter(data=oaks.bud, aes(x=species, y=latitude, color=obs.type), size=0.25, alpha=0.2)+
  theme_cowplot(12)+
  theme(text=element_text(size=18), axis.text.x = element_text(size = 11, angle=-20, hjust=0)) +
  scale_fill_manual(name="Data Type", values=c("#CA3C97", "#4B2991")) +
  scale_color_manual(name="Data Type", values=c("#CA3C97", "#4B2991")) +
  xlab("Species")+
  ylab("Latitude")+
  # ylim(0,55) +
  theme(legend.position="top")

leaf.1a <- ggplot(data=oaks.occur[oaks.occur$decimalLatitude>0,], aes(x=species, y=decimalLatitude, fill=spp.type))+
  geom_hline(yintercept = 41.8, linetype = "dashed") +
  geom_violin(alpha=0.5, scale="width") +
  geom_boxplot(width=0.075, lwd=0.3, color="light grey", alpha=0.75, outlier.shape=NA)+
  geom_jitter(data=oaks.leaf, aes(x=species, y=latitude, color=obs.type), size=0.25, alpha=0.2)+
  theme_cowplot(12)+
  theme(text=element_text(size=18), axis.text.x = element_text(size = 11, angle=-20, hjust=0)) +
  scale_fill_manual(values=c("#CA3C97", "#4B2991")) +
  scale_color_manual(values=c("#CA3C97", "#4B2991")) +
  xlab("Species")+
  ylab("Latitude")+
  # ylim(0,55) +
  guides(fill=F, color=F)

png(width=9, height=5, units="in", res=600, filename= file.path(path.figures, paste0('Figure 1b', '.png')))
plot_grid(bud.1a, leaf.1a, labels=c('A', 'B'), align = "v", nrow=2, label_size = 18, rel_heights = c(1.1, 1))
dev.off()


#-------------------------------------------------------------------------------------------------#
#----------------------#
# ~~~ FIGURE 2 ~~~ #
#----------------------#
spp.valid <- c("imbricaria", "montana", "velutina")
burst.df <- read.csv(file.path("../data_processed/model_output/TT_model_budburst.csv"))
summary(burst.df)

burst.df <- burst.df[,grep("THRESH", names(burst.df))]
colnames(burst.df) <- unlist(lapply(strsplit(names(burst.df), "[.]"), FUN=function(x)x[2]))

bud.stats <- data.table::melt(burst.df, variable.name = "Species")

#Read in all the species outputs into one dataframe
leaf.df <- read.csv(file.path("../data_processed/model_output/TT_model_leaf.csv"))
summary(leaf.df)

leaf.df <- leaf.df[,grep("THRESH", names(leaf.df))]
colnames(leaf.df) <- unlist(lapply(strsplit(names(leaf.df), "[.]"), FUN=function(x)x[2]))

leaf.stats <- data.table::melt(leaf.df, variable.name = "Species")

#Assigning NPN status to each species

bud.stats$NPN <- ifelse(bud.stats$Species %in% spp.valid, "validation", "calibration")
leaf.stats$NPN <- ifelse(leaf.stats$Species %in% spp.valid, "validation", "calibration")


bud.ci <- aggregate(value~Species, data=bud.stats,
                    FUN=function(x) quantile(x,c(0.025, 0.5, 0.975)), na.action = na.omit)

bud.ci$tail <- bud.ci$value[,1]
bud.ci$mid <- bud.ci$value[,2]
bud.ci$head <- bud.ci$value[,3]

bud.ci$range <- bud.ci$head - bud.ci$tail

leaf.ci <- aggregate(value~Species, data=leaf.stats,
                     FUN=function(x) quantile(x,c(0.025, 0.5, 0.975)), na.action = na.omit)

leaf.ci$tail <- leaf.ci$value[,1]
leaf.ci$mid <- leaf.ci$value[,2]
leaf.ci$head <- leaf.ci$value[,3]

leaf.ci$range <- leaf.ci$head - leaf.ci$tail

bud.clean <- data.frame()
for(SP in unique(bud.stats$Species)){
  temp <- bud.stats[bud.stats$Species == SP,]
  ci <- bud.ci[bud.ci$Species == SP,]
  temp <- temp[temp$value >= ci$tail & temp$value <= ci$head,]
  bud.clean <- rbind(bud.clean, temp)
}

leaf.clean <- data.frame()
for(SP in unique(leaf.stats$Species)){
  temp <- leaf.stats[leaf.stats$Species == SP,]
  ci <- leaf.ci[leaf.ci$Species == SP,]
  temp <- temp[temp$value >= ci$tail & temp$value <= ci$head,]
  leaf.clean <- rbind(leaf.clean, temp)
}


bud.clean$species <- factor(bud.clean$Species, levels = c("lyrata", "pagoda", "michauxii", "georgiana", "shumardii", "stellata", "marilandica", "montana", "gambelii", "alba", "velutina", "muehlenbergii", "imbricaria", "palustris", "prinoides", "bicolor", "ilicifolia", "macrocarpa", "ellipsoidalis", "rubra"))
leaf.clean$species <- factor(leaf.clean$Species, levels = c("lyrata", "pagoda", "michauxii", "georgiana", "shumardii", "stellata", "marilandica", "montana", "gambelii", "alba", "velutina", "muehlenbergii", "imbricaria", "palustris", "prinoides", "bicolor", "ilicifolia", "macrocarpa", "ellipsoidalis", "rubra"))

bud.1a <- ggplot(data=bud.clean, aes(x=Species, y=value, fill=NPN))+
  geom_violin(alpha=0.5, scale="width") +
  geom_boxplot(width=0.075, lwd=0.3, color="light grey", alpha=0.75, outlier.shape=NA)+
  theme_cowplot(12)+
  theme(text=element_text(size=18), axis.text.x = element_text(size = 11, angle=-20, hjust=0)) +
  scale_fill_manual(values=c("#CA3C97", "#4B2991")) +
  scale_color_manual(values=c("#CA3C97", "#4B2991")) +
  xlab("Species")+
  ylab("GDD5")

leaf.1a <- ggplot(data=leaf.clean, aes(x=Species, y=value, fill=NPN))+
  geom_violin(alpha=0.5, scale="width") +
  geom_boxplot(width=0.075, lwd=0.3, color="light grey", alpha=0.75, outlier.shape=NA)+
  theme_cowplot(12)+
  theme(text=element_text(size=18), axis.text.x = element_text(size = 11, angle=-20, hjust=0)) +
  scale_fill_manual(values=c("#CA3C97", "#4B2991")) +
  scale_color_manual(values=c("#CA3C97", "#4B2991")) +
  xlab("Species")+
  ylab("GDD5")

png(width=9, height=5, units="in", res=600, filename= file.path(path.figures, paste0('Figure 2', '.png')))
plot_grid(bud.1a, leaf.1a, labels=c('A', 'B'), align = "v", nrow=2, label_size = 18)
dev.off()
#----------------------#
# ~~~ FIGURE 3 & 4 ~~~ #
#----------------------#

first.comb.burst <- read.csv(file.path(path.data, paste0('TT_Budburst_Prediction_Evaluation_all.csv')))
RevLat.comb.burst <- read.csv(file.path(path.data, paste0('RevLat_Budburst_Prediction_Evaluation_all.csv')))
RevGT.comb.burst <- read.csv(file.path(path.data, paste0('RevGT_Budburst_Prediction_Evaluation_all.csv')))


#Leafout model dfs
first.comb.leaf <- read.csv(file.path(path.data, paste0('TT_Leaf_Prediction_Evaluation_all.csv')))
RevLat.comb.leaf <- read.csv(file.path(path.data, paste0('RevLat_Leaf_Prediction_Evaluation_all.csv')))
RevGT.comb.leaf <- read.csv(file.path(path.data, paste0('RevGT_Leaf_Prediction_Evaluation_all.csv')))


# -----------------------------------
# Mixed Effects models needed for proper stat. sig assessment
# -----------------------------------
library(nlme)

# -----------------
# Bud Burst
# -----------------
bud.gdd.lme <- lme(diff ~ latitude*species - latitude - 1, random=list(site_id=~1, individual_id=~1), data=first.comb.burst[,], na.action=na.omit)
bud.gdd.t <- round(summary(bud.gdd.lme)$tTable, 3)[grep("latitude:", row.names(summary(bud.gdd.lme)$tTable)),]

bud.lat.lme <- lme(diff ~ latitude*species - latitude - 1, random=list(site_id=~1, individual_id=~1), data=RevLat.comb.burst[,], na.action=na.omit)
bud.lat.t <- round(summary(bud.lat.lme)$tTable, 3)[grep("latitude:", row.names(summary(bud.lat.lme)$tTable)),]

bud.gt.lme <- lme(diff ~ latitude*species - latitude - 1, random=list(site_id=~1, individual_id=~1), data=RevGT.comb.burst[,], na.action=na.omit)
bud.gt.t <- round(summary(bud.gt.lme)$tTable, 3)[grep("latitude:", row.names(summary(bud.gt.lme)$tTable)),]
# -----------------

# -----------------
# Leaf Out
# -----------------
leaf.gdd.lme <- lme(diff ~ latitude*species - latitude - 1, random=list(site_id=~1, individual_id=~1), data=first.comb.leaf[,], na.action=na.omit)
leaf.gdd.t <- round(summary(leaf.gdd.lme)$tTable, 3)[grep("latitude:", row.names(summary(leaf.gdd.lme)$tTable)),]


leaf.lat.lme <- lme(diff ~ latitude*species - latitude - 1, random=list(site_id=~1, individual_id=~1), data=RevLat.comb.leaf[,], na.action=na.omit)
leaf.lat.t <- round(summary(leaf.lat.lme)$tTable, 3)[grep("latitude:", row.names(summary(leaf.lat.lme)$tTable)),]

leaf.gt.lme <- lme(diff ~ latitude*species - latitude - 1, random=list(site_id=~1, individual_id=~1), data=RevGT.comb.leaf[,], na.action=na.omit)
leaf.gt.t <- round(summary(leaf.gt.lme)$tTable, 3)[grep("latitude:", row.names(summary(leaf.gt.lme)$tTable)),]
# -----------------

# -----------------------------------



#Selecting matching rows so we can combine dfs into one

first.sel.bud <- first.comb.burst %>% select(latitude, species, diff, spp.type) %>% mutate(model="GDD")
RevLat.sel.bud <- RevLat.comb.burst %>% select(latitude, species, diff, spp.type) %>% mutate(model="Lat")
RevGT.sel.bud <- RevGT.comb.burst %>% select(latitude, species, diff, spp.type) %>% mutate(model="WT")


first.sel.leaf <- first.comb.leaf %>% select(latitude, species, diff, spp.type) %>% mutate(model="GDD")
RevLat.sel.leaf <- RevLat.comb.leaf %>% select(latitude, species, diff, spp.type) %>% mutate(model="Lat")
RevGT.sel.leaf <- RevGT.comb.leaf %>% select(latitude, species, diff, spp.type) %>% mutate(model="WT")


#Combining into one df
bud.sel <- rbind(first.sel.bud, RevLat.sel.bud, RevGT.sel.bud)
leaf.sel <- rbind(first.sel.leaf, RevLat.sel.leaf, RevGT.sel.leaf)


# Doing a quick slope calculation for each species to see if the slop is significant
# NOTE: this isn't as robust as what's happening in the analysis script, so we shoudl check to make sure this is roughly consistent with those results
bud.sel$trend.type <- bud.sel$spp.type
leaf.sel$trend.type <- leaf.sel$spp.type
for(SPP in unique(bud.sel$species)){
  # GDD
  # bud.gdd.t
  if(bud.gdd.t[grep(SPP, row.names(bud.gdd.t)),5]>=0.05) bud.sel$trend.type[bud.sel$species==SPP & bud.sel$model=="GDD"] <- "N.S."
  if(leaf.gdd.t[grep(SPP, row.names(leaf.gdd.t)),5]>=0.05) leaf.sel$trend.type[leaf.sel$species==SPP & leaf.sel$model=="GDD"] <- "N.S."
  
  # Lat
  # bud.lat.t
  if(bud.lat.t[grep(SPP, row.names(bud.lat.t)),5]>=0.05) bud.sel$trend.type[bud.sel$species==SPP & bud.sel$model=="Lat"] <- "N.S."
  if(leaf.lat.t[grep(SPP, row.names(leaf.lat.t)),5]>=0.05) leaf.sel$trend.type[leaf.sel$species==SPP & leaf.sel$model=="Lat"] <- "N.S."
  
  # WT
  # bud.gt.t
  if(bud.gt.t[grep(SPP, row.names(bud.gt.t)),5]>=0.05) bud.sel$trend.type[bud.sel$species==SPP & bud.sel$model=="WT"] <- "N.S."
  if(leaf.gt.t[grep(SPP, row.names(leaf.gt.t)),5]>=0.05) leaf.sel$trend.type[leaf.sel$species==SPP & leaf.sel$model=="WT"] <- "N.S."
  
}
summary(as.factor(bud.sel$trend.type))
summary(as.factor(leaf.sel$trend.type))




#Ordering x-axis
bud.sel$model <- factor(bud.sel$model, levels = c("GDD", "Lat", "WT" ))
leaf.sel$model <- factor(leaf.sel$model, levels = c("GDD", "Lat", "WT"))
bud.sel$trend.type <- factor(bud.sel$trend.type, levels = c("calibration", "validation", "N.S." ))
leaf.sel$trend.type <- factor(leaf.sel$trend.type, levels = c("calibration", "validation", "N.S."))

#Fig. 2 v2 BUD
plots.bud.4 <- ggplot(bud.sel, aes(x = latitude, y = diff, color = spp.type, group=species))+
  facet_wrap(~model, dir = "v")+
  geom_jitter(alpha=0.25, size=0.5, aes(shape=spp.type)) +
  geom_smooth(method='lm', se = TRUE, alpha=0.25, size=0.5, aes(fill=spp.type, color=spp.type))+
  geom_vline(linetype="dashed", xintercept=41.8)+
  theme_cowplot(12) +
  theme(text=element_text(size=16), 
        legend.position="bottom", 
        legend.justification = "center",
        legend.title = element_text(size=12),
        legend.text=element_text(size=12)) + #remove legend.position for horizontal version  
  scale_color_manual(name="Species", values=c("#56B4E9", "#E69F00")) +
  scale_fill_manual(name="Species", values=c("#56B4E9", "#E69F00")) +
  # scale_shape_manual(name="Species") +
  xlab("Latitude")+
  ylab("Residual error") + guides(shape=F)

plots.bud.4alt <- ggplot(bud.sel, aes(x = latitude, y = diff, color = trend.type, group=species))+
  facet_wrap(~model, dir = "v")+
  geom_jitter(alpha=0.25, size=0.5, aes(shape=spp.type)) +
  geom_smooth(method='lm', se = TRUE, alpha=0.25, size=0.5, aes(fill=trend.type, color=trend.type))+
  geom_vline(linetype="dashed", xintercept=41.8)+
  theme_cowplot(12) +
  theme(text=element_text(size=16), 
        legend.position="bottom", 
        legend.justification = "center",
        legend.title = element_text(size=12),
        legend.text=element_text(size=12)) + #remove legend.position for horizontal version
  scale_color_manual(name="Species", values=c("#56B4E9", "#E69F00", "gray50")) +
  scale_fill_manual(name="Species", values=c("#56B4E9", "#E69F00", "gray50")) +
  # scale_shape_manual(name="Species") +
  xlab("Latitude")+
  ylab("Residual error") + guides(shape=F)

png(height = 6, width = 4, units="in", res=600, filename= file.path(path.figures, paste0('Model_Fig_3', '.png')))
plots.bud.4
dev.off()

png(height = 6, width = 4, units="in", res=600, filename= file.path(path.figures, paste0('Model_Fig_3-Alt', '.png')))
plots.bud.4alt
dev.off()

#Fig. 3 v2 LEAF

plots.leaf.4 <- ggplot(leaf.sel, aes(x = latitude, y = diff, color = spp.type, group=species))+
  facet_wrap(~model, dir = "v")+
  geom_jitter(alpha=0.25, size=0.5, aes(shape=spp.type)) +
  geom_smooth(method='lm', se = TRUE, alpha=0.25, size=0.5, aes(fill=spp.type, color=spp.type))+
  geom_vline(linetype="dashed", xintercept=41.8)+
  theme_cowplot(12) +
  theme(text=element_text(size=16), legend.position="bottom", legend.justification = "center") + #remove legend.position for horizontal version
  scale_color_manual(name="Species", values=c("#0072B2", "#D55E00")) +
  scale_fill_manual(name="Species", values=c("#0072B2", "#D55E00")) +
  xlab("Latitude")+
  ylab("Residual error") + guides(shape=F)

plots.leaf.4alt <- ggplot(leaf.sel, aes(x = latitude, y = diff, color = trend.type, group=species))+
  facet_wrap(~model, dir = "v")+
  geom_jitter(alpha=0.25, size=0.5, aes(shape=spp.type)) +
  geom_smooth(method='lm', se = TRUE, alpha=0.25, size=0.5, aes(fill=trend.type, color=trend.type))+
  geom_vline(linetype="dashed", xintercept=41.8)+
  theme_cowplot(12) +
  theme(text=element_text(size=16), legend.position="bottom", legend.justification = "center") + #remove legend.position for horizontal version
  scale_color_manual(name="Species", values=c("#0072B2", "#D55E00", "gray50")) +
  scale_fill_manual(name="Species", values=c("#0072B2", "#D55E00", "gray50")) +
  xlab("Latitude")+
  ylab("Residual error") + guides(shape=F)

png(height = 6, width = 4, units="in", res=600, filename= file.path(path.figures, paste0('Model_Fig_4', '.png')))
plots.leaf.4
dev.off()

png(height = 6, width = 4, units="in", res=600, filename= file.path(path.figures, paste0('Model_Fig_4-Alt', '.png')))
plots.leaf.4alt
dev.off()

#--------------------------------------------------------------------------------------------------#

#------------------#
# ~~~ FIGURE 5 ~~~ #
#------------------#

#Wrangling Budburst data

#Calculating RMSE by species and adding an RMSE column to each model's dataframe

rmse.first.bud <- first.comb.burst %>% group_by(species) %>% mutate_each(funs(mean)) %>% distinct %>% mutate(RMSE = sqrt(expdiff))
rmse.RevLat.bud <- RevLat.comb.burst %>% group_by(species) %>% mutate_each(funs(mean)) %>% distinct %>% mutate(RMSE = sqrt(expdiff))
rmse.RevGT.bud <- RevGT.comb.burst %>% group_by(species) %>% mutate_each(funs(mean)) %>% distinct %>% mutate(RMSE = sqrt(expdiff))
summary(rmse.RevGT.bud)

#Selecting only the columns which we need so that columns will match when combining df's; adding model name columns
#Note: make sure to update model names in 'model' column
#Note; I'm pretty sure this averages the latitudes for each species as well

rmse.first.bud <- rmse.first.bud %>% select(site_id, latitude, longitude, species, diff, error, RMSE, mid, yday, spp.type) %>% mutate(model="GDD")
rmse.RevLat.bud <- rmse.RevLat.bud %>% select(site_id, latitude, longitude, species, diff, error, RMSE, mid, yday, spp.type) %>% mutate(model="Lat")
rmse.RevGT.bud <- rmse.RevGT.bud %>% select(site_id, latitude, longitude, species, diff, error, RMSE, mid, yday, spp.type) %>% mutate(model="WT")

#Luciens version of rmse delta
#Matching for RMSE diff
rmse.first.bud$RMSE.org <- 0 
rmse.RevLat.bud$RMSE.org <- rmse.first.bud$RMSE[match(rmse.RevLat.bud$species, rmse.first.bud$species)]
rmse.RevGT.bud$RMSE.org <- rmse.first.bud$RMSE[match(rmse.RevGT.bud$species, rmse.first.bud$species)]


rmse.RevLat.bud$RMSE.diff <- rmse.RevLat.bud$RMSE-rmse.RevLat.bud$RMSE.org
rmse.RevGT.bud$RMSE.diff <- rmse.RevGT.bud$RMSE-rmse.RevGT.bud$RMSE.org



#Re-assigning 'type' to each species

# spp.valid <- c("ilicifolia", "imbricaria", "marilandica", "stellata", "shumardii")
# summary(rmse.first.bud)
rmse.first.bud$type <- ifelse(rmse.first.bud$species %in% unique(oaks.bud$species[oaks.bud$spp.type=="validation"]), "Validation", "Calibration")

rmse.RevLat.bud$type <- ifelse(rmse.RevLat.bud$species %in% unique(oaks.bud$species[oaks.bud$spp.type=="validation"]), "Validation", "Calibration")

rmse.RevGT.bud$type <- ifelse(rmse.RevGT.bud$species %in% unique(oaks.bud$species[oaks.bud$spp.type=="validation"]), "Validation", "Calibration")



#Combining model df's into one df for comparison (excluding 'first')

bud.model <- rbind(rmse.first.bud, rmse.RevLat.bud, rmse.RevGT.bud)

#Rearranging the x-axis for the following figures

bud.model$model <- factor(bud.model$model, levels = c("GDD", "Lat", "WT"))

#Doing the same data wrangling for Leafout data

#Calculating RMSE by species and adding an RMSE column to each model's dataframe

rmse.first.leaf <- first.comb.leaf %>% group_by(species) %>% mutate_each(funs(mean)) %>% distinct %>% mutate(RMSE = sqrt(expdiff))
rmse.RevLat.leaf <- RevLat.comb.leaf %>% group_by(species) %>% mutate_each(funs(mean)) %>% distinct %>% mutate(RMSE = sqrt(expdiff))
rmse.RevGT.leaf <- RevGT.comb.leaf %>% group_by(species) %>% mutate_each(funs(mean)) %>% distinct %>% mutate(RMSE = sqrt(expdiff))




#Selecting only the columns which we need so that columns will match when combining df's; adding model name columns
#Note: make sure to update model names in 'model' column
#Note; I'm pretty sure this averages the latitudes for each species as well

rmse.first.leaf <- rmse.first.leaf %>% select(site_id, latitude, longitude, species, diff, error, RMSE, mid, yday, spp.type) %>% mutate(model="GDD")
rmse.RevLat.leaf <- rmse.RevLat.leaf %>% select(site_id, latitude, longitude, species, diff, error, RMSE, mid, yday, spp.type) %>% mutate(model="Lat")
rmse.RevGT.leaf <- rmse.RevGT.leaf %>% select(site_id, latitude, longitude, species, diff, error, RMSE, mid, yday, spp.type) %>% mutate(model="WT")

#Matching for RMSE diff
rmse.first.leaf$RMSE.org <- 0 
rmse.RevLat.leaf$RMSE.org <- rmse.first.leaf$RMSE[match(rmse.RevLat.leaf$species, rmse.first.leaf$species)]
rmse.RevGT.leaf$RMSE.org <- rmse.first.leaf$RMSE[match(rmse.RevGT.leaf$species, rmse.first.leaf$species)]

rmse.RevLat.leaf$RMSE.diff <- rmse.RevLat.leaf$RMSE-rmse.RevLat.leaf$RMSE.org
rmse.RevGT.leaf$RMSE.diff <- rmse.RevGT.leaf$RMSE-rmse.RevGT.leaf$RMSE.org




#Re-assigning 'type' to each species

# spp.valid <- c("ilicifolia", "imbricaria", "marilandica", "stellata", "shumardii")

rmse.first.leaf$type <- ifelse(rmse.first.leaf$species %in% unique(oaks.leaf$species[oaks.leaf$spp.type=="validation"]), "Validation", "Calibration")

rmse.RevLat.leaf$type <- ifelse(rmse.RevLat.leaf$species %in% unique(oaks.leaf$species[oaks.leaf$spp.type=="validation"]), "Validation", "Calibration")

rmse.RevGT.leaf$type <- ifelse(rmse.RevGT.leaf$species %in% unique(oaks.leaf$species[oaks.leaf$spp.type=="validation"]), "Validation", "Calibration")


#Combining model df's into one df for comparison (excluding 'first')

leaf.model <- rbind(rmse.first.leaf, rmse.RevLat.leaf, rmse.RevGT.leaf) 

#Rearranging what will be on the x-axis

leaf.model$model <- factor(leaf.model$model, levels = c("GDD", "Lat", "WT"))

#Figure Generation

bud.3 <- ggplot(data=bud.model, aes(x=type, y=RMSE, fill=model))+
  geom_boxplot(aes(fill=model)) +
  theme_cowplot(12) +
  theme(text=element_text(size=18)) +
  # ylim(0, 45) +
  scale_fill_manual(values=c("#E69F00", "#56B4E9", "#009E73")) +
  xlab("Species type")+
  ylab("RMSE (days)")

leaf.3 <- ggplot(data=leaf.model, aes(x= type, y=RMSE, fill=model))+
  geom_boxplot(aes(fill=model)) +
  theme_cowplot(12)+
  theme(text=element_text(size=18)) +
  scale_fill_manual(values=c("#E69F00", "#56B4E9", "#009E73")) +
  # ylim(0, 30) +
  xlab("Species type")+
  ylab("RMSE (days)")

png(width = 8, height=6, units="in", res=600, filename= file.path(path.figures, paste0('Figure 5', '.png')))
plot_grid(bud.3, leaf.3, labels=c('A', 'B'), rel_widths=c(1, 2, 1, 2), align = "v", nrow=2, label_size = 18)
dev.off()
