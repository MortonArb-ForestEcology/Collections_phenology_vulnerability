#----------------------------------------------------------------------------------------------------------------------------------#
# Script by: Lucien Fitzpatrick
# Project: Collection phenology vulnerability
# Purpose: This script is used to validate our GTmean model
# Inputs: Null GDD Model output from script 8
#         First_Budburst_Prediction_Evaluation_all.csv
#         RevLat_Budburst_Prediction_Evaluation_all.csv
#         RevGT_Budburst_Prediction_Evaluation_all.csv
#         First_Leaf_Prediction_Evaluation_all.csv
#         RevLat_Leaf_Prediction_Evaluation_all.csv
#         RevGT_Leaf_Prediction_Evaluation_all.csv
# Outputs: Four major figures for our paper
# Notes: 
#-----------------------------------------------------------------------------------------------------------------------------------#
library(ggplot2)
library(cowplot)
library(Rmisc)
library(dplyr)
library(tidyverse)
library(rgdal)
path.data <- "../data_processed"
path.figures <- "../figures"
paht.hub <- "../data"

path.google <- "/Volumes/GoogleDrive/My Drive/Manuscripts/CollectionsPhenologyVulnerability_CCE_2020/Submission 3 2021-08-27"
figs.google <- file.path(path.google, "figures/")

if(!dir.exists(path.figures)) dir.create(path.figures, recursive=T)

model.palette <- c("ARB"="#CC79A7", "COMB"="#E69F00", "LAT"="#56B4E9", "WT"="#009E73")
type.palette <- c("TMA"="#D55E00", "calibration"="#0072B2", "validation"="#CC79A7")

#------------------#
# ~~~ FIGURE 1 ~~~ #
# PURPOSE OF FIGURE: where our observations are compared to species range
# Update: color/shape code for calibration/validation observation
# Get ranges from Little
# Add NPN points
#------------------#
spp.calib <- c("alba", "macrocarpa", "palustris", "rubra")
spp.valid <- c("imbricaria", "montana", "velutina")
spp.code <- c("queralba", "quermacr", "querpalu", "querrubr", "querimbr", "querprin", "quervelu")

map.us <- ggplot2::map_data("state")

path.shp <- "../../USTreeAtlas/SHP/"
fshp <- dir(path.shp)

shp.spp <- data.frame()
for(SPP in spp.code){
  # i <- grep("queralba", fshp)
  sp.tmp <- readOGR(file.path(path.shp, SPP))
  fort.tmp <- fortify(sp.tmp)
  fort.tmp$hole <- as.character(fort.tmp$hole)
  fort.tmp$species <- SPP  
  
  shp.spp <- rbind(shp.spp, fort.tmp)
}
shp.spp$species <- car::recode(shp.spp$species, "'queralba'='alba'; 'querimbr'='imbricaria'; 'querprin'='montana'; 'quermacr'='macrocarpa'; 'querpalu'='palustris'; 'querrubr'='rubra'; 'quervelu'='velutina'")
shp.spp$spp.type2 <- ifelse(shp.spp$species %in% spp.calib, "Arb + NPN", "Arb Only")
summary(shp.spp)
# summary(fort.tmp)

# shp.spp$hole <- as.logical(shp.spp$hole)
ggplot(data=shp.spp[,]) +
  facet_wrap(~species) +
  coord_equal() +
  geom_polygon(data=shp.spp[shp.spp$hole=="FALSE",], aes(x=long, y=lat, group=group, fill=hole)) +
  geom_polygon(data=shp.spp[shp.spp$hole=="TRUE",], aes(x=long, y=lat, group=group, fill=hole)) +
  scale_fill_manual(values=c("FALSE"="green4", "TRUE"="yellow3")) +
  guides(fill="none")


#Using inputs only for Fig 1.
oaks.bud <- read.csv("../data_processed/Full_Bud_Obs.csv")
oaks.bud$phenophase <- "budburst"
oaks.bud <- oaks.bud[!oaks.bud$flag.3sig & oaks.bud$spp.type %in% c("calibration", "validation"),]
summary(as.factor(oaks.bud$spp.type))
summary(oaks.bud[oaks.bud$site_id=="Morton",])

oaks.leaf <- read.csv("../data_processed/Full_Leaf_Obs.csv")
oaks.leaf$phenophase <- "leaf out"
oaks.leaf <- oaks.leaf[!oaks.leaf$flag.3sig & oaks.leaf$spp.type %in% c("calibration", "validation"),]
summary(as.factor(oaks.leaf$spp.type))
summary(as.factor(oaks.leaf$obs.type))

# Getting a summary of the mean conditions for The Morton Arboretum
cond.arb <- aggregate(cbind(latitude, longitude, GTmean)~year, data=oaks.bud[oaks.bud$site_id=="Morton",], FUN=mean)
cond.arb <- colMeans(cond.arb)

obs.all <- rbind(oaks.bud[oaks.bud$species %in% c(spp.calib, spp.valid),],
                 oaks.leaf[oaks.leaf$species %in% c(spp.calib, spp.valid),])
obs.all$spp.type2 <- car::recode(obs.all$spp.type, "'calibration'='Arb + NPN'; 'validation'='Arb Only'")
obs.all$obs.type[obs.all$site_id=="Morton"] <- "TMA"
obs.all$obs.type <- factor(obs.all$obs.type, levels=c("TMA", "calibration", "validation"))

obs.all$species <- factor(obs.all$species, levels=c(spp.calib, spp.valid))
shp.spp$species <- factor(shp.spp$species, levels=c(spp.calib, spp.valid))

obs.all$species2 <- factor(paste("Q.", obs.all$species),levels=paste("Q.",c(spp.calib, spp.valid)))
shp.spp$species2 <- factor(paste("Q.", shp.spp$species),levels=paste("Q.",c(spp.calib, spp.valid)))


obs.map <- ggplot(data=obs.all[,]) +
  facet_grid(species2~phenophase) +
  coord_equal() +
  geom_path(data=map.us, aes(x=long, y=lat, group=group), color="black", size=0.25) +
  geom_polygon(data=shp.spp[shp.spp$hole=="FALSE",], aes(x=long, y=lat, group=group, fill=hole), alpha=0.5) +
  geom_polygon(data=shp.spp[shp.spp$hole=="TRUE",], aes(x=long, y=lat, group=group, fill=hole)) +
  geom_point(aes(x=longitude, y=latitude, color=obs.type, shape=obs.type), size=2) +
  geom_point(aes(x=cond.arb["longitude"], y=cond.arb["latitude"], color="TMA", shape="TMA"), size=5) +
  scale_x_continuous(name="Longitude", breaks=seq(-60, -140, by=-20)) +
  scale_y_continuous(name="Latitude", breaks=seq(20, 60, by=10)) +
  scale_shape_manual(name="Obs Type", values=c("TMA"=8, "calibration"=20, "validation"=17)) +
  scale_color_manual(name="Obs Type", values=type.palette) +
  scale_fill_manual(values=c("FALSE"="green4", "TRUE"="white")) +
  guides(fill="none") +
  theme(panel.background=element_rect(fill=NA, color="black"),
        strip.text.y = element_text(face="italic"),
        legend.position="top",
        legend.key = element_blank())


png(width=8, height=9, units="in", res=600, filename= file.path(path.figures, 'Fig1_ObservationLocations.png'))
obs.map
dev.off()

png(width=8, height=9, units="in", res=600, filename= file.path(figs.google, 'Fig1_ObservationLocations.png'))
obs.map
dev.off()


#-------------------------------------------------------------------------------------------------#
#----------------------#
# ~~~ FIGURE 2 ~~~ #
#----------------------#
spp.valid <- c("imbricaria", "montana", "velutina")
fmod <- dir("../data_processed/model_output/", "model")
# burst.df <- read.csv(file.path("../data_processed/model_output/TT_model_budburst.csv"))
# summary(burst.df)
gdd.thresh <- data.frame()
for(i in 1:length(fmod)){
  print(fmod[i])
  fmod.split <- stringr::str_split(fmod[i], "_")[[1]]
  
  mod.out <- read.csv(file.path("../data_processed/model_output", fmod[i]))
  summary(mod.out)
  
  # If we're missing a threshold calculation, we'll need to add it
  if(!any(grepl("THRESH", names(mod.out)))){
    cols.spp <- grep("Sp.bias", names(mod.out))
    
    # Find which spatial covariate to use
    arb.loc <- ifelse(grepl("RevGT", fmod[i]), cond.arb["GTmean"], cond.arb["latitude"])
    
    # Add a threshold calculation column that adds the base thresh to the species adjustments
    # NOTE: For spatial covariates, we need to preidct the threshold at a PARTICULAR Location; 
    #       Since the Arboretum is our focal site, we should use the lat & GT for the Arboretum as our site
    mod.out[, gsub("Sp.bias", "THRESH", names(mod.out)[cols.spp])] <- mod.out[,cols.spp] + mod.out$bias.loc*arb.loc + mod.out$int.loc # Add consistent naming 
  } 
  
  mod.out1 <- mod.out[,grep("THRESH", names(mod.out))]
  colnames(mod.out1) <- unlist(lapply(strsplit(names(mod.out1), "[.]"), FUN=function(x)x[2]))
  
  mod.thresh <- reshape2::melt(mod.out1, variable.name = "Species")
  mod.thresh$model <- fmod.split[1]  
  mod.thresh$phenophase <- stringr::str_split(fmod.split[length(fmod.split)], "[.]")[[1]][1]
  
  gdd.thresh <- rbind(gdd.thresh, mod.thresh)
}
summary(gdd.thresh)

#Assigning species group
gdd.thresh$spp.group <- ifelse(gdd.thresh$Species %in% spp.valid, "Arb Only", "Arb + NPN")

# -----------------------
# Trimming the distributions to the 95% CI
# -----------------------
gdd.ci <- aggregate(value~Species+model+phenophase, data=gdd.thresh,
                    FUN=function(x) quantile(x,c(0.025, 0.5, 0.975)), na.action = na.omit)

gdd.ci$tail <- gdd.ci$value[,1]
gdd.ci$mid <- gdd.ci$value[,2]
gdd.ci$head <- gdd.ci$value[,3]

gdd.ci$range <- gdd.ci$head - gdd.ci$tail

thresh.clean <- data.frame()
for(SP in unique(gdd.thresh$Species)){
  for(MOD in unique(gdd.thresh$model)){
    for(PHENO in unique(gdd.thresh$phenophase)){
      # Subset the data
      temp <- gdd.thresh[gdd.thresh$Species==SP & gdd.thresh$model==MOD & gdd.thresh$phenophase==PHENO,]
      
      ci <- gdd.ci[gdd.ci$Species==SP & gdd.ci$model==MOD & gdd.ci$phenophase==PHENO,]
      temp <- temp[temp$value >= ci$tail & temp$value <= ci$head,]
      thresh.clean <- rbind(thresh.clean, temp)
    }
  }
}
summary(thresh.clean) 
# thresh.clean$spp.group <- ifelse(thresh.clean$Species %in% spp.valid, "Arb Only", "Arb + NPN")
# -----------------------

thresh.clean$model <- car::recode(thresh.clean$model, "'RevLat'='LAT'; 'RevGT'='WT'")

# Doing some preliminary graphs before doing this cleaning step
gdd.bud <- ggplot(data=thresh.clean[thresh.clean$phenophase=="budburst",]) +
  facet_grid(.~spp.group, scales="free_x") +
  geom_violin(aes(x=paste("Q.", Species), y=value, fill=model), scale="width") +
  scale_y_continuous(name="GDD5 Threshold", expand=c(0,0), limits=c(0, max(thresh.clean$value))) +
  scale_x_discrete(name="Species") +
  scale_fill_manual(name="Model", values=model.palette) +
  # scale_fill_manual(name="Model", values=model.palette) +
  theme(panel.background = element_blank(),
        panel.grid = element_blank(),
        axis.line = element_line(color="black", size=0.2),
        axis.text.x = element_text(face="italic", size=rel(1.5), angle=-15, hjust=0),
        axis.text.y=element_text(size=rel(1.5)),
        axis.title = element_text(size=rel(1.75), face="bold"),
        strip.text = element_text(size=rel(1.75)),
        # legend.position=c(0.2, 0.8),
        legend.title=element_text(size=rel(1.5)),
        legend.text=element_text(size=rel(1.25)))

gdd.leaf <- ggplot(data=thresh.clean[thresh.clean$phenophase=="leaf",]) +
  facet_grid(.~spp.group, scales="free_x") +
  geom_violin(aes(x=paste("Q.", Species), y=value, fill=model), scale="width") +
  scale_y_continuous(name="GDD5 Threshold", expand=c(0,0), limits=c(0, max(thresh.clean$value))) +
  scale_x_discrete(name="Species") +
  scale_fill_manual(name="Model", values=model.palette) +
  # scale_fill_manual(name="Model", values=model.palette) +
  theme(panel.background = element_blank(),
        panel.grid = element_blank(),
        axis.line = element_line(color="black", size=0.2),
        axis.text.x = element_text(face="italic", size=rel(1.5), angle=-15, hjust=0),
        axis.text.y=element_text(size=rel(1.5)),
        axis.title = element_text(size=rel(1.75), face="bold"),
        strip.text = element_text(size=rel(1.75)),
        # legend.position=c(0.2, 0.8),
        legend.title=element_text(size=rel(1.5)),
        legend.text=element_text(size=rel(1.25)))

png(width=9, height=8, units="in", res=600, filename= file.path(path.figures, 'Fig2_GDD5thresh.png'))
plot_grid(gdd.bud, gdd.leaf, labels=c('A', 'B'), align = "v", nrow=2, label_size = 18)
dev.off()
png(width=9, height=8, units="in", res=600, filename= file.path(figs.google, 'Fig2_GDD5thresh.png'))
plot_grid(gdd.bud, gdd.leaf, labels=c('A', 'B'), align = "v", nrow=2, label_size = 18)
dev.off()
#-------------------------------------------------------------------------------------------------#


#-------------------------------------------------------------------------------------------------#
#----------------------#
# ~~~ Data inputs for FIGURE 3 & 4 ~~~ #
#----------------------#
fpred <- dir(path.data, "Prediction_Evaluation")
pred.all <- data.frame()
stats.all <- data.frame()
for(i in 1:length(fpred)){
  print(fpred[i])
  fpred.split <- stringr::str_split(fpred[i], "_")[[1]]
  
  pred.out <- read.csv(file.path(path.data, fpred[i]))
  pred.out$model <- fpred.split[1]  
  pred.out$phenophase <- ifelse(grepl("TT", fpred[i]), fpred.split[3], fpred.split[2])
  summary(pred.out)
  
  stat.tmp <- data.frame(model=fpred.split[1], 
                         phenophase=ifelse(grepl("TT", fpred[i]), fpred.split[3], fpred.split[2]),
                         species=unique(pred.out$species), 
                         RMSE=NA, err.rate=NA, bias=NA)
  for(SPP in unique(pred.out$species)){
    row.spp <- which(stat.tmp$species==SPP)
    dat.spp <- pred.out[pred.out$species==SPP & pred.out$obs.type=="validation",]
    stat.tmp[row.spp,"RMSE"] <- sqrt(mean(dat.spp$diff^2))
    stat.tmp[row.spp,"err.rate"] <- mean(dat.spp$error)
    stat.tmp[row.spp, "bias"] <- mean(dat.spp$diff)
  }

  pred.all <- rbind(pred.all, pred.out)
  stats.all <- rbind(stats.all, stat.tmp)
}
summary(pred.all)
summary(stats.all)
stats.all$spp.type <- ifelse(stats.all$species %in% spp.calib, "Arb + NPN", "Arb Only")
stats.all$model <- car::recode(stats.all$model, "'RevGT'='WT'; 'RevLat'='LAT'")
stats.all

pred.all$spp.type2 <- ifelse(pred.all$species %in% spp.calib, "Arb + NPN", "Arb Only")
pred.all$model <- car::recode(pred.all$model, "'RevGT'='WT'; 'RevLat'='LAT'")


# ------------------------
# Figure 3 - RMSE
# ------------------------
ggplot(data=stats.all) +
  facet_grid(phenophase~.) +
  geom_boxplot(aes(x=spp.type, y=RMSE, fill=model)) +
  scale_fill_manual(name="Model", values=model.palette) +
  theme(panel.background = element_blank(),
        axis.line = element_line(color="black", size=0.5),
        legend.key = element_blank())

bud.rmse <- ggplot(data=stats.all[stats.all$phenophase=="Budburst",]) +
  facet_grid(.~spp.type, scales="free_x") +
  geom_bar(aes(x=paste("Q.", species), y=RMSE, fill=model), stat="identity", position="dodge") +
  scale_y_continuous(name="RMSE (days)", expand=c(0,0), limits=c(0, max(stats.all$RMSE))) +
  scale_x_discrete(name="Species") +
  scale_fill_manual(name="Model", values=model.palette) +
  # scale_fill_manual(name="Model", values=model.palette) +
  theme(panel.background = element_blank(),
        panel.grid = element_blank(),
        axis.line = element_line(color="black", size=0.2),
        axis.text.x = element_text(face="italic", size=rel(1.5), angle=-15, hjust=0),
        axis.text.y=element_text(size=rel(1.5)),
        axis.title = element_text(size=rel(1.75), face="bold"),
        strip.text = element_text(size=rel(1.75)),
        # legend.position=c(0.2, 0.8),
        legend.key=element_blank(),
        legend.title=element_text(size=rel(1.5)),
        legend.text=element_text(size=rel(1.25)))

leaf.rmse <- ggplot(data=stats.all[stats.all$phenophase=="Leaf",]) +
  facet_grid(.~spp.type, scales="free_x") +
  geom_bar(aes(x=paste("Q.", species), y=RMSE, fill=model), stat="identity", position="dodge") +
  scale_y_continuous(name="RMSE (days)", expand=c(0,0), limits=c(0, max(stats.all$RMSE))) +
  scale_x_discrete(name="Species") +
  scale_fill_manual(name="Model", values=model.palette) +
  # scale_fill_manual(name="Model", values=model.palette) +
  theme(panel.background = element_blank(),
        panel.grid = element_blank(),
        axis.line = element_line(color="black", size=0.2),
        axis.text.x = element_text(face="italic", size=rel(1.5), angle=-15, hjust=0),
        axis.text.y=element_text(size=rel(1.5)),
        axis.title = element_text(size=rel(1.75), face="bold"),
        strip.text = element_text(size=rel(1.75)),
        # legend.position=c(0.2, 0.8),
        legend.key=element_blank(),
        legend.title=element_text(size=rel(1.5)),
        legend.text=element_text(size=rel(1.25)))

png(width=9, height=8, units="in", res=600, filename= file.path(path.figures, 'Fig3_RMSE.png'))
plot_grid(bud.rmse, leaf.rmse, labels=c('A', 'B'), align = "v", nrow=2, label_size = 18)
dev.off()
png(width=9, height=8, units="in", res=600, filename= file.path(figs.google, 'Fig3_RMSE.png'))
plot_grid(bud.rmse, leaf.rmse, labels=c('A', 'B'), align = "v", nrow=2, label_size = 18)
dev.off()

# ------------------------
# Figure 4 - Spatial Trends in predictability
# ------------------------
summary(pred.all)
pred.all$species2 <- factor(paste("Q.", pred.all$species), levels=paste("Q.", c(spp.calib, spp.valid)))
pred.all$phenophase <- car::recode(pred.all$phenophase, "'Leaf'='Leaf Out'")


lat.trend <- ggplot(data=pred.all[pred.all$obs.type=="validation",]) +
  facet_grid(species2~phenophase) +
  geom_point(aes(x=latitude, y=diff, color=model), size=0.5, alpha=0.5) +
  stat_smooth(aes(x=latitude, y=diff, color=model, fill=model), method="lm", alpha=0.2) +
  geom_hline(yintercept = 0, linetype="dashed", color="black", size=0.25) +
  # geom_vline(xintercept = cond.arb["latitude"], linetype="dashed", color="black", size=0.25) +
  scale_y_continuous(name="Residual (days)", breaks=seq(-40, 60, by=20)) +
  scale_x_continuous(name="Latitude (degrees)", breaks=seq(-40, 60, by=20)) +
  scale_color_manual(name="Model", values=model.palette) +
  scale_fill_manual(name="Model", values=model.palette) +
  theme(panel.background = element_rect(fill=NA, color="black"),
        panel.grid = element_blank(),
        panel.spacing = unit(0.21, "lines"),
        axis.line=element_line(size=0.5, color="black"),
        axis.text = element_text(color="black"),
        axis.title = element_text(color="black", size=rel(1.25), face="bold"),
        strip.text.y=element_text(face="italic"),
        legend.key=element_blank())

png(width=8, height=9, units="in", res=600, filename= file.path(path.figures, 'Fig4_LatTrend.png'))
lat.trend
dev.off()

png(width=8, height=9, units="in", res=600, filename= file.path(figs.google, 'Fig4_LatTrend.png'))
lat.trend
dev.off()

# ------------------------


# ------------------------

# 
# # -----------------------------------
# # Mixed Effects models needed for proper stat. sig assessment
# # -----------------------------------
# library(nlme)
# 
# # -----------------
# # Bud Burst
# # -----------------
# bud.arb.lme <- lme(diff ~ latitude*species - latitude - 1, random=list(site_id=~1, individual_id=~1), data=ARB.comb.burst[,], na.action=na.omit)
# bud.arb.t <- round(summary(bud.arb.lme)$tTable, 3)[grep("latitude:", row.names(summary(bud.arb.lme)$tTable)),]
# 
# bud.comb.lme <- lme(diff ~ latitude*species - latitude - 1, random=list(site_id=~1, individual_id=~1), data=COMB.comb.burst[,], na.action=na.omit)
# bud.comb.t <- round(summary(bud.comb.lme)$tTable, 3)[grep("latitude:", row.names(summary(bud.comb.lme)$tTable)),]
# 
# bud.lat.lme <- lme(diff ~ latitude*species - latitude - 1, random=list(site_id=~1, individual_id=~1), data=RevLat.comb.burst[,], na.action=na.omit)
# bud.lat.t <- round(summary(bud.lat.lme)$tTable, 3)[grep("latitude:", row.names(summary(bud.lat.lme)$tTable)),]
# 
# bud.gt.lme <- lme(diff ~ latitude*species - latitude - 1, random=list(site_id=~1, individual_id=~1), data=RevGT.comb.burst[,], na.action=na.omit)
# bud.gt.t <- round(summary(bud.gt.lme)$tTable, 3)[grep("latitude:", row.names(summary(bud.gt.lme)$tTable)),]
# # -----------------
# 
# # -----------------
# # Leaf Out
# # -----------------
# leaf.arb.lme <- lme(diff ~ latitude*species - latitude - 1, random=list(site_id=~1, individual_id=~1), data=ARB.comb.leaf[,], na.action=na.omit)
# leaf.arb.t <- round(summary(leaf.arb.lme)$tTable, 3)[grep("latitude:", row.names(summary(leaf.arb.lme)$tTable)),]
# 
# leaf.comb.lme <- lme(diff ~ latitude*species - latitude - 1, random=list(site_id=~1, individual_id=~1), data=COMB.comb.burst[,], na.action=na.omit)
# leaf.comb.t <- round(summary(leaf.comb.lme)$tTable, 3)[grep("latitude:", row.names(summary(leaf.comb.lme)$tTable)),]
# 
# leaf.lat.lme <- lme(diff ~ latitude*species - latitude - 1, random=list(site_id=~1, individual_id=~1), data=RevLat.comb.leaf[,], na.action=na.omit)
# leaf.lat.t <- round(summary(leaf.lat.lme)$tTable, 3)[grep("latitude:", row.names(summary(leaf.lat.lme)$tTable)),]
# 
# leaf.gt.lme <- lme(diff ~ latitude*species - latitude - 1, random=list(site_id=~1, individual_id=~1), data=RevGT.comb.leaf[,], na.action=na.omit)
# leaf.gt.t <- round(summary(leaf.gt.lme)$tTable, 3)[grep("latitude:", row.names(summary(leaf.gt.lme)$tTable)),]
# # -----------------
# 
# # -----------------
# #Selecting matching rows so we can combine dfs into one
# 
# ARB.sel.bud <- ARB.comb.burst %>% select(latitude, species, diff, spp.type) %>% mutate(model="ARB_GDD")
# COMB.sel.bud <- COMB.comb.burst %>% select(latitude, species, diff, spp.type) %>% mutate(model="COMB_GDD")
# RevLat.sel.bud <- RevLat.comb.burst %>% select(latitude, species, diff, spp.type) %>% mutate(model="Lat")
# RevGT.sel.bud <- RevGT.comb.burst %>% select(latitude, species, diff, spp.type) %>% mutate(model="WT")
# 
# 
# ARB.sel.leaf <- ARB.comb.leaf %>% select(latitude, species, diff, spp.type) %>% mutate(model="ARB_GDD")
# COMB.sel.leaf <- COMB.comb.leaf %>% select(latitude, species, diff, spp.type) %>% mutate(model="COMB_GDD")
# RevLat.sel.leaf <- RevLat.comb.leaf %>% select(latitude, species, diff, spp.type) %>% mutate(model="Lat")
# RevGT.sel.leaf <- RevGT.comb.leaf %>% select(latitude, species, diff, spp.type) %>% mutate(model="WT")
# 
# 
# #Combining into one df
# bud.sel <- rbind(ARB.sel.bud, COMB.sel.bud, RevLat.sel.bud, RevGT.sel.bud)
# leaf.sel <- rbind(ARB.sel.leaf, COMB.sel.leaf, RevLat.sel.leaf, RevGT.sel.leaf)
# 
# 
# # Doing a quick slope calculation for each species to see if the slop is significant
# # NOTE: this isn't as robust as what's happening in the analysis script, so we shoudl check to make sure this is roughly consistent with those results
# bud.sel$trend.type <- bud.sel$spp.type
# leaf.sel$trend.type <- leaf.sel$spp.type
# for(SPP in unique(bud.sel$species)){
#   
#   # ARB_GDD
#   # bud.arb.t
#   if(bud.arb.t[grep(SPP, row.names(bud.arb.t)),5]>=0.05) bud.sel$trend.type[bud.sel$species==SPP & bud.sel$model=="ARB_GDD"] <- "N.S."
#   if(leaf.arb.t[grep(SPP, row.names(leaf.arb.t)),5]>=0.05) leaf.sel$trend.type[leaf.sel$species==SPP & leaf.sel$model=="ARB_GDD"] <- "N.S."
#   
#   # ARB_GDD
#   # bud.comb.t
#   if(bud.comb.t[grep(SPP, row.names(bud.comb.t)),5]>=0.05) bud.sel$trend.type[bud.sel$species==SPP & bud.sel$model=="COMB_GDD"] <- "N.S."
#   if(leaf.comb.t[grep(SPP, row.names(leaf.comb.t)),5]>=0.05) leaf.sel$trend.type[leaf.sel$species==SPP & leaf.sel$model=="COMB_GDD"] <- "N.S."
#   
#   # Lat
#   # bud.lat.t
#   if(bud.lat.t[grep(SPP, row.names(bud.lat.t)),5]>=0.05) bud.sel$trend.type[bud.sel$species==SPP & bud.sel$model=="Lat"] <- "N.S."
#   if(leaf.lat.t[grep(SPP, row.names(leaf.lat.t)),5]>=0.05) leaf.sel$trend.type[leaf.sel$species==SPP & leaf.sel$model=="Lat"] <- "N.S."
#   
#   # WT
#   # bud.gt.t
#   if(bud.gt.t[grep(SPP, row.names(bud.gt.t)),5]>=0.05) bud.sel$trend.type[bud.sel$species==SPP & bud.sel$model=="WT"] <- "N.S."
#   if(leaf.gt.t[grep(SPP, row.names(leaf.gt.t)),5]>=0.05) leaf.sel$trend.type[leaf.sel$species==SPP & leaf.sel$model=="WT"] <- "N.S."
#   
# }
# summary(as.factor(bud.sel$trend.type))
# summary(as.factor(leaf.sel$trend.type))
# 
# 
# #Ordering x-axis
# bud.sel$model <- factor(bud.sel$model, levels = c("ARB_GDD", "COMB_GDD", "Lat", "WT" ))
# leaf.sel$model <- factor(leaf.sel$model, levels = c("ARB_GDD", "COMB_GDD", "Lat", "WT"))
# bud.sel$trend.type <- factor(bud.sel$trend.type, levels = c("calibration", "validation", "N.S." ))
# leaf.sel$trend.type <- factor(leaf.sel$trend.type, levels = c("calibration", "validation", "N.S."))
# 
# #Fig. 2 v2 BUD
# plots.bud.4 <- ggplot(bud.sel, aes(x = latitude, y = diff, color = spp.type, group=species))+
#   facet_wrap(~model, dir = "v")+
#   geom_jitter(alpha=0.25, size=0.5, aes(shape=spp.type)) +
#   geom_smooth(method='lm', se = TRUE, alpha=0.25, size=0.5, aes(fill=spp.type, color=spp.type))+
#   geom_vline(linetype="dashed", xintercept=41.8)+
#   theme_cowplot(12) +
#   theme(text=element_text(size=16), 
#         legend.position="bottom", 
#         legend.justification = "center",
#         legend.title = element_text(size=12),
#         legend.text=element_text(size=12)) + #remove legend.position for horizontal version  
#   scale_color_manual(name="Species", values=c("#56B4E9", "#E69F00")) +
#   scale_fill_manual(name="Species", values=c("#56B4E9", "#E69F00")) +
#   # scale_shape_manual(name="Species") +
#   xlab("Latitude")+
#   ylab("Residual error") + guides(shape=F)
# 
# plots.bud.4alt <- ggplot(bud.sel, aes(x = latitude, y = diff, color = trend.type, group=species))+
#   facet_wrap(~model, dir = "v")+
#   geom_jitter(alpha=0.25, size=0.5, aes(shape=spp.type)) +
#   geom_smooth(method='lm', se = TRUE, alpha=0.25, size=0.5, aes(fill=trend.type, color=trend.type))+
#   geom_vline(linetype="dashed", xintercept=41.8)+
#   theme_cowplot(12) +
#   theme(text=element_text(size=16), 
#         legend.position="bottom", 
#         legend.justification = "center",
#         legend.title = element_text(size=12),
#         legend.text=element_text(size=12)) + #remove legend.position for horizontal version
#   scale_color_manual(name="Species", values=c("#56B4E9", "#E69F00", "gray50")) +
#   scale_fill_manual(name="Species", values=c("#56B4E9", "#E69F00", "gray50")) +
#   # scale_shape_manual(name="Species") +
#   xlab("Latitude")+
#   ylab("Residual error") + guides(shape=F)
# 
# png(height = 6, width = 4, units="in", res=600, filename= file.path(path.figures, paste0('Model_Fig_4', '.png')))
# plots.bud.4
# dev.off()
# 
# png(height = 6, width = 4, units="in", res=600, filename= file.path(path.figures, paste0('Model_Fig_4-Alt', '.png')))
# plots.bud.4alt
# dev.off()
# 
# #Fig. 3 v2 LEAF
# 
# plots.leaf.4 <- ggplot(leaf.sel, aes(x = latitude, y = diff, color = spp.type, group=species))+
#   facet_wrap(~model, dir = "v")+
#   geom_jitter(alpha=0.25, size=0.5, aes(shape=spp.type)) +
#   geom_smooth(method='lm', se = TRUE, alpha=0.25, size=0.5, aes(fill=spp.type, color=spp.type))+
#   geom_vline(linetype="dashed", xintercept=41.8)+
#   theme_cowplot(12) +
#   theme(text=element_text(size=16), legend.position="bottom", legend.justification = "center") + #remove legend.position for horizontal version
#   scale_color_manual(name="Species", values=c("#0072B2", "#D55E00")) +
#   scale_fill_manual(name="Species", values=c("#0072B2", "#D55E00")) +
#   xlab("Latitude")+
#   ylab("Residual error") + guides(shape=F)
# 
# plots.leaf.4alt <- ggplot(leaf.sel, aes(x = latitude, y = diff, color = trend.type, group=species))+
#   facet_wrap(~model, dir = "v")+
#   geom_jitter(alpha=0.25, size=0.5, aes(shape=spp.type)) +
#   geom_smooth(method='lm', se = TRUE, alpha=0.25, size=0.5, aes(fill=trend.type, color=trend.type))+
#   geom_vline(linetype="dashed", xintercept=41.8)+
#   theme_cowplot(12) +
#   theme(text=element_text(size=16), 
#         legend.position="bottom", 
#         legend.justification = "center",
#         legend.title = element_text(size=12),
#         legend.text=element_text(size=12)) + #remove legend.position for horizontal version
#   scale_color_manual(name="Species", values=c("#0072B2", "#D55E00", "gray50")) +
#   scale_fill_manual(name="Species", values=c("#0072B2", "#D55E00", "gray50"))+
#   # scale_shape_manual(name="Species") +
#   xlab("Latitude")+
#   ylab("Residual error") + guides(shape=F)
# 
# png(height = 6, width = 4, units="in", res=600, filename= file.path(path.figures, paste0('Model_Fig_5', '.png')))
# plots.leaf.4
# dev.off()
# 
# png(height = 6, width = 4, units="in", res=600, filename= file.path(path.figures, paste0('Model_Fig_5-Alt', '.png')))
# plots.leaf.4alt
# dev.off()

#--------------------------------------------------------------------------------------------------#

