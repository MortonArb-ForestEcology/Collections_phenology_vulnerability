#----------------------------------------------------------------------------------------------------------------------------------#
# Script by: Lucien Fitzpatrick
# Project: Collection phenology vulnerability
# Purpose: This script is used to validate our GTmean model
# Inputs: Null GDD Model output from script 8
#         First_Budburst_Prediction_Evaluation_all.csv
#         RevLat_Budburst_Prediction_Evaluation_all.csv
#         RevGT_Budburst_Prediction_Evaluation_all.csv
#         First_Leaf_Prediction_Evaluation_all.csv
#         RevLat_Leaf_Prediction_Evaluation_all.csv
#         RevGT_Leaf_Prediction_Evaluation_all.csv
# Outputs: Four major figures for our paper
# Notes: 
#-----------------------------------------------------------------------------------------------------------------------------------#
library(ggplot2)
library(cowplot)
library(Rmisc)
library(dplyr)
library(tidyverse)
path.data <- "../data_processed"
path.figures <- "../figures"

if(!dir.exists(path.figures)) dir.create(path.figures, recursive=T)

#------------------#
# ~~~ FIGURE 1 ~~~ #
#------------------#

#Using inputs only for Fig 1.

oaks.bud <- read.csv(file.path(path.data, 'Oak_collection_budburst.csv'))
oaks.leaf <- read.csv(file.path(path.data, 'Oak_collection_leaf.csv'))

#Selecting (if one chooses) only calibration and validation species

#oaks.bud <- oaks.bud[oaks.bud$Species %in% c("Quercus ilicifolia", "Quercus imbricaria", "Quercus marilandica", "Quercus stellata", "Quercus shumardii", "Quercus alba", "Quercus gambelii", "Quercus macrocarpa", "Quercus velutina", "Quercus rubra", "Quercus montana", "Quercus palustris"),]
#oaks.leaf <- oaks.leaf[oaks.leaf$Species %in% c("Quercus ilicifolia", "Quercus imbricaria", "Quercus marilandica", "Quercus stellata", "Quercus shumardii", "Quercus alba", "Quercus gambelii", "Quercus macrocarpa", "Quercus velutina", "Quercus rubra", "Quercus montana", "Quercus palustris"),]

#Separating genus and species

oaks.bud <- tidyr::separate(oaks.bud, col = "Species", into=c("Genus", "Species"))

oaks.leaf <- tidyr::separate(oaks.leaf, col = "Species", into=c("Genus", "Species"))

#Assigning NPN status to species

not.npn <- c('lyrata', 'georgiana', 'pagoda', 'prinoides', 'coccinea', 'ellipsoidalis', 'michauxii', 'meuhlenbergii', 'bicolor')
oaks.bud$NPN <- ifelse(oaks.bud$Species %in% not.npn, "No NPN data", "NPN")
oaks.leaf$NPN <- ifelse(oaks.leaf$Species %in% not.npn, "No NPN data", "NPN")

bud.1 <- ggplot(data=oaks.bud, aes(x= Species, y=GDD5.cum, fill=NPN))+
  geom_violin() +
  #geom_jitter(size=0.5) +
  #geom_boxplot()+
  theme_cowplot(12)+
  theme(text=element_text(size=18), axis.text.x = element_text(size = 11, angle=-20, hjust=0)) +
  scale_fill_manual(values=c("#A3319F", "#DF488D")) +
  #ylim(0, 500) +
  xlab("Species")+
  ylab("GDD5.cum (days)")

leaf.1 <- ggplot(data=oaks.leaf, aes(x= Species, y=GDD5.cum, fill=NPN))+
  geom_violin() +
  #geom_boxplot()+
  theme_cowplot(12)+
  theme(text=element_text(size=18), axis.text.x = element_text(size = 11, angle=-20, hjust=0)) +
  scale_fill_manual(values=c("#FA7876", "#F3B584")) +
  #ylim(0, 500) +
  xlab("Species")+
  ylab("GDD5.cum (days)")

png(width = 1000, filename= file.path(path.figures, paste0('Figure 1', '.png')))
plot_grid(bud.1, leaf.1, labels=c('A', 'B'), align = "v", nrow=2, label_size = 16)
dev.off()

#----------------------------#

#Using inputs AND outputs for Fig. 1

#Read in all the species outputs into one dataframe
bud.files <- list.files(path = "../data_processed/model_output/", pattern = "TT_model_budburst.csv", full.names = T)
bud.stats <- as.data.frame(sapply(bud.files, read.csv, simplify=FALSE) %>% 
                             bind_rows(.id = "id"))

bud.stats <- bud.stats[,c("THRESH", "aPrec", "sd", "species")]

#Seperating columns to help match with npn data
bud.stats <- tidyr::separate(bud.stats, col = "species", into=c("genus", "species"))

#Read in all the species outputs into one dataframe
leaf.files <- list.files(path = "../data_processed/model_output/", pattern = "TT_model_leaf.csv", full.names = T)
leaf.stats <- as.data.frame(sapply(leaf.files, read.csv, simplify=FALSE) %>% 
                              bind_rows(.id = "id"))

leaf.stats <- leaf.stats[,c("THRESH", "aPrec", "sd", "species")]

#Seperating columns to help match with npn data
leaf.stats <- tidyr::separate(leaf.stats, col = "species", into=c("genus", "species"))

#Assigning NPN status to each species

bud.stats$NPN <- ifelse(bud.stats$species %in% not.npn, "No NPN data", "NPN")
leaf.stats$NPN <- ifelse(leaf.stats$species %in% not.npn, "No NPN data", "NPN")

#Removing data outside 95% CI from outputs

bud.stats <- subset(bud.stats, THRESH >= quantile(THRESH, 0.025) & THRESH <= quantile(THRESH, 0.975))

leaf.stats <- subset(leaf.stats, THRESH >= quantile(THRESH, 0.025) & THRESH <= quantile(THRESH, 0.975))

#Removing coccinea from oaks.leaf

oaks.leaf <- oaks.leaf %>% subset(!(Species == "coccinea"))

#Putting the x-axis in decreasing order of species latitude centroid

#list of species (rubra has 3 because of file size)
species <- c("alba", "bicolor", "ellipsoidalis", "gambellii", "georgiana", "ilicifolia", "imbricaria", "lyrata", "macrocarpa",
             "marilandica", "michauxii", "montana", "muehlenbergii", "pagoda", "palustris", "prinoides",
             "rubra_1", "rubra_2", "rubra_3", "shumardii", "stellata", "velutina")

#downloaded all species and putting them in one data frame
full <- data.frame()
for(SP in species){
  tmp <- read.csv(file.path(path.hub, paste0("Quercus_", SP, ".csv")))
  full <- rbind(full, tmp)
}

#This should produce the median latitude for each species so you can use this to order fig 1
med.lat <- aggregate(decimalLatitude~species_name_acc, data=full,
                     FUN=median)

oaks.bud$Species <- factor(oaks.bud$Species, levels = c("lyrata", "pagoda", "michauxii", "georgiana", "shumardii", "stellata", "marilandica", "montana", "gambelii", "alba", "velutina", "muehlenbergii", "imbricaria", "palustris", "prinoides", "bicolor", "ilicifolia", "macrocarpa", "ellipsoidalis", "rubra"))
oaks.leaf$Species <- factor(oaks.leaf$Species, levels = c("lyrata", "pagoda", "michauxii", "georgiana", "shumardii", "stellata", "marilandica", "montana", "gambelii", "alba", "velutina", "muehlenbergii", "imbricaria", "palustris", "prinoides", "bicolor", "ilicifolia", "macrocarpa", "ellipsoidalis", "rubra"))

bud.stats$species <- factor(bud.stats$species, levels = c("lyrata", "pagoda", "michauxii", "georgiana", "shumardii", "stellata", "marilandica", "montana", "gambelii", "alba", "velutina", "muehlenbergii", "imbricaria", "palustris", "prinoides", "bicolor", "ilicifolia", "macrocarpa", "ellipsoidalis", "rubra"))
leaf.stats$species <- factor(leaf.stats$species, levels = c("lyrata", "pagoda", "michauxii", "georgiana", "shumardii", "stellata", "marilandica", "montana", "gambelii", "alba", "velutina", "muehlenbergii", "imbricaria", "palustris", "prinoides", "bicolor", "ilicifolia", "macrocarpa", "ellipsoidalis", "rubra"))

bud.1a <- ggplot(data=bud.stats, aes(x=species, y=THRESH, fill=NPN))+
  geom_violin(alpha=0.5, scale="width") +
  geom_boxplot(width=0.075, lwd=0.3, color="light grey", alpha=0.75, outlier.shape=NA)+
  geom_jitter(data=oaks.bud, aes(x=Species, y=GDD5.cum, color=NPN), size=0.5, alpha=0.5)+
  theme_cowplot(12)+
  theme(text=element_text(size=18), axis.text.x = element_text(size = 11, angle=-20, hjust=0)) +
  scale_fill_manual(values=c("#CA3C97", "#4B2991")) +
  scale_color_manual(values=c("#CA3C97", "#4B2991")) +
  xlab("Species")+
  ylab("GDD5")

leaf.1a <- ggplot(data=leaf.stats, aes(x=species, y=THRESH, fill=NPN))+
  geom_violin(alpha=0.5, scale="width") +
  geom_boxplot(width=0.075, lwd=0.3, color="light grey", alpha=0.75, outlier.shape=NA)+
  geom_jitter(data=oaks.leaf, aes(x=Species, y=GDD5.cum, color=NPN), size=0.5, alpha=0.5)+
  theme_cowplot(12)+
  theme(text=element_text(size=18), axis.text.x = element_text(size = 11, angle=-20, hjust=0)) +
  scale_fill_manual(values=c("#CA3C97", "#4B2991")) +
  scale_color_manual(values=c("#CA3C97", "#4B2991")) +
  xlab("Species")+
  ylab("GDD5")

png(width=9, height=5, units="in", res=600, filename= file.path(path.figures, paste0('Figure 1b', '.png')))
plot_grid(bud.1a, leaf.1a, labels=c('A', 'B'), align = "v", nrow=2, label_size = 18)
dev.off()

#-------------------------------------------------------------------------------------------------#

first.comb.burst <- read.csv(file.path(path.data, paste0('First_Budburst_Prediction_Evaluation_all.csv')))
RevLat.comb.burst <- read.csv(file.path(path.data, paste0('RevLat_Budburst_Prediction_Evaluation_all.csv')))
RevGT.comb.burst <- read.csv(file.path(path.data, paste0('RevGT_Budburst_Prediction_Evaluation_all.csv')))


#Leafout model dfs
first.comb.leaf <- read.csv(file.path(path.data, paste0('First_Leaf_Prediction_Evaluation_all.csv')))
RevLat.comb.leaf <- read.csv(file.path(path.data, paste0('RevLat_Leaf_Prediction_Evaluation_all.csv')))
RevGT.comb.leaf <- read.csv(file.path(path.data, paste0('RevGT_Leaf_Prediction_Evaluation_all.csv')))


#Selecting matching rows so we can combine dfs into one

first.sel.bud <- first.comb.burst %>% select(latitude, species, diff, type) %>% mutate(model="GDD")
RevLat.sel.bud <- RevLat.comb.burst %>% select(latitude, species, diff, type) %>% mutate(model="Lat")
RevGT.sel.bud <- RevGT.comb.burst %>% select(latitude, species, diff, type) %>% mutate(model="GT")


first.sel.leaf <- first.comb.leaf %>% select(latitude, species, diff, type) %>% mutate(model="GDD")
RevLat.sel.leaf <- RevLat.comb.leaf %>% select(latitude, species, diff, type) %>% mutate(model="Lat")
RevGT.sel.leaf <- RevGT.comb.leaf %>% select(latitude, species, diff, type) %>% mutate(model="GT")


#Combining into one df

bud.sel <- rbind(first.sel.bud, RevLat.sel.bud, RevGT.sel.bud)

leaf.sel <- rbind(first.sel.leaf, RevLat.sel.leaf, RevGT.sel.leaf)


#Ordering x-axis

bud.sel$model <- factor(bud.sel$model, levels = c("GDD", "Lat", "GT" ))
leaf.sel$model <- factor(leaf.sel$model, levels = c("GDD", "Lat", "GT"))

#Fig. 2 v2 BUD

plots.bud.4 <- ggplot(bud.sel, aes(x = latitude, y = diff, color = type, group=species))+
  facet_wrap(~model)+
  geom_smooth(method='lm', se = TRUE, alpha=0.25, size=0.5, aes(fill=type, color=type))+
  geom_vline(linetype="dashed", xintercept=41.8)+
  theme_cowplot(12) +
  theme(text=element_text(size=18), legend.position="bottom", legend.justification = "center") + #remove legend.position for horizontal version
  geom_jitter(alpha=0.25, size=0.5, aes(shape=type)) +
  scale_color_manual(values=c("#453781", "#3CBB75")) +
  scale_fill_manual(values=c("#453781", "#3CBB75")) +
  xlab("Latitude")+
  ylab("Resid.")

plots.bud.1 <- ggplot(first.sel.bud, aes(x = latitude, y = diff, color = type, group=species))+
  facet_wrap(~model)+
  geom_smooth(method='lm', se = TRUE, alpha=0.25, size=0.5, aes(fill=type, color=type))+
  geom_vline(linetype="dashed", xintercept=41.8)+
  theme_cowplot(12) +
  theme(text=element_text(size=18), legend.position = "none", aspect.ratio=0.655) +  # add aspect.ratio=0.69 for horizontal version
  geom_jitter(alpha=0.25, size=0.5, aes(shape=type)) +
  scale_color_manual(values=c("#453781", "#3CBB75")) +
  scale_fill_manual(values=c("#453781", "#3CBB75")) +
  xlab("Latitude")+
  ylab("Resid.")

png(height = 6, width = 4, units="in", res=600, filename= file.path(path.figures, paste0('Model_Fig_2', '.png')))
plot_grid(plots.bud.1, plots.bud.4, rel_heights=c(1, 1.93), axis="t", nrow=2, align="v")
dev.off()

#Fig. 2 v2 LEAF

plots.leaf.4 <- ggplot(leaf.sel, aes(x = latitude, y = diff, color = type, group=species))+
  facet_wrap(~model)+
  geom_smooth(method='lm', se = TRUE, alpha=0.25, size=0.5, aes(fill=type, color=type))+
  geom_vline(linetype="dashed", xintercept=41.8)+
  theme_cowplot(12) +
  theme(text=element_text(size=18), legend.position="bottom", legend.justification = "center") + #remove legend.position for horizontal version
  geom_jitter(alpha=0.25, size=0.5, aes(shape=type)) +
  scale_color_manual(values=c("#287D8E", "#FDE725")) +
  scale_fill_manual(values=c("#287D8E", "#FDE725")) +
  xlab("Latitude")+
  ylab("Resid.")

plots.leaf.1 <- ggplot(first.sel.leaf, aes(x = latitude, y = diff, color = type, group=species))+
  facet_wrap(~model)+
  geom_smooth(method='lm', se = TRUE, alpha=0.25, size=0.5, aes(fill=type, color=type))+
  geom_vline(linetype="dashed", xintercept=41.8)+
  theme_cowplot(12) +
  theme(text=element_text(size=18), legend.position = "none", aspect.ratio=0.655) +  # add aspect.ratio=0.69 for horizontal version
  geom_jitter(alpha=0.25, size=0.5, aes(shape=type)) +
  scale_color_manual(values=c("#287D8E", "#FDE725")) +
  scale_fill_manual(values=c("#287D8E", "#FDE725")) +
  xlab("Latitude")+
  ylab("Resid.")

png(height = 6, width = 4, units="in", res=600, filename= file.path(path.figures, paste0('Model_Fig_3', '.png')))
plot_grid(plots.leaf.1, plots.leaf.4, rel_heights=c(1, 1.93), axis="t", nrow=2, align="v")
dev.off()

#--------------------------------------------------------------------------------------------------#

#------------------#
# ~~~ FIGURE 3 ~~~ #
#------------------#

#Wrangling Budburst data

#Calculating RMSE by species and adding an RMSE column to each model's dataframe

rmse.first.bud <- first.comb.burst %>% group_by(species) %>% mutate_each(funs(mean)) %>% distinct %>% mutate(RMSE = sqrt(expdiff))
rmse.RevLat.bud <- RevLat.comb.burst %>% group_by(species) %>% mutate_each(funs(mean)) %>% distinct %>% mutate(RMSE = sqrt(expdiff))
rmse.RevGT.bud <- RevGT.comb.burst %>% group_by(species) %>% mutate_each(funs(mean)) %>% distinct %>% mutate(RMSE = sqrt(expdiff))


#Selecting only the columns which we need so that columns will match when combining df's; adding model name columns
#Note: make sure to update model names in 'model' column
#Note; I'm pretty sure this averages the latitudes for each species as well

rmse.first.bud <- rmse.first.bud %>% select(site_id, latitude, longitude, species, diff, error, RMSE, mid, Yday, type) %>% mutate(model="GDD")
rmse.RevLat.bud <- rmse.RevLat.bud %>% select(site_id, latitude, longitude, species, diff, error, RMSE, mid, Yday, type) %>% mutate(model="Lat")
rmse.RevGT.bud <- rmse.RevGT.bud %>% select(site_id, latitude, longitude, species, diff, error, RMSE, mid, Yday, type) %>% mutate(model="GT")

#Luciens version of rmse delta
#Matching for RMSE diff
rmse.first.bud$RMSE.org <- 0 
rmse.RevLat.bud$RMSE.org <- rmse.first.bud$RMSE[match(rmse.RevLat.bud$species, rmse.first.bud$species)]
rmse.RevGT.bud$RMSE.org <- rmse.first.bud$RMSE[match(rmse.RevGT.bud$species, rmse.first.bud$species)]


rmse.RevLat.bud$RMSE.diff <- rmse.RevLat.bud$RMSE-rmse.RevLat.bud$RMSE.org
rmse.RevGT.bud$RMSE.diff <- rmse.RevGT.bud$RMSE-rmse.RevGT.bud$RMSE.org



#Re-assigning 'type' to each species

spp.valid <- c("ilicifolia", "imbricaria", "marilandica", "stellata", "shumardii")

rmse.first.bud$type <- ifelse(rmse.first.bud$species %in% spp.valid, "Validation", "Calibration")

rmse.RevLat.bud$type <- ifelse(rmse.RevLat.bud$species %in% spp.valid, "Validation", "Calibration")

rmse.RevGT.bud$type <- ifelse(rmse.RevGT.bud$species %in% spp.valid, "Validation", "Calibration")



#Combining model df's into one df for comparison (excluding 'first')

bud.model <- rbind(rmse.first.bud, rmse.RevLat.bud, rmse.RevGT.bud)

#Rearranging the x-axis for the following figures

bud.model$model <- factor(bud.model$model, levels = c("GDD", "Lat", "GT"))

#Doing the same data wrangling for Leafout data

#Calculating RMSE by species and adding an RMSE column to each model's dataframe

rmse.first.leaf <- first.comb.leaf %>% group_by(species) %>% mutate_each(funs(mean)) %>% distinct %>% mutate(RMSE = sqrt(expdiff))
rmse.RevLat.leaf <- RevLat.comb.leaf %>% group_by(species) %>% mutate_each(funs(mean)) %>% distinct %>% mutate(RMSE = sqrt(expdiff))
rmse.RevGT.leaf <- RevGT.comb.leaf %>% group_by(species) %>% mutate_each(funs(mean)) %>% distinct %>% mutate(RMSE = sqrt(expdiff))




#Selecting only the columns which we need so that columns will match when combining df's; adding model name columns
#Note: make sure to update model names in 'model' column
#Note; I'm pretty sure this averages the latitudes for each species as well

rmse.first.leaf <- rmse.first.leaf %>% select(site_id, latitude, longitude, species, diff, error, RMSE, mid, Yday, type) %>% mutate(model="GDD")
rmse.RevLat.leaf <- rmse.RevLat.leaf %>% select(site_id, latitude, longitude, species, diff, error, RMSE, mid, Yday, type) %>% mutate(model="Lat")
rmse.RevGT.leaf <- rmse.RevGT.leaf %>% select(site_id, latitude, longitude, species, diff, error, RMSE, mid, Yday, type) %>% mutate(model="GT")

#Matching for RMSE diff
rmse.first.leaf$RMSE.org <- 0 
rmse.RevLat.leaf$RMSE.org <- rmse.first.leaf$RMSE[match(rmse.RevLat.leaf$species, rmse.first.leaf$species)]
rmse.RevGT.leaf$RMSE.org <- rmse.first.leaf$RMSE[match(rmse.RevGT.leaf$species, rmse.first.leaf$species)]

rmse.RevLat.leaf$RMSE.diff <- rmse.RevLat.leaf$RMSE-rmse.RevLat.leaf$RMSE.org
rmse.RevGT.leaf$RMSE.diff <- rmse.RevGT.leaf$RMSE-rmse.RevGT.leaf$RMSE.org




#Re-assigning 'type' to each species

spp.valid <- c("ilicifolia", "imbricaria", "marilandica", "stellata", "shumardii")

rmse.first.leaf$type <- ifelse(rmse.first.leaf$species %in% spp.valid, "Validation", "Calibration")

rmse.RevLat.leaf$type <- ifelse(rmse.RevLat.leaf$species %in% spp.valid, "Validation", "Calibration")

rmse.RevGT.leaf$type <- ifelse(rmse.RevGT.leaf$species %in% spp.valid, "Validation", "Calibration")


#Combining model df's into one df for comparison (excluding 'first')

leaf.model <- rbind(rmse.first.leaf, rmse.RevLat.leaf, rmse.RevGT.leaf) 

#Rearranging what will be on the x-axis

leaf.model$model <- factor(leaf.model$model, levels = c("GDD", "Lat", "GT"))

#Figure Generation

bud.3 <- ggplot(data=bud.model, aes(x=type, y=RMSE, fill=model))+
  geom_boxplot(aes(fill=model)) +
  theme_cowplot(12) +
  theme(text=element_text(size=18)) +
  ylim(0, 45) +
  scale_fill_manual(values=c("#E69F00", "#56B4E9", "#009E73")) +
  xlab("Datatype")+
  ylab("RMSE (days)")

leaf.3 <- ggplot(data=leaf.model, aes(x= type, y=RMSE, fill=model))+
  geom_boxplot(aes(fill=model)) +
  theme_cowplot(12)+
  theme(text=element_text(size=18)) +
  scale_fill_manual(values=c("#E69F00", "#56B4E9", "#009E73")) +
  ylim(0, 30) +
  xlab("Datatype")+
  ylab("RMSE (days)")

png(width = 8, height=6, units="in", res=600, filename= file.path(path.figures, paste0('Rev_Figure 3', '.png')))
plot_grid(bud.3, leaf.3, labels=c('A', 'B'), rel_widths=c(1, 2, 1, 2), align = "v", nrow=2, label_size = 18)
dev.off()
