#----------------------------------------------------------------------------------------------------------------------------------#
# Script by: Lucien Fitzpatrick & Christy Rollinson
# Project: Collection phenology vulnerability
# Purpose: This script is used to validate our GTmean model
# Inputs: Null GDD Model output from script 8
#         First_Budburst_Prediction_Evaluation_all.csv
#         RevLat_Budburst_Prediction_Evaluation_all.csv
#         RevGT_Budburst_Prediction_Evaluation_all.csv
#         First_Leaf_Prediction_Evaluation_all.csv
#         RevLat_Leaf_Prediction_Evaluation_all.csv
#         RevGT_Leaf_Prediction_Evaluation_all.csv
# Outputs: Four major figures for our paper
# Notes: 
#-----------------------------------------------------------------------------------------------------------------------------------#
library(ggplot2)
library(cowplot)
library(Rmisc)
library(dplyr)
library(tidyverse)
library(rgdal)
library(nlme)

path.data <- "../data_processed"
path.figures <- "../figures"
paht.hub <- "../data"

path.google <- "/Volumes/GoogleDrive/My Drive/Manuscripts/CollectionsPhenologyVulnerability_CCE_2020/Submission 3 2021-08-27"
figs.google <- file.path(path.google, "figures/")

if(!dir.exists(path.figures)) dir.create(path.figures, recursive=T)

model.palette <- c("TMA"="#D55E00", "COMB"="#E69F00", "LAT"="#56B4E9", "WT"="#0072B2")
type.palette <- c("TMA"="#D55E00", "calibration"="#E69F00", "validation"="#009E73")
spp.calib <- c("alba", "macrocarpa", "palustris", "rubra")
spp.valid <- c("imbricaria", "montana", "velutina")

#Using inputs only for Fig 1.
oaks.bud <- read.csv("../data_processed/Full_Bud_Obs.csv")
oaks.bud$phenophase <- "Budburst"
oaks.bud <- oaks.bud[!oaks.bud$flag.3sig & oaks.bud$spp.type %in% c("calibration", "validation"),]
summary(as.factor(oaks.bud$spp.type))
summary(oaks.bud[oaks.bud$site_id=="Morton",])

oaks.leaf <- read.csv("../data_processed/Full_Leaf_Obs.csv")
oaks.leaf$phenophase <- "Leaf Out"
oaks.leaf <- oaks.leaf[!oaks.leaf$flag.3sig & oaks.leaf$spp.type %in% c("calibration", "validation"),]
summary(as.factor(oaks.leaf$spp.type))
summary(as.factor(oaks.leaf$obs.type))

# Getting a summary of the mean conditions for The Morton Arboretum
cond.arb <- aggregate(cbind(latitude, longitude, GTmean)~year, data=oaks.bud[oaks.bud$site_id=="Morton",], FUN=mean)
cond.arb <- colMeans(cond.arb)

obs.all <- rbind(oaks.bud[oaks.bud$species %in% c(spp.calib, spp.valid),],
                 oaks.leaf[oaks.leaf$species %in% c(spp.calib, spp.valid),])
obs.all$spp.type2 <- car::recode(obs.all$spp.type, "'calibration'='TMA + NPN'; 'validation'='TMA Only'")
obs.all$obs.type[obs.all$site_id=="Morton"] <- "TMA"
obs.all$obs.type <- factor(obs.all$obs.type, levels=c("TMA", "calibration", "validation"))


#------------------#
# ~~~ FIGURE 1 ~~~ #
# PURPOSE OF FIGURE: where our observations are compared to species range
# Update: color/shape code for calibration/validation observation
# Get ranges from Little
# Add NPN points
#------------------#
spp.code <- c("queralba", "quermacr", "querpalu", "querrubr", "querimbr", "querprin", "quervelu")

map.us <- ggplot2::map_data("state")

path.shp <- "../../USTreeAtlas/SHP/"
fshp <- dir(path.shp)

shp.spp <- data.frame()
for(SPP in spp.code){
  # i <- grep("queralba", fshp)
  sp.tmp <- readOGR(file.path(path.shp, SPP))
  fort.tmp <- fortify(sp.tmp)
  fort.tmp$hole <- as.character(fort.tmp$hole)
  fort.tmp$species <- SPP  
  
  shp.spp <- rbind(shp.spp, fort.tmp)
}
shp.spp$species <- car::recode(shp.spp$species, "'queralba'='alba'; 'querimbr'='imbricaria'; 'querprin'='montana'; 'quermacr'='macrocarpa'; 'querpalu'='palustris'; 'querrubr'='rubra'; 'quervelu'='velutina'")
shp.spp$spp.type2 <- ifelse(shp.spp$species %in% spp.calib, "TMA + NPN", "TMA Only")
summary(shp.spp)
# summary(fort.tmp)

# shp.spp$hole <- as.logical(shp.spp$hole)
ggplot(data=shp.spp[,]) +
  facet_wrap(~species) +
  coord_equal() +
  geom_polygon(data=shp.spp[shp.spp$hole=="FALSE",], aes(x=long, y=lat, group=group, fill=hole)) +
  geom_polygon(data=shp.spp[shp.spp$hole=="TRUE",], aes(x=long, y=lat, group=group, fill=hole)) +
  scale_fill_manual(values=c("FALSE"="green4", "TRUE"="yellow3")) +
  guides(fill="none")


obs.all$species <- factor(obs.all$species, levels=c(spp.calib, spp.valid))
shp.spp$species <- factor(shp.spp$species, levels=c(spp.calib, spp.valid))

obs.all$species2 <- factor(paste("Q.", obs.all$species),levels=paste("Q.",c(spp.calib, spp.valid)))
shp.spp$species2 <- factor(paste("Q.", shp.spp$species),levels=paste("Q.",c(spp.calib, spp.valid)))


obs.map <- ggplot(data=obs.all[,]) +
  facet_grid(species2~phenophase) +
  coord_equal() +
  geom_path(data=map.us, aes(x=long, y=lat, group=group), color="black", size=0.25) +
  geom_polygon(data=shp.spp[shp.spp$hole=="FALSE",], aes(x=long, y=lat, group=group, fill=hole), alpha=0.3) +
  geom_polygon(data=shp.spp[shp.spp$hole=="TRUE",], aes(x=long, y=lat, group=group, fill=hole)) +
  geom_point(data=obs.all[obs.all$obs.type=="validation",], aes(x=longitude, y=latitude, color=obs.type, shape=obs.type), size=2.5) +
  geom_point(data=obs.all[obs.all$obs.type=="calibration",], aes(x=longitude, y=latitude, color=obs.type, shape=obs.type, size=obs.type), size=2) +
  geom_point(aes(x=cond.arb["longitude"], y=cond.arb["latitude"], color="TMA", shape="TMA"), size=3) +
  scale_x_continuous(name="Longitude (degrees)", breaks=seq(-60, -140, by=-20)) +
  scale_y_continuous(name="Latitude (degrees)", breaks=seq(20, 60, by=10)) +
  scale_size_manual(name="Observation Type", values=c("TMA"=3, "calibration"=2, "validation"=2.5)) +
  scale_shape_manual(name="Observation Type", values=c("TMA"=15, "calibration"=20, "validation"=17)) +
  scale_color_manual(name="Observation Type", values=type.palette) +
  scale_fill_manual(values=c("FALSE"="black", "TRUE"="white")) +
  guides(fill="none") +
  theme(panel.background=element_rect(fill=NA, color="black"),
        panel.grid=element_blank(),
        axis.text=element_text(color="black"),
        axis.title=element_text(color="black", face="bold", size=rel(1.25)),
        strip.text.y = element_text(face="italic"),
        legend.position="top",
        legend.key = element_blank())


png(width=6, height=9, units="in", res=600, filename= file.path(path.figures, 'Fig1_ObservationLocations.png'))
obs.map
dev.off()

png(width=6, height=9, units="in", res=600, filename= file.path(figs.google, 'Fig1_ObservationLocations.png'))
obs.map
dev.off()


#-------------------------------------------------------------------------------------------------#
#----------------------#
# ~~~ FIGURE 2 ~~~ #
#----------------------#
spp.valid <- c("imbricaria", "montana", "velutina")
fmod <- dir("../data_processed/model_output/", "model")
# burst.df <- read.csv(file.path("../data_processed/model_output/TT_model_budburst.csv"))
# summary(burst.df)
gdd.thresh <- data.frame()
for(i in 1:length(fmod)){
  print(fmod[i])
  fmod.split <- stringr::str_split(fmod[i], "_")[[1]]
  pheno.now <- stringr::str_split(fmod.split[length(fmod.split)], "[.]")[[1]][1]
  
  mod.out <- read.csv(file.path("../data_processed/model_output", fmod[i]))
  summary(mod.out)
  
  # Read the Gelman stats & blank out any param that didn't converge
  splt.ind <- which(fmod.split=="model")
  gel.out <- read.csv(file.path("../data_processed/model_output/", paste(paste(fmod.split[1:(splt.ind-1)], collapse = "_"), pheno.now, "GelmanDiag.csv", sep="_")))
  dim(gel.out); dim(mod.out)
  param.bad <- which(gel.out$Point.est.>=1.05)
  
  if(length(param.bad)>0) mod.out[,param.bad] <- NA
  summary(mod.out)
  
  # If we're missing a threshold calculation, we'll need to add it
  if(!any(grepl("THRESH", names(mod.out)))){
    cols.spp <- grep("Sp.bias", names(mod.out))
    
    # Find which spatial covariate to use
    arb.loc <- ifelse(grepl("RevGT", fmod[i]), cond.arb["GTmean"], cond.arb["latitude"])
    
    # Add a threshold calculation column that adds the base thresh to the species adjustments
    # NOTE: For spatial covariates, we need to preidct the threshold at a PARTICULAR Location; 
    #       Since the Arboretum is our focal site, we should use the lat & GT for the Arboretum as our site
    mod.out[, gsub("Sp.bias", "THRESH", names(mod.out)[cols.spp])] <- mod.out[,cols.spp] + mod.out$bias.loc*arb.loc + mod.out$int.loc # Add consistent naming 
  } 
  
  mod.out1 <- mod.out[,grep("THRESH", names(mod.out))]
  colnames(mod.out1) <- unlist(lapply(strsplit(names(mod.out1), "[.]"), FUN=function(x)x[2]))
  
  mod.thresh <- reshape2::melt(mod.out1, variable.name = "Species")
  mod.thresh$model <- fmod.split[1]  
  mod.thresh$phenophase <- pheno.now
  
  gdd.thresh <- rbind(gdd.thresh, mod.thresh)
}
summary(gdd.thresh)

#Assigning species group
gdd.thresh$spp.group <- ifelse(gdd.thresh$Species %in% spp.valid, "TMA Only", "TMA + NPN")

# -----------------------
# Trimming the distributions to the 95% CI
# -----------------------
gdd.ci <- aggregate(value~Species+model+phenophase, data=gdd.thresh,
                    FUN=function(x) quantile(x,c(0.025, 0.5, 0.975)), na.action = na.omit)

gdd.ci$tail <- gdd.ci$value[,1]
gdd.ci$mid <- gdd.ci$value[,2]
gdd.ci$head <- gdd.ci$value[,3]

gdd.ci$range <- gdd.ci$head - gdd.ci$tail

thresh.clean <- data.frame()
for(SP in unique(gdd.thresh$Species)){
  for(MOD in unique(gdd.thresh$model)){
    for(PHENO in unique(gdd.thresh$phenophase)){
      # Subset the data
      temp <- gdd.thresh[gdd.thresh$Species==SP & gdd.thresh$model==MOD & gdd.thresh$phenophase==PHENO,]
      
      ci <- gdd.ci[gdd.ci$Species==SP & gdd.ci$model==MOD & gdd.ci$phenophase==PHENO,]
      temp <- temp[temp$value >= ci$tail & temp$value <= ci$head,]
      thresh.clean <- rbind(thresh.clean, temp)
    }
  }
}
summary(thresh.clean) 
# thresh.clean$spp.group <- ifelse(thresh.clean$Species %in% spp.valid, "Arb Only", "Arb + NPN")
# -----------------------

# thresh.clean$spp.group <- ifelse(thresh.clean$Species %in% spp.valid, "TMA Only", "TMA + NPN")

thresh.clean$model <- car::recode(thresh.clean$model, "'ARB'='TMA'; 'RevLat'='LAT'; 'RevGT'='WT'")
thresh.clean$model <- factor(thresh.clean$model, levels=c("TMA", "COMB", "LAT", "WT"))

# Doing some preliminary graphs before doing this cleaning step
gdd.bud <- ggplot(data=thresh.clean[thresh.clean$phenophase=="budburst",]) +
  facet_grid(.~spp.group, scales="free_x") +
  geom_violin(aes(x=paste("Q.", Species), y=value, fill=model), scale="width") +
  scale_y_continuous(name="GDD5 Threshold", expand=c(0,0), limits=c(0, max(thresh.clean$value))) +
  scale_x_discrete(name="Species") +
  scale_fill_manual(name="Model", values=model.palette) +
  # scale_fill_manual(name="Model", values=model.palette) +
  theme(panel.background = element_blank(),
        panel.grid = element_blank(),
        axis.line = element_line(color="black", size=0.2),
        axis.text.x = element_text(face="italic", size=rel(1.5), angle=-15, hjust=0),
        axis.text.y=element_text(size=rel(1.5)),
        axis.title = element_text(size=rel(1.75), face="bold"),
        strip.text = element_text(size=rel(1.75)),
        # legend.position=c(0.2, 0.8),
        legend.title=element_text(size=rel(1.5)),
        legend.text=element_text(size=rel(1.25)))

gdd.leaf <- ggplot(data=thresh.clean[thresh.clean$phenophase=="leaf",]) +
  facet_grid(.~spp.group, scales="free_x") +
  geom_violin(aes(x=paste("Q.", Species), y=value, fill=model), scale="width") +
  scale_y_continuous(name="GDD5 Threshold", expand=c(0,0), limits=c(0, max(thresh.clean$value))) +
  scale_x_discrete(name="Species") +
  scale_fill_manual(name="Model", values=model.palette) +
  # scale_fill_manual(name="Model", values=model.palette) +
  theme(panel.background = element_blank(),
        panel.grid = element_blank(),
        axis.line = element_line(color="black", size=0.2),
        axis.text.x = element_text(face="italic", size=rel(1.5), angle=-15, hjust=0),
        axis.text.y=element_text(size=rel(1.5)),
        axis.title = element_text(size=rel(1.75), face="bold"),
        strip.text = element_text(size=rel(1.75)),
        # legend.position=c(0.2, 0.8),
        legend.title=element_text(size=rel(1.5)),
        legend.text=element_text(size=rel(1.25)))

png(width=9, height=8, units="in", res=600, filename= file.path(path.figures, 'Fig2_GDD5thresh.png'))
plot_grid(gdd.bud, gdd.leaf, labels=c('A', 'B'), align = "v", nrow=2, label_size = 18)
dev.off()

png(width=9, height=8, units="in", res=600, filename= file.path(figs.google, 'Fig2_GDD5thresh.png'))
plot_grid(gdd.bud, gdd.leaf, labels=c('A', 'B'), align = "v", nrow=2, label_size = 18)
dev.off()

### -----------------------------
### Associated Results - Fig. 2
### -----------------------------
summary(gdd.ci)
gdd.ci$spp.group <- ifelse(gdd.ci$Species %in% spp.calib, "TMA + NPN", "TMA Only")
# Getting additional summaries on differences to do mean & SD
for(SPP in unique(gdd.ci$Species)){
  for(PHENO in unique(gdd.ci$phenophase)){
    row.now <- which(gdd.ci$Species==SPP & gdd.ci$phenophase==PHENO)
    row.ref <- which(gdd.ci$Species==SPP & gdd.ci$phenophase==PHENO & gdd.ci$model=="ARB")
    
    gdd.ci[row.now,"dMid"] <- gdd.ci[row.now,"mid"] - gdd.ci[row.ref,"mid"]
    gdd.ci[row.now,"dRange"] <- gdd.ci[row.now,"range"] - gdd.ci[row.ref,"range"]
    
  }
}
summary(gdd.ci)


# Statistical Comparisons to know what specific numbers to pull
# --------
# Budburst
# --------
bud.med.comp0 <- lme(mid ~ model*spp.group, random=list(Species=~1), data=gdd.ci[gdd.ci$phenophase=="budburst",])
anova(bud.med.comp0)

bud.med.comp1 <- lme(mid ~ model, random=list(Species=~1), data=gdd.ci[gdd.ci$phenophase=="budburst",])
anova(bud.med.comp1)
summary(bud.med.comp1)

bud.rng.comp0 <- lme(range ~ model*spp.group, random=list(Species=~1), data=gdd.ci[gdd.ci$phenophase=="budburst",])
anova(bud.rng.comp0)
summary(bud.rng.comp0)
# --------


# --------
# Leaf out
# --------
leaf.med.comp0 <- lme(mid ~ model*spp.group, random=list(Species=~1), data=gdd.ci[gdd.ci$phenophase=="leaf",])
anova(leaf.med.comp0)

leaf.med.comp1 <- lme(mid ~ model, random=list(Species=~1), data=gdd.ci[gdd.ci$phenophase=="leaf",])
anova(leaf.med.comp1)

leaf.med.comp1 <- lme(mid ~ model, random=list(Species=~1), data=gdd.ci[gdd.ci$phenophase=="leaf",])
anova(leaf.med.comp1)
summary(leaf.med.comp1)

leaf.rng.comp0 <- lme(range ~ model*spp.group, random=list(Species=~1), data=gdd.ci[gdd.ci$phenophase=="leaf",])
anova(leaf.rng.comp0)
summary(leaf.rng.comp0)
# --------

gdd.mean <- aggregate(cbind(mid, dMid, range, dRange) ~ model + phenophase, data=gdd.ci, FUN=mean)
gdd.sd <- aggregate(cbind(mid, dMid, range, dRange) ~ model + phenophase, data=gdd.ci, FUN=sd)

### Reviewer 2 comment -- GDD threshold for QUMA leafout seems lower than budburst
gdd.ci[gdd.ci$Species=="macrocarpa",]


### -----------------------------



#-------------------------------------------------------------------------------------------------#


#-------------------------------------------------------------------------------------------------#
#----------------------#
# ~~~ Data inputs for FIGURE 3 & 4 ~~~ #
#----------------------#
fpred <- dir(path.data, "Prediction_Evaluation")
pred.all <- data.frame()
stats.all <- data.frame()
for(i in 1:length(fpred)){
  print(fpred[i])
  fpred.split <- stringr::str_split(fpred[i], "_")[[1]]
  
  pred.out <- read.csv(file.path(path.data, fpred[i]))
  pred.out$model <- fpred.split[1]  
  pred.out$phenophase <- ifelse(grepl("TT", fpred[i]), fpred.split[3], fpred.split[2])
  summary(pred.out)
  
  stat.tmp <- data.frame(model=fpred.split[1], 
                         phenophase=ifelse(grepl("TT", fpred[i]), fpred.split[3], fpred.split[2]),
                         species=unique(pred.out$species), 
                         RMSE=NA, err.rate=NA, bias=NA)
  for(SPP in unique(pred.out$species)){
    row.spp <- which(stat.tmp$species==SPP)
    dat.spp <- pred.out[pred.out$species==SPP & pred.out$obs.type=="validation",]
    stat.tmp[row.spp,"RMSE"] <- sqrt(mean(dat.spp$diff^2))
    stat.tmp[row.spp,"err.rate"] <- mean(dat.spp$error)
    stat.tmp[row.spp, "bias"] <- mean(dat.spp$diff)
  }

  pred.all <- rbind(pred.all, pred.out)
  stats.all <- rbind(stats.all, stat.tmp)
}
summary(pred.all)
summary(stats.all)
stats.all$spp.type <- ifelse(stats.all$species %in% spp.calib, "TMA + NPN", "TMA Only")
stats.all$model <- car::recode(stats.all$model, "'ARB'='TMA'; 'RevGT'='WT'; 'RevLat'='LAT'")
stats.all$model <- factor(stats.all$model, levels=c("TMA", "COMB", "LAT", "WT"))
stats.all

pred.all$spp.type2 <- ifelse(pred.all$species %in% spp.calib, "TMA + NPN", "TMA Only")
pred.all$model <- car::recode(pred.all$model, "'ARB'='TMA'; 'RevGT'='WT'; 'RevLat'='LAT'")
pred.all$model <- factor(pred.all$model, levels=c("TMA", "COMB", "LAT", "WT"))


# ---------------------------------------------
# Figure 3 - RMSE
# ---------------------------------------------
ggplot(data=stats.all) +
  facet_grid(phenophase~.) +
  geom_boxplot(aes(x=spp.type, y=err.rate, fill=model)) +
  scale_fill_manual(name="Model", values=model.palette) +
  theme(panel.background = element_blank(),
        axis.line = element_line(color="black", size=0.5),
        legend.key = element_blank())

bud.rmse <- ggplot(data=stats.all[stats.all$phenophase=="Budburst",]) +
  facet_grid(.~spp.type, scales="free_x") +
  geom_bar(aes(x=paste("Q.", species), y=RMSE, fill=model), stat="identity", position="dodge") +
  scale_y_continuous(name="RMSE (days)", expand=c(0,0), limits=c(0, max(stats.all$RMSE))) +
  scale_x_discrete(name="Species") +
  scale_fill_manual(name="Model", values=model.palette) +
  # scale_fill_manual(name="Model", values=model.palette) +
  theme(panel.background = element_blank(),
        panel.grid = element_blank(),
        axis.line = element_line(color="black", size=0.2),
        axis.text.x = element_text(face="italic", size=rel(1.5), angle=-15, hjust=0),
        axis.text.y=element_text(size=rel(1.5)),
        axis.title = element_text(size=rel(1.75), face="bold"),
        strip.text = element_text(size=rel(1.75)),
        # legend.position=c(0.2, 0.8),
        legend.key=element_blank(),
        legend.title=element_text(size=rel(1.5)),
        legend.text=element_text(size=rel(1.25)))

leaf.rmse <- ggplot(data=stats.all[stats.all$phenophase=="Leaf",]) +
  facet_grid(.~spp.type, scales="free_x") +
  geom_bar(aes(x=paste("Q.", species), y=RMSE, fill=model), stat="identity", position="dodge") +
  scale_y_continuous(name="RMSE (days)", expand=c(0,0), limits=c(0, max(stats.all$RMSE))) +
  scale_x_discrete(name="Species") +
  scale_fill_manual(name="Model", values=model.palette) +
  # scale_fill_manual(name="Model", values=model.palette) +
  theme(panel.background = element_blank(),
        panel.grid = element_blank(),
        axis.line = element_line(color="black", size=0.2),
        axis.text.x = element_text(face="italic", size=rel(1.5), angle=-15, hjust=0),
        axis.text.y=element_text(size=rel(1.5)),
        axis.title = element_text(size=rel(1.75), face="bold"),
        strip.text = element_text(size=rel(1.75)),
        # legend.position=c(0.2, 0.8),
        legend.key=element_blank(),
        legend.title=element_text(size=rel(1.5)),
        legend.text=element_text(size=rel(1.25)))

png(width=9, height=8, units="in", res=600, filename= file.path(path.figures, 'Fig3_RMSE.png'))
plot_grid(bud.rmse, leaf.rmse, labels=c('A', 'B'), align = "v", nrow=2, label_size = 18)
dev.off()
png(width=9, height=8, units="in", res=600, filename= file.path(figs.google, 'Fig3_RMSE.png'))
plot_grid(bud.rmse, leaf.rmse, labels=c('A', 'B'), align = "v", nrow=2, label_size = 18)
dev.off()

### --------------------
### Results that go with Fig. 3
### --------------------
for(SPP in unique(stats.all$species)){
  for(PHENO in unique(stats.all$phenophase)){
    row.now <- which(stats.all$species==SPP & stats.all$phenophase==PHENO)
    row.ref <- which(stats.all$species==SPP & stats.all$phenophase==PHENO & stats.all$model=="TMA")
    
    stats.all[row.now,"dRMSE"] <- stats.all[row.now,"RMSE"] - stats.all[row.ref,"RMSE"]
  }
}
summary(stats.all)


summary(stats.all)
bud.rmse.comp0 <- lme(RMSE ~ model*spp.type, random=list(species=~1), data=stats.all[stats.all$phenophase=="Budburst",])
anova(bud.rmse.comp0)

bud.rmse.comp1a <- lme(RMSE ~ model, random=list(species=~1), data=stats.all[stats.all$phenophase=="Budburst",])
anova(bud.rmse.comp1a)
summary(bud.rmse.comp1a)

bud.rmse.comp1b <- lme(RMSE ~ spp.type, random=list(species=~1), data=stats.all[stats.all$phenophase=="Budburst",])
anova(bud.rmse.comp1b)
summary(bud.rmse.comp1b)

leaf.rmse.comp0 <- lme(RMSE ~ model*spp.type, random=list(species=~1), data=stats.all[stats.all$phenophase=="Leaf",])
anova(leaf.rmse.comp0)
summary(leaf.rmse.comp0)

leaf.rmse.comp1a <- lme(RMSE ~ model, random=list(species=~1), data=stats.all[stats.all$phenophase=="Leaf",])
anova(leaf.rmse.comp1a)
summary(leaf.rmse.comp1a)

leaf.rmse.comp1b <- lme(RMSE ~ spp.type, random=list(species=~1), data=stats.all[stats.all$phenophase=="Leaf",])
anova(leaf.rmse.comp1b)
summary(leaf.rmse.comp1b)


rmse.stats <- aggregate(RMSE ~ model + phenophase, data=stats.all, FUN=mean)
rmse.stats$sd <- aggregate(RMSE ~ model + phenophase, data=stats.all, FUN=sd)[,"RMSE"]
rmse.stats$dRMSE <- aggregate(dRMSE ~ model + phenophase, data=stats.all, FUN=mean)[,"dRMSE"]
rmse.stats$dRMSE.sd <- aggregate(dRMSE ~ model + phenophase, data=stats.all, FUN=sd)[,"dRMSE"]
rmse.stats


rmse.stats2 <- aggregate(RMSE ~ spp.type + phenophase, data=stats.all, FUN=mean)
rmse.stats2$sd <- aggregate(RMSE ~ spp.type + phenophase, data=stats.all, FUN=sd)[,"RMSE"]
rmse.stats2
### --------------------
# ---------------------------------------------


# ---------------------------------------------
# Figure 4 - Spatial Trends in predictability
# ---------------------------------------------
summary(pred.all)
pred.all$species2 <- factor(paste("Q.", pred.all$species), levels=paste("Q.", c(spp.calib, spp.valid)))
pred.all$phenophase <- car::recode(pred.all$phenophase, "'Leaf'='Leaf Out'")


lat.trend <- ggplot(data=pred.all[pred.all$obs.type=="validation",]) +
  facet_grid(species2~phenophase) +
  geom_point(aes(x=latitude, y=diff, color=model), size=0.5, alpha=0.5) +
  stat_smooth(aes(x=latitude, y=diff, color=model, fill=model), method="lm", alpha=0.2) +
  geom_hline(yintercept = 0, linetype="dashed", color="black", size=0.25) +
  # geom_vline(xintercept = cond.arb["latitude"], linetype="dashed", color="black", size=0.25) +
  scale_y_continuous(name="Residual (days)", breaks=seq(-40, 60, by=20)) +
  scale_x_continuous(name="Latitude (degrees)", breaks=seq(30, 55, by=5)) +
  scale_color_manual(name="Model", values=model.palette) +
  scale_fill_manual(name="Model", values=model.palette) +
  theme(panel.background = element_rect(fill=NA, color="black"),
        panel.grid = element_blank(),
        panel.spacing = unit(0.21, "lines"),
        axis.line=element_line(size=0.5, color="black"),
        axis.text = element_text(color="black"),
        axis.title = element_text(color="black", size=rel(1.25), face="bold"),
        strip.text.y=element_text(face="italic"),
        legend.key=element_blank())

png(width=8, height=9, units="in", res=600, filename= file.path(path.figures, 'Fig4_LatTrend.png'))
lat.trend
dev.off()

png(width=8, height=9, units="in", res=600, filename= file.path(figs.google, 'Fig4_LatTrend.png'))
lat.trend
dev.off()


### -----------------------
### Doing analyses of lat trend 
### -----------------------
trends.out <- data.frame(Species=rep(unique(pred.all$species), 2), 
                         Phenophase=rep(unique(pred.all$phenophase), each=length(unique(pred.all$species))),
                         TMA=NA, COMB=NA, LAT=NA, WT=NA)
trends.val <- data.frame(Species=rep(unique(pred.all$species), 2), 
                         Phenophase=rep(unique(pred.all$phenophase), each=length(unique(pred.all$species))),
                         TMA=NA, COMB=NA, LAT=NA, WT=NA)

for(SPP in unique(pred.all$species)){
  for(PHENO in unique(pred.all$phenophase)){
    dat.now <- pred.all[pred.all$obs.type=="validation" & pred.all$species==SPP & pred.all$phenophase==PHENO,]
    row.out <- which(trends.out$Species==SPP & trends.out$Phenophase==PHENO)
    
    # getting the trends in residual & stat sig from 0
    lm.eff <- lme(diff ~ latitude*model-latitude - 1, random=list(site_id=~1), data=dat.now, na.action = na.omit)
    sum.eff <- data.frame(summary(lm.eff)$tTable)
    
    sum.eff2 <- sum.eff[grep("latitude", row.names(sum.eff)),]
    sum.eff2$Value.lab <- paste0(sprintf( "%.1f", round(sum.eff2$Value, 1)), " (", sprintf( "%.1f", round(sum.eff2$Std.Error, 1)) ,")")
    
    vals.now <- ifelse(sum.eff2$p.value<0.05, paste0(sum.eff2$Value.lab, "*"), sum.eff2$Value.lab)
    
    if(!any(grepl("COMB", row.names(sum.eff2)))){
      vals.now <- c(vals.now[1], "", vals.now[2:3])
    }
    
    
    # Comparisons LME where p-value corresponds to diff form ARB model
    lm.comp <- lme(diff ~ latitude*model, random=list(site_id=~1), data=dat.now, na.action=na.omit)
    sum.comp <- data.frame(summary(lm.comp)$tTable)

    sum.comp2 <- sum.comp[grep("latitude:", row.names(sum.comp)),]
    
    if(!any(grepl("COMB", row.names(sum.comp2)))){
      vals.now[3:4] <- ifelse(sum.comp2$p.value<0.05, paste0(vals.now[3:4], "†"), vals.now[3:4])
    } else {   
      vals.now[2:4] <- ifelse(sum.comp2$p.value<0.05, paste0(vals.now[2:4], "†"), vals.now[2:4])
    }
    
    trends.out[row.out, c("TMA", "COMB", "LAT", "WT")] <- vals.now
    
    if(!any(grepl("COMB", row.names(sum.comp)))){
      trends.val[row.out, c("TMA", "LAT", "WT")] <- sum.comp[grep("latitude", row.names(sum.comp)),"Value"]
    } else {
      trends.val[row.out, c("TMA", "COMB", "LAT", "WT")] <- sum.comp[grep("latitude", row.names(sum.comp)),"Value"]
    }
    
  }
}
trends.out$Species <- factor(trends.out$Species, levels=c(spp.calib, spp.valid))
trends.out$Group <- ifelse(trends.out$Species %in% spp.calib, "TMA + NPN", "TMA Only")
trends.out$Species <- paste("Q.", trends.out$Species)
trends.out <- trends.out[order(trends.out$Phenophase, trends.out$Group), c("Group", "Species", "Phenophase", "TMA", "COMB", "LAT", "WT")]
trends.out

write.csv(trends.out, file.path(path.figures, 'TableS5_LatTrend.csv'), row.names=F)
write.csv(trends.out, file.path(figs.google, 'TableS5_LatTrend.csv'), row.names=F)

trends.val

# Getting the baseline Arb-only model
mean(trends.val$TMA[trends.val$Phenophase=="Budburst"]); sd(trends.val$TMA[trends.val$Phenophase=="Budburst"])

mean(trends.val$TMA[trends.val$Phenophase=="Leaf Out"]); sd(trends.val$TMA[trends.val$Phenophase=="Leaf Out"])


# Changes for LAT
mean(trends.val$LAT[trends.val$Phenophase=="Budburst"]); sd(trends.val$LAT[trends.val$Phenophase=="Budburst"])

mean(trends.val$LAT[trends.val$Phenophase=="Leaf Out"]); sd(trends.val$LAT[trends.val$Phenophase=="Leaf Out"])

# Changes for WT
mean(trends.val$WT[trends.val$Phenophase=="Budburst"]); sd(trends.val$WT[trends.val$Phenophase=="Budburst"])

mean(trends.val$WT[trends.val$Phenophase=="Leaf Out"]); sd(trends.val$WT[trends.val$Phenophase=="Leaf Out"])

### -----------------------




# ---------------------------------------------


