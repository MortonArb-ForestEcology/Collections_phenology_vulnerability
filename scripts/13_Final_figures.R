#Figures moving into the final stages of the paper
#Script sections are ordered by figure.

library(ggplot2)
library(cowplot)
library(Rmisc)
library(dplyr)
library(tidyverse)


path.data <- "../data_processed" 
path.figures <- "../figures_final"
path.hub <- "../data"


if(!dir.exists(path.figures)) dir.create(path.figures, recursive=T)

#------------------#
# ~~~ FIGURE 1 ~~~ #
#------------------#

#Using inputs only for Fig 1.

oaks.bud <- read.csv(file.path(path.data, 'Oak_collection_budburst.csv'))
oaks.leaf <- read.csv(file.path(path.data, 'Oak_collection_leaf.csv'))

#Selecting (if one chooses) only calibration and validation species

#oaks.bud <- oaks.bud[oaks.bud$Species %in% c("Quercus ilicifolia", "Quercus imbricaria", "Quercus marilandica", "Quercus stellata", "Quercus shumardii", "Quercus alba", "Quercus gambelii", "Quercus macrocarpa", "Quercus velutina", "Quercus rubra", "Quercus montana", "Quercus palustris"),]
#oaks.leaf <- oaks.leaf[oaks.leaf$Species %in% c("Quercus ilicifolia", "Quercus imbricaria", "Quercus marilandica", "Quercus stellata", "Quercus shumardii", "Quercus alba", "Quercus gambelii", "Quercus macrocarpa", "Quercus velutina", "Quercus rubra", "Quercus montana", "Quercus palustris"),]

#Separating genus and species

oaks.bud <- tidyr::separate(oaks.bud, col = "Species", into=c("Genus", "Species"))

oaks.leaf <- tidyr::separate(oaks.leaf, col = "Species", into=c("Genus", "Species"))

#Assigning NPN status to species

not.npn <- c('lyrata', 'georgiana', 'pagoda', 'prinoides', 'coccinea', 'ellipsoidalis', 'michauxii', 'meuhlenbergii', 'bicolor')
oaks.bud$NPN <- ifelse(oaks.bud$Species %in% not.npn, "No NPN data", "NPN")
oaks.leaf$NPN <- ifelse(oaks.leaf$Species %in% not.npn, "No NPN data", "NPN")

bud.1 <- ggplot(data=oaks.bud, aes(x= Species, y=GDD5.cum, fill=NPN))+
  geom_violin() +
  #geom_jitter(size=0.5) +
  #geom_boxplot()+
  theme_cowplot(12)+
  theme(text=element_text(size=18), axis.text.x = element_text(size = 11, angle=-20, hjust=0)) +
  scale_fill_manual(values=c("#A3319F", "#DF488D")) +
  #ylim(0, 500) +
  xlab("Species")+
  ylab("GDD5.cum (days)")

leaf.1 <- ggplot(data=oaks.leaf, aes(x= Species, y=GDD5.cum, fill=NPN))+
  geom_violin() +
  #geom_boxplot()+
  theme_cowplot(12)+
  theme(text=element_text(size=18), axis.text.x = element_text(size = 11, angle=-20, hjust=0)) +
  scale_fill_manual(values=c("#FA7876", "#F3B584")) +
  #ylim(0, 500) +
  xlab("Species")+
  ylab("GDD5.cum (days)")

png(width = 1000, filename= file.path(path.figures, paste0('Figure 1', '.png')))
plot_grid(bud.1, leaf.1, labels=c('A', 'B'), align = "v", nrow=2, label_size = 16)
dev.off()

#----------------------------#

#Using inputs AND outputs for Fig. 1

#Read in all the species outputs into one dataframe
bud.files <- list.files(path = "../data_processed/model_output/", pattern = "OldTT_model_budburst.csv", full.names = T)
bud.stats <- as.data.frame(sapply(bud.files, read.csv, simplify=FALSE) %>% 
                             bind_rows(.id = "id"))

bud.stats <- bud.stats[,c("THRESH", "aPrec", "sd", "species")]

#Seperating columns to help match with npn data
bud.stats <- tidyr::separate(bud.stats, col = "species", into=c("genus", "species"))

#Read in all the species outputs into one dataframe
leaf.files <- list.files(path = "../data_processed/model_output/", pattern = "OldTT_model_leaf.csv", full.names = T)
leaf.stats <- as.data.frame(sapply(leaf.files, read.csv, simplify=FALSE) %>% 
                              bind_rows(.id = "id"))

leaf.stats <- leaf.stats[,c("THRESH", "aPrec", "sd", "species")]

#Seperating columns to help match with npn data
leaf.stats <- tidyr::separate(leaf.stats, col = "species", into=c("genus", "species"))

#Assigning NPN status to each species

bud.stats$NPN <- ifelse(bud.stats$species %in% not.npn, "No NPN data", "NPN")
leaf.stats$NPN <- ifelse(leaf.stats$species %in% not.npn, "No NPN data", "NPN")

#Removing data outside 95% CI from outputs

bud.stats <- subset(bud.stats, THRESH >= quantile(THRESH, 0.025) & THRESH <= quantile(THRESH, 0.975))

leaf.stats <- subset(leaf.stats, THRESH >= quantile(THRESH, 0.025) & THRESH <= quantile(THRESH, 0.975))

#Removing coccinea from oaks.leaf

oaks.leaf <- oaks.leaf %>% subset(!(Species == "coccinea"))

#Putting the x-axis in decreasing order of species latitude centroid

#list of species (rubra has 3 because of file size)
species <- c("alba", "bicolor", "ellipsoidalis", "gambellii", "georgiana", "ilicifolia", "imbricaria", "lyrata", "macrocarpa",
             "marilandica", "michauxii", "montana", "muehlenbergii", "pagoda", "palustris", "prinoides",
             "rubra_1", "rubra_2", "rubra_3", "shumardii", "stellata", "velutina")

#downloaded all species and putting them in one data frame
full <- data.frame()
for(SP in species){
  tmp <- read.csv(file.path(path.hub, paste0("Quercus_", SP, ".csv")))
  full <- rbind(full, tmp)
}

#This should produce the median latitude for each species so you can use this to order fig 1
med.lat <- aggregate(decimalLatitude~species_name_acc, data=full,
                     FUN=median)

oaks.bud$Species <- factor(oaks.bud$Species, levels = c("lyrata", "pagoda", "michauxii", "georgiana", "shumardii", "stellata", "marilandica", "montana", "gambelii", "alba", "velutina", "muehlenbergii", "imbricaria", "palustris", "prinoides", "bicolor", "ilicifolia", "macrocarpa", "ellipsoidalis", "rubra"))
oaks.leaf$Species <- factor(oaks.leaf$Species, levels = c("lyrata", "pagoda", "michauxii", "georgiana", "shumardii", "stellata", "marilandica", "montana", "gambelii", "alba", "velutina", "muehlenbergii", "imbricaria", "palustris", "prinoides", "bicolor", "ilicifolia", "macrocarpa", "ellipsoidalis", "rubra"))

bud.stats$species <- factor(bud.stats$species, levels = c("lyrata", "pagoda", "michauxii", "georgiana", "shumardii", "stellata", "marilandica", "montana", "gambelii", "alba", "velutina", "muehlenbergii", "imbricaria", "palustris", "prinoides", "bicolor", "ilicifolia", "macrocarpa", "ellipsoidalis", "rubra"))
leaf.stats$species <- factor(leaf.stats$species, levels = c("lyrata", "pagoda", "michauxii", "georgiana", "shumardii", "stellata", "marilandica", "montana", "gambelii", "alba", "velutina", "muehlenbergii", "imbricaria", "palustris", "prinoides", "bicolor", "ilicifolia", "macrocarpa", "ellipsoidalis", "rubra"))

bud.1a <- ggplot(data=bud.stats, aes(x=species, y=THRESH, fill=NPN))+
  geom_violin(alpha=0.5, scale="width") +
  geom_boxplot(width=0.075, lwd=0.3, color="light grey", alpha=0.75, outlier.shape=NA)+
  geom_jitter(data=oaks.bud, aes(x=Species, y=GDD5.cum, color=NPN), size=0.5, alpha=0.5)+
  theme_cowplot(12)+
  theme(text=element_text(size=18), axis.text.x = element_text(size = 11, angle=-20, hjust=0)) +
  scale_fill_manual(values=c("#CA3C97", "#4B2991")) +
  scale_color_manual(values=c("#CA3C97", "#4B2991")) +
  xlab("Species")+
  ylab("GDD5")

leaf.1a <- ggplot(data=leaf.stats, aes(x=species, y=THRESH, fill=NPN))+
  geom_violin(alpha=0.5, scale="width") +
  geom_boxplot(width=0.075, lwd=0.3, color="light grey", alpha=0.75, outlier.shape=NA)+
  geom_jitter(data=oaks.leaf, aes(x=Species, y=GDD5.cum, color=NPN), size=0.5, alpha=0.5)+
  theme_cowplot(12)+
  theme(text=element_text(size=18), axis.text.x = element_text(size = 11, angle=-20, hjust=0)) +
  scale_fill_manual(values=c("#CA3C97", "#4B2991")) +
  scale_color_manual(values=c("#CA3C97", "#4B2991")) +
  xlab("Species")+
  ylab("GDD5")

png(width=9, height=5, units="in", res=600, filename= file.path(path.figures, paste0('Figure 1b', '.png')))
plot_grid(bud.1a, leaf.1a, labels=c('A', 'B'), align = "v", nrow=2, label_size = 18)
dev.off()

#-------------------------------------------------------------------------------------------------#

#------------------#
# ~~~ FIGURE 2 ~~~ #
#------------------#

bud.eval <- read.csv(file.path(path.data, 'First_Budburst_Prediction_Evaluation_all.csv'), stringsAsFactors = T)
leaf.eval <- read.csv(file.path(path.data, 'First_Leaf_Prediction_Evaluation_all.csv'), stringsAsFactors = T)

spp.valid <- c("ilicifolia", "imbricaria", "marilandica", "stellata", "shumardii")

bud.eval[bud.eval$species %in% spp.valid,"type"] <- "validation"
bud.eval[!bud.eval$species %in% spp.valid,"type"] <- "calibration"

leaf.eval[leaf.eval$species %in% spp.valid,"type"] <- "validation"
leaf.eval[!leaf.eval$species %in% spp.valid,"type"] <- "calibration"

#v1: Resid vs. Lat and Resid vs. GTmean only for "first" model data

bud.2 <- ggplot(bud.eval, aes(x = latitude, y = diff, color = type, group=species))+
  geom_smooth(method='lm', se = TRUE, alpha=0.25, aes(fill=type, color=type))+
  geom_vline(linetype="dashed", xintercept=41.8)+
  theme_cowplot(12) +
  theme(text=element_text(size=18), legend.position = "none") +
  geom_jitter(alpha=0.25, size=0.5, aes(shape=type)) +
  scale_color_manual(values=c("#440154", "#55C667")) +
  scale_fill_manual(values=c("#440154", "#55C667")) +
  xlab("Latitude")+
  ylab("Resid.")

leaf.2 <- ggplot(leaf.eval, aes(x = latitude, y = diff, color = type, group=species))+
  geom_smooth(method='lm', se = TRUE, alpha=0.25, aes(fill=type, color=type))+
  geom_vline(linetype="dashed", xintercept=41.8)+
  theme_cowplot(12) +
  theme(text=element_text(size=18), legend.position='none') +
  geom_jitter(alpha=0.25, size=0.5, aes(shape=type)) +
  scale_color_manual(values=c("#440154", "#55C667")) +
  scale_fill_manual(values=c("#440154", "#55C667")) +
  xlab("Latitude")+
  ylab("Resid.")

GT.bud.2 <- ggplot(bud.eval, aes(x = GTmean, y = diff, color = type, group=species))+
  geom_smooth(method='lm', se = TRUE, alpha=0.25, aes(fill=type, color=type))+
  #geom_vline(linetype="dashed", xintercept=41.8)+
  theme_cowplot(12) +
  theme(text=element_text(size=18), legend.position = "none") +
  geom_jitter(alpha=0.25, size=0.5, aes(shape=type)) +
  scale_color_manual(values=c("#440154", "#55C667")) +
  scale_fill_manual(values=c("#440154", "#55C667")) +
  xlab("GTmean")+
  ylab("Resid.")

GT.leaf.2 <- ggplot(leaf.eval, aes(x = GTmean, y = diff, color = type, group=species))+
  geom_smooth(method='lm', se = TRUE, alpha=0.25, aes(fill=type, color=type))+
  #geom_vline(linetype="dashed", xintercept=41.8)+
  theme_cowplot(12) +
  theme(text=element_text(size=18), legend.position = "none") +
  geom_jitter(alpha=0.25, size=0.5, aes(shape=type)) +
  scale_color_manual(values=c("#440154", "#55C667")) +
  scale_fill_manual(values=c("#440154", "#55C667")) +
  xlab("GTmean")+
  ylab("Resid.")

png(width=1000, height=600, filename= file.path(path.figures, paste0('Figure 2', '.png')))
plot_grid(bud.2, leaf.2, GT.bud.2, GT.leaf.2, labels=c('A', 'B', 'C', 'D'), align = "v", nrow=2, label_size = 18)
dev.off()

# -------------------------------

#v2: Resid vs. Lat for all 5 models, separate facet wrapped figs for bud and leaf.

#Budburst model dfs

first.comb.burst <- read.csv(file.path(path.data, paste0('First_Budburst_Prediction_Evaluation_all.csv')))
GT.comb.burst <- read.csv(file.path(path.data, paste0('GTmean_Budburst_Prediction_Evaluation_all.csv')))
RGT.comb.burst <- read.csv(file.path(path.data, paste0('Rel_GTmean_Budburst_Prediction_Evaluation_all.csv')))
Rlat.comb.burst <- read.csv(file.path(path.data, paste0('Rel_Lat_Budburst_Prediction_Evaluation_all.csv')))
Lat.comb.burst <- read.csv(file.path(path.data, paste0('Lat_Budburst_Prediction_Evaluation_all.csv')))

#Leafout model dfs

first.comb.leaf <- read.csv(file.path(path.data, paste0('First_Leaf_Prediction_Evaluation_all.csv')))
GT.comb.leaf <- read.csv(file.path(path.data, paste0('GTmean_Leaf_Prediction_Evaluation_all.csv')))
RGT.comb.leaf <- read.csv(file.path(path.data, paste0('Rel_GTmean_Leaf_Prediction_Evaluation_all.csv')))
Rlat.comb.leaf <- read.csv(file.path(path.data, paste0('Rel_Lat_Leaf_Prediction_Evaluation_all.csv')))
Lat.comb.leaf <- read.csv(file.path(path.data, paste0('Lat_Leaf_Prediction_Evaluation_all.csv')))

#Selecting matching rows so we can combine dfs into one

first.sel.bud <- first.comb.burst %>% select(latitude, species, diff, type) %>% mutate(model="GDD")
GT.sel.bud <- GT.comb.burst %>% select(latitude, species, diff, type) %>% mutate(model="GT")
RGT.sel.bud <- RGT.comb.burst %>% select(latitude, species, diff, type) %>% mutate(model="RGT")
Rlat.sel.bud <- Rlat.comb.burst %>% select(latitude, species, diff, type) %>% mutate(model="Rlat")
Lat.sel.bud <- Lat.comb.burst %>% select(latitude, species, diff, type) %>% mutate(model="Lat")

first.sel.leaf <- first.comb.leaf %>% select(latitude, species, diff, type) %>% mutate(model="GDD")
GT.sel.leaf <- GT.comb.leaf %>% select(latitude, species, diff, type) %>% mutate(model="GT")
RGT.sel.leaf <- RGT.comb.leaf %>% select(latitude, species, diff, type) %>% mutate(model="RGT")
Rlat.sel.leaf <- Rlat.comb.leaf %>% select(latitude, species, diff, type) %>% mutate(model="Rlat")
Lat.sel.leaf <- Lat.comb.leaf %>% select(latitude, species, diff, type) %>% mutate(model="Lat")

#Combining into one df

bud.sel <- rbind(GT.sel.bud, RGT.sel.bud, Rlat.sel.bud, Lat.sel.bud)

leaf.sel <- rbind(GT.sel.leaf, RGT.sel.leaf, Rlat.sel.leaf, Lat.sel.leaf)

#Ordering x-axis

bud.sel$model <- factor(bud.sel$model, levels = c("Lat", "GT", "Rlat", "RGT"))
leaf.sel$model <- factor(leaf.sel$model, levels = c("Lat", "GT", "Rlat", "RGT"))

#Fig. 2 v2 BUD

plots.bud.4 <- ggplot(bud.sel, aes(x = latitude, y = diff, color = type, group=species))+
  facet_wrap(~model)+
  geom_smooth(method='lm', se = TRUE, alpha=0.25, size=0.5, aes(fill=type, color=type))+
  geom_vline(linetype="dashed", xintercept=41.8)+
  theme_cowplot(12) +
  theme(text=element_text(size=18), legend.position="bottom", legend.justification = "center") + #remove legend.position for horizontal version
  geom_jitter(alpha=0.25, size=0.5, aes(shape=type)) +
  scale_color_manual(values=c("#453781", "#3CBB75")) +
  scale_fill_manual(values=c("#453781", "#3CBB75")) +
  xlab("Latitude")+
  ylab("Resid.")

plots.bud.1 <- ggplot(first.sel.bud, aes(x = latitude, y = diff, color = type, group=species))+
  facet_wrap(~model)+
  geom_smooth(method='lm', se = TRUE, alpha=0.25, size=0.5, aes(fill=type, color=type))+
  geom_vline(linetype="dashed", xintercept=41.8)+
  theme_cowplot(12) +
  theme(text=element_text(size=18), legend.position = "none", aspect.ratio=0.655) +  # add aspect.ratio=0.69 for horizontal version
  geom_jitter(alpha=0.25, size=0.5, aes(shape=type)) +
  scale_color_manual(values=c("#453781", "#3CBB75")) +
  scale_fill_manual(values=c("#453781", "#3CBB75")) +
  xlab("Latitude")+
  ylab("Resid.")

png(height = 6, width = 4, units="in", res=600, filename= file.path(path.figures, paste0('Figure 2b Bud', '.png')))
plot_grid(plots.bud.1, plots.bud.4, rel_heights=c(1, 1.93), axis="t", nrow=2, align="v")
dev.off()

#Fig. 2 v2 LEAF

plots.leaf.4 <- ggplot(leaf.sel, aes(x = latitude, y = diff, color = type, group=species))+
  facet_wrap(~model)+
  geom_smooth(method='lm', se = TRUE, alpha=0.25, size=0.5, aes(fill=type, color=type))+
  geom_vline(linetype="dashed", xintercept=41.8)+
  theme_cowplot(12) +
  theme(text=element_text(size=18), legend.position="bottom", legend.justification = "center") + #remove legend.position for horizontal version
  geom_jitter(alpha=0.25, size=0.5, aes(shape=type)) +
  scale_color_manual(values=c("#287D8E", "#FDE725")) +
  scale_fill_manual(values=c("#287D8E", "#FDE725")) +
  xlab("Latitude")+
  ylab("Resid.")

plots.leaf.1 <- ggplot(first.sel.leaf, aes(x = latitude, y = diff, color = type, group=species))+
  facet_wrap(~model)+
  geom_smooth(method='lm', se = TRUE, alpha=0.25, size=0.5, aes(fill=type, color=type))+
  geom_vline(linetype="dashed", xintercept=41.8)+
  theme_cowplot(12) +
  theme(text=element_text(size=18), legend.position = "none", aspect.ratio=0.655) +  # add aspect.ratio=0.69 for horizontal version
  geom_jitter(alpha=0.25, size=0.5, aes(shape=type)) +
  scale_color_manual(values=c("#287D8E", "#FDE725")) +
  scale_fill_manual(values=c("#287D8E", "#FDE725")) +
  xlab("Latitude")+
  ylab("Resid.")

png(height = 6, width = 4, units="in", res=600, filename= file.path(path.figures, paste0('Figure 2b Leaf', '.png')))
plot_grid(plots.leaf.1, plots.leaf.4, rel_heights=c(1, 1.93), axis="t", nrow=2, align="v")
dev.off()

#--------------------------------------------------------------------------------------------------#
  
#------------------#
# ~~~ FIGURE 3 ~~~ #
#------------------#

#Wrangling Budburst data

#Calculating RMSE by species and adding an RMSE column to each model's dataframe

rmse.first.bud <- first.comb.burst %>% group_by(species) %>% mutate_each(funs(mean)) %>% distinct %>% mutate(RMSE = sqrt(expdiff))
rmse.GT.bud <- GT.comb.burst %>% group_by(species) %>% mutate_each(funs(mean)) %>% distinct %>% mutate(RMSE = sqrt(expdiff))
rmse.RGT.bud <- RGT.comb.burst %>% group_by(species) %>% mutate_each(funs(mean)) %>% distinct %>% mutate(RMSE = sqrt(expdiff))
rmse.Rlat.bud <- Rlat.comb.burst %>% group_by(species) %>% mutate_each(funs(mean)) %>% distinct %>% mutate(RMSE = sqrt(expdiff))
rmse.Lat.bud <- Lat.comb.burst %>% group_by(species) %>% mutate_each(funs(mean)) %>% distinct %>% mutate(RMSE = sqrt(expdiff))

#Selecting only the columns which we need so that columns will match when combining df's; adding model name columns
#Note: make sure to update model names in 'model' column
#Note; I'm pretty sure this averages the latitudes for each species as well

rmse.first.bud <- rmse.first.bud %>% select(site_id, latitude, longitude, species, diff, error, RMSE, mid, Yday, type) %>% mutate(model="first")
rmse.GT.bud <- rmse.GT.bud %>% select(site_id, latitude, longitude, species, diff, error, RMSE, mid, Yday, type) %>% mutate(model="GT")
rmse.RGT.bud <- rmse.RGT.bud %>% select(site_id, latitude, longitude, species, diff, error, RMSE, mid, Yday, type) %>% mutate(model="RGT")
rmse.Rlat.bud <- rmse.Rlat.bud %>% select(site_id, latitude, longitude, species, diff, error, RMSE, mid, Yday, type) %>% mutate(model="Rlat")
rmse.Lat.bud <- rmse.Lat.bud %>% select(site_id, latitude, longitude, species, diff, error, RMSE, mid, Yday, type) %>% mutate(model="Lat")

#Luciens version of rmse delta
#Matching for RMSE diff
rmse.first.bud$RMSE.org <- 0 
rmse.GT.bud$RMSE.org <- rmse.first.bud$RMSE[match(rmse.GT.bud$species, rmse.first.bud$species)]
rmse.RGT.bud$RMSE.org <- rmse.first.bud$RMSE[match(rmse.RGT.bud$species, rmse.first.bud$species)]
rmse.Rlat.bud$RMSE.org <- rmse.first.bud$RMSE[match(rmse.Rlat.bud$species, rmse.first.bud$species)]
rmse.Lat.bud$RMSE.org <- rmse.first.bud$RMSE[match(rmse.Lat.bud$species, rmse.first.bud$species)]

rmse.GT.bud$RMSE.diff <- rmse.GT.bud$RMSE-rmse.GT.bud$RMSE.org
rmse.RGT.bud$RMSE.diff <- rmse.RGT.bud$RMSE-rmse.RGT.bud$RMSE.org
rmse.Rlat.bud$RMSE.diff <- rmse.Rlat.bud$RMSE-rmse.Rlat.bud$RMSE.org
rmse.Lat.bud$RMSE.diff <- rmse.Lat.bud$RMSE-rmse.Lat.bud$RMSE.org

#Re-assigning 'type' to each species

spp.valid <- c("ilicifolia", "imbricaria", "marilandica", "stellata", "shumardii")

rmse.first.bud$type <- ifelse(rmse.first.bud$species %in% spp.valid, "validation", "calibration")

rmse.GT.bud$type <- ifelse(rmse.GT.bud$species %in% spp.valid, "validation", "calibration")

rmse.RGT.bud$type <- ifelse(rmse.RGT.bud$species %in% spp.valid, "validation", "calibration")

rmse.Rlat.bud$type <- ifelse(rmse.Rlat.bud$species %in% spp.valid, "validation", "calibration")

rmse.Lat.bud$type <- ifelse(rmse.Lat.bud$species %in% spp.valid, "validation", "calibration")


#Combining model df's into one df for comparison (excluding 'first')

bud.model <- rbind(rmse.Lat.bud, rmse.GT.bud, rmse.RGT.bud, rmse.Rlat.bud)

#Rearranging the x-axis for the following figures

bud.model$model <- factor(bud.model$model, levels = c("Lat", "GT", "RGT", "Rlat"))

#Doing the same data wrangling for Leafout data

#Calculating RMSE by species and adding an RMSE column to each model's dataframe

rmse.first.leaf <- first.comb.leaf %>% group_by(species) %>% mutate_each(funs(mean)) %>% distinct %>% mutate(RMSE = sqrt(expdiff))
rmse.GT.leaf <- GT.comb.leaf %>% group_by(species) %>% mutate_each(funs(mean)) %>% distinct %>% mutate(RMSE = sqrt(expdiff))
rmse.RGT.leaf <- RGT.comb.leaf %>% group_by(species) %>% mutate_each(funs(mean)) %>% distinct %>% mutate(RMSE = sqrt(expdiff))
rmse.Rlat.leaf <- Rlat.comb.leaf %>% group_by(species) %>% mutate_each(funs(mean)) %>% distinct %>% mutate(RMSE = sqrt(expdiff))
rmse.Lat.leaf <- Lat.comb.leaf %>% group_by(species) %>% mutate_each(funs(mean)) %>% distinct %>% mutate(RMSE = sqrt(expdiff))

#Selecting only the columns which we need so that columns will match when combining df's; adding model name columns
#Note: make sure to update model names in 'model' column
#Note; I'm pretty sure this averages the latitudes for each species as well

rmse.first.leaf <- rmse.first.leaf %>% select(site_id, latitude, longitude, species, diff, error, RMSE, mid, Yday, type) %>% mutate(model="first")
rmse.GT.leaf <- rmse.GT.leaf %>% select(site_id, latitude, longitude, species, diff, error, RMSE, mid, Yday, type) %>% mutate(model="GT")
rmse.RGT.leaf <- rmse.RGT.leaf %>% select(site_id, latitude, longitude, species, diff, error, RMSE, mid, Yday, type) %>% mutate(model="RGT")
rmse.Rlat.leaf <- rmse.Rlat.leaf %>% select(site_id, latitude, longitude, species, diff, error, RMSE, mid, Yday, type) %>% mutate(model="Rlat")
rmse.Lat.leaf <- rmse.Lat.leaf %>% select(site_id, latitude, longitude, species, diff, error, RMSE, mid, Yday, type) %>% mutate(model="Lat")

#Matching for RMSE diff
rmse.first.leaf$RMSE.org <- 0 
rmse.GT.leaf$RMSE.org <- rmse.first.leaf$RMSE[match(rmse.GT.leaf$species, rmse.first.leaf$species)]
rmse.RGT.leaf$RMSE.org <- rmse.first.leaf$RMSE[match(rmse.RGT.leaf$species, rmse.first.leaf$species)]
rmse.Rlat.leaf$RMSE.org <- rmse.first.leaf$RMSE[match(rmse.Rlat.leaf$species, rmse.first.leaf$species)]
rmse.Lat.leaf$RMSE.org <- rmse.first.leaf$RMSE[match(rmse.Lat.leaf$species, rmse.first.leaf$species)]

rmse.GT.leaf$RMSE.diff <- rmse.GT.leaf$RMSE-rmse.GT.leaf$RMSE.org
rmse.RGT.leaf$RMSE.diff <- rmse.RGT.leaf$RMSE-rmse.RGT.leaf$RMSE.org
rmse.Rlat.leaf$RMSE.diff <- rmse.Rlat.leaf$RMSE-rmse.Rlat.leaf$RMSE.org
rmse.Lat.leaf$RMSE.diff <- rmse.Lat.leaf$RMSE-rmse.Lat.leaf$RMSE.org

#Re-assigning 'type' to each species

spp.valid <- c("ilicifolia", "imbricaria", "marilandica", "stellata", "shumardii")

rmse.first.leaf$type <- ifelse(rmse.first.leaf$species %in% spp.valid, "validation", "calibration")

rmse.GT.leaf$type <- ifelse(rmse.GT.leaf$species %in% spp.valid, "validation", "calibration")

rmse.RGT.leaf$type <- ifelse(rmse.RGT.leaf$species %in% spp.valid, "validation", "calibration")

rmse.Rlat.leaf$type <- ifelse(rmse.Rlat.leaf$species %in% spp.valid, "validation", "calibration")

rmse.Lat.leaf$type <- ifelse(rmse.Lat.leaf$species %in% spp.valid, "validation", "calibration")

#Combining model df's into one df for comparison (excluding 'first')

leaf.model <- rbind(rmse.Lat.leaf, rmse.GT.leaf, rmse.RGT.leaf, rmse.Rlat.leaf)

#Rearranging what will be on the x-axis

leaf.model$model <- factor(leaf.model$model, levels = c("Lat", "GT", "RGT", "Rlat"))

#Figure Generation

first.bud.3 <- ggplot(data=rmse.first.bud, aes(x= model, y=RMSE, fill=type))+
  geom_boxplot(aes(fill=type)) +
  theme_cowplot(12) +
  theme(aspect.ratio = 2, text=element_text(size=18), legend.position = "none") +
  ylim(0, 45) +
  scale_fill_manual(values=c("#404788", "#3CBB75")) +
  xlab("Model")+
  ylab("RMSE (days)")

first.leaf.3 <- ggplot(data=rmse.first.leaf, aes(x= model, y=RMSE, fill=type))+
  geom_boxplot(aes(fill=type)) +
  theme_cowplot(12) +
  theme(aspect.ratio = 2, text=element_text(size=18), legend.position = "none") +
  ylim(0, 45) +
  scale_fill_manual(values=c("#287D8E", "#FDE725")) +
  xlab("Model")+
  ylab("RMSE (days)")

bud.3 <- ggplot(data=bud.model, aes(x= model, y=RMSE.diff, fill=type))+
  geom_boxplot(aes(fill=type)) +
  theme_cowplot(12) +
  geom_hline(linetype="dashed", yintercept=0)+
  theme(text=element_text(size=18)) +
  ylim(-20, 7) +
  scale_fill_manual(values=c("#404788", "#3CBB75")) +
  xlab("Model")+
  ylab("ΔRMSE (days)")

leaf.3 <- ggplot(data=leaf.model, aes(x= model, y=RMSE.diff, fill=type))+
  geom_boxplot(aes(fill=type)) +
  theme_cowplot(12)+
  geom_hline(linetype="dashed", yintercept=0)+
  theme(text=element_text(size=18)) +
  scale_fill_manual(values=c("#287D8E", "#FDE725")) +
  ylim(-20, 7) +
  xlab("Model")+
  ylab("ΔRMSE (days)")

png(width = 8, height=6, units="in", res=600, filename= file.path(path.figures, paste0('Figure 3', '.png')))
plot_grid(first.bud.3, bud.3, first.leaf.3, leaf.3, labels=c('A', 'B', 'C', 'D'), rel_widths=c(1, 2, 1, 2), align = "v", nrow=2, label_size = 18)
dev.off()



#----------------------------------#
#Lucien does error rate table down here
#----------------------------------#
GT.comb.burst$model <- "GT"
RGT.comb.burst$model <- "RGT"
Rlat.comb.burst$model <- "Rlat"
Lat.comb.burst$model <- "Lat"

first.comb.burst <- read.csv(file.path(path.data, paste0('First_Budburst_Prediction_Evaluation_all.csv')))
first.comb.burst$model <- "GDD"

burst.model <- rbind(GT.comb.burst, RGT.comb.burst, Lat.comb.burst, Rlat.comb.burst)

first.b.diff <- aggregate(error~model+site_id+species, data = first.comb.burst,
                          FUN=mean, na.rm=F) 

burst.diff <- aggregate(error~model+site_id+species, data = burst.model,
                        FUN=mean, na.rm=F) 

burst.diff <- rbind(burst.diff, first.b.diff)

error.bud <- aggregate(error~model+species, data = burst.diff,
                       FUN=mean, na.rm=F)

error.bud[,c("sd")] <- aggregate(error~model+species, data = burst.diff,
                                 FUN=sd, na.rm=F)[,c("error")]

write.csv(error.bud, "../data_processed/Bud_error_rates.csv", row.names=T)

report.bud <- aggregate(error~model, data = error.bud,
                         FUN=mean, na.rm=F)

report.bud[,c('sd')] <- aggregate(error~model, data = error.bud,
                                   FUN=sd, na.rm=F)[,c("error")]

#------------------#
#Leafout
#------------------#

GT.comb.leaf$model <- "GT"
RGT.comb.leaf$model <- "RGT"
Rlat.comb.leaf$model <- "Rlat"
Lat.comb.leaf$model <- "Lat"

first.comb.leaf <- read.csv(file.path(path.data, paste0('First_Leaf_Prediction_Evaluation_all.csv')))
first.comb.leaf$model <- "GDD"

leaf.model <- rbind(GT.comb.leaf, RGT.comb.leaf, Lat.comb.leaf, Rlat.comb.leaf)

first.l.diff <- aggregate(error~model+site_id+species, data = first.comb.leaf,
                          FUN=mean, na.rm=F) 


leaf.model <- rbind(GT.comb.leaf, RGT.comb.leaf, Lat.comb.leaf, Rlat.comb.leaf)

leaf.diff <- aggregate(error~model+site_id+species, data = leaf.model,
                       FUN=mean, na.rm=F) 

leaf.diff <- rbind(leaf.diff, first.l.diff)

error.leaf <- aggregate(error~model+species, data = leaf.diff,
                        FUN=mean, na.rm=F)

error.leaf[,c("sd")] <- aggregate(error~model+species, data = leaf.diff,
                                  FUN=sd, na.rm=F)[,c("error")]


write.csv(error.leaf, "../data_processed/Leaf_error_rates.csv", row.names=T)

report.leaf <- aggregate(error~model, data = error.leaf,
                    FUN=mean, na.rm=F)

report.leaf[,c('sd')] <- aggregate(error~model, data = error.leaf,
                    FUN=sd, na.rm=F)[,c("error")]

