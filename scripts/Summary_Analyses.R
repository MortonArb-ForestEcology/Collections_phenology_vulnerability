# Doing some summary analyses to help provide analyses, particularly with latitudinal trends that support manuscript text
# Table of Script Contents -- EVERYTHING NEEDS a species breakdown (supplemental) and a summary based on the species-level summary (manuscript)
# 1. Summary Stats for Arb data leaf out & bud burst
# 2. Summary Stats for NPN data
# 3. Analysis of RMSE & Error Rate in budburst and leaf out
#    3.1. Budburst
#    3.2. Leaf out
#    3.a. Null GDD model
#    3.b. Latitude adjustment  (lat)
#    3.c. Growing Season Temp Adjustment (GT)
#    3.d. RelLat (RLAT)
#    3.e. RelGT  (RGT)
# 4. Analysis of latitudinal trends in budburst and leaf out
#    4.1. Budburst
#    4.2. Leaf out
#    4.a. Null GDD model
#    4.b. Latitude adjustment  (lat)
#    4.c. Growing Season Temp Adjustment (GT)
#    4.d. RelLat (RLAT)
#    4.e. RelGT  (RGT)

library(nlme)
library(dplyr)
library(tidyverse)

path.data <- "../data_processed" 
path.figures <- "../figures_final"
path.hub <- "../data"
path.google <- "/Volumes/GoogleDrive/My Drive/Manuscripts/CollectionsPhenologyVulnerability_CCE_2020" 

######## --------------------------------------------------
# 1. Summary Stats for Arboretum Phenology Data
######## --------------------------------------------------
not.npn <- c('lyrata', 'georgiana', 'pagoda', 'prinoides', 'coccinea', 'ellipsoidalis', 'michauxii', 'meuhlenbergii', 'bicolor')
# ---------------------------------
# Bud Burst
# ---------------------------------
# Getting the raw observation data
arb.bb <- read.csv(file.path(path.data, 'Oak_collection_budburst.csv'))
arb.bb <- tidyr::separate(arb.bb, col = "Species", into=c("Genus", "Species"))
summary(arb.bb)

arb.bb$NPN <- ifelse(arb.bb$Species %in% not.npn, "No NPN data", "NPN")

# Getting the model posteriors
bud.files <- list.files(path = "../data_processed/model_output/", pattern = "OldTT_model_budburst.csv", full.names = T)
bud.stats <- as.data.frame(sapply(bud.files, read.csv, simplify=FALSE) %>% 
                             bind_rows(.id = "id"))
bud.stats <- bud.stats[,c("THRESH", "aPrec", "sd", "species")]


#Seperating columns to help match with npn data
bud.stats <- tidyr::separate(bud.stats, col = "species", into=c("genus", "species"))

#Assigning NPN status to each species
bud.stats$NPN <- ifelse(bud.stats$species %in% not.npn, "No NPN data", "NPN")


# Summarizing Budburst
summary(arb.bb)
arb.bb.sum <- data.frame(Species=unique(arb.bb$Species),
                         n.tree=NA, # Number of trees observed
                         n.obs=NA, # Number of observations over 2 years
                         Obs.DOY=NA, # Med (Min, Max) DOY
                         Obs.GDD=NA, # Median (min, max) GDD
                         Mod.GDD=NA  # median (95 CI) modeled thresh
                         )

for(i in 1:nrow(arb.bb.sum)){
  SPP <- arb.bb.sum$Species[i]
  dat.spp <- arb.bb[arb.bb$Species==SPP,]
  stat.spp <- bud.stats[bud.stats$species==SPP,]
  
  if(!SPP %in% not.npn) arb.bb.sum$Species[i] <- paste0(arb.bb.sum$Species[i], "*")
  arb.bb.sum$n.tree  [i] <- length(unique(dat.spp$PlantNumber))
  arb.bb.sum$n.obs   [i] <- nrow(dat.spp)
  arb.bb.sum$Obs.DOY [i] <- paste0(round(median(dat.spp$Yday)), " (", min(dat.spp$Yday), "-", max(dat.spp$Yday), ")")
  arb.bb.sum$Obs.GDD [i] <- paste0(round(median(dat.spp$GDD5.cum)), " (", round(min(dat.spp$GDD5.cum)), "-", round(max(dat.spp$GDD5.cum)), ")")
  arb.bb.sum$Mod.GDD [i] <- paste0(round(median(stat.spp$THRESH)), " (", round(quantile(stat.spp$THRESH, 0.025)), "-", round(quantile(stat.spp$THRESH, 0.975)), ")")
}

arb.bb.sum <- arb.bb.sum[order(arb.bb.sum$Species),]
write.csv(arb.bb.sum, "../data_processed/ArboretumSummaryStats_BudBurst.csv", row.names=F)
write.csv(arb.bb.sum, file.path(path.google, "Tables/ArboretumSummaryStats_BudBurst.csv"), row.names=F)

# ---------------------------------

# ---------------------------------
# Summarizing Arboretum Leaf out Data 
# ---------------------------------
# Getting the raw arboretum observations
arb.lo <- read.csv(file.path(path.data, 'Oak_collection_leaf.csv'))
arb.lo <- tidyr::separate(arb.lo, col = "Species", into=c("Genus", "Species"))
summary(arb.lo)

arb.lo$NPN <- ifelse(arb.lo$Species %in% not.npn, "No NPN data", "NPN")
#Removing coccinea from oaks.leaf
arb.lo <- arb.lo %>% subset(!(Species == "coccinea"))

# Getting the model posteriors
leaf.files <- list.files(path = "../data_processed/model_output/", pattern = "OldTT_model_leaf.csv", full.names = T)
leaf.stats <- as.data.frame(sapply(leaf.files, read.csv, simplify=FALSE) %>% 
                              bind_rows(.id = "id"))
leaf.stats <- leaf.stats[,c("THRESH", "aPrec", "sd", "species")]
#Seperating columns to help match with npn data
leaf.stats <- tidyr::separate(leaf.stats, col = "species", into=c("genus", "species"))

#Assigning NPN status to each species
leaf.stats$NPN <- ifelse(leaf.stats$species %in% not.npn, "No NPN data", "NPN")

arb.lo.sum <- data.frame(Species=unique(arb.lo$Species),
                         n.tree=NA, # Number of trees observed
                         n.obs=NA, # Number of observations over 2 years
                         Obs.DOY=NA, # Med (Min, Max) DOY
                         Obs.GDD=NA, # Median (min, max) GDD
                         Mod.GDD=NA  # median (95 CI) modeled thresh
)

for(i in 1:nrow(arb.lo.sum)){
  SPP <- arb.lo.sum$Species[i]
  dat.spp <- arb.lo[arb.lo$Species==SPP,]
  stat.spp <- leaf.stats[leaf.stats$species==SPP,]
  
  if(!SPP %in% not.npn) arb.lo.sum$Species[i] <- paste0(arb.lo.sum$Species[i], "*")
  arb.lo.sum$n.tree  [i] <- length(unique(dat.spp$PlantNumber))
  arb.lo.sum$n.obs   [i] <- nrow(dat.spp)
  arb.lo.sum$Obs.DOY [i] <- paste0(round(median(dat.spp$Yday)), " (", min(dat.spp$Yday), "-", max(dat.spp$Yday), ")")
  arb.lo.sum$Obs.GDD [i] <- paste0(round(median(dat.spp$GDD5.cum)), " (", round(min(dat.spp$GDD5.cum)), "-", round(max(dat.spp$GDD5.cum)), ")")
  arb.lo.sum$Mod.GDD [i] <- paste0(round(median(stat.spp$THRESH)), " (", round(quantile(stat.spp$THRESH, 0.025)), "-", round(quantile(stat.spp$THRESH, 0.975)), ")")
}

arb.lo.sum <- arb.lo.sum[order(arb.lo.sum$Species),]
write.csv(arb.lo.sum, "../data_processed/ArboretumSummaryStats_LeafOut.csv", row.names=F)
write.csv(arb.lo.sum, file.path(path.google, "Tables/ArboretumSummaryStats_LeafOut.csv"), row.names=F)
# ---------------------------------

######## --------------------------------------------------





######## --------------------------------------------------
# 4. Analysis of latitudinal trends in budburst and leaf out
#    4.1. Budburst
#    4.2. Leaf out
#    4.a. Null GDD model
#    4.b. Latitude adjustment  (lat)
#    4.c. Growing Season Temp Adjustment (GT)
#    4.d. RelLat (RLAT)
#    4.e. RelGT  (RGT)
######## --------------------------------------------------
# ---------------------------------
# 4.1 Analysis of latitude trends in budburst
# ---------------------------------
bud.gdd <- read.csv(file.path(path.data, 'First_Budburst_Prediction_Evaluation_all.csv'), stringsAsFactors = T)
bud.lat <- read.csv(file.path(path.data, 'Lat_Budburst_Prediction_Evaluation_all.csv'), stringsAsFactors = T)
bud.gt <- read.csv(file.path(path.data, 'GTmean_Budburst_Prediction_Evaluation_all.csv'), stringsAsFactors = T)
bud.rlat <- read.csv(file.path(path.data, 'Rel_Lat_Budburst_Prediction_Evaluation_all.csv'), stringsAsFactors = T)
bud.rgt <- read.csv(file.path(path.data, 'Rel_GTmean_Budburst_Prediction_Evaluation_all.csv'), stringsAsFactors = T)

# The linear mixed model with random effects is more appropriate, but since we only ahve 1 site for marilandica, we need to omit it from the analysis
bud.gdd.lme <- lme(diff ~ latitude*species - latitude - 1, random=list(site_id=~1, individual_id=~1), data=bud.gdd[!bud.gdd$species %in% "marilandica",], na.action=na.omit)
bud.gdd.t <- round(summary(bud.gdd.lme)$tTable, 3)[grep("latitude:", row.names(summary(bud.gdd.lme)$tTable)),]


bud.lat.lme <- lme(diff ~ latitude*species - latitude - 1, random=list(site_id=~1, individual_id=~1), data=bud.lat[!bud.lat$species %in% "marilandica",], na.action=na.omit)
bud.lat.t <- round(summary(bud.lat.lme)$tTable, 3)[grep("latitude:", row.names(summary(bud.lat.lme)$tTable)),]

bud.gt.lme <- lme(diff ~ latitude*species - latitude - 1, random=list(site_id=~1, individual_id=~1), data=bud.gt[!bud.gt$species %in% "marilandica",], na.action=na.omit)
bud.gt.t <- round(summary(bud.gt.lme)$tTable, 3)[grep("latitude:", row.names(summary(bud.gt.lme)$tTable)),]

bud.rlat.lme <- lme(diff ~ latitude*species - latitude - 1, random=list(site_id=~1, individual_id=~1), data=bud.rlat[!bud.rlat$species %in% "marilandica",], na.action=na.omit)
bud.rlat.t <- round(summary(bud.rlat.lme)$tTable, 3)[grep("latitude:", row.names(summary(bud.rlat.lme)$tTable)),]

bud.rgt.lme <- lme(diff ~ latitude*species - latitude - 1, random=list(site_id=~1, individual_id=~1), data=bud.rgt[!bud.rgt$species %in% "marilandica",], na.action=na.omit)
round(summary(bud.rgt.lme)$tTable, 3)[grep("latitude:", row.names(summary(bud.rlat.lme)$tTable)),]
bud.rgt.t <- round(summary(bud.rgt.lme)$tTable, 3)[grep("latitude:", row.names(summary(bud.rgt.lme)$tTable)),]


bud.spatial.stats <- data.frame(Species=gsub("latitude:species", "", row.names(bud.gdd.t)),
                                GDD=paste0(round(bud.gdd.t[,1], 2), " (", round(bud.gdd.t[,2], 2),")", ifelse(bud.gdd.t[,5]<0.05, "*", "")),
                                Lat=paste0(round(bud.lat.t[,1], 2), " (", round(bud.lat.t[,2], 2),")", ifelse(bud.lat.t[,5]<0.05, "*", "")),
                                RLat=paste0(round(bud.rlat.t[,1], 2), " (", round(bud.rlat.t[,2], 2),")", ifelse(bud.rlat.t[,5]<0.05, "*", "")),
                                GT=paste0(round(bud.gt.t[,1], 2), " (", round(bud.gt.t[,2], 2),")", ifelse(bud.gt.t[,5]<0.05, "*", "")),
                                RGT=paste0(round(bud.rgt.t[,1], 2), " (", round(bud.rgt.t[,2], 2),")", ifelse(bud.rgt.t[,5]<0.05, "*", "")))


write.csv(bud.spatial.stats, "../data_processed/LatitudeTrends_ModelComparison_Budburst.csv", row.names=F)
write.csv(bud.spatial.stats, file.path(path.google, "Tables/LatitudeTrends_ModelComparison_Budburst.csv"), row.names=F)
# ---------------------------------


# ---------------------------------
# 4.2. Analysis of latitude trends in Leaf Out
# ---------------------------------
leaf.gdd <- read.csv(file.path(path.data, 'First_Leaf_Prediction_Evaluation_all.csv'), stringsAsFactors = T)
leaf.lat <- read.csv(file.path(path.data, 'Lat_Leaf_Prediction_Evaluation_all.csv'), stringsAsFactors = T)
leaf.gt <- read.csv(file.path(path.data, 'GTmean_Leaf_Prediction_Evaluation_all.csv'), stringsAsFactors = T)
leaf.rlat <- read.csv(file.path(path.data, 'Rel_Lat_Leaf_Prediction_Evaluation_all.csv'), stringsAsFactors = T)
leaf.rgt <- read.csv(file.path(path.data, 'Rel_GTmean_Leaf_Prediction_Evaluation_all.csv'), stringsAsFactors = T)

leaf.gdd.lme <- lme(diff ~ latitude*species - latitude - 1, random=list(site_id=~1, individual_id=~1), data=leaf.gdd[!leaf.gdd$species %in% "marilandica",], na.action=na.omit)
leaf.gdd.t <- round(summary(leaf.gdd.lme)$tTable, 3)[grep("latitude:", row.names(summary(leaf.gdd.lme)$tTable)),]


leaf.lat.lme <- lme(diff ~ latitude*species - latitude - 1, random=list(site_id=~1, individual_id=~1), data=leaf.lat[!leaf.lat$species %in% "marilandica",], na.action=na.omit)
leaf.lat.t <- round(summary(leaf.lat.lme)$tTable, 3)[grep("latitude:", row.names(summary(leaf.lat.lme)$tTable)),]

leaf.gt.lme <- lme(diff ~ latitude*species - latitude - 1, random=list(site_id=~1, individual_id=~1), data=leaf.gt[!leaf.gt$species %in% "marilandica",], na.action=na.omit)
leaf.gt.t <- round(summary(leaf.gt.lme)$tTable, 3)[grep("latitude:", row.names(summary(leaf.gt.lme)$tTable)),]

leaf.rlat.lme <- lme(diff ~ latitude*species - latitude - 1, random=list(site_id=~1, individual_id=~1), data=leaf.rlat[!leaf.rlat$species %in% "marilandica",], na.action=na.omit)
leaf.rlat.t <- round(summary(leaf.rlat.lme)$tTable, 3)[grep("latitude:", row.names(summary(leaf.rlat.lme)$tTable)),]

leaf.rgt.lme <- lme(diff ~ latitude*species - latitude - 1, random=list(site_id=~1, individual_id=~1), data=leaf.rgt[!leaf.rgt$species %in% "marilandica",], na.action=na.omit)
round(summary(leaf.rgt.lme)$tTable, 3)[grep("latitude:", row.names(summary(leaf.rlat.lme)$tTable)),]
leaf.rgt.t <- round(summary(leaf.rgt.lme)$tTable, 3)[grep("latitude:", row.names(summary(leaf.rgt.lme)$tTable)),]


leaf.spatial.stats <- data.frame(Species=gsub("latitude:species", "", row.names(leaf.gdd.t)),
                                GDD=paste0(round(leaf.gdd.t[,1], 2), " (", round(leaf.gdd.t[,2], 2),")", ifelse(leaf.gdd.t[,5]<0.05, "*", "")),
                                Lat=paste0(round(leaf.lat.t[,1], 2), " (", round(leaf.lat.t[,2], 2),")", ifelse(leaf.lat.t[,5]<0.05, "*", "")),
                                RLat=paste0(round(leaf.rlat.t[,1], 2), " (", round(leaf.rlat.t[,2], 2),")", ifelse(leaf.rlat.t[,5]<0.05, "*", "")),
                                GT=paste0(round(leaf.gt.t[,1], 2), " (", round(leaf.gt.t[,2], 2),")", ifelse(leaf.gt.t[,5]<0.05, "*", "")),
                                RGT=paste0(round(leaf.rgt.t[,1], 2), " (", round(leaf.rgt.t[,2], 2),")", ifelse(leaf.rgt.t[,5]<0.05, "*", "")))


write.csv(leaf.spatial.stats, "../data_processed/LatitudeTrends_ModelComparison_LeafOut.csv", row.names=F)
write.csv(leaf.spatial.stats, file.path(path.google, "Tables/LatitudeTrends_ModelComparison_LeafOut.csv"), row.names=F)


# ---------------------------------
######## --------------------------------------------------
