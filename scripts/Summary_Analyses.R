# Doing some summary analyses to help provide analyses, particularly with latitudinal trends that support manuscript text
# Table of Script Contents
# 1. Analysis of latitudinal trends in budburst and leaf out
#    1.1. Budburst
#    1.2. Leaf out
#    1.a. Null GDD model
#    1.b. Latitude adjustment  (lat)
#    1.c. Growing Season Temp Adjustment (GT)
#    1.d. RelLat (RLAT)
#    1.e. RelGT  (RGT)

library(nlme)
path.data <- "../data_processed" 
path.figures <- "../figures_final"
path.hub <- "../data"
path.google <- "/Volumes/GoogleDrive/My Drive/Manuscripts/CollectionsPhenologyVulnerability_CCE_2020" 

######## --------------------------------------------------
# 1. Analysis of latitudinal trends in budburst and leaf out
#    1.1. Budburst
#    1.2. Leaf out
#    1.a. Null GDD model
#    1.b. Latitude adjustment  (lat)
#    1.c. Growing Season Temp Adjustment (GT)
#    1.d. RelLat (RLAT)
#    1.e. RelGT  (RGT)
######## --------------------------------------------------
# ---------------------------------
# 1.1 Analysis of latitude trends in budburst
# ---------------------------------
bud.gdd <- read.csv(file.path(path.data, 'First_Budburst_Prediction_Evaluation_all.csv'), stringsAsFactors = T)
bud.lat <- read.csv(file.path(path.data, 'Lat_Budburst_Prediction_Evaluation_all.csv'), stringsAsFactors = T)
bud.gt <- read.csv(file.path(path.data, 'GTmean_Budburst_Prediction_Evaluation_all.csv'), stringsAsFactors = T)
bud.rlat <- read.csv(file.path(path.data, 'Rel_Lat_Budburst_Prediction_Evaluation_all.csv'), stringsAsFactors = T)
bud.rgt <- read.csv(file.path(path.data, 'Rel_GTmean_Budburst_Prediction_Evaluation_all.csv'), stringsAsFactors = T)

# The linear mixed model with random effects is more appropriate, but since we only ahve 1 site for marilandica, we need to omit it from the analysis
bud.gdd.lme <- lme(diff ~ latitude*species - latitude - 1, random=list(site_id=~1, individual_id=~1), data=bud.gdd[!bud.gdd$species %in% "marilandica",], na.action=na.omit)
bud.gdd.t <- round(summary(bud.gdd.lme)$tTable, 3)[grep("latitude:", row.names(summary(bud.gdd.lme)$tTable)),]


bud.lat.lme <- lme(diff ~ latitude*species - latitude - 1, random=list(site_id=~1, individual_id=~1), data=bud.lat[!bud.lat$species %in% "marilandica",], na.action=na.omit)
bud.lat.t <- round(summary(bud.lat.lme)$tTable, 3)[grep("latitude:", row.names(summary(bud.lat.lme)$tTable)),]

bud.gt.lme <- lme(diff ~ latitude*species - latitude - 1, random=list(site_id=~1, individual_id=~1), data=bud.gt[!bud.gt$species %in% "marilandica",], na.action=na.omit)
bud.gt.t <- round(summary(bud.gt.lme)$tTable, 3)[grep("latitude:", row.names(summary(bud.gt.lme)$tTable)),]

bud.rlat.lme <- lme(diff ~ latitude*species - latitude - 1, random=list(site_id=~1, individual_id=~1), data=bud.rlat[!bud.rlat$species %in% "marilandica",], na.action=na.omit)
bud.rlat.t <- round(summary(bud.rlat.lme)$tTable, 3)[grep("latitude:", row.names(summary(bud.rlat.lme)$tTable)),]

bud.rgt.lme <- lme(diff ~ latitude*species - latitude - 1, random=list(site_id=~1, individual_id=~1), data=bud.rgt[!bud.rgt$species %in% "marilandica",], na.action=na.omit)
round(summary(bud.rgt.lme)$tTable, 3)[grep("latitude:", row.names(summary(bud.rlat.lme)$tTable)),]
bud.rgt.t <- round(summary(bud.rgt.lme)$tTable, 3)[grep("latitude:", row.names(summary(bud.rgt.lme)$tTable)),]


bud.spatial.stats <- data.frame(Species=gsub("latitude:species", "", row.names(bud.gdd.t)),
                                GDD=paste0(round(bud.gdd.t[,1], 2), " (", round(bud.gdd.t[,2], 2),")", ifelse(bud.gdd.t[,5]<0.05, "*", "")),
                                Lat=paste0(round(bud.lat.t[,1], 2), " (", round(bud.lat.t[,2], 2),")", ifelse(bud.lat.t[,5]<0.05, "*", "")),
                                RLat=paste0(round(bud.rlat.t[,1], 2), " (", round(bud.rlat.t[,2], 2),")", ifelse(bud.rlat.t[,5]<0.05, "*", "")),
                                GT=paste0(round(bud.gt.t[,1], 2), " (", round(bud.gt.t[,2], 2),")", ifelse(bud.gt.t[,5]<0.05, "*", "")),
                                RGT=paste0(round(bud.rgt.t[,1], 2), " (", round(bud.rgt.t[,2], 2),")", ifelse(bud.rgt.t[,5]<0.05, "*", "")))


write.csv(bud.spatial.stats, "../data_processed/LatitudeTrends_ModelComparison_Budburst.csv", row.names=F)
write.csv(bud.spatial.stats, file.path(path.google, "Tables/LatitudeTrends_ModelComparison_Budburst.csv"), row.names=F)
# ---------------------------------


# ---------------------------------
# 1.2. Analysis of latitude trends in Leaf Out
# ---------------------------------
leaf.gdd <- read.csv(file.path(path.data, 'First_Leaf_Prediction_Evaluation_all.csv'), stringsAsFactors = T)
leaf.lat <- read.csv(file.path(path.data, 'Lat_Leaf_Prediction_Evaluation_all.csv'), stringsAsFactors = T)
leaf.gt <- read.csv(file.path(path.data, 'GTmean_Leaf_Prediction_Evaluation_all.csv'), stringsAsFactors = T)
leaf.rlat <- read.csv(file.path(path.data, 'Rel_Lat_Leaf_Prediction_Evaluation_all.csv'), stringsAsFactors = T)
leaf.rgt <- read.csv(file.path(path.data, 'Rel_GTmean_Leaf_Prediction_Evaluation_all.csv'), stringsAsFactors = T)

leaf.gdd.lme <- lme(diff ~ latitude*species - latitude - 1, random=list(site_id=~1, individual_id=~1), data=leaf.gdd[!leaf.gdd$species %in% "marilandica",], na.action=na.omit)
leaf.gdd.t <- round(summary(leaf.gdd.lme)$tTable, 3)[grep("latitude:", row.names(summary(leaf.gdd.lme)$tTable)),]


leaf.lat.lme <- lme(diff ~ latitude*species - latitude - 1, random=list(site_id=~1, individual_id=~1), data=leaf.lat[!leaf.lat$species %in% "marilandica",], na.action=na.omit)
leaf.lat.t <- round(summary(leaf.lat.lme)$tTable, 3)[grep("latitude:", row.names(summary(leaf.lat.lme)$tTable)),]

leaf.gt.lme <- lme(diff ~ latitude*species - latitude - 1, random=list(site_id=~1, individual_id=~1), data=leaf.gt[!leaf.gt$species %in% "marilandica",], na.action=na.omit)
leaf.gt.t <- round(summary(leaf.gt.lme)$tTable, 3)[grep("latitude:", row.names(summary(leaf.gt.lme)$tTable)),]

leaf.rlat.lme <- lme(diff ~ latitude*species - latitude - 1, random=list(site_id=~1, individual_id=~1), data=leaf.rlat[!leaf.rlat$species %in% "marilandica",], na.action=na.omit)
leaf.rlat.t <- round(summary(leaf.rlat.lme)$tTable, 3)[grep("latitude:", row.names(summary(leaf.rlat.lme)$tTable)),]

leaf.rgt.lme <- lme(diff ~ latitude*species - latitude - 1, random=list(site_id=~1, individual_id=~1), data=leaf.rgt[!leaf.rgt$species %in% "marilandica",], na.action=na.omit)
round(summary(leaf.rgt.lme)$tTable, 3)[grep("latitude:", row.names(summary(leaf.rlat.lme)$tTable)),]
leaf.rgt.t <- round(summary(leaf.rgt.lme)$tTable, 3)[grep("latitude:", row.names(summary(leaf.rgt.lme)$tTable)),]


leaf.spatial.stats <- data.frame(Species=gsub("latitude:species", "", row.names(leaf.gdd.t)),
                                GDD=paste0(round(leaf.gdd.t[,1], 2), " (", round(leaf.gdd.t[,2], 2),")", ifelse(leaf.gdd.t[,5]<0.05, "*", "")),
                                Lat=paste0(round(leaf.lat.t[,1], 2), " (", round(leaf.lat.t[,2], 2),")", ifelse(leaf.lat.t[,5]<0.05, "*", "")),
                                RLat=paste0(round(leaf.rlat.t[,1], 2), " (", round(leaf.rlat.t[,2], 2),")", ifelse(leaf.rlat.t[,5]<0.05, "*", "")),
                                GT=paste0(round(leaf.gt.t[,1], 2), " (", round(leaf.gt.t[,2], 2),")", ifelse(leaf.gt.t[,5]<0.05, "*", "")),
                                RGT=paste0(round(leaf.rgt.t[,1], 2), " (", round(leaf.rgt.t[,2], 2),")", ifelse(leaf.rgt.t[,5]<0.05, "*", "")))


write.csv(leaf.spatial.stats, "../data_processed/LatitudeTrends_ModelComparison_LeafOut.csv", row.names=F)
write.csv(leaf.spatial.stats, file.path(path.google, "Tables/LatitudeTrends_ModelComparison_LeafOut.csv"), row.names=F)


# ---------------------------------
######## --------------------------------------------------
