#Figures moving into the final stages of the paper
#Script sections are ordered by figure.

library(ggplot2)
library(cowplot)

path.data <- "C:/Users/giama/OneDrive/Documents/R/Morton_Phenology/data_processed" 
path.figures <- "C:/Users/giama/OneDrive/Documents/R/Morton_Phenology/figures/Arb_Pheno/final_figures"

#--------------------------------------------------------------------------------#

#------------------#
# ~~~ FIGURE 1 ~~~ #
#------------------#

oaks.bud <- read.csv(file.path(path.data, paste0('Oak_collection_budburst.csv')))
oaks.leaf <- read.csv(file.path(path.data, paste0('Oak_collection_leaf.csv')))

#Selecting, (if one chooses) only calibration and validation species

#oaks.bud <- oaks.bud[oaks.bud$Species %in% c("Quercus ilicifolia", "Quercus imbricaria", "Quercus marilandica", "Quercus stellata", "Quercus shumardii", "Quercus alba", "Quercus gambelii", "Quercus macrocarpa", "Quercus velutina", "Quercus rubra", "Quercus montana", "Quercus palustris"),]
#oaks.leaf <- oaks.leaf[oaks.leaf$Species %in% c("Quercus ilicifolia", "Quercus imbricaria", "Quercus marilandica", "Quercus stellata", "Quercus shumardii", "Quercus alba", "Quercus gambelii", "Quercus macrocarpa", "Quercus velutina", "Quercus rubra", "Quercus montana", "Quercus palustris"),]

#Excluding Genus name from Species column

oaks.bud[oaks.bud$Species == "Quercus alba",1] <- "alba"
oaks.bud[oaks.bud$Species == "Quercus ilicifolia",1] <- "ilicifolia"
oaks.bud[oaks.bud$Species == "Quercus imbricaria",1] <- "imbricaria"
oaks.bud[oaks.bud$Species == "Quercus marilandica",1] <- "marilandica"
oaks.bud[oaks.bud$Species == "Quercus stellata",1] <- "stellata"
oaks.bud[oaks.bud$Species == "Quercus shumardii",1] <- "shumardii"
oaks.bud[oaks.bud$Species == "Quercus gambelii",1] <- "gambelii"
oaks.bud[oaks.bud$Species == "Quercus macrocarpa",1] <- "macrocarpa"
oaks.bud[oaks.bud$Species == "Quercus velutina",1] <- "velutina"
oaks.bud[oaks.bud$Species == "Quercus rubra",1] <- "rubra"
oaks.bud[oaks.bud$Species == "Quercus montana",1] <- "montana"
oaks.bud[oaks.bud$Species == "Quercus palustris",1] <- "palustris"
oaks.bud[oaks.bud$Species == "Quercus lyrata",1] <- "lyrata"
oaks.bud[oaks.bud$Species == "Quercus ellipsoidalis",1] <- "ellipsoidalis"
oaks.bud[oaks.bud$Species == "Quercus bicolor",1] <- "bicolor"
oaks.bud[oaks.bud$Species == "Quercus muehlenbergii",1] <- "muehlenbergii"
oaks.bud[oaks.bud$Species == "Quercus michauxii",1] <- "michauxii"
oaks.bud[oaks.bud$Species == "Quercus georgiana",1] <- "georgiana"
oaks.bud[oaks.bud$Species == "Quercus pagoda",1] <- "pagoda"
oaks.bud[oaks.bud$Species == "Quercus prinoides",1] <- "prinoides"

oaks.leaf[oaks.leaf$Species == "Quercus alba",1] <- "alba"
oaks.leaf[oaks.leaf$Species == "Quercus ilicifolia",1] <- "ilicifolia"
oaks.leaf[oaks.leaf$Species == "Quercus imbricaria",1] <- "imbricaria"
oaks.leaf[oaks.leaf$Species == "Quercus marilandica",1] <- "marilandica"
oaks.leaf[oaks.leaf$Species == "Quercus stellata",1] <- "stellata"
oaks.leaf[oaks.leaf$Species == "Quercus shumardii",1] <- "shumardii"
oaks.leaf[oaks.leaf$Species == "Quercus gambelii",1] <- "gambelii"
oaks.leaf[oaks.leaf$Species == "Quercus macrocarpa",1] <- "macrocarpa"
oaks.leaf[oaks.leaf$Species == "Quercus velutina",1] <- "velutina"
oaks.leaf[oaks.leaf$Species == "Quercus rubra",1] <- "rubra"
oaks.leaf[oaks.leaf$Species == "Quercus montana",1] <- "montana"
oaks.leaf[oaks.leaf$Species == "Quercus palustris",1] <- "palustris"
oaks.leaf[oaks.leaf$Species == "Quercus lyrata",1] <- "lyrata"
oaks.leaf[oaks.leaf$Species == "Quercus ellipsoidalis",1] <- "ellipsoidalis"
oaks.leaf[oaks.leaf$Species == "Quercus bicolor",1] <- "bicolor"
oaks.leaf[oaks.leaf$Species == "Quercus muehlenbergii",1] <- "muehlenbergii"
oaks.leaf[oaks.leaf$Species == "Quercus michauxii",1] <- "michauxii"
oaks.leaf[oaks.leaf$Species == "Quercus georgiana",1] <- "georgiana"
oaks.leaf[oaks.leaf$Species == "Quercus pagoda",1] <- "pagoda"
oaks.leaf[oaks.leaf$Species == "Quercus prinoides",1] <- "prinoides"
oaks.leaf[oaks.leaf$Species == "Quercus coccinea",1] <- "coccinea"

bud.1 <- ggplot(data=oaks.bud, aes(x= Species, y=GDD5.cum))+
  geom_boxplot() +
  theme_cowplot(12)+
  theme(text=element_text(size=18), axis.text.x = element_text(size = 8)) +
  #scale_fill_manual(values=c("#FA7876", "#F3B584")) +
  #ylim(0, 45) +
  xlab("Species")+
  ylab("GDD5.cum (days)")

leaf.1 <- ggplot(data=oaks.leaf, aes(x= Species, y=GDD5.cum))+
  geom_boxplot() +
  theme_cowplot(12)+
  theme(text=element_text(size=18), axis.text.x = element_text(size = 8)) +
  #scale_fill_manual(values=c("#FA7876", "#F3B584")) +
  #ylim(0, 45) +
  xlab("Species")+
  ylab("GDD5.cum (days)")

png(width = 1000, filename= file.path(path.figures, paste0('Figure 1', '.png')))
plot_grid(bud.1, leaf.1, labels=c('A', 'B'), align = "v", nrow=2, label_size = 18)
dev.off()

#-------------------------------------------------------------------------------------------------#

#------------------#
# ~~~ FIGURE 2 ~~~ #
#------------------#

bud.eval <- read.csv(file.path(path.data, paste0('Budburst_Prediction_Evaluation_all.csv')))
leaf.eval <- read.csv(file.path(path.data, paste0('Leaf_Prediction_Evaluation_all.csv')))

spp.valid <- c("ilicifolia", "imbricaria", "marilandica", "stellata", "shumardii")

bud.eval[bud.eval$species %in% spp.valid,"type"] <- "validation"
bud.eval[!bud.eval$species %in% spp.valid,"type"] <- "calibration"

leaf.eval[leaf.eval$species %in% spp.valid,"type"] <- "validation"
leaf.eval[!leaf.eval$species %in% spp.valid,"type"] <- "calibration"
  
bud.2 <- ggplot(bud.eval, aes(x = latitude, y = diff, color = type))+
  geom_smooth(method='lm', se = TRUE, alpha=0.5, aes(fill=type, color=type))+
  geom_vline(linetype="dashed", xintercept=41.8)+
  theme_cowplot(12) +
  geom_jitter(alpha=0.5, size=0.5, aes(shape=type)) +
  scale_color_manual(values=c("#440154", "#55C667")) +
  scale_fill_manual(values=c("#440154", "#55C667")) +
  xlab("Latitude")+
  ylab("Resid.")

leaf.2 <- ggplot(leaf.eval, aes(x = latitude, y = diff, color = type))+
  geom_smooth(method='lm', se = TRUE, alpha=0.5, aes(fill=type, color=type))+
  geom_vline(linetype="dashed", xintercept=41.8)+
  theme_cowplot(12) +
  geom_jitter(alpha=0.5, size=0.5, aes(shape=type)) +
  scale_color_manual(values=c("#440154", "#55C667")) +
  scale_fill_manual(values=c("#440154", "#55C667")) +
  xlab("Latitude")+
  ylab("Resid.")

png(width = 800, filename= file.path(path.figures, paste0('Figure 2', '.png')))
plot_grid(bud.2, leaf.2, labels=c('A', 'B'), align = "v", nrow=2, label_size = 18)
dev.off()


#Alternate Fig. 2

#The following is for if we choose to combine leaf and bud into 1 df and plot 
bud.eval.1 <- select(bud.eval, species, latitude, diff, type)
leaf.eval.1 <- select(bud.eval, species, latitude, diff, type)

comb.eval <- merge(bud.eval, leaf.eval)

comb.A <- ggplot(comb.eval, aes(x = latitude, y = diff, color = type))+
  geom_smooth(method='lm', se = TRUE, alpha=0.5, aes(fill=type, color=type))+
  geom_vline(linetype="dashed", xintercept=41.8)+
  theme_cowplot(12) +
  geom_jitter(alpha=0.5, size=0.5, aes(shape=type)) +
  scale_color_manual(values=c("#440154", "#55C667")) +
  scale_fill_manual(values=c("#440154", "#55C667")) +
  xlab("Latitude")+
  ylab("Resid.")

comb.B <- #will be same as comb.A except the x-axis will be GT instead of Latitude (awaiting data)
  
#placeholder png function for this figure
  
#Options: 
#(A) plot_grid 4 panels in one figure (Q2: Bud Resid vs Lat, Q3: Leaf Resid vs Lat, Q1: Bud Resid vs GT, Q4: Leaf Resid vs GT),
#(B) two different figures: Fig 1 = Bud Resid vs Lat on left, Bud Resid vs GT on right, Fig 2: Leaf Resid vs Lat on left, Leaf Resid vs GT on right 
#(C) combine leaf and bud plots into one, Resid vs Lat on left, Resid vs GT on right.

#--------------------------------------------------------------------------------#
  
#------------------#
# ~~~ FIGURE 3 ~~~ #
#------------------#

#Reading in model data

#Budburst model dfs

first.comb.burst <- read.csv(file.path(path.data, paste0('First_Budburst_Prediction_Evaluation_all.csv')))
GT.comb.burst <- read.csv(file.path(path.data, paste0('GTmean_Budburst_Prediction_Evaluation_all.csv')))
RGT.comb.burst <- read.csv(file.path(path.data, paste0('Rel_GTmean_Budburst_Prediction_Evaluation_all.csv')))
Rlat.comb.burst <- read.csv(file.path(path.data, paste0('Rel_Lat_Budburst_Prediction_Evaluation_all.csv')))
Lat.comb.burst <- read.csv(file.path(path.data, paste0('Lat_Budburst_Prediction_Evaluation_all.csv')))

#Leafout model dfs

first.comb.leaf <- read.csv(file.path(path.data, paste0('First_Leaf_Prediction_Evaluation_all.csv')))
GT.comb.leaf <- read.csv(file.path(path.data, paste0('GTmean_Leaf_Prediction_Evaluation_all.csv')))
RGT.comb.leaf <- read.csv(file.path(path.data, paste0('Rel_GTmean_Leaf_Prediction_Evaluation_all.csv')))
Rlat.comb.leaf <- read.csv(file.path(path.data, paste0('Rel_Lat_Leaf_Prediction_Evaluation_all.csv')))
Lat.comb.leaf <- read.csv(file.path(path.data, paste0('Lat_Leaf_Prediction_Evaluation_all.csv')))

#Wrangling Budburst data

#Calculating RMSE by species and adding an RMSE column to each model's dataframe

rmse.first.bud <- first.comb.burst %>% group_by(species) %>% mutate_each(funs(mean)) %>% distinct %>% mutate(RMSE = sqrt(expdiff))
rmse.GT.bud <- GT.comb.burst %>% group_by(species) %>% mutate_each(funs(mean)) %>% distinct %>% mutate(RMSE = sqrt(expdiff))
rmse.RGT.bud <- RGT.comb.burst %>% group_by(species) %>% mutate_each(funs(mean)) %>% distinct %>% mutate(RMSE = sqrt(expdiff))
rmse.Rlat.bud <- Rlat.comb.burst %>% group_by(species) %>% mutate_each(funs(mean)) %>% distinct %>% mutate(RMSE = sqrt(expdiff))
rmse.Lat.bud <- Lat.comb.burst %>% group_by(species) %>% mutate_each(funs(mean)) %>% distinct %>% mutate(RMSE = sqrt(expdiff))

#Selecting only the columns which we need so that columns will match when combining df's; adding model name columns
#Note: make sure to update model names in 'model' column
#Note; I'm pretty sure this averages the latitudes for each species as well

rmse.first.bud <- rmse.first.bud %>% select(site_id, latitude, longitude, species, diff, error, RMSE, mid, Yday, type) %>% mutate(model="first")
rmse.GT.bud <- rmse.GT.bud %>% select(site_id, latitude, longitude, species, diff, error, RMSE, mid, Yday, type) %>% mutate(model="GT")
rmse.RGT.bud <- rmse.RGT.bud %>% select(site_id, latitude, longitude, species, diff, error, RMSE, mid, Yday, type) %>% mutate(model="RGT")
rmse.Rlat.bud <- rmse.Rlat.bud %>% select(site_id, latitude, longitude, species, diff, error, RMSE, mid, Yday, type) %>% mutate(model="Rlat")
rmse.Lat.bud <- rmse.Lat.bud %>% select(site_id, latitude, longitude, species, diff, error, RMSE, mid, Yday, type) %>% mutate(model="Lat")

#Re-assigning 'type' to each species

spp.valid <- c("ilicifolia", "imbricaria", "marilandica", "stellata", "shumardii")

rmse.first.bud$type <- ifelse(rmse.first.bud$species %in% spp.valid, "validation", "calibration")

rmse.GT.bud$type <- ifelse(rmse.GT.bud$species %in% spp.valid, "validation", "calibration")

rmse.RGT.bud$type <- ifelse(rmse.RGT.bud$species %in% spp.valid, "validation", "calibration")

rmse.Rlat.bud$type <- ifelse(rmse.Rlat.bud$species %in% spp.valid, "validation", "calibration")

rmse.Lat.bud$type <- ifelse(rmse.Lat.bud$species %in% spp.valid, "validation", "calibration")


#Combining model df's into one df for comparison

bud.model <- rbind(rmse.first.bud, rmse.Lat.bud, rmse.GT.bud, rmse.RGT.bud, rmse.Rlat.bud)

#Rearranging the x-axis for the following figures

bud.model$model <- factor(bud.model$model, levels = c("first", "Lat", "GT", "RGT", "Rlat"))

#Doing the same data wrangling for Leafout data

#Calculating RMSE by species and adding an RMSE column to each model's dataframe

rmse.first.leaf <- first.comb.leaf %>% group_by(species) %>% mutate_each(funs(mean)) %>% distinct %>% mutate(RMSE = sqrt(expdiff))
rmse.GT.leaf <- GT.comb.leaf %>% group_by(species) %>% mutate_each(funs(mean)) %>% distinct %>% mutate(RMSE = sqrt(expdiff))
rmse.RGT.leaf <- RGT.comb.leaf %>% group_by(species) %>% mutate_each(funs(mean)) %>% distinct %>% mutate(RMSE = sqrt(expdiff))
rmse.Rlat.leaf <- Rlat.comb.leaf %>% group_by(species) %>% mutate_each(funs(mean)) %>% distinct %>% mutate(RMSE = sqrt(expdiff))
rmse.Lat.leaf <- Lat.comb.leaf %>% group_by(species) %>% mutate_each(funs(mean)) %>% distinct %>% mutate(RMSE = sqrt(expdiff))

#Selecting only the columns which we need so that columns will match when combining df's; adding model name columns
#Note: make sure to update model names in 'model' column
#Note; I'm pretty sure this averages the latitudes for each species as well

rmse.first.leaf <- rmse.first.leaf %>% select(site_id, latitude, longitude, species, diff, error, RMSE, mid, Yday, type) %>% mutate(model="first")
rmse.GT.leaf <- rmse.GT.leaf %>% select(site_id, latitude, longitude, species, diff, error, RMSE, mid, Yday, type) %>% mutate(model="GT")
rmse.RGT.leaf <- rmse.RGT.leaf %>% select(site_id, latitude, longitude, species, diff, error, RMSE, mid, Yday, type) %>% mutate(model="RGT")
rmse.Rlat.leaf <- rmse.Rlat.leaf %>% select(site_id, latitude, longitude, species, diff, error, RMSE, mid, Yday, type) %>% mutate(model="Rlat")
rmse.Lat.leaf <- rmse.Lat.leaf %>% select(site_id, latitude, longitude, species, diff, error, RMSE, mid, Yday, type) %>% mutate(model="Lat")

#Re-assigning 'type' to each species

spp.valid <- c("ilicifolia", "imbricaria", "marilandica", "stellata", "shumardii")

rmse.first.leaf$type <- ifelse(rmse.first.leaf$species %in% spp.valid, "validation", "calibration")

rmse.GT.leaf$type <- ifelse(rmse.GT.leaf$species %in% spp.valid, "validation", "calibration")

rmse.RGT.leaf$type <- ifelse(rmse.RGT.leaf$species %in% spp.valid, "validation", "calibration")

rmse.Rlat.leaf$type <- ifelse(rmse.Rlat.leaf$species %in% spp.valid, "validation", "calibration")

rmse.Lat.leaf$type <- ifelse(rmse.Lat.leaf$species %in% spp.valid, "validation", "calibration")

#Combining model df's into one df for comparison

leaf.model <- rbind(rmse.first.leaf, rmse.Lat.leaf, rmse.GT.leaf, rmse.RGT.leaf, rmse.Rlat.leaf)

#Rearranging what will be on the x-axis

leaf.model$model <- factor(leaf.model$model, levels = c("first", "Lat", "GT", "RGT", "Rlat"))

#Figure Generation

bud.3 <- ggplot(data=bud.model, aes(x= model, y=RMSE, fill=type))+
  geom_boxplot(aes(fill=type)) +
  theme_cowplot(12) +
  theme(text=element_text(size=18)) +
  ylim(0, 45) +
  scale_fill_manual(values=c("#A3319F", "#DF488D")) +
  xlab("Model")+
  ylab("RMSE (days)")

leaf.3 <- ggplot(data=leaf.model, aes(x= model, y=RMSE, fill=type))+
  geom_boxplot(aes(fill=type)) +
  theme_cowplot(12)+
  theme(text=element_text(size=18)) +
  scale_fill_manual(values=c("#FA7876", "#F3B584")) +
  ylim(0, 45) +
  xlab("Model")+
  ylab("RMSE (days)")

png(width = 500, height=600, filename= file.path(path.figures, paste0('Figure 3', '.png')))
plot_grid(bud.3, leaf.3, labels=c('A', 'B'), align = "v", nrow=2, label_size = 18)
dev.off()

#IDEA: group by type rather than species and toy around with that (only two groupings)
