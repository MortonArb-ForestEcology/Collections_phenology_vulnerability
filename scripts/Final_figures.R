#Figures moving into the final stages of the paper

library(ggplot2)
library(cowplot)

path.data <- "C:/Users/giama/OneDrive/Documents/R/Morton_Phenology/data_processed" 
path.figures <- "C:/Users/giama/OneDrive/Documents/R/Morton_Phenology/figures/Arb_Pheno/final_figures"

#This script gets the data for budburst and leafout squared away first in separate sections
#Then we move on to figure generation using the two datasets at the end

#--------------------------#
# ~~~ Budburst Section ~~~ #
#--------------------------#

#Reading in df's for calibration and validation data

first.comb.burst <- read.csv(file.path(path.data, paste0('First_Budburst_Prediction_Evaluation_all.csv')))
GT.comb.burst <- read.csv(file.path(path.data, paste0('GTmean_Budburst_Prediction_Evaluation_all.csv')))
RGT.comb.burst <- read.csv(file.path(path.data, paste0('Rel_GTmean_Budburst_Prediction_Evaluation_all.csv')))
Rlat.comb.burst <- read.csv(file.path(path.data, paste0('Rel_Lat_Budburst_Prediction_Evaluation_all.csv')))
Lat.comb.burst <- read.csv(file.path(path.data, paste0('Lat_Budburst_Prediction_Evaluation_all.csv')))

#Calculating RMSE by species and adding an RMSE column to each model's dataframe

rmse.first.bud <- first.comb.burst %>% group_by(species) %>% mutate_each(funs(mean)) %>% distinct %>% mutate(RMSE = sqrt(expdiff))
rmse.GT.bud <- GT.comb.burst %>% group_by(species) %>% mutate_each(funs(mean)) %>% distinct %>% mutate(RMSE = sqrt(expdiff))
rmse.RGT.bud <- RGT.comb.burst %>% group_by(species) %>% mutate_each(funs(mean)) %>% distinct %>% mutate(RMSE = sqrt(expdiff))
rmse.Rlat.bud <- Rlat.comb.burst %>% group_by(species) %>% mutate_each(funs(mean)) %>% distinct %>% mutate(RMSE = sqrt(expdiff))
rmse.Lat.bud <- Lat.comb.burst %>% group_by(species) %>% mutate_each(funs(mean)) %>% distinct %>% mutate(RMSE = sqrt(expdiff))

#Selecting only the columns which we need so that columns will match when combining df's; adding model name columns
#Note: make sure to update model names in 'model' column
#Note; I'm pretty sure this averages the latitudes for each species as well

rmse.first.bud <- rmse.first.bud %>% select(site_id, latitude, longitude, species, diff, error, RMSE, mid, Yday, type) %>% mutate(model="first")
rmse.GT.bud <- rmse.GT.bud %>% select(site_id, latitude, longitude, species, diff, error, RMSE, mid, Yday, type) %>% mutate(model="GT")
rmse.RGT.bud <- rmse.RGT.bud %>% select(site_id, latitude, longitude, species, diff, error, RMSE, mid, Yday, type) %>% mutate(model="RGT")
rmse.Rlat.bud <- rmse.Rlat.bud %>% select(site_id, latitude, longitude, species, diff, error, RMSE, mid, Yday, type) %>% mutate(model="Rlat")
rmse.Lat.bud <- rmse.Lat.bud %>% select(site_id, latitude, longitude, species, diff, error, RMSE, mid, Yday, type) %>% mutate(model="Lat")

#Re-assigning 'type' to each species
#Is there a more concise way of doing this?
#Thanks, Christy!

spp.valid <- c("ilicifolia", "imbricaria", "marilandica", "stellata", "shumardii")

rmse.first.bud[rmse.first.bud$species %in% spp.valid,"type"] <- "validation"
rmse.first.bud[!rmse.first.bud$species %in% spp.valid,"type"] <- "calibration"

rmse.GT.bud[rmse.GT.bud$species %in% spp.valid,"type"] <- "validation"
rmse.GT.bud[!rmse.GT.bud$species %in% spp.valid,"type"] <- "calibration"

rmse.RGT.bud[rmse.RGT.bud$species %in% spp.valid,"type"] <- "validation"
rmse.RGT.bud[!rmse.RGT.bud$species %in% spp.valid,"type"] <- "calibration"

rmse.Rlat.bud[rmse.Rlat.bud$species %in% spp.valid,"type"] <- "validation"
rmse.Rlat.bud[!rmse.Rlat.bud$species %in% spp.valid,"type"] <- "calibration"

rmse.Lat.bud[rmse.Lat.bud$species %in% spp.valid,"type"] <- "validation"
rmse.Lat.bud[!rmse.Lat.bud$species %in% spp.valid,"type"] <- "calibration"

#Combining model df's into one df for comparison

bud.model <- rbind(rmse.first.bud, rmse.Lat.bud, rmse.GT.bud, rmse.RGT.bud, rmse.Rlat.bud)

#Rearranging the x-axis for the following figures

bud.model$model <- factor(bud.model$model, levels = c("first", "Lat", "GT", "RGT", "Rlat"))


#-------------------------------------------------------------------------------------------------#

#-------------------------#
# ~~~ Leafout Section ~~~ #
#-------------------------#

#Reading in df's for calibration and validation data

first.comb.leaf <- read.csv(file.path(path.data, paste0('First_Leaf_Prediction_Evaluation_all.csv')))
GT.comb.leaf <- read.csv(file.path(path.data, paste0('GTmean_Leaf_Prediction_Evaluation_all.csv')))
RGT.comb.leaf <- read.csv(file.path(path.data, paste0('Rel_GTmean_Leaf_Prediction_Evaluation_all.csv')))
Rlat.comb.leaf <- read.csv(file.path(path.data, paste0('Rel_Lat_Leaf_Prediction_Evaluation_all.csv')))
Lat.comb.leaf <- read.csv(file.path(path.data, paste0('Lat_Leaf_Prediction_Evaluation_all.csv')))

#Calculating RMSE by species and adding an RMSE column to each model's dataframe

rmse.first.leaf <- first.comb.leaf %>% group_by(species) %>% mutate_each(funs(mean)) %>% distinct %>% mutate(RMSE = sqrt(expdiff))
rmse.GT.leaf <- GT.comb.leaf %>% group_by(species) %>% mutate_each(funs(mean)) %>% distinct %>% mutate(RMSE = sqrt(expdiff))
rmse.RGT.leaf <- RGT.comb.leaf %>% group_by(species) %>% mutate_each(funs(mean)) %>% distinct %>% mutate(RMSE = sqrt(expdiff))
rmse.Rlat.leaf <- Rlat.comb.leaf %>% group_by(species) %>% mutate_each(funs(mean)) %>% distinct %>% mutate(RMSE = sqrt(expdiff))
rmse.Lat.leaf <- Lat.comb.leaf %>% group_by(species) %>% mutate_each(funs(mean)) %>% distinct %>% mutate(RMSE = sqrt(expdiff))

#Selecting only the columns which we need so that columns will match when combining df's; adding model name columns
#Note: make sure to update model names in 'model' column
#Note; I'm pretty sure this averages the latitudes for each species as well

rmse.first.leaf <- rmse.first.leaf %>% select(site_id, latitude, longitude, species, diff, error, RMSE, mid, Yday, type) %>% mutate(model="first")
rmse.GT.leaf <- rmse.GT.leaf %>% select(site_id, latitude, longitude, species, diff, error, RMSE, mid, Yday, type) %>% mutate(model="GT")
rmse.RGT.leaf <- rmse.RGT.leaf %>% select(site_id, latitude, longitude, species, diff, error, RMSE, mid, Yday, type) %>% mutate(model="RGT")
rmse.Rlat.leaf <- rmse.Rlat.leaf %>% select(site_id, latitude, longitude, species, diff, error, RMSE, mid, Yday, type) %>% mutate(model="Rlat")
rmse.Lat.leaf <- rmse.Lat.leaf %>% select(site_id, latitude, longitude, species, diff, error, RMSE, mid, Yday, type) %>% mutate(model="Lat")

#Re-assigning 'type' to each species

spp.valid <- c("ilicifolia", "imbricaria", "marilandica", "stellata", "shumardii")

rmse.first.leaf[rmse.first.leaf$species %in% spp.valid,"type"] <- "validation"
rmse.first.leaf[!rmse.first.leaf$species %in% spp.valid,"type"] <- "calibration"

rmse.GT.leaf[rmse.GT.leaf$species %in% spp.valid,"type"] <- "validation"
rmse.GT.leaf[!rmse.GT.leaf$species %in% spp.valid,"type"] <- "calibration"

rmse.RGT.leaf[rmse.RGT.leaf$species %in% spp.valid,"type"] <- "validation"
rmse.RGT.leaf[!rmse.RGT.leaf$species %in% spp.valid,"type"] <- "calibration"

rmse.Rlat.leaf[rmse.Rlat.leaf$species %in% spp.valid,"type"] <- "validation"
rmse.Rlat.leaf[!rmse.Rlat.leaf$species %in% spp.valid,"type"] <- "calibration"

rmse.Lat.leaf[rmse.Lat.leaf$species %in% spp.valid,"type"] <- "validation"
rmse.Lat.leaf[!rmse.Lat.leaf$species %in% spp.valid,"type"] <- "calibration"

#Combining model df's into one df for comparison

leaf.model <- rbind(rmse.first.leaf, rmse.Lat.leaf, rmse.GT.leaf, rmse.RGT.leaf, rmse.Rlat.leaf)

#Rearranging what will be on the x-axis

leaf.model$model <- factor(leaf.model$model, levels = c("first", "Lat", "GT", "RGT", "Rlat"))

#-------------------------------------------------------------------------------------------------#

#------------------------#
# ~~~ Figure Section ~~~ #
#------------------------#

# ~ FIGURE 1 ~ #

oaks.bud <- read.csv(file.path(path.data, paste0('Oak_collection_budburst.csv')))
oaks.leaf <- read.csv(file.path(path.data, paste0('Oak_collection_leaf.csv')))

#Question: should this include all species in the above df or just the 12 calibration and validation species?
#Selecting only calibration and validation species

oaks.bud <- oaks.bud[oaks.bud$Species %in% c("Quercus ilicifolia", "Quercus imbricaria", "Quercus marilandica", "Quercus stellata", "Quercus shumardii", "Quercus alba", "Quercus gambelii", "Quercus macrocarpa", "Quercus velutina", "Quercus rubra", "Quercus montana", "Quercus palustris"),]
oaks.leaf <- oaks.leaf[oaks.leaf$Species %in% c("Quercus ilicifolia", "Quercus imbricaria", "Quercus marilandica", "Quercus stellata", "Quercus shumardii", "Quercus alba", "Quercus gambelii", "Quercus macrocarpa", "Quercus velutina", "Quercus rubra", "Quercus montana", "Quercus palustris"),]

#Excluding Genus name from Species column

oaks.bud[oaks.bud$Species == "Quercus alba",1] <- "alba"
oaks.bud[oaks.bud$Species == "Quercus ilicifolia",1] <- "ilicifolia"
oaks.bud[oaks.bud$Species == "Quercus imbricaria",1] <- "imbricaria"
oaks.bud[oaks.bud$Species == "Quercus marilandica",1] <- "marilandica"
oaks.bud[oaks.bud$Species == "Quercus stellata",1] <- "stellata"
oaks.bud[oaks.bud$Species == "Quercus shumardii",1] <- "shumardii"
oaks.bud[oaks.bud$Species == "Quercus gambelii",1] <- "gambelii"
oaks.bud[oaks.bud$Species == "Quercus macrocarpa",1] <- "macrocarpa"
oaks.bud[oaks.bud$Species == "Quercus velutina",1] <- "velutina"
oaks.bud[oaks.bud$Species == "Quercus rubra",1] <- "rubra"
oaks.bud[oaks.bud$Species == "Quercus montana",1] <- "montana"
oaks.bud[oaks.bud$Species == "Quercus palustris",1] <- "palustris"

oaks.leaf[oaks.leaf$Species == "Quercus alba",1] <- "alba"
oaks.leaf[oaks.leaf$Species == "Quercus ilicifolia",1] <- "ilicifolia"
oaks.leaf[oaks.leaf$Species == "Quercus imbricaria",1] <- "imbricaria"
oaks.leaf[oaks.leaf$Species == "Quercus marilandica",1] <- "marilandica"
oaks.leaf[oaks.leaf$Species == "Quercus stellata",1] <- "stellata"
oaks.leaf[oaks.leaf$Species == "Quercus shumardii",1] <- "shumardii"
oaks.leaf[oaks.leaf$Species == "Quercus gambelii",1] <- "gambelii"
oaks.leaf[oaks.leaf$Species == "Quercus macrocarpa",1] <- "macrocarpa"
oaks.leaf[oaks.leaf$Species == "Quercus velutina",1] <- "velutina"
oaks.leaf[oaks.leaf$Species == "Quercus rubra",1] <- "rubra"
oaks.leaf[oaks.leaf$Species == "Quercus montana",1] <- "montana"
oaks.leaf[oaks.leaf$Species == "Quercus palustris",1] <- "palustris"

bud.1 <- ggplot(data=oaks.bud, aes(x= Species, y=GDD5.cum))+
  geom_boxplot() +
  theme_cowplot(12)+
  theme(text=element_text(size=18)) +
  #scale_fill_manual(values=c("#FA7876", "#F3B584")) +
  #ylim(0, 45) +
  xlab("Species")+
  ylab("GDD5.cum (days)")

#There is an extreme outlyer for shumardii with a Gdd5.cum of over 2,000. Are we including this?
leaf.1 <- ggplot(data=oaks.leaf, aes(x= Species, y=GDD5.cum))+
  geom_boxplot() +
  theme_cowplot(12)+
  theme(text=element_text(size=18)) +
  #scale_fill_manual(values=c("#FA7876", "#F3B584")) +
  #ylim(0, 45) +
  xlab("Species")+
  ylab("GDD5.cum (days)")

png(width = 800, filename= file.path(path.figures, paste0('Figure 1', '.png')))
plot_grid(bud.1, leaf.1, labels=c('A', 'B'), align = "v", nrow=2, label_size = 18)
dev.off()

# ~ FIGURE 2 ~ #

# ~ FIGURE 3 ~ #

bud.3 <- ggplot(data=bud.model, aes(x= model, y=RMSE, fill=type))+
  geom_boxplot(aes(fill=type)) +
  theme_cowplot(12) +
  theme(text=element_text(size=18)) +
  ylim(0, 45) +
  scale_fill_manual(values=c("#A3319F", "#DF488D")) +
  xlab("Model")+
  ylab("RMSE (days)")

leaf.3 <- ggplot(data=leaf.model, aes(x= model, y=RMSE, fill=type))+
  geom_boxplot(aes(fill=type)) +
  theme_cowplot(12)+
  theme(text=element_text(size=18)) +
  scale_fill_manual(values=c("#FA7876", "#F3B584")) +
  ylim(0, 45) +
  xlab("Model")+
  ylab("RMSE (days)")

png(width = 500, height=600, filename= file.path(path.figures, paste0('Figure 3', '.png')))
plot_grid(bud.3, leaf.3, labels=c('A', 'B'), align = "v", nrow=2, label_size = 18)
dev.off()

#IDEA: group by type rather than species and toy around with that (only two groupings)
