#Figures moving into the final stages of the paper

library(ggplot2)
library(cowplot)

path.data <- "C:/Users/giama/OneDrive/Documents/R/Morton_Phenology/data_processed" 
path.figures <- "C:/Users/giama/OneDrive/Documents/R/Morton_Phenology/figures/Arb_Pheno/final_figures"

#This script gets the data for budburst and leafout squared away first in separate sections
#Then we move on to figure generation using the two datasets at the end

#--------------------------#
# ~~~ Budburst Section ~~~ #
#--------------------------#

#Reading in df's for calibration and validation data

first.comb.burst <- read.csv(file.path(path.data, paste0('First_Budburst_Prediction_Evaluation_all.csv')))
GT.comb.burst <- read.csv(file.path(path.data, paste0('GTmean_Budburst_Prediction_Evaluation_all.csv')))
RGT.comb.burst <- read.csv(file.path(path.data, paste0('Rel_GTmean_Budburst_Prediction_Evaluation_all.csv')))
Rlat.comb.burst <- read.csv(file.path(path.data, paste0('Rel_Lat_Budburst_Prediction_Evaluation_all.csv')))
Lat.comb.burst <- read.csv(file.path(path.data, paste0('Lat_Budburst_Prediction_Evaluation_all.csv')))

#Calculating RMSE by species and adding an RMSE column to each model's dataframe

rmse.first.bud <- first.comb.burst %>% group_by(species) %>% mutate_each(funs(mean)) %>% distinct %>% mutate(RMSE = sqrt(expdiff))
rmse.GT.bud <- GT.comb.burst %>% group_by(species) %>% mutate_each(funs(mean)) %>% distinct %>% mutate(RMSE = sqrt(expdiff))
rmse.RGT.bud <- RGT.comb.burst %>% group_by(species) %>% mutate_each(funs(mean)) %>% distinct %>% mutate(RMSE = sqrt(expdiff))
rmse.Rlat.bud <- Rlat.comb.burst %>% group_by(species) %>% mutate_each(funs(mean)) %>% distinct %>% mutate(RMSE = sqrt(expdiff))
rmse.Lat.bud <- Lat.comb.burst %>% group_by(species) %>% mutate_each(funs(mean)) %>% distinct %>% mutate(RMSE = sqrt(expdiff))

#Selecting only the columns which we need so that columns will match when combining df's; adding model name columns
#Note: make sure to update model names in 'model' column
#Note; I'm pretty sure this averages the latitudes for each species as well

rmse.first.bud <- rmse.first.bud %>% select(site_id, latitude, longitude, species, diff, error, RMSE, mid, Yday, type) %>% mutate(model="first")
rmse.GT.bud <- rmse.GT.bud %>% select(site_id, latitude, longitude, species, diff, error, RMSE, mid, Yday, type) %>% mutate(model="GT")
rmse.RGT.bud <- rmse.RGT.bud %>% select(site_id, latitude, longitude, species, diff, error, RMSE, mid, Yday, type) %>% mutate(model="RGT")
rmse.Rlat.bud <- rmse.Rlat.bud %>% select(site_id, latitude, longitude, species, diff, error, RMSE, mid, Yday, type) %>% mutate(model="Rlat")
rmse.Lat.bud <- rmse.Lat.bud %>% select(site_id, latitude, longitude, species, diff, error, RMSE, mid, Yday, type) %>% mutate(model="Lat")

#Re-assigning 'type' to each species
#Is there a more concise way of doing this?

rmse.first.bud$type <- as.character(rmse.first.bud$type)
rmse.first.bud[1,10] = "calibration"
rmse.first.bud[2,10] = "calibration"
rmse.first.bud[3,10] = "validation"
rmse.first.bud[4,10] = "validation"
rmse.first.bud[5,10] = "calibration"
rmse.first.bud[6,10] = "validation"
rmse.first.bud[7,10] = "calibration"
rmse.first.bud[8,10] = "calibration"
rmse.first.bud[9,10] = "calibration"
rmse.first.bud[10,10] = "validation"
rmse.first.bud[11,10] = "validation"
rmse.first.bud[12,10] = "calibration"

rmse.GT.bud$type <- as.character(rmse.GT.bud$type)
rmse.GT.bud[1,10] = "calibration"
rmse.GT.bud[2,10] = "calibration"
rmse.GT.bud[3,10] = "validation"
rmse.GT.bud[4,10] = "validation"
rmse.GT.bud[5,10] = "calibration"
rmse.GT.bud[6,10] = "validation"
rmse.GT.bud[7,10] = "calibration"
rmse.GT.bud[8,10] = "calibration"
rmse.GT.bud[9,10] = "calibration"
rmse.GT.bud[10,10] = "validation"
rmse.GT.bud[11,10] = "validation"
rmse.GT.bud[12,10] = "calibration"

rmse.RGT.bud$type <- as.character(rmse.RGT.bud$type)
rmse.RGT.bud[1,10] = "calibration"
rmse.RGT.bud[2,10] = "calibration"
rmse.RGT.bud[3,10] = "validation"
rmse.RGT.bud[4,10] = "validation"
rmse.RGT.bud[5,10] = "calibration"
rmse.RGT.bud[6,10] = "validation"
rmse.RGT.bud[7,10] = "calibration"
rmse.RGT.bud[8,10] = "calibration"
rmse.RGT.bud[9,10] = "calibration"
rmse.RGT.bud[10,10] = "validation"
rmse.RGT.bud[11,10] = "validation"
rmse.RGT.bud[12,10] = "calibration"

rmse.Rlat.bud$type <- as.character(rmse.Rlat.bud$type)
rmse.Rlat.bud[1,10] = "calibration"
rmse.Rlat.bud[2,10] = "calibration"
rmse.Rlat.bud[3,10] = "validation"
rmse.Rlat.bud[4,10] = "validation"
rmse.Rlat.bud[5,10] = "calibration"
rmse.Rlat.bud[6,10] = "validation"
rmse.Rlat.bud[7,10] = "calibration"
rmse.Rlat.bud[8,10] = "calibration"
rmse.Rlat.bud[9,10] = "calibration"
rmse.Rlat.bud[10,10] = "validation"
rmse.Rlat.bud[11,10] = "validation"
rmse.Rlat.bud[12,10] = "calibration"

rmse.Lat.bud$type <- as.character(rmse.Lat.bud$type)
rmse.Lat.bud[1,10] = "calibration"
rmse.Lat.bud[2,10] = "calibration"
rmse.Lat.bud[3,10] = "validation"
rmse.Lat.bud[4,10] = "validation"
rmse.Lat.bud[5,10] = "calibration"
rmse.Lat.bud[6,10] = "validation"
rmse.Lat.bud[7,10] = "calibration"
rmse.Lat.bud[8,10] = "calibration"
rmse.Lat.bud[9,10] = "calibration"
rmse.Lat.bud[10,10] = "validation"
rmse.Lat.bud[11,10] = "validation"
rmse.Lat.bud[12,10] = "calibration"

#Combining model df's into one df for comparison

bud.model <- rbind(rmse.first.bud, rmse.Lat.bud, rmse.GT.bud, rmse.RGT.bud, rmse.Rlat.bud)

#Rearranging the x-axis for the following figurewhat will be on the x-axis

bud.model$model <- factor(bud.model$model, levels = c("first", "Lat", "GT", "RGT", "Rlat"))


#-------------------------------------------------------------------------------------------------#

#-------------------------#
# ~~~ Leafout Section ~~~ #
#-------------------------#

#Reading in df's for calibration and validation data

first.comb.leaf <- read.csv(file.path(path.data, paste0('First_Leaf_Prediction_Evaluation_all.csv')))
GT.comb.leaf <- read.csv(file.path(path.data, paste0('GTmean_Leaf_Prediction_Evaluation_all.csv')))
RGT.comb.leaf <- read.csv(file.path(path.data, paste0('Rel_GTmean_Leaf_Prediction_Evaluation_all.csv')))
Rlat.comb.leaf <- read.csv(file.path(path.data, paste0('Rel_Lat_Leaf_Prediction_Evaluation_all.csv')))
Lat.comb.leaf <- read.csv(file.path(path.data, paste0('Lat_Leaf_Prediction_Evaluation_all.csv')))

#Calculating RMSE by species and adding an RMSE column to each model's dataframe

rmse.first.leaf <- first.comb.leaf %>% group_by(species) %>% mutate_each(funs(mean)) %>% distinct %>% mutate(RMSE = sqrt(expdiff))
rmse.GT.leaf <- GT.comb.leaf %>% group_by(species) %>% mutate_each(funs(mean)) %>% distinct %>% mutate(RMSE = sqrt(expdiff))
rmse.RGT.leaf <- RGT.comb.leaf %>% group_by(species) %>% mutate_each(funs(mean)) %>% distinct %>% mutate(RMSE = sqrt(expdiff))
rmse.Rlat.leaf <- Rlat.comb.leaf %>% group_by(species) %>% mutate_each(funs(mean)) %>% distinct %>% mutate(RMSE = sqrt(expdiff))
rmse.Lat.leaf <- Lat.comb.leaf %>% group_by(species) %>% mutate_each(funs(mean)) %>% distinct %>% mutate(RMSE = sqrt(expdiff))

#Selecting only the columns which we need so that columns will match when combining df's; adding model name columns
#Note: make sure to update model names in 'model' column
#Note; I'm pretty sure this averages the latitudes for each species as well

rmse.first.leaf <- rmse.first.leaf %>% select(site_id, latitude, longitude, species, diff, error, RMSE, mid, Yday, type) %>% mutate(model="first")
rmse.GT.leaf <- rmse.GT.leaf %>% select(site_id, latitude, longitude, species, diff, error, RMSE, mid, Yday, type) %>% mutate(model="GT")
rmse.RGT.leaf <- rmse.RGT.leaf %>% select(site_id, latitude, longitude, species, diff, error, RMSE, mid, Yday, type) %>% mutate(model="RGT")
rmse.Rlat.leaf <- rmse.Rlat.leaf %>% select(site_id, latitude, longitude, species, diff, error, RMSE, mid, Yday, type) %>% mutate(model="Rlat")
rmse.Lat.leaf <- rmse.Lat.leaf %>% select(site_id, latitude, longitude, species, diff, error, RMSE, mid, Yday, type) %>% mutate(model="Lat")

#Re-assigning 'type' to each species
#Is there a more concise way of doing this?

rmse.first.leaf$type <- as.character(rmse.first.leaf$type)
rmse.first.leaf[1,10] = "calibration"
rmse.first.leaf[2,10] = "calibration"
rmse.first.leaf[3,10] = "validation"
rmse.first.leaf[4,10] = "validation"
rmse.first.leaf[5,10] = "calibration"
rmse.first.leaf[6,10] = "validation"
rmse.first.leaf[7,10] = "calibration"
rmse.first.leaf[8,10] = "calibration"
rmse.first.leaf[9,10] = "calibration"
rmse.first.leaf[10,10] = "validation"
rmse.first.leaf[11,10] = "validation"
rmse.first.leaf[12,10] = "calibration"

rmse.GT.leaf$type <- as.character(rmse.GT.leaf$type)
rmse.GT.leaf[1,10] = "calibration"
rmse.GT.leaf[2,10] = "calibration"
rmse.GT.leaf[3,10] = "validation"
rmse.GT.leaf[4,10] = "validation"
rmse.GT.leaf[5,10] = "calibration"
rmse.GT.leaf[6,10] = "validation"
rmse.GT.leaf[7,10] = "calibration"
rmse.GT.leaf[8,10] = "calibration"
rmse.GT.leaf[9,10] = "calibration"
rmse.GT.leaf[10,10] = "validation"
rmse.GT.leaf[11,10] = "validation"
rmse.GT.leaf[12,10] = "calibration"

rmse.RGT.leaf$type <- as.character(rmse.RGT.leaf$type)
rmse.RGT.leaf[1,10] = "calibration"
rmse.RGT.leaf[2,10] = "calibration"
rmse.RGT.leaf[3,10] = "validation"
rmse.RGT.leaf[4,10] = "validation"
rmse.RGT.leaf[5,10] = "calibration"
rmse.RGT.leaf[6,10] = "validation"
rmse.RGT.leaf[7,10] = "calibration"
rmse.RGT.leaf[8,10] = "calibration"
rmse.RGT.leaf[9,10] = "calibration"
rmse.RGT.leaf[10,10] = "validation"
rmse.RGT.leaf[11,10] = "validation"
rmse.RGT.leaf[12,10] = "calibration"

rmse.Rlat.leaf$type <- as.character(rmse.Rlat.leaf$type)
rmse.Rlat.leaf[1,10] = "calibration"
rmse.Rlat.leaf[2,10] = "calibration"
rmse.Rlat.leaf[3,10] = "validation"
rmse.Rlat.leaf[4,10] = "validation"
rmse.Rlat.leaf[5,10] = "calibration"
rmse.Rlat.leaf[6,10] = "validation"
rmse.Rlat.leaf[7,10] = "calibration"
rmse.Rlat.leaf[8,10] = "calibration"
rmse.Rlat.leaf[9,10] = "calibration"
rmse.Rlat.leaf[10,10] = "validation"
rmse.Rlat.leaf[11,10] = "validation"
rmse.Rlat.leaf[12,10] = "calibration"

rmse.Lat.leaf$type <- as.character(rmse.Lat.leaf$type)
rmse.Lat.leaf[1,10] = "calibration"
rmse.Lat.leaf[2,10] = "calibration"
rmse.Lat.leaf[3,10] = "validation"
rmse.Lat.leaf[4,10] = "validation"
rmse.Lat.leaf[5,10] = "calibration"
rmse.Lat.leaf[6,10] = "validation"
rmse.Lat.leaf[7,10] = "calibration"
rmse.Lat.leaf[8,10] = "calibration"
rmse.Lat.leaf[9,10] = "calibration"
rmse.Lat.leaf[10,10] = "validation"
rmse.Lat.leaf[11,10] = "validation"
rmse.Lat.leaf[12,10] = "calibration"

#Combining model df's into one df for comparison

leaf.model <- rbind(rmse.first.leaf, rmse.Lat.leaf, rmse.GT.leaf, rmse.RGT.leaf, rmse.Rlat.leaf)

#Rearranging what will be on the x-axis

leaf.model$model <- factor(leaf.model$model, levels = c("first", "Lat", "GT", "RGT", "Rlat"))

#-------------------------------------------------------------------------------------------------#

#------------------------#
# ~~~ Figure Section ~~~ #
#------------------------#

# ~ FIGURE 1 ~ #

# ~ FIGURE 2 ~ #

# ~ FIGURE 3 ~ #

bud.3 <- ggplot(data=bud.model, aes(x= model, y=RMSE, fill=type))+
  geom_boxplot(aes(fill=type)) +
  theme_cowplot(12) +
  theme(text=element_text(size=18)) +
  ylim(0, 45) +
  scale_fill_manual(values=c("#A3319F", "#DF488D")) +
  xlab("Model")+
  ylab("RMSE (days)")

leaf.3 <- ggplot(data=leaf.model, aes(x= model, y=RMSE, fill=type))+
  geom_boxplot(aes(fill=type)) +
  theme_cowplot(12)+
  theme(text=element_text(size=18)) +
  scale_fill_manual(values=c("#FA7876", "#F3B584")) +
  ylim(0, 45) +
  xlab("Model")+
  ylab("RMSE (days)")

#How do you add a main title to the combined figure?
title.3 <- ggdraw() + draw_label("Tentative: Model Type RMSE Comparison", fontface='bold')
#Not working when I add this title to plot_grid

png(width = 500, height=600, filename= file.path(path.figures, paste0('Figure 3', '.png')))
plot_grid(bud.3, leaf.3, labels=c('A', 'B'), align = "v", nrow=2, label_size = 18)
dev.off()

#IDEA: group by type rather than species and toy around with that (only two groupings)
