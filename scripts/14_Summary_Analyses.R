# Doing some summary analyses to help provide analyses, particularly with latitudinal trends that support manuscript text
# Table of Script Contents -- EVERYTHING NEEDS a species breakdown (supplemental) and a summary based on the species-level summary (manuscript)
# 1. Summary Stats for Arb data leaf out & bud burst
# 2. Summary Stats for NPN data
# 3. Analysis of RMSE & Error Rate in budburst and leaf out
#    3.1. Budburst
#    3.2. Leaf out
#    3.a. Null GDD model
#    3.b. Lat-revised (RevLAT)
#    3.c. GT-revised  (RevGT)
# 4. Analysis of latitudinal trends in budburst and leaf out
#    4.1. Budburst
#    4.2. Leaf out
#    4.a. Null GDD model
#    4.b. Lat-revised (RevLAT)
#    4.c. GT-revised  (RevGT)

library(nlme)
library(dplyr)
library(tidyverse)

path.data <- "../data_processed" 
path.figures <- "../figures_final"
path.hub <- "../data"
path.google <- "/Volumes/GoogleDrive/My Drive/Manuscripts/CollectionsPhenologyVulnerability_CCE_2020/Review responses/"

bud.all <- read.csv("../data_processed/Full_Bud_Obs.csv")
bud.all <- bud.all[!bud.all$flag.3sig & bud.all$spp.type %in% c("calibration", "validation"),]
summary(bud.all)

leaf.all <- read.csv("../data_processed/Full_Bud_Obs.csv")
leaf.all <- leaf.all[!leaf.all$flag.3sig & leaf.all$spp.type %in% c("calibration", "validation"),]
summary(leaf.all)

######## --------------------------------------------------
# 1. Summary Stats for Arboretum Phenology Data
######## --------------------------------------------------
spp.valid <- c("imbricaria", "montana", "velutina")# ---------------------------------
# Bud Burst
# ---------------------------------
# Getting the raw observation data
arb.bb <- bud.all[bud.all$site_id=="Morton",]
# arb.bb <- read.csv(file.path(path.data, 'Oak_collection_budburst.csv'))
# arb.bb <- tidyr::separate(arb.bb, col = "Species", into=c("Genus", "Species"))
# summary(arb.bb)
# 
# arb.bb$NPN <- ifelse(arb.bb$Species %in% not.npn, "No NPN data", "NPN")

# Getting the model posteriors
bud.stats <- read.csv("../data_processed/model_output/TT_model_budburst.csv")

#Assigning NPN status to each species
# bud.stats$NPN <- ifelse(bud.stats$species %in% not.npn, "No NPN data", "NPN")
# bud.stats <- bud.stats[bud.stats$NPN == "NPN",]


# Summarizing Budburst
summary(arb.bb)
arb.bb.sum <- data.frame(species=unique(arb.bb$species),
                         n.tree=NA, # Number of trees observed
                         n.obs=NA, # Number of observations over 2 years
                         Obs.DOY=NA, # Med (Min, Max) DOY
                         Obs.GDD=NA # Median (min, max) GDD
                         #Mod.GDD=NA  # median (95 CI) modeled thresh
                         )

for(i in 1:nrow(arb.bb.sum)){
  SPP <- arb.bb.sum$species[i]
  dat.spp <- arb.bb[arb.bb$species==SPP,]
  stat.spp <- bud.stats[bud.stats$species==SPP,]
  
  if(SPP %in% spp.valid) arb.bb.sum$species[i] <- paste0(arb.bb.sum$species[i], "*")
  arb.bb.sum$n.tree  [i] <- length(unique(dat.spp$individual_id))
  arb.bb.sum$n.obs   [i] <- nrow(dat.spp)
  arb.bb.sum$Obs.DOY [i] <- paste0(round(median(dat.spp$yday)), " (", min(dat.spp$yday), "-", max(dat.spp$yday), ")")
  arb.bb.sum$Obs.GDD [i] <- paste0(round(median(dat.spp$GDD5.cum)), " (", round(min(dat.spp$GDD5.cum)), "-", round(max(dat.spp$GDD5.cum)), ")")
  #arb.bb.sum$Mod.GDD [i] <- paste0(round(median(stat.spp$THRESH)), " (", round(quantile(stat.spp$THRESH, 0.025)), "-", round(quantile(stat.spp$THRESH, 0.975)), ")")
}

arb.bb.yr<- data.frame(species=unique(arb.bb$species),
                        Obs.GDD.2018=NA, 
                        Obs.GDD.2019=NA,
                        Individual.diff=NA,
                        WTmean.2018=NA,
                        WTmean.2019=NA
                       
)

for(i in 1:nrow(arb.bb.yr)){
  SPP <- arb.bb.yr$species[i]
  dat.spp <- arb.bb[arb.bb$species==SPP,]
  if(SPP %in% spp.valid) arb.bb.yr$species[i] <- paste0(arb.bb.yr$species[i], "*")
  arb.bb.yr$Obs.GDD.2018 [i] <- paste0(round(median(dat.spp[dat.spp$year == 2018,"GDD5.cum"])), " (", round(min(dat.spp[dat.spp$year == 2018,"GDD5.cum"])), "-", round(max(dat.spp[dat.spp$year == 2018,"GDD5.cum"])), ")")
  arb.bb.yr$Obs.GDD.2019 [i] <- paste0(round(median(dat.spp[dat.spp$year == 2019,"GDD5.cum"])), " (", round(min(dat.spp[dat.spp$year == 2019,"GDD5.cum"])), "-", round(max(dat.spp[dat.spp$year == 2019,"GDD5.cum"])), ")")
  hold <- numeric()
  for(PN in unique(dat.spp$individual_id)){
    temp <- dat.spp[dat.spp$individual_id == PN,]
    if(nrow(temp) == 2){
      diff <- max(temp$GDD5.cum) - min(temp$GDD5.cum)
      hold <- rbind(hold, diff)
    }
  }
  arb.bb.yr$Individual.diff [i] <- paste0(round(median(hold)), " (", round(min(hold)), "-", round(max(hold)), ")")
  arb.bb.yr$WTmean.2018   [i] <- unique(dat.spp[dat.spp$year == 2018,"GTmean"])
  arb.bb.yr$WTmean.2019   [i] <- unique(dat.spp[dat.spp$year == 2019,"GTmean"])
}


arb.bb.sum <- arb.bb.sum[order(arb.bb.sum$species),]
arb.bb.yr <- arb.bb.yr[order(arb.bb.yr$species),]
write.csv(arb.bb.sum, "../data_processed/ArboretumSummaryStats_BudBurst.csv", row.names=F)
write.csv(arb.bb.yr, "../data_processed/ArboretumYearStats_BudBurst.csv", row.names=F)
write.csv(arb.bb.sum, file.path(path.google, "Tables/ArboretumSummaryStats_BudBurst.csv"), row.names=F)
write.csv(arb.bb.yr, file.path(path.google, "Tables/ArboretumSummaryStats_BudBurst.csv"), row.names=F)

# ---------------------------------

# ---------------------------------
# Summarizing Arboretum Leaf out Data 
# ---------------------------------
# Getting the raw arboretum observations
arb.lo <- leaf.all[leaf.all$site_id=="Morton",]
# arb.lo <- read.csv(file.path(path.data, 'Oak_collection_leaf.csv'))
# arb.lo <- tidyr::separate(arb.lo, col = "Species", into=c("Genus", "Species"))
# summary(arb.lo)
# 
# arb.lo$NPN <- ifelse(arb.lo$Species %in% not.npn, "No NPN data", "NPN")
# #Removing coccinea from oaks.leaf
# arb.lo <- arb.lo %>% subset(!(Species == "coccinea"))

# Getting the model posteriors
leaf.stats <- read.csv("../data_processed/model_output/TT_model_leaf.csv")

arb.lo.sum <- data.frame(species=unique(arb.lo$species),
                         n.tree=NA, # Number of trees observed
                         n.obs=NA, # Number of observations over 2 years
                         Obs.DOY=NA, # Med (Min, Max) DOY
                         Obs.GDD=NA # Median (min, max) GDD
                         #Mod.GDD=NA  # median (95 CI) modeled thresh
)

for(i in 1:nrow(arb.lo.sum)){
  SPP <- arb.lo.sum$species[i]
  dat.spp <- arb.lo[arb.lo$species==SPP,]
  stat.spp <- leaf.stats[leaf.stats$species==SPP,]
  
  if(SPP %in% spp.valid) arb.lo.sum$species[i] <- paste0(arb.lo.sum$species[i], "*")
  arb.lo.sum$n.tree  [i] <- length(unique(dat.spp$individual_id))
  arb.lo.sum$n.obs   [i] <- nrow(dat.spp)
  arb.lo.sum$Obs.DOY [i] <- paste0(round(median(dat.spp$yday)), " (", min(dat.spp$yday), "-", max(dat.spp$yday), ")")
  arb.lo.sum$Obs.GDD [i] <- paste0(round(median(dat.spp$GDD5.cum)), " (", round(min(dat.spp$GDD5.cum)), "-", round(max(dat.spp$GDD5.cum)), ")")
  #arb.lo.sum$Mod.GDD [i] <- paste0(round(median(stat.spp$THRESH)), " (", round(quantile(stat.spp$THRESH, 0.025)), "-", round(quantile(stat.spp$THRESH, 0.975)), ")")
}

arb.lo.yr<- data.frame(species=unique(arb.lo$species),
                       Obs.GDD.2018=NA, # Median (min, max) GDD
                       Obs.GDD.2019=NA,
                       Individual.diff=NA,
                       WTmean.2018=NA,
                       WTmean.2019=NA
                       
)

for(i in 1:nrow(arb.lo.yr)){
  SPP <- arb.lo.yr$species[i]
  dat.spp <- arb.lo[arb.lo$species==SPP,]
  if(SPP %in% spp.valid) arb.lo.yr$species[i] <- paste0(arb.lo.yr$species[i], "*")
  arb.lo.yr$Obs.GDD.2018 [i] <- paste0(round(median(dat.spp[dat.spp$year == 2018,"GDD5.cum"])), " (", round(min(dat.spp[dat.spp$year == 2018,"GDD5.cum"])), "-", round(max(dat.spp[dat.spp$year == 2018,"GDD5.cum"])), ")")
  arb.lo.yr$Obs.GDD.2019 [i] <- paste0(round(median(dat.spp[dat.spp$year == 2019,"GDD5.cum"])), " (", round(min(dat.spp[dat.spp$year == 2019,"GDD5.cum"])), "-", round(max(dat.spp[dat.spp$year == 2019,"GDD5.cum"])), ")")
  hold <- numeric()
  for(PN in unique(dat.spp$individual_id)){
    temp <- dat.spp[dat.spp$individual_id == PN,]
    if(nrow(temp) == 2){
      diff <- max(temp$GDD5.cum) - min(temp$GDD5.cum)
      hold <- rbind(hold, diff)
    }
  }
  arb.lo.yr$Individual.diff [i] <- paste0(round(median(hold)), " (", round(min(hold)), "-", round(max(hold)), ")")
  arb.lo.yr$WTmean.2018   [i] <- unique(dat.spp[dat.spp$year == 2018,"GTmean"])
  arb.lo.yr$WTmean.2019   [i] <- unique(dat.spp[dat.spp$year == 2019,"GTmean"])
}


arb.lo.sum <- arb.lo.sum[order(arb.lo.sum$species),]
arb.lo.yr <- arb.lo.yr[order(arb.lo.yr$species),]
write.csv(arb.lo.sum, "../data_processed/ArboretumSummaryStats_LeafOut.csv", row.names=F)
write.csv(arb.lo.yr, "../data_processed/ArboretumYearStats_LeafOut.csv", row.names=F)
write.csv(arb.lo.sum, file.path(path.google, "Tables/ArboretumSummaryStats_LeafOut.csv"), row.names=F)
write.csv(arb.lo.yr, file.path(path.google, "Tables/ArboretumSummaryStats_Leafout.csv"), row.names=F)
# ---------------------------------

######## --------------------------------------------------

######## --------------------------------------------------
# 2. Summary Stats for NPN data
# Species
# Spatial Calib/Valid
# N sites
# N trees
# N obs
# Lat range (median)
# GT range (median)

######## --------------------------------------------------
# spp.valid <- c("ilicifolia", "imbricaria", "marilandica", "stellata", "shumardii")
# ---------------------------------
# Bud Burst
# ---------------------------------
bud.npn <- read.csv(file.path(path.data, 'TT_Budburst_Prediction_Evaluation_all.csv'), stringsAsFactors = F)
# bud.npn$type <- as.factor(ifelse(bud.npn$species %in% spp.valid, "validation", "calibration"))
summary(bud.npn)

npn.bb <- data.frame(Species=unique(bud.npn$species),
                     n.site=NA, # Number of unique sites observed at
                     n.tree=NA, # Number of trees observed
                     n.obs=NA, # Number of observations over 2 years
                     lat.stat=NA, # Med (Min, Max) latitude
                     WT.stat=NA # Median (min, max) growign season temperatures
                     )

for(i in 1:nrow(npn.bb)){
  SPP <- npn.bb$Species[i]
  dat.spp <- bud.npn[bud.npn$species==SPP,]

  if(SPP %in% spp.valid) npn.bb$Species[i] <- paste0(npn.bb$Species[i], "*")
  npn.bb$n.site  [i] <- length(unique(dat.spp$site_id))
  npn.bb$n.tree  [i] <- length(unique(dat.spp$individual_id))
  npn.bb$n.obs   [i] <- nrow(dat.spp)
  npn.bb$lat.stat [i] <- paste0(round(median(dat.spp$latitude), 2), " (", round(min(dat.spp$latitude), 2), "-", round(max(dat.spp$latitude), 2), ")")
  npn.bb$WT.stat [i] <- paste0(round(median(dat.spp$GTmean), 1), " (", round(min(dat.spp$GTmean), 1), "-", round(max(dat.spp$GTmean), 1), ")")
}

npn.bb <- npn.bb[order(npn.bb$Species),]
write.csv(npn.bb, "../data_processed/NPNSummaryStats_BudBurst.csv", row.names=F)
write.csv(npn.bb, file.path(path.google, "Tables/NPNSummaryStats_BudBurst.csv"), row.names=F)
# ---------------------------------

# ---------------------------------
# Leaf Out
# ---------------------------------
leaf.npn <- read.csv(file.path(path.data, 'TT_Leaf_Prediction_Evaluation_all.csv'), stringsAsFactors = F)
# leaf.npn$type <- as.factor(ifelse(leaf.npn$species %in% spp.valid, "validation", "calibration"))
summary(leaf.npn)

npn.lo <- data.frame(Species=unique(leaf.npn$species),
                     n.site=NA, # Number of unique sites observed at
                     n.tree=NA, # Number of trees observed
                     n.obs=NA, # Number of observations over 2 years
                     lat.stat=NA, # Med (Min, Max) latitude
                     WT.stat=NA # Median (min, max) growign season temperatures
                     )

for(i in 1:nrow(npn.lo)){
  SPP <- npn.lo$Species[i]
  dat.spp <- leaf.npn[leaf.npn$species==SPP,]
  
  if(SPP %in% spp.valid) npn.lo$Species[i] <- paste0(npn.lo$Species[i], "*")
  npn.lo$n.site  [i] <- length(unique(dat.spp$site_id))
  npn.lo$n.tree  [i] <- length(unique(dat.spp$individual_id))
  npn.lo$n.obs   [i] <- nrow(dat.spp)
  npn.lo$lat.stat [i] <- paste0(round(median(dat.spp$latitude), 2), " (", round(min(dat.spp$latitude), 2), "-", round(max(dat.spp$latitude), 2), ")")
  npn.lo$WT.stat [i] <- paste0(round(median(dat.spp$GTmean), 1), " (", round(min(dat.spp$GTmean), 1), "-", round(max(dat.spp$GTmean), 1), ")")
}

npn.lo <- npn.lo[order(npn.lo$Species),]

write.csv(npn.lo, "../data_processed/NPNSummaryStats_LeafOut.csv", row.names=F)
write.csv(npn.lo, file.path(path.google, "Tables/NPNSummaryStats_LeafOut.csv"), row.names=F)
# ---------------------------------
######## --------------------------------------------------

######## --------------------------------------------------
# 3. Analysis of RMSE & Error Rate in budburst and leaf out
#    3.1. Budburst
#    3.2. Leaf out
#    3.a. Null GDD model
#    3.b. Latitude adjustment  (lat)
#    3.c. Growing Season Temp Adjustment (GT)
#    3.d. RelLat (RLAT)
#    3.e. RelGT  (RGT)
######## --------------------------------------------------
# ---------------------------------
# Bud Burst
# ---------------------------------
bud.gdd <- read.csv(file.path(path.data, 'TT_Budburst_Prediction_Evaluation_all.csv'), stringsAsFactors = T)
bud.lat <- read.csv(file.path(path.data, 'ReVLat_Budburst_Prediction_Evaluation_all.csv'), stringsAsFactors = T)
bud.gt <- read.csv(file.path(path.data, 'ReVGT_Budburst_Prediction_Evaluation_all.csv'), stringsAsFactors = T)
bud.gdd $Model <- "GDD"
bud.lat$Model <- "Lat"
bud.gt $Model <- "WT"

bud.keep <- c("species", "site_id", "individual_id", "year", "latitude", "longitude", "yday", "mid", "diff", "expdiff", "error", "spp.type", "Model")
bud.long <- rbind(bud.gdd[,bud.keep], 
                  bud.lat[,bud.keep], 
                  bud.gt[,bud.keep])
bud.long$Model <- factor(bud.long$Model, levels=c("GDD", "Lat", "WT"))
summary(bud.long)

# Doing a quick analyses with the raw residuals to see changes in the error with models
# NOTE: Because ilicifolia isn't in the GDD model, needed to drop it form this analysis
bud.resid <- lme(abs(diff) ~ Model*species- Model, random=list(site_id=~1, individual_id=~1, year=~1), data=bud.long[!bud.long$species=="ilicifolia",])
t.bud.resid <- summary(bud.resid)$tTable

bud.resid.valid <- lme(abs(diff) ~ Model, random=list(species=~1, site_id=~1, individual_id=~1, year=~1), data=bud.long[bud.long$spp.type=="validation" & !bud.long$species=="ilicifolia",])
t.bud.resid.valid <- summary(bud.resid.valid)$tTable

bud.resid.calib <- lme(abs(diff) ~ Model, random=list(species=~1, site_id=~1, individual_id=~1, year=~1), data=bud.long[bud.long$spp.type=="calibration",])
t.bud.resid.calib <- summary(bud.resid.calib)$tTable

# Just a couple species spot-checks to make sure I'm interpretitng the big complicated model right 
# (I am)
bud.resid.qual <- lme(diff ~ Model, random=list(site_id=~1, individual_id=~1, year=~1), data=bud.long[bud.long$species=="alba",])
summary(bud.resid.qual)$tTable

bud.resid.quim <- lme(diff ~ Model, random=list(site_id=~1, individual_id=~1, year=~1), data=bud.long[bud.long$species=="imbricaria",])
summary(bud.resid.quim)$tTable

bud.error <-  aggregate(error ~ Model + species + spp.type, data=bud.long, mean)


bud.rmse.long <- aggregate(expdiff ~ Model + species + spp.type, data=bud.long, FUN=function(x){round(sqrt(mean(x)), 1)})

bud.rmse <- data.frame(Species=unique(bud.rmse.long$species),
                       Type=NA,
                       GDD=NA,
                       Lat=NA,
                       WT=NA)
# bud.rmse$Type <- ifelse(bud.rmse$Species %in% spp.valid, "validation", "calibration")

for(i in 1:nrow(bud.rmse)){
  SPP <- bud.rmse$Species[i]
  rmse.spp <- bud.rmse.long[bud.rmse.long$species==SPP,]
  stat.spp <- t.bud.resid[grep(SPP, row.names(t.bud.resid)),]
  
  bud.rmse$Type[i] <- paste(unique(bud.rmse.long$spp.type[bud.rmse.long$species==SPP]))
  
  # If the species has the base model assess significance (Q. ilicifolia isn't)
  if(length(rmse.spp$expdiff[rmse.spp$Model=="GDD"])>0) {
    bud.rmse$GDD[i] <- rmse.spp$expdiff[rmse.spp$Model=="GDD"]
    bud.rmse$Lat[i] <- paste0(rmse.spp$expdiff[rmse.spp$Model=="Lat"], ifelse(stat.spp[grep("Lat",row.names(stat.spp)), "p-value"][1]<0.05, "*", ""))
    bud.rmse$WT[i] <- paste0(rmse.spp$expdiff[rmse.spp$Model=="WT"], ifelse(stat.spp[grep("WT",row.names(stat.spp)), "p-value"][1]<0.05, "*", ""))
  } else {
    # If the species isn't in GDD (Q. ilicifolia, present its results for the others)
    bud.rmse$GDD[i] <- ""
    bud.rmse$Lat[i] <- rmse.spp$expdiff[rmse.spp$Model=="Lat"]
    bud.rmse$WT[i] <- rmse.spp$expdiff[rmse.spp$Model=="WT"]
  }

  
}
bud.rmse

write.csv(bud.rmse, "../data_processed/RMSEStats_BudBurst_Species.csv", row.names=F)
write.csv(bud.rmse, file.path(path.google, "Tables/RMSEStats_BudBurst_Species.csv"), row.names=F)


# Secondary test looking at RMSE of groups
bud.rmse.valid <- lme(expdiff ~ Model, random=list(species=~1), data=bud.rmse.long[bud.rmse.long$spp.type=="validation",])
bud.rmse.valid.t <- summary(bud.rmse.valid)$tTable
bud.rmse.valid.t[,"p-value"] <- round(bud.rmse.valid.t[,"p-value"], 3)
bud.rmse.valid.t

bud.rmse.valid2 <- lme(expdiff ~ Model, random=list(species=~1), data=bud.rmse.long[bud.rmse.long$spp.type=="validation" & bud.rmse.long$species!="gambelii",])
bud.rmse.valid2.t <- summary(bud.rmse.valid2)$tTable
bud.rmse.valid2.t[,"p-value"] <- round(bud.rmse.valid2.t[,"p-value"], 3)
bud.rmse.valid2.t

bud.rmse[]
# mean(c(23.6-20.3, 20.0-18.2, 34.1-17.6, 21.1-20.5, 40.8-25.7))

eval.lat <- t.test(abs(bud.gdd$diff), abs(bud.lat$diff), paired=T)
eval.gt <- t.test(abs(bud.gdd$diff), abs(bud.gt$diff), paired=T)

# ---------------------------------

# ---------------------------------
# Leaf Out
# ---------------------------------
leaf.gdd <- read.csv(file.path(path.data, 'TT_Leaf_Prediction_Evaluation_all.csv'), stringsAsFactors = T)
leaf.lat <- read.csv(file.path(path.data, 'RevLat_Leaf_Prediction_Evaluation_all.csv'), stringsAsFactors = T)
leaf.gt <- read.csv(file.path(path.data, 'RevGT_Leaf_Prediction_Evaluation_all.csv'), stringsAsFactors = T)
leaf.gdd $Model <- "GDD"
leaf.lat $Model <- "Lat"
leaf.gt  $Model <- "WT"


leaf.keep <- c("species", "site_id", "individual_id", "year", "latitude", "longitude", "yday", "diff", "expdiff", "error", "spp.type", "Model")
leaf.long <- rbind(leaf.gdd[,leaf.keep], 
                  leaf.lat[,leaf.keep], 
                  leaf.gt[,leaf.keep])
leaf.long$Model <- factor(leaf.long$Model, levels=c("GDD", "Lat", "WT"))
summary(leaf.long)

# Doing a quick analyses with the raw residuals to see changes in the error with models
leaf.resid <- lme(abs(diff) ~ Model*species- Model, random=list(site_id=~1, individual_id=~1, year=~1), data=leaf.long[leaf.long$species!="ilicifolia",])
t.leaf.resid <- summary(leaf.resid)$tTable

leaf.resid.valid <- lme(abs(diff) ~ Model, random=list(species=~1, site_id=~1, individual_id=~1, year=~1), data=leaf.long[leaf.long$spp.type=="validation" & leaf.long$species!="ilicifolia",])
t.leaf.resid.valid <- summary(leaf.resid.valid)$tTable

leaf.resid.calib <- lme(abs(diff) ~ Model, random=list(species=~1, site_id=~1, individual_id=~1, year=~1), data=leaf.long[leaf.long$spp.type=="calibration",])
t.leaf.resid.calib <- summary(leaf.resid.calib)$tTable

# Just a couple species spot-checks to make sure I'm interpretitng the big complicated model right 
# (I am)
leaf.resid.qual <- lme(diff ~ Model, random=list(site_id=~1, individual_id=~1, year=~1), data=leaf.long[leaf.long$species=="alba",])
summary(leaf.resid.qual)$tTable

leaf.resid.quim <- lme(diff ~ Model, random=list(site_id=~1, individual_id=~1, year=~1), data=leaf.long[leaf.long$species=="imbricaria",])
summary(leaf.resid.quim)$tTable

leaf.error <-  aggregate(error ~ Model + species + spp.type, data=leaf.long, mean)

leaf.rmse.long <- aggregate(expdiff ~ Model + species + spp.type, data=leaf.long, FUN=function(x){round(sqrt(mean(x)), 1)})

leaf.rmse <- data.frame(Species=unique(leaf.rmse.long$species),
                       Type=NA,
                       GDD=NA,
                       Lat=NA,
                       WT=NA
)
# leaf.rmse$Type <- ifelse(leaf.rmse$Species %in% spp.valid, "validation", "calibration")

for(i in 1:nrow(leaf.rmse)){
  SPP <- leaf.rmse$Species[i]
  rmse.spp <- leaf.rmse.long[leaf.rmse.long$species==SPP,]
  stat.spp <- t.leaf.resid[grep(SPP, row.names(t.leaf.resid)),]
  
  leaf.rmse$Type[i] <- paste(unique(leaf.rmse.long$spp.type[leaf.rmse.long$species==SPP]))
  
  # If the species has the base model assess significance (Q. ilicifolia isn't)
  if(length(rmse.spp$expdiff[rmse.spp$Model=="GDD"])>0) {
    leaf.rmse$GDD[i] <- rmse.spp$expdiff[rmse.spp$Model=="GDD"]
    leaf.rmse$Lat[i] <- paste0(rmse.spp$expdiff[rmse.spp$Model=="Lat"], ifelse(stat.spp[grep("Lat",row.names(stat.spp)), "p-value"][1]<0.05, "*", ""))
    leaf.rmse$WT[i] <- paste0(rmse.spp$expdiff[rmse.spp$Model=="WT"], ifelse(stat.spp[grep("WT",row.names(stat.spp)), "p-value"][1]<0.05, "*", ""))
  } else {
    # If the species isn't in GDD (Q. ilicifolia, present its results for the others)
    leaf.rmse$GDD[i] <- ""
    leaf.rmse$Lat[i] <- rmse.spp$expdiff[rmse.spp$Model=="Lat"]
    leaf.rmse$WT[i] <- rmse.spp$expdiff[rmse.spp$Model=="WT"]
  }
  
}
leaf.rmse

leaf.rmse.valid <- lme(expdiff ~ Model, random=list(species=~1), data=leaf.rmse.long[leaf.rmse.long$spp.type=="validation",])
leaf.rmse.valid.t <- summary(leaf.rmse.valid)$tTable
leaf.rmse.valid.t[,"p-value"] <- round(leaf.rmse.valid.t[,"p-value"], 3)
leaf.rmse.valid.t

leaf.rmse.valid2 <- lme(expdiff ~ Model, random=list(species=~1), data=leaf.rmse.long[leaf.rmse.long$spp.type=="validation" & leaf.rmse.long$species!="gambelii",])
leaf.rmse.valid2.t <- summary(leaf.rmse.valid2)$tTable
leaf.rmse.valid2.t[,"p-value"] <- round(leaf.rmse.valid2.t[,"p-value"], 3)
leaf.rmse.valid2.t


write.csv(leaf.rmse, "../data_processed/RMSEStats_LeafOut_Species.csv", row.names=F)
write.csv(leaf.rmse, file.path(path.google, "Tables/RMSEStats_LeafOut_Species.csv"), row.names=F)

# ---------------------------------
######## --------------------------------------------------



######## --------------------------------------------------
# 4. Analysis of latitudinal trends in budburst and leaf out
#    4.1. Budburst
#    4.2. Leaf out
#    4.a. Null GDD model
#    4.b. Latitude adjustment  (lat)
#    4.c. Growing Season Temp Adjustment (GT)
#    4.d. RelLat (RLAT)
#    4.e. RelGT  (RGT)
######## --------------------------------------------------
# ---------------------------------
# 4.1 Analysis of latitude trends in budburst
# ---------------------------------
bud.gdd <- read.csv(file.path(path.data, 'TT_Budburst_Prediction_Evaluation_all.csv'), stringsAsFactors = T)
bud.lat <- read.csv(file.path(path.data, 'ReVLat_Budburst_Prediction_Evaluation_all.csv'), stringsAsFactors = T)
bud.gt <- read.csv(file.path(path.data, 'ReVGT_Budburst_Prediction_Evaluation_all.csv'), stringsAsFactors = T)
bud.gdd $Model <- "GDD"
bud.lat$Model <- "Lat"
bud.gt $Model <- "WT"

bud.keep <- c("species", "site_id", "individual_id", "year", "latitude", "longitude", "yday", "mid", "diff", "expdiff", "error", "spp.type", "Model")
bud.long <- rbind(bud.gdd[,bud.keep], 
                  bud.lat[,bud.keep], 
                  bud.gt[,bud.keep])
bud.long$Model <- factor(bud.long$Model, levels=c("GDD", "Lat", "WT"))
summary(bud.long)

# -------------
# Looking at overall change for validation species as a group
# -------------
# This one lets us see if we improved upon the spatial pattern or not
bud.slope.lme <- lme(diff ~ latitude*Model, random=list(species=~1, site_id=~1), data=bud.long[bud.long$spp.type=="validation",], na.action=na.omit)
summary(bud.slope.lme)$tTable

# This gets us is there overall a trend with latitude or not
bud.slope.lme2 <- lme(diff ~ latitude*Model - latitude - 1, random=list(species=~1, site_id=~1), data=bud.long[bud.long$spp.type=="validation",], na.action=na.omit)
summary(bud.slope.lme2)$tTable

# -------------


# The linear mixed model with random effects is more appropriate, but since we only have 1 site for marilandica, we need to omit it from the analysis
bud.gdd.lme <- lme(diff ~ latitude*species - latitude - 1, random=list(site_id=~1), data=bud.gdd[,], na.action=na.omit)
bud.gdd.t <- round(summary(bud.gdd.lme)$tTable, 3)[grep("latitude:", row.names(summary(bud.gdd.lme)$tTable)),]


bud.lat.lme <- lme(diff ~ latitude*species - latitude - 1, random=list(site_id=~1), data=bud.lat[,], na.action=na.omit)
bud.lat.t <- round(summary(bud.lat.lme)$tTable, 3)[grep("latitude:", row.names(summary(bud.lat.lme)$tTable)),]

bud.gt.lme <- lme(diff ~ latitude*species - latitude - 1, random=list(site_id=~1), data=bud.gt[,], na.action=na.omit)
bud.gt.t <- round(summary(bud.gt.lme)$tTable, 3)[grep("latitude:", row.names(summary(bud.gt.lme)$tTable)),]


bud.spatial.stats <- data.frame(Species=gsub("latitude:species", "", row.names(bud.gdd.t)),
                                Type=NA,
                                GDD=paste0(round(bud.gdd.t[,1], 2), " (", round(bud.gdd.t[,2], 2),")", ifelse(bud.gdd.t[,5]<0.05, "*", "")),
                                Lat=paste0(round(bud.lat.t[!grepl("ilicifolia", row.names(bud.lat.t)),1], 2), " (", round(bud.lat.t[!grepl("ilicifolia", row.names(bud.lat.t)),2], 2),")", ifelse(bud.lat.t[!grepl("ilicifolia", row.names(bud.lat.t)),5]<0.05, "*", "")),
                                WT=paste0(round(bud.gt.t[!grepl("ilicifolia", row.names(bud.gt.t)),1], 2), " (", round(bud.gt.t[!grepl("ilicifolia", row.names(bud.gt.t)),2], 2),")", ifelse(bud.gt.t[!grepl("ilicifolia", row.names(bud.gt.t)),5]<0.05, "*", "")))

# bud.quil <- data.frame(Species="ilicifolia",
#                        Type=NA,
#                        GDD="",
#                        Lat=paste0(round(bud.lat.t[grepl("ilicifolia", row.names(bud.lat.t)),1], 2), " (", round(bud.lat.t[grepl("ilicifolia", row.names(bud.lat.t)),2], 2),")", ifelse(bud.lat.t[grepl("ilicifolia", row.names(bud.lat.t)),5]<0.05, "*", "")),
#                        WT=paste0(round(bud.gt.t[grepl("ilicifolia", row.names(bud.gt.t)),1], 2), " (", round(bud.gt.t[grepl("ilicifolia", row.names(bud.gt.t)),2], 2),")", ifelse(bud.gt.t[grepl("ilicifolia", row.names(bud.gt.t)),5]<0.05, "*", "")))

# bud.spatial.stats <- rbind(bud.spatial.stats, bud.quil)

bud.spatial.stats$Type[bud.spatial.stats$Species %in% unique(bud.all$species[bud.all$spp.type=="validation"])] <- "validation"
bud.spatial.stats$Type[bud.spatial.stats$Species %in% unique(bud.all$species[bud.all$spp.type=="calibration"])] <- "calibration"
bud.spatial.stats <- bud.spatial.stats[order(bud.spatial.stats$Type, bud.spatial.stats$Species),]


write.csv(bud.spatial.stats, "../data_processed/LatitudeTrends_ModelComparison_Budburst.csv", row.names=F)
write.csv(bud.spatial.stats, file.path(path.google, "Tables/LatitudeTrends_ModelComparison_Budburst.csv"), row.names=F)
# ---------------------------------


# ---------------------------------
# 4.2. Analysis of latitude trends in Leaf Out
# ---------------------------------
leaf.gdd <- read.csv(file.path(path.data, 'TT_Leaf_Prediction_Evaluation_all.csv'), stringsAsFactors = T)
leaf.lat <- read.csv(file.path(path.data, 'RevLat_Leaf_Prediction_Evaluation_all.csv'), stringsAsFactors = T)
leaf.gt <- read.csv(file.path(path.data, 'RevGT_Leaf_Prediction_Evaluation_all.csv'), stringsAsFactors = T)
leaf.gdd $Model <- "GDD"
leaf.lat $Model <- "Lat"
leaf.gt  $Model <- "WT"

leaf.keep <- c("species", "site_id", "individual_id", "year", "latitude", "longitude", "yday", "mid", "diff", "expdiff", "error", "spp.type", "Model")
leaf.long <- rbind(leaf.gdd[,leaf.keep], 
                   leaf.lat[,leaf.keep], 
                   leaf.gt[,leaf.keep])
leaf.long$Model <- factor(leaf.long$Model, levels=c("GDD", "Lat", "WT"))
summary(leaf.long)

# -------------
# Looking at overall change for validation species as a group
# -------------
# This one lets us see if we improved upon the spatial pattern or not
leaf.slope.lme <- lme(diff ~ latitude*Model, random=list(species=~1, site_id=~1), data=leaf.long[leaf.long$spp.type=="validation",], na.action=na.omit)
summary(leaf.slope.lme)$tTable

# This gets us is there overall a trend with latitude or not
leaf.slope.lme2 <- lme(diff ~ latitude*Model - latitude - 1, random=list(species=~1, site_id=~1), data=leaf.long[leaf.long$spp.type=="validation",], na.action=na.omit)
summary(leaf.slope.lme2)$tTable
 # -------------

leaf.gdd.lme <- lme(diff ~ latitude*species - latitude - 1, random=list(site_id=~1), data=leaf.gdd[,], na.action=na.omit)
leaf.gdd.t <- round(summary(leaf.gdd.lme)$tTable, 3)[grep("latitude:", row.names(summary(leaf.gdd.lme)$tTable)),]


leaf.lat.lme <- lme(diff ~ latitude*species - latitude - 1, random=list(site_id=~1), data=leaf.lat[,], na.action=na.omit)
leaf.lat.t <- round(summary(leaf.lat.lme)$tTable, 3)[grep("latitude:", row.names(summary(leaf.lat.lme)$tTable)),]

leaf.gt.lme <- lme(diff ~ latitude*species - latitude - 1, random=list(site_id=~1), data=leaf.gt[,], na.action=na.omit)
leaf.gt.t <- round(summary(leaf.gt.lme)$tTable, 3)[grep("latitude:", row.names(summary(leaf.gt.lme)$tTable)),]


leaf.spatial.stats <- data.frame(Species=gsub("latitude:species", "", row.names(leaf.gdd.t)),
                                Type=NA,
                                GDD=paste0(round(leaf.gdd.t[,1], 2), " (", round(leaf.gdd.t[,2], 2),")", ifelse(leaf.gdd.t[,5]<0.05, "*", "")),
                                Lat=paste0(round(leaf.lat.t[!grepl("ilicifolia", row.names(leaf.lat.t)),1], 2), " (", round(leaf.lat.t[!grepl("ilicifolia", row.names(leaf.lat.t)),2], 2),")", ifelse(leaf.lat.t[!grepl("ilicifolia", row.names(leaf.lat.t)),5]<0.05, "*", "")),
                                WT=paste0(round(leaf.gt.t[!grepl("ilicifolia", row.names(leaf.gt.t)),1], 2), " (", round(leaf.gt.t[!grepl("ilicifolia", row.names(leaf.gt.t)),2], 2),")", ifelse(leaf.gt.t[!grepl("ilicifolia", row.names(leaf.gt.t)),5]<0.05, "*", "")))

# leaf.quil <- data.frame(Species="ilicifolia",
#                        Type=NA,
#                        GDD="",
#                        Lat=paste0(round(leaf.lat.t[grepl("ilicifolia", row.names(leaf.lat.t)),1], 2), " (", round(leaf.lat.t[grepl("ilicifolia", row.names(leaf.lat.t)),2], 2),")", ifelse(leaf.lat.t[grepl("ilicifolia", row.names(leaf.lat.t)),5]<0.05, "*", "")),
#                        WT=paste0(round(leaf.gt.t[grepl("ilicifolia", row.names(leaf.gt.t)),1], 2), " (", round(leaf.gt.t[grepl("ilicifolia", row.names(leaf.gt.t)),2], 2),")", ifelse(leaf.gt.t[grepl("ilicifolia", row.names(leaf.gt.t)),5]<0.05, "*", "")))
# 
# leaf.spatial.stats <- rbind(leaf.spatial.stats, leaf.quil)

leaf.spatial.stats$Type[leaf.spatial.stats$Species %in% unique(leaf.all$species[leaf.all$spp.type=="validation"])] <- "validation"
leaf.spatial.stats$Type[leaf.spatial.stats$Species %in% unique(leaf.all$species[leaf.all$spp.type=="calibration"])] <- "calibration"
leaf.spatial.stats <- leaf.spatial.stats[order(leaf.spatial.stats$Type, leaf.spatial.stats$Species),]
leaf.spatial.stats

write.csv(leaf.spatial.stats, "../data_processed/LatitudeTrends_ModelComparison_LeafOut.csv", row.names=F)
write.csv(leaf.spatial.stats, file.path(path.google, "Tables/LatitudeTrends_ModelComparison_LeafOut.csv"), row.names=F)


# Doing a couple tests just for just Q. imrbicaria & Q. shumardii, which were the only validation species with a lat trend
leaf.slope.quim <- lme(diff ~ latitude*Model, random=list(site_id=~1, individual_id=~1), data=leaf.long[leaf.long$species=="imbricaria",], na.action=na.omit)
summary(leaf.slope.quim)$tTable


# ---------------------------------
######## --------------------------------------------------
