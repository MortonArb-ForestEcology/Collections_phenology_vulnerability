#----------------------------------------------------------------------------------------------------------------------------------#
# Script by : Lucien Fitzpatrick
# Project: Collection phenology vulnerability
# Purpose: This script is the actual model predicting the GDD5.cum value at which budburst or leaf out occur
# Inputs: Full_Bud_Obs.csv
#         Full_Leaf_Obs.csv
# Outputs: Posterior distributions for bud burst and leaf out for every species in our collection
#         A data.frame with information on the model run to check convergence  
# Notes: 
#-----------------------------------------------------------------------------------------------------------------------------------#
library(rjags)
library(coda)
library(dplyr)
library(tidyr)

dat.burst <- read.csv("../data_processed/Full_Bud_Obs.csv")
dat.leaf <- read.csv("../data_processed/Full_Leaf_Obs.csv")
#Creating indexes so the hierarchy can properly function
burst.ind <- aggregate(Site~PlantNumber, data=dat.burst,
                       FUN=min)

burst.loc <- aggregate(Species~PlantNumber, data=dat.burst,
                       FUN=min)


leaf.ind <- aggregate(Site~PlantNumber, data=dat.leaf,
                      FUN=min)

leaf.loc <- aggregate(Species~PlantNumber, data=dat.leaf,
                      FUN=min)
#We are using burst to determine the species becasue it is missing two species: fusiformis and laurifolia
  hierarchical_regression <- "
  model{
    for(k in 1:n){
        mu[k] <- ind[pln[k]]  
        y[k] ~ dnorm(mu[k], sPrec)
    }
    
    for(j in 1:nSp){
      THRESH[j] <-  a[j]
      a[j] ~ dnorm(Tprior[j], aPrec[j])
      aPrec[j] ~ dgamma(0.1, 0.1)
      Tprior[j] ~ dunif(1, 600)
    }
    
    for(t in 1:nLoc){
      Site[t] <-  THRESH[sp[t]] + b[t]
      b[t] ~ dnorm(0, bPrec[t])
      bPrec[t] ~ dgamma(0.1, 0.1)
    }

    for(i in 1:nPln){
        ind[i] <-  Site[loc[i]] + c[i]
        c[i] ~ dnorm(0, cPrec)
    }
    sPrec ~ dgamma(0.1, 0.1)
    cPrec ~ dgamma(0.1, 0.1)

  }
  "
  
  burst.list <- list(y = dat.burst$GDD5.cum, n = length(dat.burst$GDD5.cum),
                     pln = as.numeric(factor(dat.burst$PlantNumber)), nPln = length(unique(dat.burst$PlantNumber)),
                     loc = as.numeric(factor(burst.ind$Site)), nLoc = length(unique(dat.burst$Site)),
                     sp = as.numeric(factor(burst.loc$Species)), nSp = length(unique(dat.burst$Species)))
  
  leaf.list <- list(y = dat.leaf$GDD5.cum, n = length(dat.leaf$GDD5.cum),
                    pln = as.numeric(factor(dat.leaf$PlantNumber)), nPln = length(unique(dat.leaf$PlantNumber)),
                    loc = as.numeric(factor(leaf.ind$Site)), nLoc = length(unique(dat.leaf$Site)),
                    sp = as.numeric(factor(leaf.loc$Species)), nSp = length(unique(dat.leaf$Species)))
  
  

  
  #---------------------------------------------------------#
  #This section actually runs the model and then provides ways to check the output and clean it
  #---------------------------------------------------------#
  burst.model   <- jags.model (file = textConnection(hierarchical_regression),
                               data = burst.list,
                               n.chains = 3)
  
  leaf.model   <- jags.model (file = textConnection(hierarchical_regression),
                              data = leaf.list,
                              n.chains = 3)
  
  
  #Converting the ooutput into a workable format
  burst.out   <- coda.samples (model = burst.model,
                               variable.names = c("THRESH", "aPrec"),
                               n.iter = 700000)
  
  #Converting the ooutput into a workable format
  leaf.out   <- coda.samples (model = leaf.model,
                              variable.names = c("THRESH", "aPrec"),
                              n.iter = 700000)
  
  
  # #Checking that convergence happened
gelman.diag(burst.out)
gelman.diag(leaf.out)

  
  #Removing burnin before convergence occurred
  burnin = 690000                                ## determine convergence from GBR output
  burst.burn <- window(burst.out,start=burnin)  ## remove burn-in
  summary(burst.burn)
  
  leaf.burn <- window(leaf.out, start = burnin)
  summary(leaf.burn)
  
  #converting them into a dataframe 
  burst.df <- as.data.frame(as.matrix(burst.burn))
  leaf.df <- as.data.frame(as.matrix(leaf.burn))
  

write.csv(burst.df, file.path("../data_processed/model_output", paste0(SP, "_TT_model_budburst.csv")), row.names=F)
write.csv(leaf.df, file.path("../data_processed/model_output", paste0(SP, "_TT_model_leaf.csv")), row.names=F)
#Checking convergence and confidence interval of all species
Check

#If they are below 1.1 then they are consider converged (I'll get the right citation for that I've seen it in a few papers)
Close <- Check[(Check$burst.converge > 1.05 | Check$leaf.converge > 1.05) , ]
Close
