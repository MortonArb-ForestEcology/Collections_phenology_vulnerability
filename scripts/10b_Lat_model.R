#----------------------------------------------------------------------------------------------------------------------------------#
# Script by: Lucien Fitzpatrick
# Project: Collection phenology vulnerability
# Purpose: This script fits our latitude model 
# Inputs: Full_Bud_Obs.csv
#         Full_Leaf_Obs.csv  
# Outputs:latitude model output
# Notes: 
#-----------------------------------------------------------------------------------------------------------------------------------#
library(rjags)
library(coda)
library(dplyr)
library(tidyr)

dat.burst <- read.csv("../data_processed/Full_Bud_Obs.csv")
dat.burst <- dat.burst[!dat.burst$flag.3sig & dat.burst$obs.type=="calibration" & dat.burst$spp.type!="validation-tier2",]
dat.burst$pln <- as.numeric(factor(dat.burst$individual_id))
dat.burst$loc <- as.numeric(factor(dat.burst$site_id))
dat.burst$sp <- as.numeric(factor(dat.burst$species))
summary(dat.burst)

dat.leaf <- read.csv("../data_processed/Full_Leaf_Obs.csv")
dat.leaf <- dat.leaf[!dat.leaf$flag.3sig & dat.leaf$obs.type=="calibration" & dat.leaf$spp.type!="validation-tier2",]
dat.leaf$pln <- as.numeric(factor(dat.leaf$individual_id))
dat.leaf$loc <- as.numeric(factor(dat.leaf$site_id))
dat.leaf$sp <- as.numeric(factor(dat.leaf$species))
summary(dat.leaf)

#Creating indexes so the hierarchy can properly function
spp.ind.bud <- aggregate(species ~ sp, data=dat.burst, FUN=min)
spp.ind.leaf <- aggregate(species ~ sp, data=dat.leaf, FUN=min)

#Giving us an index for the spatial effect of individuals nested within sites (spatial effect)
burst.ind <- aggregate(cbind(site_id, loc)~individual_id + pln, data=dat.burst,
                       FUN=min)
head(burst.ind)
#Giving us an index for the species effect of individuals nested within species (species efffect)
burst.loc <- aggregate(cbind(species, sp)~individual_id + pln, data=dat.burst,
                       FUN=min)
head(burst.loc)

#Giving us an index for the spatial effect of individuals nested within sites (spatial effect)
leaf.ind <- aggregate(cbind(site_id, loc)~individual_id + pln, data=dat.leaf,
                      FUN=min)
#Giving us an index for the species effect of individuals nested within species (species efffect)
leaf.loc <- aggregate(cbind(species, sp)~individual_id + pln, data=dat.leaf,
                      FUN=min)
# 
# #Creating indexes so the hierarchy can properly function
# burst.ind <- aggregate(Site~PlantNumber, data=dat.burst,
#                        FUN=min)
# 
# burst.loc <- aggregate(Species~PlantNumber, data=dat.burst,
#                        FUN=min)
# 
# 
# leaf.ind <- aggregate(Site~PlantNumber, data=dat.leaf,
#                       FUN=min)
# 
# leaf.loc <- aggregate(Species~PlantNumber, data=dat.leaf,
#                       FUN=min)

#Actual spatial bias correction model
spatial_correction <- "
  model{
    for(k in 1:n){
        mu[k] <- ind.sp[pln[k]] + (ind.loc[pln[k]] * GT[k] + Int[pln[k]])   
        y[k] ~ dnorm(mu[k], sPrec)
    }
      #Start of Location effect 1
      bias.loc <- x
      x ~ dnorm(0, xPrec)
      xPrec ~ dgamma(0.1, 0.1)
      
      int.loc <- z
      z ~ dnorm(0, zPrec)
      zPrec ~ dgamma(0.1, 0.1)


    for(t in 1:nSp){
      #Start of Species effect 1
      Sp.bias[t] <-   b[t]
      b[t] ~ dnorm(0, bPrec[t])
      bPrec[t] ~ dgamma(0.1, 0.1)
    }
    
     for(t in 1:nLoc){
     #Location effect slope
      Site.loc[t] <-  bias.loc + c.loc[t]
      c.loc[t] ~ dnorm(0, cPrec.loc[t])
      cPrec.loc[t] ~ dgamma(0.1, 0.1)
      
       #Location effect intercept
      int.site[t] <-  int.loc + i.loc[t]
      i.loc[t] ~ dnorm(0, i.prec[t])
      i.prec[t] ~ dgamma(0.1, 0.1)
      
    }
    
    for(i in 1:nPln){
        #Species effect 2
        ind.sp[i] <-   Sp.bias[sp[i]] + d.sp[i]
        d.sp[i] ~ dnorm(0, dPrec.sp)
        
        #Location effect slope
        ind.loc[i] <- Site.loc[loc[i]] + d.loc[i]
        d.loc[i] ~dnorm(0, dPrec.loc)
        
        #Location effect intercept
        Int[i] <- int.site[loc[i]] + x.loc[i]
        x.loc[i] ~dnorm(0, xPrec.loc)
    }
    sPrec ~ dgamma(0.1, 0.1)
    dPrec.sp ~ dgamma(0.1, 0.1)
    dPrec.loc ~ dgamma(0.1, 0.1)
    xPrec.loc ~ dgamma(0.1, 0.1)
  }
  "
burst.list <- list(y = dat.burst$GDD5.cum, n = length(dat.burst$GDD5.cum), GT = dat.burst$latitude,
                   pln = dat.burst$pln, nPln = length(unique(dat.burst$individual_id)),
                   loc = burst.ind$loc, nLoc = length(unique(dat.burst$site_id)),
                   sp = burst.loc$sp, nSp = length(unique(dat.burst$species)))

leaf.list <- list(y = dat.leaf$GDD5.cum, n = length(dat.leaf$GDD5.cum), GT = dat.leaf$latitude,
                  pln = dat.leaf$pln, nPln = length(unique(dat.leaf$individual_id)),
                  loc = leaf.ind$loc, nLoc = length(unique(dat.leaf$site_id)),
                  sp = leaf.loc$sp, nSp = length(unique(dat.leaf$species)))


burst.model   <- jags.model (file = textConnection(spatial_correction),
                             data = burst.list,
                             n.chains = 3)

leaf.model   <- jags.model (file = textConnection(spatial_correction),
                            data = leaf.list,
                            n.chains = 3)


#Converting the ooutput into a workable format
burst.out   <- coda.samples (model = burst.model,
                             variable.names = c("Sp.bias", "bias.loc", "int.loc", "bPrec", "xPrec", "zPrec"),
                             n.iter = 700000)

#Converting the ooutput into a workable format
leaf.out   <- coda.samples (model = leaf.model,
                            variable.names = c("Sp.bias", "bias.loc", "int.loc", "bPrec", "xPrec", "zPrec"),
                            n.iter = 700000)


#Checking that convergence happened
gel.burst <- data.frame(gelman.diag(burst.out)$psrf)
gel.leaf <- data.frame(gelman.diag(leaf.out)$psrf)


row.names(gel.burst) <- c(paste(rep(c("Sp.bias", "bPrec"), each=nrow(spp.ind.bud)), spp.ind.bud$species, sep="."), "bias.loc", "int.loc", "xPrec", "zPrec")
row.names(gel.leaf) <- c(paste(rep(c("Sp.bias", "bPrec"), each=nrow(spp.ind.bud)), spp.ind.bud$species, sep="."), "bias.loc", "int.loc", "xPrec", "zPrec")

write.csv(gel.burst, "../data_processed/model_output/RevLat_Budburst_GelmanDiag.csv", row.names=T)
write.csv(gel.leaf, "../data_processed/model_output/RevLat_Leaf_GelmanDiag.csv", row.names=T)


#Removing burnin before convergence occurred
burnin = 690000                                ## determine convergence from GBR output
burst.burn <- window(burst.out,start=burnin)  ## remove burn-in
summary(burst.burn)

leaf.burn <- window(leaf.out, start = burnin)
summary(leaf.burn)

#converting them into a dataframe 
burst.df <- as.data.frame(as.matrix(burst.burn))
leaf.df <- as.data.frame(as.matrix(leaf.burn))
summary(burst.df)

summary(leaf.df)

# Fixing label names real quick
names(burst.df)[grep("Sp.bias", names(burst.df))] <- paste("Sp.bias", spp.ind.bud$species, sep=".")
names(burst.df)[grep("bPrec", names(burst.df))] <- paste("bPrec", spp.ind.bud$species, sep=".")

names(leaf.df)[grep("Sp.bias", names(leaf.df))] <- paste("Sp.bias", spp.ind.leaf$species, sep=".")
names(leaf.df)[grep("bPrec", names(leaf.df))] <- paste("bPrec", spp.ind.leaf$species, sep=".")


write.csv(burst.df, file.path("../data_processed/model_output/RevLat_model_budburst.csv"), row.names=F)
write.csv(leaf.df, file.path("../data_processed/model_output/RevLat_model_leaf.csv"), row.names=F)

