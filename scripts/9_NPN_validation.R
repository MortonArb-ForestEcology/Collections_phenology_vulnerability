#----------------------------------------------------------------------------------------------------------------------------------#
# Script by: Lucien Fitzpatrick
# Project: Collection phenology vulnerability
# Purpose: This script downloads the neccessary daymet weather data to match our NPN sites
# Inputs: Budburst data frame with weather metrics as created by script 8
#         Leaf out data frame with weather metrics as created by script 8 
# Outputs: Tables containing summary statistics of the GDD5.cum Thresholds for each species and site
# Notes: 
#-----------------------------------------------------------------------------------------------------------------------------------#

#Reading in the NPN data with weather metrics
bud.npn <- read.csv("../data_processed/Budburst_Phenology_NPN_combined.csv")
leaf.npn <- read.csv("../data_processed/Leaf_Phenology_NPN_combined.csv")

#Aggreating by species and site for the CI
dat.burst.ci <- aggregate(GDD5.cum~species+site_id, data=bud.npn,
                       FUN=function(x) quantile(x,c(0.025, 0.5, 0.975)), na.action = na.omit)

write.csv(dat.burst.ci, "../data_processed/Arb_pheno/Budburst_Phenology_NPN_combined.csv", row.names = F)

#Aggregating by Species and site for the CI 
dat.leaf.ci <- aggregate(GDD5.cum~species+site_id, data=leaf.npn,
                        FUN=function(x) quantile(x,c(0.025, 0.5, 0.975)))

write.csv(dat.leaf.ci, "../data_processed/Arb_pheno/Leaf_Phenology_NPN_combined.csv", row.names = F)


#Reading in the posterior predictions from the models
bud.density <- read.csv(file.path("../data_processed/Arb_Pheno", paste("Density values for budburst.csv")))

leaf.density <- read.csv(file.path("../data_processed/Arb_Pheno", paste("Density values for leaf.csv")))

#Seperating the species from the full genus and species combination into two seperate piles
bud.density <- tidyr::separate(bud.density, col = "species", into=c("genus", "species"))

leaf.density <- tidyr::separate(leaf.density, col = "species", into=c("genus", "species"))

#Only working the species in the npn system
#This gets us 12 species
bud.density <- bud.density[bud.density$species %in% unique(bud.npn$species), ]

leaf.density <- leaf.density[leaf.density$species %in% unique(leaf.npn$species), ]

#Pulling out 100 random draws from the posterior distribution
bud.arb <- data.frame()
for(SP in unique(bud.density$species)){
  dat.SP <- bud.density[bud.density$species == SP,]
  dat.draw <- as.data.frame(sample(dat.SP$pred, 100))
  dat.draw$species <- SP
  colnames(dat.draw) <- c("GDD5.cum", "species")
  bud.arb <- rbind(bud.arb, dat.draw)
}

#Pulling out 100 random draws from the posterior distribution
leaf.arb <- data.frame()
for(SP in unique(leaf.density$species)){
  dat.SP <- leaf.density[leaf.density$species == SP,]
  dat.draw <- as.data.frame(sample(dat.SP$pred, 100))
  dat.draw$species <- SP
  colnames(dat.draw) <- c("GDD5.cum", "species")
  leaf.arb <- rbind(leaf.arb, dat.draw)
}

ggplot(NULL)+
  theme(axis.text.x = element_text(face = "bold",, size = 12, angle = 45))+
  ggtitle('Burst Thermal Time Thresholds of Quercus species in the oak collection') +
  geom_boxplot(data= bud.arb, outlier.colour="red", mapping = aes(x = species, y= GDD5.cum)) +
  #geom_dotplot(data = bud.npn, mapping = aes(x = species, y = GDD5.cum), binaxis='y', stackdir='center') +
  #scale_y_continuous('DENSITY (%)')+
  theme(legend.position='none')
  #xlim(0, 250)

#library(ggplot2)
#path.figures <- "../figures"
#if(!dir.exists(path.figures)) dir.create(path.figures)
#png(width= 750, filename= file.path(path.figures, paste0('Oak collection TT burst', '.png')))
#ggplot(NULL) +
#  facet_grid(species~. , scales = "free_y")+
#  theme(strip.text.y = element_text(size = 10, angle = 0))+
#  ggtitle('Burst Thermal Time Thresholds of Quercus species in the oak collection') +
#  geom_density(data= bud.density, mapping = aes(x= pred, fill = species), alpha=0.5, ) +
#  geom_density(data = bud.npn, mapping = aes(x = GDD5.cum, color = )) +
#  scale_y_continuous('DENSITY (%)')+
#  theme(legend.position='none')+
#  xlim(0, 250)
#dev.off()

#ggplot(data= leaf.density) +
#  facet_grid(species~. , scales = "free_y")+
#  theme(strip.text.y = element_text(size = 10, angle = 0))+
#  ggtitle('Burst Thermal Time Thresholds of Quercus species in the oak collection') +
#  geom_density(mapping = aes(x= pred, fill = species), alpha=0.5, ) +
#  scale_y_continuous('DENSITY (%)')+
#  theme(legend.position='none')+
#  xlim(0, 400)

