#----------------------------------------------------------------------------------------------------------------------------------#
# Script by: Lucien Fitzpatrick
# Project: Collection phenology vulnerability
# Purpose: This script downloads the neccessary daymet weather data to match our NPN sites
# Inputs: Budburst data frame with weather metrics as created by script 8
#         Leaf out data frame with weather metrics as created by script 8 
# Outputs: Tables containing summary statistics of the GDD5.cum Thresholds for each species and site
# Notes: 
#-----------------------------------------------------------------------------------------------------------------------------------#
library(ggplot2)

dat.budburst <- read.csv("../data_raw/Raw_Phenology_NPN_combined_budburst.csv")
dat.budburst <- dat.budburst[!is.na(dat.budburst$Yday),]
dat.budburst <- dat.budburst[!is.infinite(dat.budburst$Yday),]

#Putting a filter on reports after August 1st since we are interested in spring phenology
dat.budburst <- dat.budburst[dat.budburst$Yday < 213,]

npn.burst.ci <- aggregate(Yday~species+site_id+year, data=dat.budburst,
                          FUN=mean, na.action = na.omit)

#npn.burst.ci$date <- as.Date(npn.burst.ci$Yday, origin = paste(npn.burst.ci$year,"-01-01", sep = ""))


#Reading in the predictions for npn sites
pred.bust <- read.csv("../data_processed/Budburst_Phenology_NPN_prediction.csv")

pred.burst.ci <- aggregate(yday.pred~species+site+year, data=pred.burst,
                          FUN=function(x) quantile(x,c(0.025, 0.5, 0.975)), na.action = na.omit)

pred.burst.ci$tail <- pred.burst.ci$yday.pred[,1]
pred.burst.ci$mid <- pred.burst.ci$yday.pred[,2]
pred.burst.ci$head <- pred.burst.ci$yday.pred[,3]

pred.burst.ci$yday.pred <- NULL

comb.burst <- merge(npn.burst.ci, pred.burst.ci, by.x = c("species", "site_id", "year"), by.y = c("species", "site", "year"))

comb.test <- comb.burst[comb.burst$species == "stellata",]

path.figures <- "../figures/Arb_pheno/"
png(width= 750, filename= file.path(path.figures, paste0('NPN Validation scatter budburst', '.png')))
ggplot(comb.burst, aes(x = Yday, y = mid))+
  facet_wrap(~species) +
  geom_point() +
  geom_smooth(method='lm', se = FALSE, linetype = "dashed")+
  geom_abline(intercept = 0, slope = 1)+
  xlim(0, 220)+ylim(0, 220)+
  ggtitle('Observed Yday of budburst vs. predicted') +
  xlab("Observed Yday")+
  ylab("Predicted Yday")
dev.off()


map.us <- map_data("state")
png(paste0(path.figures, "NPN Quercus Map BudBurst.png", sep=""), height=6, width=8, units="in", res=180)
ggplot() +
  coord_fixed(1.3) +
  ggtitle(paste("NPN Quercus Breaking Leaf Buds", sep=" ")) +
  geom_polygon(data=map.us, aes(x=long, y=lat, group=group), fill=NA, color="black") +
  geom_point(data=dat.budburst, aes(x=longitude, y=latitude, color=species), alpha=0.75) +
  facet_wrap(~species)+
  #scale_color_continuous(type = "viridis") +
  #scale_size_continuous()+
  labs(color = "Log of GDD5.cum THreshold",size="Number of Observations") +
  theme(panel.background = element_blank(),
        panel.grid = element_blank(),
        axis.text=element_blank(),
        axis.title=element_blank(),
        axis.ticks = element_blank())
dev.off()

for(SP in unique(comb.burst$species)){
  burst.tmp <- comb.burst[comb.burst$species == SP,]
  png(paste0(path.figures, SP, " Predicted vs. observed Site_BudBurst.png", sep=""), height=6, width=8, units="in", res=180)
  ggplot(burst.tmp, aes(x = Yday, y = mid))+
    facet_wrap(~site_id) +
    geom_point() +
    geom_smooth(method='lm', se = FALSE, linetype = "dashed")+
    geom_abline(intercept = 0, slope = 1)+
    xlim(0, 220)+ylim(0, 220)+
    ggtitle('Observed Yday of budburst vs. predicted') +
    xlab("Observed Yday")+
    ylab("Predicted Yday")
  dev.off()
}

Obs <- as.data.frame(table(dat.budburst$site))
colnames(Obs) <- c("Site", "Freq")
size <- Obs[Obs$Freq > 2, ]





dat.leaf <- read.csv("../data_raw/Raw_Phenology_NPN_combined_leaf.csv")
dat.leaf <- dat.leaf[!is.na(dat.leaf$Yday),]
dat.leaf <- dat.leaf[!is.infinite(dat.leaf$Yday),]

dat.leaf <- dat.leaf[dat.leaf$Yday < 213,]

npn.leaf.ci <- aggregate(Yday~species+site_id+year, data=dat.leaf,
                          FUN=mean, na.action = na.omit)


pred.leaf <- read.csv("../data_processed/Leaf_Phenology_NPN_combined.csv")

pred.leaf.ci <- aggregate(yday.pred~species+site+year, data=pred.leaf,
                           FUN=function(x) quantile(x,c(0.025, 0.5, 0.975)), na.action = na.omit)

pred.leaf.ci$tail <- pred.leaf.ci$yday.pred[,1]
pred.leaf.ci$mid <- pred.leaf.ci$yday.pred[,2]
pred.leaf.ci$head <- pred.leaf.ci$yday.pred[,3]

pred.leaf.ci$yday.pred <- NULL

comb.leaf <- merge(npn.leaf.ci, pred.leaf.ci, by.x = c("species", "site_id", "year"), by.y = c("species", "site", "year"))


png(width= 750, filename= file.path(path.figures, paste0('NPN Validation scatter leaf', '.png')))
ggplot(comb.leaf, aes(x = Yday, y = mid))+
  facet_wrap(~species) +
  geom_point() +
  geom_smooth(method='lm', se = FALSE, linetype = "dashed")+
  geom_abline(intercept = 0, slope = 1)+
  xlim(0, 220)+ylim(0, 220)+
  ggtitle('Observed Yday of leaf vs. predicted') +
  xlab("Observed Yday")+
  ylab("Predicted Yday")
dev.off()


map.us <- map_data("state")
png(paste0(path.figures, "NPN Quercus Map leaf.png", sep=""), height=6, width=8, units="in", res=180)
ggplot() +
  coord_fixed(1.3) +
  ggtitle(paste("NPN Quercus Breaking Leaf Buds", sep=" ")) +
  geom_polygon(data=map.us, aes(x=long, y=lat, group=group), fill=NA, color="black") +
  geom_point(data=dat.leaf, aes(x=longitude, y=latitude, color=species), alpha=0.75) +
  facet_wrap(~species)+
  #scale_color_continuous(type = "viridis") +
  #scale_size_continuous()+
  labs(color = "Log of GDD5.cum THreshold",size="Number of Observations") +
  theme(panel.background = element_blank(),
        panel.grid = element_blank(),
        axis.text=element_blank(),
        axis.title=element_blank(),
        axis.ticks = element_blank())
dev.off()

for(SP in unique(comb.leaf$species)){
  leaf.tmp <- comb.leaf[comb.leaf$species == SP,]
  png(paste0(path.figures, SP, " Predicted vs. observed Site_leaf.png", sep=""), height=6, width=8, units="in", res=180)
  ggplot(leaf.tmp, aes(x = Yday, y = mid))+
    facet_wrap(~site_id) +
    geom_point() +
    geom_smooth(method='lm', se = FALSE, linetype = "dashed")+
    geom_abline(intercept = 0, slope = 1)+
    xlim(0, 220)+ylim(0, 220)+
    ggtitle('Observed Yday of leaf vs. predicted') +
    xlab("Observed Yday")+
    ylab("Predicted Yday")
  dev.off()
}

Obs <- as.data.frame(table(dat.leaf$site))
colnames(Obs) <- c("Site", "Freq")
size <- Obs[Obs$Freq > 2, ]

