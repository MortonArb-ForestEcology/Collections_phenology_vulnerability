#----------------------------------------------------------------------------------------------------------------------------------#
# Script by: Lucien Fitzpatrick
# Project: Collection phenology vulnerability
# Purpose: This script is used to validate our first round of predictions
# Inputs: Budburst data frame with weather metrics as created by script 8
#         Leaf out data frame with weather metrics as created by script 8 
# Outputs:Validation data frames needed to fit the bias correction models 
#         Tables containing summary statistics of the GDD5.cum Thresholds for each species and site
# Notes: This scripts creates the neccessary data for the model to fit it's bias correction 
#        This script only needs to have it's frst half run as the rest is visualizations
#-----------------------------------------------------------------------------------------------------------------------------------#
library(ggplot2)

#reading daymet to attach GTmean
dat.met <- read.csv("../data_processed/Daymet_clean_data.csv")
dat.met$site <- as.character(dat.met$site)
dat.met$Date <- as.Date(dat.met$Date)

#Reading in our cleaned NPN data
dat.budburst <- read.csv("../data_raw/Raw_Phenology_NPN_combined_budburst.csv")

for(YR in unique(dat.budburst$year)){
  for(LOC in unique(dat.budburst[dat.budburst$year==YR, "site_id"])){
    #Pulling out daymet data matching the year and site
    met.now <- dat.met[dat.met$year==YR & dat.met$site==LOC,]
    dat.budburst[dat.budburst$year==YR &dat.budburst$site_id == LOC, "GTmean"] <- unique(met.now$GTmean)
  }
}


#Putting a filter on reports after August 1st since we are interested in spring phenology
dat.budburst <- dat.budburst[dat.budburst$Yday < 213,]

#Calculting the number of sites so we can filter for our second step of evaluation
for(SP in unique(dat.budburst$species)){
  dat.sp <- dat.budburst[dat.budburst$species == SP,]
  dat.budburst[dat.budburst$species == SP, "nsites"] <- length(unique(dat.sp$site_id))
}

#dat.budburst <- dat.budburst[dat.budburst$nsites < 10,]

#Reading in the predictions for npn sites
pred.burst <- read.csv("../data_processed/Budburst_Phenology_NPN_prediction.csv")

#aggregating our predictions
pred.burst.ci <- aggregate(yday.pred~species+site+year, data=pred.burst,
                          FUN=function(x) quantile(x,c(0.025, 0.5, 0.975)), na.action = na.omit)

#Pulling out the quantiles from our aggregate function
pred.burst.ci$tail <- pred.burst.ci$yday.pred[,1]
pred.burst.ci$mid <- pred.burst.ci$yday.pred[,2]
pred.burst.ci$head <- pred.burst.ci$yday.pred[,3]

pred.burst.ci$yday.pred <- NULL

#Merging our two data frames so we can compare
comb.burst <- merge(dat.budburst, pred.burst.ci, by.x = c("species", "site_id", "year"), by.y = c("species", "site", "year"))

#Calculating the difference
comb.burst$diff <- comb.burst$Yday - comb.burst$mid

#Absolute value of that difference
comb.burst$absdiff <- abs(comb.burst$diff)

#1 = yes error, 0 = no error
comb.burst$error <- ifelse((comb.burst$Yday < comb.burst$tail | comb.burst$Yday > comb.burst$head), 1, 0)

comb.burst$expdiff <- comb.burst$diff ^ 2

bad <- comb.burst[comb.burst$absdiff >= 30,]

library(dplyr)

#Getting number of Obs per species
burst.diff <- comb.burst %>% count(species)


#Filling data frame with summary stats of interest
burst.diff[,c("median_abs_diff")] <- aggregate(absdiff~species, data = comb.burst,
                                       FUN=median, na.rm=F)[,c("absdiff")] 

burst.diff[,c("mean_abs_diff")] <- aggregate(absdiff~species, data = comb.burst,
                                      FUN=mean, na.rm=F)[,c("absdiff")]

burst.diff[,c("RMSE")] <- aggregate(expdiff~species, data = comb.burst,
                                    FUN=mean, na.rm=F)[,c("expdiff")]

burst.diff$RMSE <- sqrt(burst.diff$RMSE)

burst.diff[,c("error_rate")] <- aggregate(error~species, data = comb.burst,
                                    FUN=mean, na.rm=F)[,c("error")]

#Creating data frame that contains the summary stats for all oaks
oak.burst <- data.frame("Oaks")
colnames(oak.burst) <- "species"
oak.burst$n <- nrow(comb.burst)
oak.burst$median_abs_diff <- median(comb.burst$absdiff)
oak.burst$mean_abs_diff <- mean(comb.burst$absdiff)
oak.burst$error_rate <- mean(comb.burst$error)
oak.burst$RMSE <- sqrt(mean(comb.burst$expdiff))

#Writing our summary table for sharing/storing
path.data <- "../data_processed"
burst.diff <- rbind(oak.burst, burst.diff)
write.csv(burst.diff, file.path(path.data, 'First Budburst Prediction summary.csv'), row.names = F)

summary(comb.burst)
val <- c("ilicifolia", "imbricaria", "marilandica", "shumardii", "stellata")
comb.burst$type <- ifelse(comb.burst$species %in% val, "validation", "calibration")
write.csv(comb.burst, file.path(path.data, 'First_Budburst_Prediction_Evaluation_all.csv'), row.names = F)

#---------------------------------------------#
#Here begins the leaf out section
#---------------------------------------------#
#This section is identical to the above section save for being about leaf out data

dat.leaf <- read.csv("../data_raw/Raw_Phenology_NPN_combined_leaf.csv")

for(YR in unique(dat.leaf$year)){
  for(LOC in unique(dat.leaf[dat.leaf$year==YR, "site_id"])){
    #Pulling out daymet data matching the year and site
    met.now <- dat.met[dat.met$year==YR & dat.met$site==LOC,]
    dat.leaf[dat.leaf$year==YR &dat.leaf$site_id == LOC, "GTmean"] <- unique(met.now$GTmean)
  }
}


dat.leaf <- dat.leaf[dat.leaf$Yday < 213,]

#Calculting the number of sites so we can filter for our second step of evaluation
for(SP in unique(dat.leaf$species)){
  dat.sp <- dat.leaf[dat.leaf$species == SP,]
  dat.leaf[dat.leaf$species == SP, "nsites"] <- length(unique(dat.sp$site_id))
}

#dat.leaf <- dat.leaf[dat.leaf$nsites < 10,]


pred.leaf <- read.csv("../data_processed/Leaf_Phenology_NPN_prediction.csv")

pred.leaf.ci <- aggregate(yday.pred~species+site+year, data=pred.leaf,
                          FUN=function(x) quantile(x,c(0.025, 0.5, 0.975)), na.action = na.omit)

pred.leaf.ci$tail <- pred.leaf.ci$yday.pred[,1]
pred.leaf.ci$mid <- pred.leaf.ci$yday.pred[,2]
pred.leaf.ci$head <- pred.leaf.ci$yday.pred[,3]

pred.leaf.ci$yday.pred <- NULL

comb.leaf <- merge(dat.leaf, pred.leaf.ci, by.x = c("species", "site_id", "year"), by.y = c("species", "site", "year"))

comb.leaf$diff <- comb.leaf$Yday - comb.leaf$mid

comb.leaf$absdiff <- abs(comb.leaf$diff)

#1 = yes error, 0 = no error
comb.leaf$error <- ifelse((comb.leaf$Yday < comb.leaf$tail | comb.leaf$Yday > comb.leaf$head), 1, 0)

comb.leaf$expdiff <- comb.leaf$diff ^ 2

library(dplyr)

#Filling data frame with summary stats of interest
leaf.diff <- comb.leaf %>% count(species)

leaf.diff[,c("median_abs_diff")] <- aggregate(absdiff~species, data = comb.leaf,
                                              FUN=median, na.rm=F)[,c("absdiff")] 

leaf.diff[,c("mean_abs_diff")] <- aggregate(absdiff~species, data = comb.leaf,
                                            FUN=mean, na.rm=F)[,c("absdiff")]

leaf.diff[,c("RMSE")] <- aggregate(expdiff~species, data = comb.leaf,
                                    FUN=mean, na.rm=F)[,c("expdiff")]

leaf.diff$RMSE <- sqrt(leaf.diff$RMSE)

leaf.diff[,c("error_rate")] <- aggregate(error~species, data = comb.leaf,
                                         FUN=mean, na.rm=F)[,c("error")]

#Creating general oak data frame to later be combined
oak.leaf <- data.frame("Oaks")
colnames(oak.leaf) <- "species"
oak.leaf$n <- nrow(comb.leaf)
oak.leaf$median_abs_diff <- median(comb.leaf$absdiff)
oak.leaf$mean_abs_diff <- mean(comb.leaf$absdiff)
oak.leaf$error_rate <- mean(comb.leaf$error)
oak.leaf$RMSE <- sqrt(mean(comb.leaf$expdiff))


path.data <- "../data_processed"
leaf.diff <- rbind(oak.leaf, leaf.diff)
write.csv(leaf.diff, file.path(path.data, 'First Leaf Prediction summary.csv'), row.names = F)

comb.leaf$type <- ifelse(comb.leaf$species %in% val, "validation", "calibration")
write.csv(comb.leaf, file.path(path.data, 'First_Leaf_Prediction_Evaluation_all.csv'), row.names = F)

#---------------------------------------------------------------------------#
#Below here are visualizations 
#---------------------------------------------------------------------------#


#Exploratory plot of error rate
ggplot(comb.burst, aes(x = error))+
  facet_wrap(~species) +
  geom_histogram() 

#Histogram of distirubtion of difference between observed and predicted
path.figures <- "../figures/Arb_pheno/"
png(width= 750, filename= file.path(path.figures, paste0('Budburst NPN Validation Yday diff', '.png')))
ggplot(comb.burst, aes(x = diff))+
  facet_wrap(~species) +
  geom_histogram() +
  ggtitle('Difference in Observed Yday from Predicted Yday')
dev.off()

#same histogram but with absolute difference
#ggplot(comb.burst, aes(x = absdiff))+
  facet_wrap(~species) +
  geom_histogram() 

#Scatter plot to compare 1:1 line between Prediction and Yday
png(width= 750, filename= file.path(path.figures, paste0('NPN Validation scatter budburst', '.png')))
ggplot(comb.burst, aes(x = Yday, y = mid))+
  facet_wrap(~species) +
  geom_point(aes( color = latitude)) +
  geom_errorbar(aes(ymin=tail, ymax=head), width=.2,
                position=position_dodge(0.05))+
  geom_smooth(method='lm', se = FALSE, linetype = "dashed")+
  geom_abline(intercept = 0, slope = 1)+
  scale_color_continuous(type = "viridis")+
  xlim(0, 220)+ylim(0, 220)+
  ggtitle('Observed Yday of budburst vs. predicted') +
  xlab("Observed Yday")+
  ylab("Predicted Yday")
dev.off()

#Map of where the sites in our data are located
map.us <- map_data("state")
png(paste0(path.figures, "NPN Quercus Map BudBurst.png", sep=""), height=6, width=8, units="in", res=180)
ggplot() +
  coord_fixed(1.3) +
  ggtitle(paste("NPN Quercus Breaking Leaf Buds", sep=" ")) +
  geom_polygon(data=map.us, aes(x=long, y=lat, group=group), fill=NA, color="black") +
  geom_point(data=dat.budburst, aes(x=longitude, y=latitude, color=species), alpha=0.75) +
  facet_wrap(~species)+
  #scale_color_continuous(type = "viridis") +
  #scale_size_continuous()+
  labs(color = "Log of GDD5.cum THreshold",size="Number of Observations") +
  theme(panel.background = element_blank(),
        panel.grid = element_blank(),
        axis.text=element_blank(),
        axis.title=element_blank(),
        axis.ticks = element_blank())
dev.off()

png(paste0(path.figures, "NPN Quercus Map BudBurst Resid.png", sep=""), height=6, width=8, units="in", res=180)
ggplot() +
  coord_fixed(1.3) +
  ggtitle(paste("NPN Quercus Breaking Leaf Buds", sep=" ")) +
  geom_polygon(data=map.us, aes(x=long, y=lat, group=group), fill="gray50", color="black") +
  geom_point(data=comb.burst, aes(x=longitude, y=latitude, color=diff), alpha=0.75) +
  facet_wrap(~species)+
  scale_color_gradient2(low="#fc8d59", high="#91bfdb", mid="#ffffbf") +
  #scale_color_continuous(type = "viridis") +
  #scale_size_continuous()+
  labs(color = "Resid") +
  theme(panel.background = element_blank(),
        panel.grid = element_blank(),
        axis.text=element_blank(),
        axis.title=element_blank(),
        axis.ticks = element_blank())
dev.off()

#---------------------------------------------#
#Here begins the leaf out section
#---------------------------------------------#
#This section is identical to the above section save for being about leaf out data


#histogram of error (only 1 or 0)
ggplot(comb.leaf, aes(x = error))+
  facet_wrap(~species) +
  geom_histogram() 

#histogram of diff
path.figures <- "../figures/Arb_pheno/"
png(width= 750, filename= file.path(path.figures, paste0('Leaf NPN Validation Yday diff', '.png')))
ggplot(comb.burst, aes(x = diff))+
  facet_wrap(~species) +
  geom_histogram() +
  ggtitle('Difference in Observed Yday from Predicted Yday')
dev.off()

#Histogram of absdiff
ggplot(comb.leaf, aes(x = absdiff))+
  facet_wrap(~species) +
  geom_histogram() 

#Scatter plot testing 1:1 line
png(width= 750, filename= file.path(path.figures, paste0('NPN Validation scatter leaf', '.png')))
ggplot(comb.leaf, aes(x = Yday, y = mid))+
  facet_wrap(~species) +
  geom_point() +
  geom_smooth(method='lm', se = FALSE, linetype = "dashed")+
  geom_abline(intercept = 0, slope = 1)+
  xlim(0, 220)+ylim(0, 220)+
  geom_errorbar(aes(ymin=tail, ymax=head), width=.2,
                position=position_dodge(0.05))+
  ggtitle('Observed Yday of leaf vs. predicted') +
  xlab("Observed Yday")+
  ylab("Predicted Yday")
dev.off()

#Map of sites we are using
map.us <- map_data("state")
png(file.path(path.figures, "NPN Quercus Map leaf.png"), height=6, width=8, units="in", res=180)
ggplot() +
  coord_fixed(1.3) +
  ggtitle(paste("NPN Quercus Breaking Leaf Buds", sep=" ")) +
  geom_polygon(data=map.us, aes(x=long, y=lat, group=group), fill=NA, color="black") +
  geom_point(data=dat.leaf, aes(x=longitude, y=latitude, color=species), alpha=0.75) +
  facet_wrap(~species)+
  #scale_color_continuous(type = "viridis") +
  #scale_size_continuous()+
  labs(color = "Log of GDD5.cum THreshold",size="Number of Observations") +
  theme(panel.background = element_blank(),
        panel.grid = element_blank(),
        axis.text=element_blank(),
        axis.title=element_blank(),
        axis.ticks = element_blank())
dev.off()


png(file.path(path.figures, "NPN Quercus Map Leaf Resid.png"), height=6, width=8, units="in", res=180)
ggplot() +
  coord_fixed(1.3) +
  ggtitle(paste("NPN Quercus Leaf Out", sep=" ")) +
  geom_polygon(data=map.us, aes(x=long, y=lat, group=group), fill="gray50", color="black") +
  geom_point(data=comb.leaf, aes(x=longitude, y=latitude, color=diff), alpha=0.75) +
  facet_wrap(~species)+
  scale_color_gradient2(low="#fc8d59", high="#91bfdb", mid="#ffffbf") +
  #scale_color_continuous(type = "viridis") +
  #scale_size_continuous()+
  labs(color = "Resid") +
  theme(panel.background = element_blank(),
        panel.grid = element_blank(),
        axis.text=element_blank(),
        axis.title=element_blank(),
        axis.ticks = element_blank())
dev.off()
