#----------------------------------------------------------------------------------------------------------------------------------#
# Script by : Lucien Fitzpatrick
# Project: Collection phenology vulnerability
# Purpose: This script is the actual model predicting the GDD5.cum value at which budburst or leaf out occur
# Inputs: Full_Bud_Obs.csv
#         Full_Leaf_Obs.csv
# Outputs: Posterior distributions for bud burst and leaf out for every species in our collection
#         A data.frame with information on the model run to check convergence  
# Notes: 
#-----------------------------------------------------------------------------------------------------------------------------------#
library(rjags)
library(coda)
library(dplyr)
library(tidyr)

# Bring Arb Data back in; Arb data will need spp.type and obs.type (all = calib) based on the NPN data
dat.npnleaf <- read.csv("../data_raw/CLEAN_Phenology_NPN_combined_leaf.csv")

spp.calib  <- unique(dat.npnleaf$species[dat.npnleaf$spp.type=="calibration"])
spp.valid1 <- unique(dat.npnleaf$species[dat.npnleaf$spp.type=="validation"])
spp.valid2 <- unique(dat.npnleaf$species[dat.npnleaf$spp.type=="validation-tier2"])
spp.weird <- unique(dat.npnleaf$species[dat.npnleaf$spp.type=="weird"])

arb.burst <- read.csv("../data_processed/Oak_collection_budburst.csv")
arb.burst$flag.3sig <- F
arb.burst$flag.4sig <- F
arb.burst$obs.type <- "calibration"
arb.burst$spp.type[arb.burst$species %in% spp.calib] <- "calibration"
arb.burst$spp.type[arb.burst$species %in% spp.valid1] <- "validation"
arb.burst$spp.type[arb.burst$species %in% spp.valid2] <- "validation-tier2"
arb.burst$spp.type[arb.burst$species %in% spp.weird] <- "weird"


arb.leaf <- read.csv("../data_processed/Oak_collection_leaf.csv")
arb.leaf$flag.3sig <- F
arb.leaf$flag.4sig <- F
arb.leaf$obs.type <- "calibration"
arb.leaf$spp.type[arb.leaf$species %in% spp.calib] <- "calibration"
arb.leaf$spp.type[arb.leaf$species %in% spp.valid1] <- "validation"
arb.leaf$spp.type[arb.leaf$species %in% spp.valid2] <- "validation-tier2"
arb.leaf$spp.type[arb.leaf$species %in% spp.weird] <- "weird"

# names(arb.burst)[names(arb.burst) %in% names(dat.npnbud)]
cols.keep <- c("genus", "species", "site_id", "latitude", "longitude", "individual_id", "date", "year", "yday", "GDD5.cum", "GTmean", "flag.3sig", "flag.4sig", "obs.type", "spp.type")


arb.burst <- arb.burst[!arb.burst$flag.3sig & arb.burst$obs.type=="calibration" & arb.burst$spp.type %in% c("calibration", "validation"),]
arb.burst$pln <- as.numeric(factor(arb.burst$individual_id))
arb.burst$loc <- as.numeric(factor(arb.burst$site_id))
arb.burst$sp <- as.numeric(factor(arb.burst$species))
summary(arb.burst)

arb.leaf <- arb.leaf[!arb.leaf$flag.3sig & arb.leaf$obs.type=="calibration"  & arb.leaf$spp.type %in% c("calibration", "validation"),]
arb.leaf$pln <- as.numeric(factor(arb.leaf$individual_id))
arb.leaf$loc <- as.numeric(factor(arb.leaf$site_id))
arb.leaf$sp <- as.numeric(factor(arb.leaf$species))
summary(arb.leaf)

#Creating indexes so the hierarchy can properly function
spp.ind.bud <- aggregate(species ~ sp, data=arb.burst, FUN=min)
spp.ind.leaf <- aggregate(species ~ sp, data=arb.leaf, FUN=min)


burst.ind <- aggregate(cbind(species, sp)~individual_id + pln, data=arb.burst,
                       FUN=min)

leaf.ind <- aggregate(cbind(species, sp)~individual_id + pln, data=arb.leaf,
                      FUN=min)

# The Thermal Time phenology model (used for budburst & leaf out)
hierarchical_regression <- "
model{
  for(k in 1:n){
      mu[k] <- ind[pln[k]]  
      y[k] ~ dnorm(mu[k], sPrec)
  }
  
  for(j in 1:nSp){
    THRESH[j] <-  a[j]
    a[j] ~ dnorm(Tprior[j], aPrec[j])
    aPrec[j] ~ dgamma(0.01, 0.1)
    Tprior[j] ~ dunif(1, 1000)
  }
  
  for(i in 1:nPln){
      ind[i] <-  THRESH[sp[i]] + c[i]
      c[i] ~ dnorm(0, cPrec)
  }
  sPrec ~ dgamma(0.01, 0.1)
  cPrec ~ dgamma(0.01, 0.1)

}
"

burst.list <- list(y = arb.burst$GDD5.cum, n = length(arb.burst$GDD5.cum),
                   pln = arb.burst$pln, nPln = length(unique(arb.burst$individual_id)),
                   sp = burst.ind$sp, nSp = length(unique(arb.burst$species)))

leaf.list <- list(y = arb.leaf$GDD5.cum, n = length(arb.leaf$GDD5.cum),
                  pln = arb.leaf$pln, nPln = length(unique(arb.leaf$individual_id)),
                  sp = leaf.ind$sp, nSp = length(unique(arb.leaf$species)))


nchain = 3
inits <- list()
rngs <- c(737, 874, 869)
for(i in 1:nchain){
  inits[[i]] <- list(.RNG.name = "base::Super-Duper",
                     .RNG.seed = as.integer(rngs[i])
  )
}

#---------------------------------------------------------#
#This section actually runs the model and then provides ways to check the output and clean it
#---------------------------------------------------------#
burst.model   <- jags.model (file = textConnection(hierarchical_regression),
                             data = burst.list,
                             inits = inits,
                             n.chains = 3)

leaf.model   <- jags.model (file = textConnection(hierarchical_regression),
                            data = leaf.list,
                            inits = inits,
                            n.chains = 3)


#Converting the ooutput into a workable format
burst.out   <- coda.samples (model = burst.model,
                             variable.names = c("THRESH", "aPrec"),
                             n.iter = 1000000)

# summary(burst.out)

#Converting the ooutput into a workable format
leaf.out   <- coda.samples (model = leaf.model,
                            variable.names = c("THRESH", "aPrec"),
                            n.iter = 1000000)


# #Checking that convergence happened
gelman.diag(burst.out)
gelman.diag(leaf.out)

gel.burst <- data.frame(gelman.diag(burst.out)$psrf)
gel.leaf <- data.frame(gelman.diag(leaf.out)$psrf)


row.names(gel.burst) <- paste(rep(c("THRESH", "aPrec"), each=nrow(spp.ind.bud)), spp.ind.bud$species, sep=".")
row.names(gel.leaf) <- paste(rep(c("THRESH", "aPrec"), each=nrow(spp.ind.leaf)), spp.ind.leaf$species, sep=".")

write.csv(gel.burst, "../data_processed/model_output/ARB_TT_budburst_GelmanDiag.csv", row.names=T)
write.csv(gel.leaf, "../data_processed/model_output/ARB_TT_leaf_GelmanDiag.csv", row.names=T)


#Removing burnin before convergence occurred
burnin = 890000                                ## determine convergence from GBR output
burst.burn <- window(burst.out,start=burnin)  ## remove burn-in
summary(burst.burn)

leaf.burn <- window(leaf.out, start = burnin)
summary(leaf.burn)

#converting them into a dataframe 
burst.df <- as.data.frame(as.matrix(burst.burn))
leaf.df <- as.data.frame(as.matrix(leaf.burn))

names(burst.df)[grep("THRESH", names(burst.df))] <- paste("THRESH", spp.ind.bud$species, sep=".")
names(burst.df)[grep("aPrec", names(burst.df))] <- paste("aPrec", spp.ind.bud$species, sep=".")

names(leaf.df)[grep("THRESH", names(leaf.df))] <- paste("THRESH", spp.ind.leaf$species, sep=".")
names(leaf.df)[grep("aPrec", names(leaf.df))] <- paste("aPrec", spp.ind.leaf$species, sep=".")

write.csv(burst.df, file.path("../data_processed/model_output", "ARB_TT_model_budburst.csv"), row.names=F)
write.csv(leaf.df, file.path("../data_processed/model_output", "ARB_TT_model_leaf.csv"), row.names=F)
