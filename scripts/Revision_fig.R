library(ggplot2)
library(cowplot)
library(Rmisc)
library(dplyr)
library(tidyverse)
path.data <- "../data_processed"
path.figures <- "../figures"

first.comb.burst <- read.csv(file.path(path.data, paste0('First_Budburst_Prediction_Evaluation_all.csv')))
RevLat.comb.burst <- read.csv(file.path(path.data, paste0('RevLat_Budburst_Prediction_Evaluation_all.csv')))
RevGT.comb.burst <- read.csv(file.path(path.data, paste0('RevGT_Budburst_Prediction_Evaluation_all.csv')))


#Leafout model dfs
first.comb.leaf <- read.csv(file.path(path.data, paste0('First_Leaf_Prediction_Evaluation_all.csv')))
RevLat.comb.leaf <- read.csv(file.path(path.data, paste0('RevLat_Leaf_Prediction_Evaluation_all.csv')))
RevGT.comb.leaf <- read.csv(file.path(path.data, paste0('RevGT_Leaf_Prediction_Evaluation_all.csv')))


#Selecting matching rows so we can combine dfs into one

first.sel.bud <- first.comb.burst %>% select(latitude, species, diff, type) %>% mutate(model="GDD")
RevLat.sel.bud <- RevLat.comb.burst %>% select(latitude, species, diff, type) %>% mutate(model="Lat")
RevGT.sel.bud <- RevGT.comb.burst %>% select(latitude, species, diff, type) %>% mutate(model="GT")


first.sel.leaf <- first.comb.leaf %>% select(latitude, species, diff, type) %>% mutate(model="GDD")
RevLat.sel.leaf <- RevLat.comb.leaf %>% select(latitude, species, diff, type) %>% mutate(model="Lat")
RevGT.sel.leaf <- RevGT.comb.leaf %>% select(latitude, species, diff, type) %>% mutate(model="GT")


#Combining into one df

bud.sel <- rbind(RevLat.sel.bud, RevGT.sel.bud)

leaf.sel <- rbind(RevLat.sel.leaf, RevGT.sel.leaf)


#Ordering x-axis

bud.sel$model <- factor(bud.sel$model, levels = c("Lat", "GT" ))
leaf.sel$model <- factor(leaf.sel$model, levels = c("Lat", "GT"))

#Fig. 2 v2 BUD

plots.bud.4 <- ggplot(bud.sel, aes(x = latitude, y = diff, color = type, group=species))+
  facet_wrap(~model)+
  geom_smooth(method='lm', se = TRUE, alpha=0.25, size=0.5, aes(fill=type, color=type))+
  geom_vline(linetype="dashed", xintercept=41.8)+
  theme_cowplot(12) +
  theme(text=element_text(size=18), legend.position="bottom", legend.justification = "center") + #remove legend.position for horizontal version
  geom_jitter(alpha=0.25, size=0.5, aes(shape=type)) +
  scale_color_manual(values=c("#453781", "#3CBB75")) +
  scale_fill_manual(values=c("#453781", "#3CBB75")) +
  xlab("Latitude")+
  ylab("Resid.")

plots.bud.1 <- ggplot(first.sel.bud, aes(x = latitude, y = diff, color = type, group=species))+
  facet_wrap(~model)+
  geom_smooth(method='lm', se = TRUE, alpha=0.25, size=0.5, aes(fill=type, color=type))+
  geom_vline(linetype="dashed", xintercept=41.8)+
  theme_cowplot(12) +
  theme(text=element_text(size=18), legend.position = "none", aspect.ratio=0.655) +  # add aspect.ratio=0.69 for horizontal version
  geom_jitter(alpha=0.25, size=0.5, aes(shape=type)) +
  scale_color_manual(values=c("#453781", "#3CBB75")) +
  scale_fill_manual(values=c("#453781", "#3CBB75")) +
  xlab("Latitude")+
  ylab("Resid.")

png(height = 6, width = 4, units="in", res=600, filename= file.path(path.figures, paste0('Rev_Model_Fig_2', '.png')))
plot_grid(plots.bud.1, plots.bud.4, rel_heights=c(1, 1.93), axis="t", nrow=2, align="v")
dev.off()

#Fig. 2 v2 LEAF

plots.leaf.4 <- ggplot(leaf.sel, aes(x = latitude, y = diff, color = type, group=species))+
  facet_wrap(~model)+
  geom_smooth(method='lm', se = TRUE, alpha=0.25, size=0.5, aes(fill=type, color=type))+
  geom_vline(linetype="dashed", xintercept=41.8)+
  theme_cowplot(12) +
  theme(text=element_text(size=18), legend.position="bottom", legend.justification = "center") + #remove legend.position for horizontal version
  geom_jitter(alpha=0.25, size=0.5, aes(shape=type)) +
  scale_color_manual(values=c("#287D8E", "#FDE725")) +
  scale_fill_manual(values=c("#287D8E", "#FDE725")) +
  xlab("Latitude")+
  ylab("Resid.")

plots.leaf.1 <- ggplot(first.sel.leaf, aes(x = latitude, y = diff, color = type, group=species))+
  facet_wrap(~model)+
  geom_smooth(method='lm', se = TRUE, alpha=0.25, size=0.5, aes(fill=type, color=type))+
  geom_vline(linetype="dashed", xintercept=41.8)+
  theme_cowplot(12) +
  theme(text=element_text(size=18), legend.position = "none", aspect.ratio=0.655) +  # add aspect.ratio=0.69 for horizontal version
  geom_jitter(alpha=0.25, size=0.5, aes(shape=type)) +
  scale_color_manual(values=c("#287D8E", "#FDE725")) +
  scale_fill_manual(values=c("#287D8E", "#FDE725")) +
  xlab("Latitude")+
  ylab("Resid.")

png(height = 6, width = 4, units="in", res=600, filename= file.path(path.figures, paste0('Rev_Model_Fig_3', '.png')))
plot_grid(plots.leaf.1, plots.leaf.4, rel_heights=c(1, 1.93), axis="t", nrow=2, align="v")
dev.off()

#--------------------------------------------------------------------------------------------------#

#------------------#
# ~~~ FIGURE 3 ~~~ #
#------------------#

#Wrangling Budburst data

#Calculating RMSE by species and adding an RMSE column to each model's dataframe

rmse.first.bud <- first.comb.burst %>% group_by(species) %>% mutate_each(funs(mean)) %>% distinct %>% mutate(RMSE = sqrt(expdiff))
rmse.RevLat.bud <- RevLat.comb.burst %>% group_by(species) %>% mutate_each(funs(mean)) %>% distinct %>% mutate(RMSE = sqrt(expdiff))
rmse.RevGT.bud <- RevGT.comb.burst %>% group_by(species) %>% mutate_each(funs(mean)) %>% distinct %>% mutate(RMSE = sqrt(expdiff))


#Selecting only the columns which we need so that columns will match when combining df's; adding model name columns
#Note: make sure to update model names in 'model' column
#Note; I'm pretty sure this averages the latitudes for each species as well

rmse.first.bud <- rmse.first.bud %>% select(site_id, latitude, longitude, species, diff, error, RMSE, mid, Yday, type) %>% mutate(model="GDD")
rmse.RevLat.bud <- rmse.RevLat.bud %>% select(site_id, latitude, longitude, species, diff, error, RMSE, mid, Yday, type) %>% mutate(model="Lat")
rmse.RevGT.bud <- rmse.RevGT.bud %>% select(site_id, latitude, longitude, species, diff, error, RMSE, mid, Yday, type) %>% mutate(model="GT")

#Luciens version of rmse delta
#Matching for RMSE diff
rmse.first.bud$RMSE.org <- 0 
rmse.RevLat.bud$RMSE.org <- rmse.first.bud$RMSE[match(rmse.RevLat.bud$species, rmse.first.bud$species)]
rmse.RevGT.bud$RMSE.org <- rmse.first.bud$RMSE[match(rmse.RevGT.bud$species, rmse.first.bud$species)]


rmse.RevLat.bud$RMSE.diff <- rmse.RevLat.bud$RMSE-rmse.RevLat.bud$RMSE.org
rmse.RevGT.bud$RMSE.diff <- rmse.RevGT.bud$RMSE-rmse.RevGT.bud$RMSE.org



#Re-assigning 'type' to each species

spp.valid <- c("ilicifolia", "imbricaria", "marilandica", "stellata", "shumardii")

rmse.first.bud$type <- ifelse(rmse.first.bud$species %in% spp.valid, "Validation", "Calibration")

rmse.RevLat.bud$type <- ifelse(rmse.RevLat.bud$species %in% spp.valid, "Validation", "Calibration")

rmse.RevGT.bud$type <- ifelse(rmse.RevGT.bud$species %in% spp.valid, "Validation", "Calibration")



#Combining model df's into one df for comparison (excluding 'first')

bud.model <- rbind(rmse.first.bud, rmse.RevLat.bud, rmse.RevGT.bud)

#Rearranging the x-axis for the following figures

bud.model$model <- factor(bud.model$model, levels = c("GDD", "Lat", "GT"))

#Doing the same data wrangling for Leafout data

#Calculating RMSE by species and adding an RMSE column to each model's dataframe

rmse.first.leaf <- first.comb.leaf %>% group_by(species) %>% mutate_each(funs(mean)) %>% distinct %>% mutate(RMSE = sqrt(expdiff))
rmse.RevLat.leaf <- RevLat.comb.leaf %>% group_by(species) %>% mutate_each(funs(mean)) %>% distinct %>% mutate(RMSE = sqrt(expdiff))
rmse.RevGT.leaf <- RevGT.comb.leaf %>% group_by(species) %>% mutate_each(funs(mean)) %>% distinct %>% mutate(RMSE = sqrt(expdiff))




#Selecting only the columns which we need so that columns will match when combining df's; adding model name columns
#Note: make sure to update model names in 'model' column
#Note; I'm pretty sure this averages the latitudes for each species as well

rmse.first.leaf <- rmse.first.leaf %>% select(site_id, latitude, longitude, species, diff, error, RMSE, mid, Yday, type) %>% mutate(model="GDD")
rmse.RevLat.leaf <- rmse.RevLat.leaf %>% select(site_id, latitude, longitude, species, diff, error, RMSE, mid, Yday, type) %>% mutate(model="Lat")
rmse.RevGT.leaf <- rmse.RevGT.leaf %>% select(site_id, latitude, longitude, species, diff, error, RMSE, mid, Yday, type) %>% mutate(model="GT")

#Matching for RMSE diff
rmse.first.leaf$RMSE.org <- 0 
rmse.RevLat.leaf$RMSE.org <- rmse.first.leaf$RMSE[match(rmse.RevLat.leaf$species, rmse.first.leaf$species)]
rmse.RevGT.leaf$RMSE.org <- rmse.first.leaf$RMSE[match(rmse.RevGT.leaf$species, rmse.first.leaf$species)]

rmse.RevLat.leaf$RMSE.diff <- rmse.RevLat.leaf$RMSE-rmse.RevLat.leaf$RMSE.org
rmse.RevGT.leaf$RMSE.diff <- rmse.RevGT.leaf$RMSE-rmse.RevGT.leaf$RMSE.org




#Re-assigning 'type' to each species

spp.valid <- c("ilicifolia", "imbricaria", "marilandica", "stellata", "shumardii")

rmse.first.leaf$type <- ifelse(rmse.first.leaf$species %in% spp.valid, "Validation", "Calibration")

rmse.RevLat.leaf$type <- ifelse(rmse.RevLat.leaf$species %in% spp.valid, "Validation", "Calibration")

rmse.RevGT.leaf$type <- ifelse(rmse.RevGT.leaf$species %in% spp.valid, "Validation", "Calibration")


#Combining model df's into one df for comparison (excluding 'first')

leaf.model <- rbind(rmse.first.leaf, rmse.RevLat.leaf, rmse.RevGT.leaf) 

#Rearranging what will be on the x-axis

leaf.model$model <- factor(leaf.model$model, levels = c("GDD", "Lat", "GT"))

#Figure Generation

bud.3 <- ggplot(data=bud.model, aes(x=type, y=RMSE, fill=model))+
  geom_boxplot(aes(fill=model)) +
  theme_cowplot(12) +
  theme(text=element_text(size=18)) +
  ylim(0, 45) +
  scale_fill_manual(values=c("#E69F00", "#56B4E9", "#009E73")) +
  xlab("Datatype")+
  ylab("RMSE (days)")

leaf.3 <- ggplot(data=leaf.model, aes(x= type, y=RMSE, fill=model))+
  geom_boxplot(aes(fill=model)) +
  theme_cowplot(12)+
  theme(text=element_text(size=18)) +
  scale_fill_manual(values=c("#E69F00", "#56B4E9", "#009E73")) +
  ylim(0, 30) +
  xlab("Datatype")+
  ylab("RMSE (days)")

png(width = 8, height=6, units="in", res=600, filename= file.path(path.figures, paste0('Rev_Figure 3', '.png')))
plot_grid(bud.3, leaf.3, labels=c('A', 'B'), rel_widths=c(1, 2, 1, 2), align = "v", nrow=2, label_size = 18)
dev.off()
