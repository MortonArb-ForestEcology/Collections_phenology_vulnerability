#----------------------------------------------------------------------------------------------------------------------------------#
# Script by: Lucien Fitzpatrick
# Project: Collection phenology vulnerability
# Purpose: This script creates dataframees and figures comparing our different bias correction models
# Inputs: The original non-bias corrected model output created by script 4
#         All of the bias corrected model outputs created by their various scripts
#         Currently:  Relative latitude, Growing season mean, and Relative growing season mean
# Outputs: Visulizations and dataframes comparing our different models to the null
# Notes: 
#-----------------------------------------------------------------------------------------------------------------------------------#
library(ggplot2)
path.data <- "../data_processed"
#Reading in originial predicitons
first.burst.diff <- read.csv(file.path(path.data, paste0('First Budburst Prediction summary.csv')))

first.comb.burst <- read.csv(file.path(path.data, paste0('First_Budburst_Prediction_Evaluation_all.csv')))

#Reading in mean growing season temp
GT.burst.diff <- read.csv(file.path(path.data, paste0('GTmean Budburst Prediction summary.csv')))

GT.comb.burst <- read.csv(file.path(path.data, paste0('GTmean_Budburst_Prediction_Evaluation_all.csv')))

#Reading in relative latitude

#Currently not done
#RGT.burst.diff <- read.csv(file.path(path.data, paste0('Rel GTmean Budburst Prediction summary.csv')))

#RGT.comb.burst <- read.csv(file.path(path.data, paste0('Rel_GTmean_Budburst_Prediction_Evaluation_all.csv')))


#Reading in relative latitude
Rlat.burst.diff <- read.csv(file.path(path.data, paste0('Relative Lat Budburst Prediction summary.csv')))

Rlat.comb.burst <- read.csv(file.path(path.data, paste0('Relative_Lat_Budburst_Prediction_Evaluation_all.csv')))

#Simply looking at them.
#Will want these to become a data frame with RMSE
first.burst.diff; GT.burst.diff; Rlat.burst.diff

#Exploratory plot of error rate
ggplot(comb.burst, aes(x = error))+
  facet_wrap(~species) +
  geom_histogram() 

#Histogram of distirubtion of difference between observed and predicted
path.figures <- "../figures/Arb_pheno/"
#png(width= 750, filename= file.path(path.figures, paste0('Budburst NPN Validation Yday diff', '.png')))
ggplot(comb.burst, aes(x = diff))+
  facet_wrap(~species) +
  geom_histogram() +
  ggtitle('Difference in Observed Yday from Predicted Yday')
dev.off()

#same histogram but with absolute difference
ggplot(comb.burst, aes(x = absdiff))+
  facet_wrap(~species) +
  geom_histogram() 

#Scatter plot to compare 1:1 line between Prediction and Yday
png(width= 750, filename= file.path(path.figures, paste0('NPN Validation scatter budburst', '.png')))
ggplot(Rlat.comb.burst, aes(x = Yday, y = mid))+
  facet_wrap(~species) +
  geom_point(aes(color = latitude)) +
  geom_errorbar(aes(ymin=tail, ymax=head), width=.2,
                position=position_dodge(0.05))+
  geom_smooth(method='lm', se = FALSE, linetype = "dashed")+
  geom_abline(intercept = 0, slope = 1)+
  scale_color_continuous(type = "viridis")+
  xlim(0, 220)+ylim(0, 220)+
  ggtitle('Rlat Observed Yday of budburst vs. predicted') +
  xlab("Observed Yday")+
  ylab("Predicted Yday")
dev.off()

#Map of where the sites in our data are located
map.us <- map_data("state")
#png(paste0(path.figures, "NPN Quercus Map BudBurst.png", sep=""), height=6, width=8, units="in", res=180)
ggplot() +
  coord_fixed(1.3) +
  ggtitle(paste("NPN Quercus Breaking Leaf Buds", sep=" ")) +
  geom_polygon(data=map.us, aes(x=long, y=lat, group=group), fill=NA, color="black") +
  geom_point(data=dat.budburst, aes(x=longitude, y=latitude, color=species), alpha=0.75) +
  facet_wrap(~species)+
  #scale_color_continuous(type = "viridis") +
  #scale_size_continuous()+
  labs(color = "Log of GDD5.cum THreshold",size="Number of Observations") +
  theme(panel.background = element_blank(),
        panel.grid = element_blank(),
        axis.text=element_blank(),
        axis.title=element_blank(),
        axis.ticks = element_blank())
dev.off()

#png(paste0(path.figures, "NPN Quercus Map BudBurst Resid.png", sep=""), height=6, width=8, units="in", res=180)
ggplot() +
  coord_fixed(1.3) +
  ggtitle(paste("NPN Quercus Breaking Leaf Buds", sep=" ")) +
  geom_polygon(data=map.us, aes(x=long, y=lat, group=group), fill="gray50", color="black") +
  geom_point(data=comb.burst, aes(x=longitude, y=latitude, color=diff), alpha=0.75) +
  facet_wrap(~species)+
  scale_color_gradient2(low="#fc8d59", high="#91bfdb", mid="#ffffbf") +
  #scale_color_continuous(type = "viridis") +
  #scale_size_continuous()+
  labs(color = "Resid") +
  theme(panel.background = element_blank(),
        panel.grid = element_blank(),
        axis.text=element_blank(),
        axis.title=element_blank(),
        axis.ticks = element_blank())
dev.off()

#--------------------------------------------------------------------#
#Here begins the leaf out section#
#--------------------------------------------------------------------#

#Reading in originial predicitons
first.leaf.diff <- read.csv(file.path(path.data, paste0('First Leaf Prediction summary.csv')))

first.comb.leaf <- read.csv(file.path(path.data, paste0('First_Leaf_Prediction_Evaluation_all.csv')))

#Reading in mean growing season temp
GT.leaf.diff <- read.csv(file.path(path.data, paste0('GTmean Leaf Prediction summary.csv')))

GT.comb.leaf <- read.csv(file.path(path.data, paste0('GTmean_Leaf_Prediction_Evaluation_all.csv')))

#Currently not done
#RGT.leaf.diff <- read.csv(file.path(path.data, paste0('Rel GTmean Leaf Prediction summary.csv')))

#RGT.comb.leaf <- read.csv(file.path(path.data, paste0('Rel_GTmean_Leaf_Prediction_Evaluation_all.csv')))

#Reading in relative latitude
Rlat.leaf.diff <- read.csv(file.path(path.data, paste0('Relative Lat Leaf Prediction summary.csv')))

Rlat.comb.leaf <- read.csv(file.path(path.data, paste0('Relative_Lat_Leaf_Prediction_Evaluation_all.csv')))

#Simply looking at them.
#Will want these to become a data frame with RMSE
first.leaf.diff; GT.leaf.diff; Rlat.leaf.diff

#Exploratory plot of error rate
ggplot(comb.leaf, aes(x = error))+
  facet_wrap(~species) +
  geom_histogram() 

#Histogram of distirubtion of difference between observed and predicted
path.figures <- "../figures/Arb_pheno/"
#png(width= 750, filename= file.path(path.figures, paste0('leaf NPN Validation Yday diff', '.png')))
ggplot(comb.leaf, aes(x = diff))+
  facet_wrap(~species) +
  geom_histogram() +
  ggtitle('Difference in Observed Yday from Predicted Yday')
dev.off()

#same histogram but with absolute difference
ggplot(comb.leaf, aes(x = absdiff))+
  facet_wrap(~species) +
  geom_histogram() 

#Scatter plot to compare 1:1 line between Prediction and Yday
#png(width= 750, filename= file.path(path.figures, paste0('NPN Validation scatter leaf', '.png')))
ggplot(Rlat.comb.leaf, aes(x = Yday, y = mid))+
  facet_wrap(~species) +
  geom_point(aes(color = latitude)) +
  geom_errorbar(aes(ymin=tail, ymax=head), width=.2,
                position=position_dodge(0.05))+
  geom_smooth(method='lm', se = FALSE, linetype = "dashed")+
  geom_abline(intercept = 0, slope = 1)+
  scale_color_continuous(type = "viridis")+
  xlim(0, 220)+ylim(0, 220)+
  ggtitle('Rlat Observed Yday of leaf vs. predicted') +
  xlab("Observed Yday")+
  ylab("Predicted Yday")
dev.off()

#Map of where the sites in our data are located
map.us <- map_data("state")
#png(paste0(path.figures, "NPN Quercus Map leaf.png", sep=""), height=6, width=8, units="in", res=180)
ggplot() +
  coord_fixed(1.3) +
  ggtitle(paste("NPN Quercus Breaking Leaf Buds", sep=" ")) +
  geom_polygon(data=map.us, aes(x=long, y=lat, group=group), fill=NA, color="black") +
  geom_point(data=dat.leaf, aes(x=longitude, y=latitude, color=species), alpha=0.75) +
  facet_wrap(~species)+
  #scale_color_continuous(type = "viridis") +
  #scale_size_continuous()+
  labs(color = "Log of GDD5.cum THreshold",size="Number of Observations") +
  theme(panel.background = element_blank(),
        panel.grid = element_blank(),
        axis.text=element_blank(),
        axis.title=element_blank(),
        axis.ticks = element_blank())
dev.off()

#png(paste0(path.figures, "NPN Quercus Map leaf Resid.png", sep=""), height=6, width=8, units="in", res=180)
ggplot() +
  coord_fixed(1.3) +
  ggtitle(paste("NPN Quercus Breaking Leaf Buds", sep=" ")) +
  geom_polygon(data=map.us, aes(x=long, y=lat, group=group), fill="gray50", color="black") +
  geom_point(data=comb.leaf, aes(x=longitude, y=latitude, color=diff), alpha=0.75) +
  facet_wrap(~species)+
  scale_color_gradient2(low="#fc8d59", high="#91bfdb", mid="#ffffbf") +
  #scale_color_continuous(type = "viridis") +
  #scale_size_continuous()+
  labs(color = "Resid") +
  theme(panel.background = element_blank(),
        panel.grid = element_blank(),
        axis.text=element_blank(),
        axis.title=element_blank(),
        axis.ticks = element_blank())
dev.off()

