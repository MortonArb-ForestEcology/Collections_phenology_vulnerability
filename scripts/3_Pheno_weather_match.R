#----------------------------------------------------------------------------------------------------------------------------------#
# Script by : Lucien Fitzpatrick
# Project: Collection phenology vulnerability
# Purpose: This script serves to combine our weather data with our phenometric data so we can match weather to events
#          Also to visualize our data since it will be our model input
# Inputs: Oak_collection_budburst_raw.csv
#         Oak_collection_leaf_raw.csv
#         Daymet_Clean_data.csv
# Outputs: dat.burst data frame containing first budburst event and weather statistics of interest
#          dat.leaf data frame containing first budburst event and weather statistics of interest
#-----------------------------------------------------------------------------------------------------------------------------------#
library(ggplot2)
path.hub <- ".."

dat.burst <- read.csv("../data/Oak_collection_budburst_raw.csv")
dat.leaf <- read.csv("../data/Oak_collection_leaf_raw.csv")
met.all <- read.csv("../data_processed/Arb_Daymet_clean_data.csv")

dat.burst <- dat.burst[dat.burst$Yday < 181,]
dat.leaf <- dat.leaf[dat.leaf$Yday < 213,]

# dir.create("../data_processed/", recursive = T, showWarnings = F)

#Creating a new column in our phenology data frame that takes the date of earliest burst and gives us the cumulative gdd of that date from the met data
dat.burst$GDD5.cum <- met.all$GDD5.cum[match(dat.burst$Date, met.all$Date)]
dat.burst$GDD0.cum <- met.all$GDD0.cum[match(dat.burst$Date, met.all$Date)]
dat.burst$NCD <- met.all$NCD[match(dat.burst$Date, met.all$Date)]
dat.burst$GTmean <- met.all$GTmean[match(dat.burst$Date, met.all$Date)]
dat.burst$PTTGDD.cum <- met.all$PTTGDD.cum[match(dat.burst$Date, met.all$Date)]


dat.leaf$GDD5.cum <- met.all$GDD5.cum[match(dat.leaf$Date, met.all$Date)]
dat.leaf$GDD0.cum <- met.all$GDD0.cum[match(dat.leaf$Date, met.all$Date)]
dat.leaf$NCD <- met.all$NCD[match(dat.leaf$Date, met.all$Date)]
dat.leaf$GTmean <- met.all$GTmean[match(dat.leaf$Date, met.all$Date)]
dat.leaf$PTTGDD.cum <- met.all$PTTGDD.cum[match(dat.leaf$Date, met.all$Date)]


#Loop removing any
for(SP in unique(dat.burst$Species)){
  dat.sp <- dat.burst[dat.burst$Species == SP,]
  for(YR in unique(dat.sp$Year)){
    dat.yr <- dat.sp[dat.sp$Year == YR,]
    dat.sp[dat.sp$Year == YR, "sp_ind_per_year"] <- length(unique(dat.yr$PlantNumber))
    #setting the Threshold. Current need 2 individuals budburst or leaf out per year
    if(length(unique(dat.yr$PlantNumber))<2){
      #0 notating it doesn't meet the threshold
      dat.sp[dat.sp$Year == YR, "obs_check"] <- 0
    }
    else{
      dat.sp[dat.sp$Year == YR, "obs_check"] <- 1
    }
  }
  
  dat.burst[dat.burst$Species == SP, "sp_ind_per_year"] <- dat.sp$sp_ind_per_year
  dat.burst[dat.burst$Species == SP, "nIndividuals"] <- max(dat.sp$sp_ind_per_year)
  #Making sure the whole species is removed even if only one year is bad
  dat.burst[dat.burst$Species == SP, "obs_check"] <- min(dat.sp$obs_check)
}

dat.burst <- dat.burst[dat.burst$obs_check > 0,]


for(SP in unique(dat.leaf$Species)){
  dat.sp <- dat.leaf[dat.leaf$Species == SP,]
  for(YR in unique(dat.sp$Year)){
    dat.yr <- dat.sp[dat.sp$Year == YR,]
    dat.sp[dat.sp$Year == YR, "sp_ind_per_year"] <- length(unique(dat.yr$PlantNumber))
    #setting the Threshold. Current need 2 individuals budburst or leaf out per year
    if(length(unique(dat.yr$PlantNumber))<2){
      #0 notating it doesn't meet the threshold
      dat.sp[dat.sp$Year == YR, "obs_check"] <- 0
    }
    else{
      dat.sp[dat.sp$Year == YR, "obs_check"] <- 1
    }
  }
  
  dat.leaf[dat.leaf$Species == SP, "sp_ind_per_year"] <- dat.sp$sp_ind_per_year
  dat.leaf[dat.leaf$Species == SP, "nIndividuals"] <- max(dat.sp$sp_ind_per_year)
  #Making sure the whole species is removed even if only one year is bad
  dat.leaf[dat.leaf$Species == SP, "obs_check"] <- min(dat.sp$obs_check)
}

dat.leaf <- dat.leaf[dat.leaf$obs_check > 0,]


# Save modified data

write.csv(dat.burst, "../data_processed/Oak_collection_budburst.csv", row.names=F)
write.csv(dat.leaf, "../data_processed/Oak_collection_leaf.csv", row.names=F)


#Everything below here is unnecessary. It is primary visualization for supplemental figures and hasn't been touched in a while







#--------------------------------------------#
#Starting primary data visualization
#--------------------------------------------#
path.png <- "../figures"
if(!dir.exists(path.png)) dir.create(path.png, recursive=T)

#visual for bud burst Yday thermal time accumulation
png(filename= file.path(path.png, paste0('Budburst_firstmin_Arb.png')))

hist(dat.burst$GDD5.cum)

dev.off()

#visual for Leaves Yday thermal time accumulation
png(filename= file.path(path.png, paste0('Leaves_firstmin_Arb.png')))
hist(dat.leaf$GDD5.cum)
dev.off()

#----------------------------------
#summary statistics

#GDD5 95 CI Arb Budburst
round(quantile(dat.burst$GDD5.cum, c(0.025, 0.975), na.rm = T), digits = 1)

#GDD5 95 CI Arb Leaves
round(quantile(dat.leaf$GDD5.cum, c(0.025, 0.975), na.rm = T), digits = 1)

#YDAY 95 CI Arb Budburst
round(quantile(dat.burst$Yday , c(0.025, 0.975), na.rm = T), digits = 0)

#YDAY 95 CI Arb Leaves
round(quantile(dat.leaf$Yday , c(0.025, 0.975), na.rm = T), digits = 0)

#----------------------------------

#number of observations for Arb Budburst
summary(dat.burst)
dim(dat.burst[!is.na(dat.burst$Species),])
length(unique(dat.burst$Species))

#number of observations for Arb Leaves
summary(dat.leaf)
dim(dat.leaf[!is.na(dat.leaf$Species),])
length(unique(dat.leaf$Species))

#----------------------------------

#getting a map of all the Arb sites for both metrics from 2008 to 2019
leaves.freq <- as.data.frame(table(dat.leaf$Species))
colnames(leaves.freq) <- c("Species", "Freq")

leaves.freq

budburst.freq <- as.data.frame(table(dat.burst$Species))
colnames(budburst.freq) <- c("Species", "Freq")

budburst.freq

#----------------------conceptual figures------------------------

path.figures <- "../figures"
if(!dir.exists(path.figures)) dir.create(path.figures)

#see what data there is to work with 
summary(dat.burst)
summary(dat.leaf)


#getting paired data
short.bud <- data.frame(YEAR=dat.burst$Year, species = dat.burst$Species,
                        bud.YDAY=dat.burst$Yday,
                        bud.GDD5.cum=dat.burst$GDD5.cum,
                        stringsAsFactors=FALSE)
head(short.bud)

short.leaf <- data.frame(YEAR=dat.leaf$Year, species = dat.leaf$Species,
                         leaf.YDAY=dat.leaf$Yday,
                         leaf.GDD5.cum=dat.leaf$GDD5.cum,
                         stringsAsFactors=FALSE)
head(short.leaf)


#binding the new dataframes
All.Arb <- merge(short.bud, short.leaf, by=c("species", "YEAR"))

#---------------------Presentation fig. 2------------------------
colnames(short.leaf) <- c("YEAR", "Species", "YDAY", "GDD5.cum")
colnames(short.bud) <- c("YEAR", "Species", "YDAY", "GDD5.cum")


short.leaf$Type <- "Leaf out"
short.bud$Type <- "Bud burst"

dat.long <- rbind(short.bud, short.leaf)

# Doing a quick graph:
day.labels <- data.frame(Date=seq.Date(as.Date("2020-01-01"), as.Date("2020-12-31"), by="month"))
day.labels$yday <- lubridate::yday(day.labels$Date)
day.labels$Text <- paste(lubridate::month(day.labels$Date, label=T), lubridate::day(day.labels$Date))
summary(day.labels)
summary(dat.long)

png(width= 750, filename= file.path(path.figures, paste0('Presentfig2_HIST_GDD5_', species.name, '.png')))
ggplot(data=dat.long) +
  ggtitle("Spring Phenology Thermal Time Threshold for Quercus alba") + 
  facet_grid(~Type) +
  geom_histogram(mapping = aes(x= GDD5.cum, fill = Type)) + 
  scale_x_continuous(name="Accumulated Thermal Time (5C GDD)", limits = c(0, 1000)) +
  scale_y_continuous(name="Count") +
  guides(fill=F) +
  theme_bw() +
  theme(axis.text.x=element_text(angle=-45, hjust=0)) 
dev.off()


#----------------------concept. fig. 1A -------------------------

#get color blind friendly colors
#figure using Arb Breaking Leaf Buds and MODIS Greenup metrics YDAY
png(width= 750, filename= file.path(path.figures, paste0('Concept1A_BLB_YDAY_', species.name, '.png')))
ggplot(data = All.Arb) +
  geom_point(mapping = aes(x = YEAR, y = bud.YDAY, color = 'Arb')) +
  #geom_smooth(mapping = aes(x = YEAR, y = bud.YDAY, color = 'Arb', fill = 'Arb' )) +
  scale_y_continuous('Cumulative TT (YDAY)') +
  scale_fill_manual(name='Metric', values=c("orange", "forestgreen")) +
  scale_color_manual(name='Metric', values=c("orange", "forestgreen")) +
  ggtitle('Input YDAY Threshold for Arb Breaking Leaf Buds and MODIS 15% Greenup of Quercus alba from 2009-2019') +
  theme(text = element_text(size=10))
dev.off()

