#----------------------------------------------------------------------------------------------------------------------------------#
# Script by: Lucien Fitzpatrick
# Project: Collection phenology vulnerability
# Purpose: This script fits the spatial bias model 
# Inputs: Budburst data frame with residuals created by script 9
#         Leaf out data frame with residuals created by script 9 
# Outputs: Model output of fit bias correction
# Notes: 
#-----------------------------------------------------------------------------------------------------------------------------------#
library(rjags)
library(coda)
#reading in the budburst dataframe with residuals
#Reading in our cleaned NPN data
dat.burst <- read.csv("../data_raw/Raw_Phenology_NPN_combined_budburst.csv")

#Putting a filter on reports after August 1st since we are interested in spring phenology
dat.burst <- dat.burst[dat.burst$Yday < 213,]

dat.burst$Date <- as.Date(dat.burst$Date)
dat.burst$species <- as.character(dat.burst$species)

#Calculting the number of sites so we can filter for our second step of evaluation
for(SP in unique(dat.burst$species)){
  dat.sp <- dat.burst[dat.burst$species == SP,]
  dat.burst[dat.burst$species == SP, "nsites"] <- length(unique(dat.sp$site_id))
}

dat.burst <- dat.burst[dat.burst$nsites > 10,]

#Reading in the predictions for npn sites
pred.burst <- read.csv("../data_processed/Budburst_Phenology_NPN_prediction.csv")

comb.burst <- merge(dat.burst, pred.burst, by.x = c("species", "site_id", "year", "individual_id"), by.y = c("species", "site", "year", "ind"))

comb.burst$diff <- comb.burst$Yday - comb.burst$yday.pred

comb.burst$latitude <- comb.burst$latitude - 41.8164

#reading in the leafout dataframe with residuals
dat.leaf <- read.csv("../data_raw/Raw_Phenology_NPN_combined_leaf.csv")

dat.leaf <- dat.leaf[dat.leaf$Yday < 213,]

dat.leaf$species <- as.character(dat.leaf$species)


#Calculting the number of sites so we can filter for our second step of evaluation
for(SP in unique(dat.leaf$species)){
  dat.sp <- dat.leaf[dat.leaf$species == SP,]
  dat.leaf[dat.leaf$species == SP, "nsites"] <- length(unique(dat.sp$site_id))
}

dat.leaf <- dat.leaf[dat.leaf$nsites > 10,]

pred.leaf <- read.csv("../data_processed/Leaf_Phenology_NPN_prediction.csv")

comb.leaf <- merge(dat.leaf, pred.leaf, by.x = c("species", "site_id", "year", "individual_id"), by.y = c("species", "site", "year", "ind"))

comb.leaf$diff <- comb.leaf$Yday - comb.leaf$yday.pred

comb.leaf$latitude <- comb.leaf$latitude - 41.8164 #Subtracting from arboretum latitude

#Creating indexes so the hierarchy can properly function
burst.ind <- aggregate(site_id~individual_id, data=comb.burst,
                       FUN=min)

burst.loc <- aggregate(species~site_id, data=comb.burst,
                       FUN=min)


leaf.ind <- aggregate(site_id~individual_id, data=comb.leaf,
                      FUN=min)

leaf.loc <- aggregate(species~site_id, data=comb.leaf,
                      FUN=min)

#Actual spatial bias correction model
spatial_correction <- "
  model{
    for(k in 1:n){
        mu[k] <- ind[pln[k]] * GT[k]  
        y[k] ~ dnorm(mu[k], sPrec)
    }

      bias <-  a
      a ~ dnorm(0, aPrec)
      aPrec ~ dgamma(0.1, 0.1)

    for(t in 1:nSp){
      Sp.bias[t] <-  bias + b[t]
      b[t] ~ dnorm(0, bPrec[t])
      bPrec[t] ~ dgamma(0.1, 0.1)
    }
    
     for(t in 1:nLoc){
      Site[t] <-  Sp.bias[sp[t]] + c[t]
      c[t] ~ dnorm(0, cPrec[t])
      cPrec[t] ~ dgamma(0.1, 0.1)
    }
    
    for(i in 1:nPln){
        ind[i] <-  Site[loc[i]] + d[i]
        d[i] ~ dnorm(0, dPrec)
    }
    sPrec ~ dgamma(0.1, 0.1)
    dPrec ~ dgamma(0.1, 0.1)

  }
  "
#Populating the lists with the data needed to run the model
burst.list <- list(y = comb.burst$diff, n = length(comb.burst$diff), GT = comb.burst$latitude,
                   pln = as.numeric(factor(comb.burst$individual_id)), nPln = length(unique(comb.burst$individual_id)),
                   loc = as.numeric(factor(burst.ind$site_id)), nLoc = length(unique(comb.burst$site_id)),
                   sp = as.numeric(factor(burst.loc$species)), nSp = length(unique(comb.burst$species)))

#Populating the lists with the data needed to run the model
leaf.list <- list(y = comb.leaf$diff, n = length(comb.leaf$diff), GT = comb.leaf$latitude,
                  pln = as.numeric(factor(comb.leaf$individual_id)), nPln = length(unique(comb.leaf$individual_id)),
                  loc = as.numeric(factor(leaf.ind$site_id)), nLoc = length(unique(comb.leaf$site_id)),
                  sp = as.numeric(factor(leaf.loc$species)), nSp = length(unique(comb.leaf$species)))


#---------------------------------------------------------#
#This section actually runs the model and then provides ways to check the output and clean it
#---------------------------------------------------------#
burst.model   <- jags.model (file = textConnection(spatial_correction),
                             data = burst.list,
                             n.chains = 3)

leaf.model   <- jags.model (file = textConnection(spatial_correction),
                            data = leaf.list,
                            n.chains = 3)


#Converting the ooutput into a workable format
burst.out   <- coda.samples (model = burst.model,
                             variable.names = c("bias", "Sp.bias", "bPrec"),
                             n.iter = 600000)

#Converting the ooutput into a workable format
leaf.out   <- coda.samples (model = leaf.model,
                            variable.names = c("bias", "Sp.bias", "bPrec"),
                            n.iter = 600000)


#Checking that convergence happened
gelman.diag(burst.out)

gelman.diag(leaf.out)


#Removing burnin before convergence occurred
burnin = 590000                                ## determine convergence from GBR output
burst.burn <- window(burst.out,start=burnin)  ## remove burn-in
summary(burst.burn)

leaf.burn <- window(leaf.out, start = burnin)
summary(leaf.burn)

#converting them into a dataframe 
burst.df <- as.data.frame(as.matrix(burst.burn))
leaf.df <- as.data.frame(as.matrix(leaf.burn))
summary(burst.df)

summary(leaf.df)


write.csv(burst.df, file.path("../data_processed/model_output/Relative_Lat_model_budburst.csv"), row.names=F)
write.csv(leaf.df, file.path("../data_processed/model_output/Relative_Lat_model_leaf.csv"), row.names=F)
