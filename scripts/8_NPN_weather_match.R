#----------------------------------------------------------------------------------------------------------------------------------#
# Script by: Lucien Fitzpatrick
# Project: Collection phenology vulnerability
# Purpose: This script downloads the neccessary daymet weather data to match our NPN sites
# Inputs: NPN data for relevant species as downloaded in script 6
#         Daymet data for NPN sites as downloaded in script 7
# Outputs: Data frame matching the weather with the sites
# Notes: 
#-----------------------------------------------------------------------------------------------------------------------------------#
#Read this in to give the NPN sites their names
site_names <- npn_stations()

dat.leaf <- read.csv("../data_raw/Raw_Phenology_NPN_combined_leaf.csv")
dat.budburst <- read.csv("../data_raw/Raw_Phenology_NPN_combined_budburst.csv")

lat.calc <- read.csv("../data_processed/Daymet_clean_data.csv")

dat.budburst$Date <- as.Date(dat.budburst$Date)
lat.calc$Date <- as.Date(lat.calc$Date)

dat.burst <- data.frame()
for(LOC in unique(as.numeric(dat.budburst$site_id))){
  npn.tmp <- dat.budburst[dat.budburst$site_id == LOC,]
  lat.tmp <- lat.calc[lat.calc$site == LOC,]
  npn.tmp$GDD5.cum <- lat.tmp$GDD5.cum[match(npn.tmp$Date, lat.tmp$Date)]
  npn.tmp$GDD0.cum <- lat.tmp$GDD0.cum[match(npn.tmp$Date, lat.tmp$Date)]
  npn.tmp$NCD <- lat.tmp$NCD[match(npn.tmp$Date, lat.tmp$Date)]
  npn.tmp$GTmean <- lat.tmp$GTmean[match(npn.tmp$Date, lat.tmp$Date)]
  dat.burst <- rbind(dat.burst, npn.tmp)
}

summary(dat.burst)
dat.burst <- dat.burst[!is.na(dat.burst$Yday),] 
dat.burst <- dat.burst[is.finite(dat.burst$Yday),]


#Matching site name to site id
dat.burst$site_name <- site_names$station_name[match(dat.burst$site_id, site_names$station_id)]

#Making sure different locations with the same name are given unique names by adding site_id
for(Name in unique(dat.burst$site_name)){
  dat.tmp <- dat.burst[dat.burst$site_name == Name,]
  if(length(unique(dat.tmp$site_id)) >1){
    dat.tmp$site_name <- paste(dat.tmp$site_name, dat.tmp$site_id, sep="_")
  }
  dat.burst[dat.burst$site_name==Name, "site_name"] <- dat.tmp$site_name
}


# Save dat.burst 
write.csv(dat.burst, "../data_processed/Budburst_Phenology_NPN_combined.csv", row.names=F)

#Now starting with leaf out
dat.leaf$Date <- as.Date(dat.leaf$Date)


dat.leaves <- data.frame()
for(LOC in unique(as.numeric(dat.leaf$site_id))){
  npn.tmp <- dat.leaf[dat.leaf$site_id == LOC,]
  lat.tmp <- lat.calc[lat.calc$site == LOC,]
  npn.tmp$GDD5.cum <- lat.tmp$GDD5.cum[match(npn.tmp$Date, lat.tmp$Date)]
  npn.tmp$GDD0.cum <- lat.tmp$GDD0.cum[match(npn.tmp$Date, lat.tmp$Date)]
  npn.tmp$NCD <- lat.tmp$NCD[match(npn.tmp$Date, lat.tmp$Date)]
  npn.tmp$GTmean <- lat.tmp$GTmean[match(npn.tmp$Date, lat.tmp$Date)]
  dat.leaves <- rbind(dat.leaves, npn.tmp)
}

summary(dat.leaves)
dat.leaves <- dat.leaves[!is.na(dat.leaves$Yday),] 
dat.leaves <- dat.leaves[is.finite(dat.leaves$Yday),]


#Matching site name to site id
dat.leaves$site_name <- site_names$station_name[match(dat.leaves$site_id, site_names$station_id)]

#Making sure different locations with the same name are given unique names by adding site_id
for(Name in unique(dat.leaves$site_name)){
  dat.tmp <- dat.leaves[dat.leaves$site_name == Name,]
  if(length(unique(dat.tmp$site_id)) >1){
    dat.tmp$site_name <- paste(dat.tmp$site_name, dat.tmp$site_id, sep="_")
  }
  dat.leaves[dat.leaves$site_name==Name, "site_name"] <- dat.tmp$site_name
}


# Save dat.leaves 
write.csv(dat.leaves, "../data_processed/Leaf_Phenology_NPN_combined.csv", row.names=F)

