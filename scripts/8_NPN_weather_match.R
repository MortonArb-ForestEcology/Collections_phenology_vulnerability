#----------------------------------------------------------------------------------------------------------------------------------#
# Script by: Lucien Fitzpatrick
# Project: Collection phenology vulnerability
# Purpose: This script combines the predicted GDD5.cum for a species and matches that with a yday as a validation
# Inputs: NPN data for relevant species as downloaded in script 4
#         Daymet data for NPN sites as downloaded in script 5
#         Model output from script 7
# Outputs: Data frame matching Predicitons of the null model
# Notes: 
#-----------------------------------------------------------------------------------------------------------------------------------#
#Read this in to give the NPN sites their names
library(dplyr)
#site_names <- npn_stations()

#Reading in the weather data
dat.met <- read.csv("../data_processed/Daymet_clean_data.csv")
dat.met$Freeze <- ifelse(dat.met$tmin..deg.c.<0, 1, 0)
dat.met$site <- as.character(dat.met$site)
dat.met$Date <- as.Date(dat.met$Date)
summary(dat.met)

# ------------------------------------------------
# Predicting Budburst
# ------------------------------------------------
gel.burst <- read.csv("../data_processed/model_output/TT_Budburst_GelmanDiag.csv")
bud.bad <- gel.burst[gel.burst$Point.est.>=1.05,]

#Read in all the species outputs into one dataframe
burst.df <- read.csv(file.path("../data_processed/model_output/TT_model_budburst.csv"))
summary(burst.df)

burst.df <- burst.df[,grep("THRESH", names(burst.df))]
colnames(burst.df) <- unlist(lapply(strsplit(names(burst.df), "[.]"), FUN=function(x)x[2]))

burst.long <- data.table::melt(burst.df, variable.name = "Species")
summary(burst.long)

#Reading in the npn data we are going to predict
dat.burst <- read.csv("../data_processed/Full_Bud_Obs.csv")
dat.burst <- dat.burst[!dat.burst$flag.3sig  & dat.burst$spp.type %in% c("calibration", "validation"),]
dat.burst <- dat.burst[dat.burst$site_id!="Morton",]
# dat.burst$date <- as.Date(dat.burst$date)
summary(dat.burst)
# dat.burst <- dat.burst[!dat.burst$flag.4sig,]


pred.list <- list()
set.seed(1158)
for(YR in unique(dat.burst$year)){
  for(LOC in unique(dat.burst[dat.burst$year==YR, "site_id"])){
    #Pulling out daymet data matching the year and site
    met.now <- dat.met[dat.met$year==YR & dat.met$site==LOC,]
    dat.loc <- dat.burst[dat.burst$year == YR & dat.burst$site_id == LOC,]
    for(SP in unique(dat.loc$species)){
      if(!SP %in% unique(burst.long$Species) | 
         paste("THRESH", SP, sep=".") %in% bud.bad$X) next # Skip over missing or not convrged species
      #Pulling out the posterior distribution for our species
      dat.sp <- dat.loc[dat.loc$species ==SP,]
      bud.SP <- burst.long[burst.long$Species == SP,]
      for(IND in unique(dat.sp$individual_id)){
        #Randomly sample 500 from that distribution
        dat.ind <- dat.sp[dat.sp$individual_id == IND,]
        SP.samp <- bud.SP[sample(1:nrow(bud.SP), 250),]
        SP.samp$GDD <- SP.samp$value
        pred.list[[paste(YR, LOC, SP, IND, sep="-")]] <- SP.samp
        pred.list[[paste(YR, LOC, SP, IND, sep="-")]]$yday.pred <- apply(SP.samp, 1, FUN=function(x){min(met.now[met.now$GDD5.cum>=as.numeric(x["GDD"]), "yday"])})
        pred.list[[paste(YR, LOC, SP, IND, sep="-")]]$year <- as.factor(YR)
        pred.list[[paste(YR, LOC, SP, IND, sep="-")]]$site <- as.factor(LOC)
        pred.list[[paste(YR, LOC, SP, IND, sep="-")]]$species <- as.factor(SP)
        pred.list[[paste(YR, LOC, SP, IND, sep="-")]]$ind <- as.factor(IND)
        # pred.list[[paste(YR, LOC, SP, IND, sep="-")]]$GTmean <- unique(met.now$GTmean)
      } # End individual loop
    } # End Species Loop
  } # End Site Loop
} # End Year Loop
pred.burst <- dplyr::bind_rows(pred.list)
summary(pred.burst)

# Save dat.burst 
write.csv(pred.burst, "../data_processed/TT_Budburst_Phenology_NPN_prediction.csv", row.names=F)
# ------------------------------------------------






# ------------------------------------------------
# Predicting Leaf Out
# ------------------------------------------------
# Checking the Gelman Diagram to check for convergence
gel.leaf <- read.csv("../data_processed/model_output/TT_Leaf_GelmanDiag.csv")
leaf.bad <- gel.leaf[gel.leaf$Point.est.>=1.05,]


#Read in all the species outputs into one dataframe
leaf.df <- read.csv(file.path("../data_processed/model_output/TT_model_leaf.csv"))
summary(leaf.df)

leaf.df <- leaf.df[,grep("THRESH", names(leaf.df))]
colnames(leaf.df) <- unlist(lapply(strsplit(names(leaf.df), "[.]"), FUN=function(x)x[2]))

leaf.long <- data.table::melt(leaf.df, variable.name = "Species")
summary(leaf.long)
summary(leaf.long[leaf.long$value<0,])

#Reading in the npn data we are going to predict
dat.leaf <- read.csv("../data_processed/Full_Leaf_Obs.csv")
dat.leaf <- dat.leaf[!dat.leaf$flag.3sig & dat.leaf$spp.type %in% c("calibration", "validation"),]
dat.leaf <- dat.leaf[dat.leaf$site_id!="Morton",]
summary(dat.leaf)


pred.list <- list()
set.seed(1210)
for(YR in unique(dat.leaf$year)){
  for(LOC in unique(dat.leaf[dat.leaf$year==YR, "site_id"])){
    #Pulling out daymet data matching the year and site
    met.now <- dat.met[dat.met$year==YR & dat.met$site==LOC,]
    dat.loc <- dat.leaf[dat.leaf$year == YR & dat.leaf$site_id == LOC,]
    for(SP in unique(dat.loc$species)){
      if(!SP %in% unique(burst.long$Species) | 
         paste("THRESH", SP, sep=".") %in% leaf.bad$X) next # Skip over missing or not convrged species
      #Pulling out the posterior distribution for our species
      dat.sp <- dat.loc[dat.loc$species ==SP,]
      bud.SP <- leaf.long[leaf.long$Species == SP,]
      for(IND in unique(dat.sp$individual_id)){
        #Randomly sample 500 from that distribution
        dat.ind <- dat.sp[dat.sp$individual_id == IND,]
        SP.samp <- bud.SP[sample(1:nrow(bud.SP), 250),]
        SP.samp$GDD <- SP.samp$value
        pred.list[[paste(YR, LOC, SP, IND, sep="-")]] <- SP.samp
        pred.list[[paste(YR, LOC, SP, IND, sep="-")]]$yday.pred <- apply(SP.samp, 1, FUN=function(x){min(met.now[met.now$GDD5.cum>=as.numeric(x["GDD"]), "yday"])})
        pred.list[[paste(YR, LOC, SP, IND, sep="-")]]$year <- as.factor(YR)
        pred.list[[paste(YR, LOC, SP, IND, sep="-")]]$site <- as.factor(LOC)
        pred.list[[paste(YR, LOC, SP, IND, sep="-")]]$species <- as.factor(SP)
        pred.list[[paste(YR, LOC, SP, IND, sep="-")]]$ind <- as.factor(IND)
        # pred.list[[paste(YR, LOC, SP, IND, sep="-")]]$GTmean <- unique(met.now$GTmean)
      } # End individual loop
    } # End Species Loop
  } # End Site Loop
} # End Year Loop
pred.leaf <- dplyr::bind_rows(pred.list)
summary(pred.leaf)

# Save dat.leaf 
write.csv(pred.leaf, "../data_processed/TT_Leaf_Phenology_NPN_prediction.csv", row.names=F)
# ------------------------------------------------
