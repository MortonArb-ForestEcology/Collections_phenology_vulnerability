#----------------------------------------------------------------------------------------------------------------------------------#
# Script by : Lucien Fitzpatrick
# Project: Collection phenology vulnerability
# Purpose: This script serves as the initial data download and organization of the arb data
# Inputs: Quercus 2018 to present phenology monitoring data from the googlesheet "Phenology_Observations_GoogleForm" in the "LivingCollections-Phenology/Data_Observations/" folder
#         The clean_google_form.r script which defines the clean.google function.
#         The group_google_form.r script which defines the group.google function
# Outputs: dat.burst dataframe that can be used for the model
#          dat.leaf dataframe that can be used for the model
# Notes:  Since the original data is kept by the authors, most users will not need to run this script. 
#         The data frames created by this script are saved in this repository and can be used for the proceeding scripts.
#-----------------------------------------------------------------------------------------------------------------------------------#

#loading ggplot for visualization 
library(ggplot2)

path.hub <- ".."


path.g <- "G:/My Drive"
# path.g <- "/Volumes/GoogleDrive/My Drive"
dir.create("../data_processed/", recursive = T, showWarnings = F)

# -----------------------------
# This section is to read in Phenology Monitoring data from our years of interest. THIS SECTION REQUIRES THE clean.google function
# This function below takes in a vector of the genus of interest and a start and end year for the forms you want
# -----------------------------

#Calling in the clean.google function
source(file.path(path.hub, "scripts/Clean_google_form.R"))

#Calling in the group.google function. clean.google is needed for this.
source(file.path(path.hub, "scripts/Group_google.R"))

#Enter the genus of interest as a vector and the final year of observations you want as a variable
#The function will crash if you have a genus included without end years we have a form for i.e("Ulmus" with range 2018:2019)
#This only matters for end years. Start years are adjusted to match the first year the genus has a form.
Genus <- c("Quercus")
StartYear <- 2018
EndYear <- 2019

#Will produce message that look like errors that say 
#"New names: Please choose the correct accession number for the tree you are observing.` -> `Please choose the correct accession number for the tree you are observing....5`"
#But this is a normal sign that the function is working
dat.pheno <- group.google(Genus, StartYear, EndYear)

#--------------------------------------------------------#
# Here is where you  pull out phenometrics of interest (bud burst and leaf out)
#--------------------------------------------------------#
#Seperating out our chosen species
oak.use <- read.csv("../data/SpeciesList_Oak_collection_US_oaks_pheno.csv")
dat.oak <- dat.pheno[dat.pheno$Species %in% oak.use$Species, ]

dat.oak$Date.Observed <- as.Date(dat.oak$Date.Observed)
dat.oak$Bud <- as.factor(dat.oak$leaf.breaking.buds.observed)
dat.oak$Leaf <- as.factor(dat.oak$leaf.present.observed)
dat.oak <- dat.oak[!is.na(dat.oak$Date.Observed),]

#pulling out bud burst information from out phenology data
dat.oak <- subset(dat.oak, select = c("Date.Observed", "Year", "Species", "Bud", "Leaf", "PlantNumber"))

# Double checking to make sure there was a "no" for each observation before the yes
dat.oak$bud.QAQC <- NA
dat.oak$leaf.QAQC <- NA
for(PLNT in unique(dat.oak$PlantNumber)){
  for(YR in unique(dat.oak$Year[dat.oak$PlantNumber==PLNT])){
    dat.now <- dat.oak[dat.oak$PlantNumber==PLNT & dat.oak$Year==YR,]
    bud.no <- dat.oak[!is.na(dat.oak$Date.Observed) & dat.oak$PlantNumber==PLNT & dat.oak$Year==YR & dat.oak$Bud=="No",]
    leaf.no <- dat.oak[!is.na(dat.oak$Date.Observed) & dat.oak$PlantNumber==PLNT & dat.oak$Year==YR & dat.oak$Leaf=="No",]
    
    for(DT in as.Date(unique(unique(dat.oak$Date.Observed[dat.oak$PlantNumber==PLNT & dat.oak$Year==YR & dat.oak$Bud=="Yes"])))){
      dat.oak$bud.QAQC[dat.oak$PlantNumber==PLNT & dat.oak$Year==YR & dat.oak$Bud=="Yes" & dat.oak$Date.Observed==DT] <- any(as.Date(bud.no$Date.Observed)<DT & as.Date(bud.no$Date.Observed)>(DT-10))
    }
    for(DT in as.Date(unique(unique(dat.oak$Date.Observed[dat.oak$PlantNumber==PLNT & dat.oak$Year==YR & dat.oak$Leaf=="Yes"])))){
      dat.oak$leaf.QAQC[dat.oak$PlantNumber==PLNT & dat.oak$Year==YR & dat.oak$Leaf=="Yes" & dat.oak$Date.Observed==DT] <- any(as.Date(leaf.no$Date.Observed)<DT & as.Date(leaf.no$Date.Observed)>(DT-10))
    }
  }
}
summary(dat.oak)

#Creating final frame containing the first burst for each year.
dat.burst <- aggregate(Date.Observed ~ Species + PlantNumber + Year, 
                       data=dat.oak[dat.oak$Bud=="Yes" & dat.oak$bud.QAQC,], FUN=min)
colnames(dat.burst) <- c("species", "individual_id", "year", "date")
dat.burst$genus <- "Quercus"
dat.burst$species <- sub("Quercus ", "", dat.burst$species)
dat.burst$yday <- lubridate::yday(dat.burst$date)
summary(dat.burst)
head(dat.burst)


#Creating final frame containing the first burst for each year.
dat.leaf <- aggregate(Date.Observed ~ Species + PlantNumber + Year, 
                       data=dat.oak[dat.oak$Leaf=="Yes" & dat.oak$leaf.QAQC,], FUN=min)
colnames(dat.leaf) <- c("species", "individual_id", "year", "date")
dat.leaf$genus <- "Quercus"
dat.leaf$species <- sub("Quercus ", "", dat.leaf$species)
dat.leaf$yday <- lubridate::yday(dat.leaf$date)
summary(dat.leaf)
head(dat.leaf)

#Adding in arboretum Lat and Long
dat.burst$latitude <- 41.8164
dat.burst$longitude <- -88.0549
dat.burst$site_id <- "Morton"

#Adding in arboretum Lat and Long
dat.leaf$latitude <- 41.8164
dat.leaf$longitude <- -88.0549
dat.leaf$site <- "Morton"

unique(dat.leaf$species)

#Creating raw data output
write.csv(dat.burst, paste0(path.hub, "/data/Oak_collection_budburst_raw.csv"), row.names=F)
write.csv(dat.leaf, paste0(path.hub, "/data/Oak_collection_leaf_raw.csv"), row.names=F)


