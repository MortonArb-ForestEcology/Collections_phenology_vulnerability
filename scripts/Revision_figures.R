#----------------------------------------------------------------------------------------------------------------------------------#
# Script by: Lucien Fitzpatrick
# Project: Collection phenology vulnerability
# Purpose: This script is used to validate our GTmean model
# Inputs: Prediction dataframes made by the 10_"model"_match.R scripts
#         NPN data of interest to validate with our predicitons
# Outputs:Validation data frames to be epxplored in the Bias_model_comparison script
# Notes: 
#-----------------------------------------------------------------------------------------------------------------------------------#

path.data <- "../data_processed"
modelnames <- c("Revision")

for(NM in modelnames){
  #Reading in our cleaned NPN data
  dat.budburst <- read.csv("../data_raw/Raw_Phenology_NPN_combined_budburst.csv")
  
  #Putting a filter on reports after August 1st since we are interested in spring phenology
  dat.budburst <- dat.budburst[dat.budburst$Yday < 213,]
  
  #Reading in the predictions for npn sites
  pred.burst <- read.csv(file.path(path.data, paste0(NM, "_Budburst_Phenology_NPN_prediction.csv")))
  
  #aggregating our predictions
  pred.burst.ci <- aggregate(yday~species+site+year+ind, data=pred.burst,
                             FUN=function(x) quantile(x,c(0.025, 0.5, 0.975)), na.action = na.omit)
  
  #Pulling out the quantiles from our aggregate function
  pred.burst.ci$tail <- pred.burst.ci$yday[,1]
  pred.burst.ci$mid <- pred.burst.ci$yday[,2]
  pred.burst.ci$head <- pred.burst.ci$yday[,3]
  
  pred.burst.ci$yday.pred <- NULL
  
  #Merging our two data frames so we can compare
  comb.burst <- merge(dat.budburst, pred.burst.ci, by.x = c("species", "site_id", "year", "individual_id"), by.y = c("species", "site", "year", "ind"))
  
  #Calculating the difference
  comb.burst$diff <- comb.burst$Yday - comb.burst$mid
  
  #Absolute value of that difference
  comb.burst$absdiff <- abs(comb.burst$diff)
  
  #1 = yes error, 0 = no error
  comb.burst$error <- ifelse((comb.burst$Yday < comb.burst$tail | comb.burst$Yday > comb.burst$head), 1, 0)
  
  comb.burst$expdiff <- comb.burst$diff ^ 2
  
  #Getting number of Obs per species
  # burst.diff <- count(comb.burst$species)
  burst.diff <- stack(summary(as.factor(comb.burst$species)))[,c("ind", "values")]
  names(burst.diff) <- c("species", "n")
  
  
  #Filling data frame with summary stats of interest
  burst.diff[,c("median_abs_diff")] <- aggregate(absdiff~species, data = comb.burst,
                                                 FUN=median, na.rm=F)[,c("absdiff")] 
  
  burst.diff[,c("mean_abs_diff")] <- aggregate(absdiff~species, data = comb.burst,
                                               FUN=mean, na.rm=F)[,c("absdiff")]
  
  burst.diff[,c("RMSE")] <- aggregate(expdiff~species, data = comb.burst,
                                      FUN=mean, na.rm=F)[,c("expdiff")]
  
  burst.diff$RMSE <- sqrt(burst.diff$RMSE)
  
  burst.diff[,c("error_rate")] <- aggregate(error~species, data = comb.burst,
                                            FUN=mean, na.rm=F)[,c("error")]
  
  #Creating data frame that contains the summary stats for all oaks
  oak.burst <- data.frame("Oaks")
  colnames(oak.burst) <- "species"
  oak.burst$n <- nrow(comb.burst)
  oak.burst$median_abs_diff <- median(comb.burst$absdiff)
  oak.burst$mean_abs_diff <- mean(comb.burst$absdiff)
  oak.burst$error_rate <- mean(comb.burst$error)
  oak.burst$RMSE <- sqrt(mean(comb.burst$expdiff))
  
  #Writing our summary table for sharing/storing
  burst.diff <- rbind(oak.burst, burst.diff)
  write.csv(burst.diff, file.path(path.data, paste0(NM,' Budburst Prediction summary.csv')), row.names = F)
  
  # summary(comb.burst)
  val <- c("ilicifolia", "imbricaria", "marilandica", "shumardii", "stellata")
  comb.burst$type <- ifelse(comb.burst$species %in% val, "validation", "calibration")
  write.csv(comb.burst, file.path(path.data, paste0(NM, '_Budburst_Prediction_Evaluation_all.csv')), row.names = F)
  
  
  #---------------------------------------------#
  #Here begins the leaf out section
  #Reading in our cleaned NPN data
  dat.leaf <- read.csv("../data_raw/Raw_Phenology_NPN_combined_leaf.csv")
  
  #Putting a filter on reports after August 1st since we are interested in spring phenology
  dat.leaf <- dat.leaf[dat.leaf$Yday < 213,]
  
  #Reading in the predictions for npn sites
  pred.leaf <- read.csv(file.path(path.data, paste0(NM, "_Leaf_Phenology_NPN_prediction.csv")))
  
  #aggregating our predictions
  pred.leaf.ci <- aggregate(yday~species+site+year+ind, data=pred.leaf,
                            FUN=function(x) quantile(x,c(0.025, 0.5, 0.975)), na.action = na.omit)
  
  #Pulling out the quantiles from our aggregate function
  pred.leaf.ci$tail <- pred.leaf.ci$yday[,1]
  pred.leaf.ci$mid <- pred.leaf.ci$yday[,2]
  pred.leaf.ci$head <- pred.leaf.ci$yday[,3]
  
  pred.leaf.ci$yday.pred <- NULL
  
  #Merging our two data frames so we can compare
  comb.leaf <- merge(dat.leaf, pred.leaf.ci, by.x = c("species", "site_id", "year", "individual_id"), by.y = c("species", "site", "year", "ind"))
  
  #Calculating the difference
  comb.leaf$diff <- comb.leaf$Yday - comb.leaf$mid
  
  #Absolute value of that difference
  comb.leaf$absdiff <- abs(comb.leaf$diff)
  
  #1 = yes error, 0 = no error
  comb.leaf$error <- ifelse((comb.leaf$Yday < comb.leaf$tail | comb.leaf$Yday > comb.leaf$head), 1, 0)
  
  comb.leaf$expdiff <- comb.leaf$diff ^ 2
  
  #Getting number of Obs per species
  # leaf.diff <- count(comb.leaf$species)
  leaf.diff <- stack(summary(as.factor(comb.leaf$species)))[,c("ind", "values")]
  names(leaf.diff) <- c("species", "n")
  
  #Filling data frame with summary stats of interest
  leaf.diff[,c("median_abs_diff")] <- aggregate(absdiff~species, data = comb.leaf,
                                                FUN=median, na.rm=F)[,c("absdiff")] 
  
  leaf.diff[,c("mean_abs_diff")] <- aggregate(absdiff~species, data = comb.leaf,
                                              FUN=mean, na.rm=F)[,c("absdiff")]
  
  leaf.diff[,c("RMSE")] <- aggregate(expdiff~species, data = comb.leaf,
                                     FUN=mean, na.rm=F)[,c("expdiff")]
  
  leaf.diff$RMSE <- sqrt(leaf.diff$RMSE)
  
  leaf.diff[,c("error_rate")] <- aggregate(error~species, data = comb.leaf,
                                           FUN=mean, na.rm=F)[,c("error")]
  
  #Creating data frame that contains the summary stats for all oaks
  oak.leaf <- data.frame("Oaks")
  colnames(oak.leaf) <- "species"
  oak.leaf$n <- nrow(comb.leaf)
  oak.leaf$median_abs_diff <- median(comb.leaf$absdiff)
  oak.leaf$mean_abs_diff <- mean(comb.leaf$absdiff)
  oak.leaf$error_rate <- mean(comb.leaf$error)
  oak.leaf$RMSE <- sqrt(mean(comb.leaf$expdiff))
  
  #Writing our summary table for sharing/storing
  path.data <- "../data_processed"
  leaf.diff <- rbind(oak.leaf, leaf.diff)
  write.csv(leaf.diff, file.path(path.data, paste0(NM,' Leaf Prediction summary.csv')), row.names = F)
  
  summary(comb.leaf)
  comb.leaf$type <- ifelse(comb.leaf$species %in% val, "validation", "calibration")
  write.csv(comb.leaf, file.path(path.data, paste0(NM, '_Leaf_Prediction_Evaluation_all.csv')), row.names = F)
  
}

Rev.comb.burst <- read.csv(file.path(path.data, paste0('Revision_Budburst_Prediction_Evaluation_all.csv')))

ggplot(Rev.comb.burst, aes(x = latitude, y = diff, color = type, group=species))+
  geom_smooth(method='lm', se = TRUE, alpha=0.25, size=0.5, aes(fill=type, color=type))+
  geom_vline(linetype="dashed", xintercept=41.8)+
  theme_cowplot(12) +
  theme(text=element_text(size=18), legend.position="bottom", legend.justification = "center") + #remove legend.position for horizontal version
  geom_jitter(alpha=0.25, size=0.5, aes(shape=type)) +
  scale_color_manual(values=c("#453781", "#3CBB75")) +
  scale_fill_manual(values=c("#453781", "#3CBB75")) +
  xlab("Latitude")+
  ylab("Resid.")

rmse.Rev.bud <- Rev.comb.burst %>% group_by(species) %>% mutate_each(funs(mean)) %>% distinct %>% mutate(RMSE = sqrt(expdiff))
rmse.Rev.bud <- rmse.Rev.bud %>% select(site_id, latitude, longitude, species, diff, error, RMSE, mid, Yday, type) %>% mutate(model="Lat")

rmse.first.bud <- first.comb.burst %>% group_by(species) %>% mutate_each(funs(mean)) %>% distinct %>% mutate(RMSE = sqrt(expdiff))
rmse.first.bud <- rmse.first.bud %>% select(site_id, latitude, longitude, species, diff, error, RMSE, mid, Yday, type) %>% mutate(model="first")
rmse.first.bud$RMSE.org <- 0 


rmse.Rev.bud$RMSE.org <- rmse.first.bud$RMSE[match(rmse.Rev.bud$species, rmse.first.bud$species)]
rmse.Rev.bud$RMSE.diff <- rmse.Rev.bud$RMSE-rmse.Rev.bud$RMSE.org
spp.valid <- c("ilicifolia", "imbricaria", "marilandica", "stellata", "shumardii")
rmse.Rev.bud$type <- ifelse(rmse.Rev.bud$species %in% spp.valid, "validation", "calibration")
rmse.first.bud$type <- ifelse(rmse.Rev.bud$species %in% spp.valid, "validation", "calibration")


first.bud.3 <- ggplot(data=rmse.first.bud, aes(x= model, y=RMSE, fill=type))+
  geom_boxplot(aes(fill=type)) +
  theme_cowplot(12) +
  theme(aspect.ratio = 2, text=element_text(size=18), legend.position = "none") +
  ylim(0, 45) +
  scale_fill_manual(values=c("#404788", "#3CBB75")) +
  xlab("Model")+
  ylab("RMSE (days)")

bud.3 <- ggplot(data=rmse.Rev.bud, aes(x= model, y=RMSE.diff, fill=type))+
  geom_boxplot(aes(fill=type)) +
  theme_cowplot(12) +
  geom_hline(linetype="dashed", yintercept=0)+
  theme(text=element_text(size=18)) +
  ylim(-20, 7) +
  scale_fill_manual(values=c("#404788", "#3CBB75")) +
  xlab("RMSE (days)")

plot_grid(first.bud.3, bud.3, labels=c('A', 'B'), rel_widths=c(1, 2, 1, 2), align = "v", nrow=2, label_size = 18)


#----------------------------------#
#Lucien does error rate table down here
#----------------------------------#
first.comb.burst <- read.csv(file.path(path.data, paste0('First_Budburst_Prediction_Evaluation_all.csv')))

burst.model <- Rev.comb.burst

first.b.diff <- aggregate(error~site_id+species, data = first.comb.burst,
                          FUN=mean, na.rm=F) 

burst.diff <- aggregate(error~site_id+species, data = burst.model,
                        FUN=mean, na.rm=F) 

first.b.diff$model <- "GDD"
burst.diff$model <- "Revision"

burst.diff <- rbind(burst.diff, first.b.diff)

error.bud <- aggregate(error~model+species, data = burst.diff,
                       FUN=mean, na.rm=F)

error.bud[,c("sd")] <- aggregate(error~model+species, data = burst.diff,
                                 FUN=sd, na.rm=F)[,c("error")]

write.csv(error.bud, "../data_processed/Bud_error_rates.csv", row.names=T)

report.bud <- aggregate(error~model, data = error.bud,
                        FUN=mean, na.rm=F)

report.bud[,c('sd')] <- aggregate(error~model, data = error.bud,
                                  FUN=sd, na.rm=F)[,c("error")]
