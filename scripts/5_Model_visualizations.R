#----------------------------------------------------------------------------------------------------------------------------------#
# Script by : Lucien Fitzpatrick
# Project: Collection phenology vulnerability
# Purpose: This script combines the posterior distributions of all species so we can look at them as a group
# Inputs: Model outputs for all species in the oak collection for budburst and leaf out
#         Processed leaf and budburst phenology data frame made by script 3
#         Daymet data for chosen sites made by script 2
# Outputs: Various figures and summary statistics
# Notes: I break up where we are using budburst and leaf more than in previous scripts for clarity
#-----------------------------------------------------------------------------------------------------------------------------------#

#Reading in the model input data for some summary staistics
dat.burst <- read.csv("../data_processed/Oak_collection_budburst.csv")
dat.leaf <- read.csv("../data_processed/Oak_collection_leaf.csv")
met.all <- read.csv("../data_processed/Arb_Pheno/Daymet_clean_data.csv")

#-------------------------------------------------------#
#This section is exclusively for budburst. Lower down is the section for leaf out
#-------------------------------------------------------#
library(ggmcmc)

#Read in all the species outputs into one dataframe
bud.files <- list.files(path = "../data_processed/Arb_Pheno", pattern = "model_budburst.csv", full.names = T)
bud.stats <- as.data.frame(sapply(bud.files, read.csv, simplify=FALSE) %>% 
                             bind_rows(.id = "id"))

bud.stats <- bud.stats[,c(2:5)]

#bud.stats <- tidyr::separate(bud.stats, col = "species", into=c("genus", "species"))

bud.stats$pred <- apply(as.matrix(bud.stats), 1 , function(x) rnorm(1, mean=as.numeric(x["THRESH"]), sd=as.numeric(x["sd"])))

bud.summary <- aggregate(pred~species, data=bud.stats,
                         FUN=function(x) quantile(x,c(0.025, 0.5, 0.975)))

write.csv(bud.summary, file.path("../data_processed/Arb_Pheno", paste("Confidence Interval for budburst.csv")), row.names=F)

bud.table <- aggregate(dat.burst[,c("sp_ind_per_year")],
                       by=list(dat.burst$Species),
                       FUN=max, na.rm=F)

colnames(bud.table) <- c("Species", "nIndividuals")

bud.table[, "2.5%"] <- bud.summary$pred[,"2.5%"][match(bud.table$Species, bud.summary$species)]
bud.table[, "50%"] <- bud.summary$pred[,"50%"][match(bud.table$Species, bud.summary$species)]
bud.table[, "97.5%"] <- bud.summary$pred[,"97.5%"][match(bud.table$Species, bud.summary$species)]

write.csv(bud.table, file.path("../data_processed/Arb_Pheno", paste("Summary of oak collection budburst.csv")), row.names=F)

bud.clean <- data.frame()

for(SP in unique(bud.stats$species)){
  dat.tmp <- bud.stats[bud.stats$species == SP,]
  ci <- bud.table[bud.table$Species == SP,]
  dat.tmp <- dat.tmp[dat.tmp$pred >= ci$`2.5%` & dat.tmp$pred <= ci$`97.5%`,]
  bud.clean <- rbind(bud.clean, dat.tmp)
}

library(ggplot2)
path.figures <- "../figures"
if(!dir.exists(path.figures)) dir.create(path.figures)
png(width= 750, filename= file.path(path.figures, paste0('Oak collection TT burst', '.png')))
ggplot(data= bud.clean) +
  facet_grid(species~. , scales = "free_y")+
  theme(strip.text.y = element_text(size = 10, angle = 0))+
  ggtitle('Burst Thermal Time Thresholds of Quercus species in the oak collection') +
  geom_density(mapping = aes(x= pred, fill = species), alpha=0.5, ) +
  scale_y_continuous('DENSITY (%)')+
  theme(legend.position='none')+
  xlim(0, 400)
dev.off()


#-------------------------------------------------------#
#This section is exclusively for leaf out
#-------------------------------------------------------#

#Read in all the species outputs into one dataframe
leaf.files <- list.files(path = "../data_processed/Arb_Pheno", pattern = "model_leaf.csv", full.names = T)
leaf.stats <- as.data.frame(sapply(leaf.files, read.csv, simplify=FALSE) %>% 
                             bind_rows(.id = "id"))

leaf.stats <- leaf.stats[,c(2:5)]


leaf.stats$pred <- apply(as.matrix(leaf.stats), 1 , function(x) rnorm(1, mean=as.numeric(x["THRESH"]), sd=as.numeric(x["sd"])))

leaf.summary <- aggregate(pred~species, data=leaf.stats,
                         FUN=function(x) quantile(x,c(0.025, 0.5, 0.975)))

write.csv(leaf.summary, file.path("../data_processed/Arb_Pheno", paste("Confidence Interval leaf.csv")), row.names=F)

leaf.table <- aggregate(dat.burst[,c("sp_ind_per_year")],
                       by=list(dat.burst$Species),
                       FUN=max, na.rm=F)

colnames(leaf.table) <- c("Species", "nIndividuals")

leaf.table[, "2.5%"] <- leaf.summary$pred[,"2.5%"][match(leaf.table$Species, leaf.summary$species)]
leaf.table[, "50%"] <- leaf.summary$pred[,"50%"][match(leaf.table$Species, leaf.summary$species)]
leaf.table[, "97.5%"] <- leaf.summary$pred[,"97.5%"][match(leaf.table$Species, leaf.summary$species)]

write.csv(leaf.table, file.path("../data_processed/Arb_Pheno", paste("Summary of oak collection leaf.csv")), row.names=F)

leaf.clean <- data.frame()

for(SP in unique(leaf.stats$species)){
  dat.tmp <- leaf.stats[leaf.stats$species == SP,]
  ci <- leaf.table[leaf.table$Species == SP,]
  dat.tmp <- dat.tmp[dat.tmp$pred >= ci$`2.5%` & dat.tmp$pred <= ci$`97.5%`,]
  leaf.clean <- rbind(leaf.clean, dat.tmp)
}


png(width= 750, filename= file.path(path.figures, paste0('Oak collection TT leaf', '.png')))
ggplot(data= leaf.clean) +
  facet_grid(species~. , scales = "free_y")+
  theme(strip.text.y = element_text(size = 10, angle = 0))+
  ggtitle('Leaf Thermal Time Thresholds of Quercus species in the oak collection') +
  geom_density(mapping = aes(x= pred, fill = species), alpha=0.5, ) +
  scale_y_continuous('DENSITY (%)')+
  theme(legend.position='none')+
  xlim(0, 500)
dev.off()

bud.clean$type <- "burst"
leaf.clean$type <- "leaf"

pheno.stats <- rbind(bud.clean, leaf.clean)

png(width= 750, filename= file.path(path.figures, paste0('Oak_Collection_Budburst_and_Leafout', '.png')))
ggplot(data= pheno.stats) +
  facet_grid(species~. , scales = "free_y")+
  theme(strip.text.y = element_text(size = 10, angle = 0))+
  ggtitle('Bud burst and Leaf out Thermal Time Thresholds of Quercus species in the oak collection') +
  geom_density(mapping = aes(x= pred, fill = type), alpha=0.5, ) +
  scale_y_continuous('DENSITY (%)')+
  #theme(legend.position='none')+
  xlim(-50, 450)
dev.off()
