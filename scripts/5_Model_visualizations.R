#----------------------------------------------------------------------------------------------------------------------------------#
# Script by : Lucien Fitzpatrick
# Project: Collection phenology vulnerability
# Purpose: To use arb weather data and phenology monitoring data to create a predicitve model of bud burst timing
#          This scipt combines the posterior distributions of all species so we can look at them as a group
# Inputs: Model outputs for all species in the oak collection for budburst and leaf out
# Outputs: Various figures and summary statistics
# Notes: I break up where we are using budburst and leaf more than in previous scripts for clarity
#-----------------------------------------------------------------------------------------------------------------------------------#

#-------------------------------------------------------#
#This section is exclusively for budburst. Lower down is the section for leaf out
#-------------------------------------------------------#
library(ggmcmc)

#Read in all the species outputs into one dataframe
bud.files <- list.files(path = "../data_processed/Arb_Pheno", pattern = "budburst.csv", full.names = T)
bud.stats <- as.data.frame(sapply(bud.files, read.csv, simplify=FALSE) %>% 
                             bind_rows(.id = "id"))

bud.stats <- bud.stats[,c(2:5)]

bud.stats$pred <- apply(as.matrix(bud.stats), 1 , function(x) rnorm(1, mean=as.numeric(x["THRESH"]), sd=as.numeric(x["sd"])))

bud.summary <- aggregate(pred~species, data=bud.stats,
                         FUN=function(x) quantile(x,c(0.025, 0.5, 0.975)))

write.csv(bud.summary, file.path("../data_processed/Arb_Pheno", paste("Summary of oak collection budburst.csv")), row.names=F)

dat.section <- data.frame(googlesheets4::read_sheet(ss="https://docs.google.com/spreadsheets/d/14rJUVhJ2pDSskyEzMM7KX5p3LTvpxiSnDoOw2Ngu2PY/edit#gid=0", sheet="QuercusCollection", col_types="c"))


bud.stats <- merge(bud.stats, dat.section[, c("Species", "Section")], by.x=c("species"), by.y=c("Species"))

library(ggplot2)
path.figures <- "../figures"
if(!dir.exists(path.figures)) dir.create(path.figures)
png(width= 750, filename= file.path(path.figures, paste0('Oak collection TT burst', '.png')))
ggplot(data= bud.stats) +
  facet_wrap(~Section)+
  ggtitle('Burst Thermal Time Thresholds of Quercus species in the oak collection') +
  geom_density(mapping = aes(x= pred, fill = species, color = species), alpha=0.5, ) +
  scale_y_continuous('DENSITY (%)')+
  theme(legend.position='none')+
  xlim(-100, 500)
dev.off()


#-------------------------------------------------------#
#This section is exclusively for leaf out
#-------------------------------------------------------#

#Read in all the species outputs into one dataframe
leaf.files <- list.files(path = "../data_processed/Arb_Pheno", pattern = "leaf.csv", full.names = T)
leaf.stats <- as.data.frame(sapply(leaf.files, read.csv, simplify=FALSE) %>% 
                             bind_rows(.id = "id"))

leaf.stats <- leaf.stats[,c(2:5)]

leaf.stats$pred <- apply(as.matrix(leaf.stats), 1 , function(x) rnorm(1, mean=as.numeric(x["THRESH"]), sd=as.numeric(x["sd"])))

leaf.summary <- aggregate(pred~species, data=leaf.stats,
                         FUN=function(x) quantile(x,c(0.025, 0.5, 0.975)))

write.csv(leaf.summary, file.path("../data_processed/Arb_Pheno", paste("Summary of oak collection leaf.csv")), row.names=F)

dat.section <- data.frame(googlesheets4::read_sheet(ss="https://docs.google.com/spreadsheets/d/14rJUVhJ2pDSskyEzMM7KX5p3LTvpxiSnDoOw2Ngu2PY/edit#gid=0", sheet="QuercusCollection", col_types="c"))


leaf.stats <- merge(leaf.stats, dat.section[, c("Species", "Section")], by.x=c("species"), by.y=c("Species"))

library(ggplot2)
path.figures <- "../figures"
if(!dir.exists(path.figures)) dir.create(path.figures)
png(width= 750, filename= file.path(path.figures, paste0('Oak collection TT leaf', '.png')))
ggplot(data= leaf.stats) +
  facet_wrap(~Section)+
  ggtitle('Leaf Thermal Time Thresholds of Quercus species in the oak collection') +
  geom_density(mapping = aes(x= pred, fill = species, color = species), alpha=0.5, ) +
  scale_y_continuous('DENSITY (%)')+
  theme(legend.position='none')+
  xlim(-100, 500)
dev.off()

