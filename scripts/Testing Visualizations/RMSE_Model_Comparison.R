#RMSE Model Comparison Figures

library(ggplot2)
library(cowplot)

#Loading in previous model dataframes
first.comb.burst <- read.csv(file.path(path.data, paste0('First_Budburst_Prediction_Evaluation_all.csv')))
GT.comb.burst <- read.csv(file.path(path.data, paste0('GTmean_Budburst_Prediction_Evaluation_all.csv')))
RGT.comb.burst <- read.csv(file.path(path.data, paste0('Rel_GTmean_Budburst_Prediction_Evaluation_all.csv')))
Rlat.comb.burst <- read.csv(file.path(path.data, paste0('Rel_Lat_Budburst_Prediction_Evaluation_all.csv')))
Lat.comb.burst <- read.csv(file.path(path.data, paste0('Lat_Budburst_Prediction_Evaluation_all.csv')))

#-------------------------------------------------------------------------------------------------#

#Budburst section

#RMSE by Site

#Calculating RMSE by site and adding an RMSE column to each model's dataframe

rmse.first.bud <- first.comb.burst %>% group_by(site_id) %>% mutate_each(funs(mean)) %>% distinct %>% mutate(RMSE = sqrt(expdiff))
rmse.GT.bud <- GT.comb.burst %>% group_by(site_id) %>% mutate_each(funs(mean)) %>% distinct %>% mutate(RMSE = sqrt(expdiff))
rmse.RGT.bud <- RGT.comb.burst %>% group_by(site_id) %>% mutate_each(funs(mean)) %>% distinct %>% mutate(RMSE = sqrt(expdiff))
rmse.Rlat.bud <- Rlat.comb.burst %>% group_by(site_id) %>% mutate_each(funs(mean)) %>% distinct %>% mutate(RMSE = sqrt(expdiff))
rmse.Lat.bud <- Lat.comb.burst %>% group_by(site_id) %>% mutate_each(funs(mean)) %>% distinct %>% mutate(RMSE = sqrt(expdiff))

#Selecting only the columns which we need so that columns will match when combining df's; adding model name columns

rmse.first.bud <- rmse.first.bud %>% select(site_id, latitude, longitude, species_id, RMSE) %>% mutate(model="first")
rmse.GT.bud <- rmse.GT.bud %>% select(site_id, latitude, longitude, species_id, RMSE) %>% mutate(model="GT")
rmse.RGT.bud <- rmse.RGT.bud %>% select(site_id, latitude, longitude, species_id, RMSE) %>% mutate(model="RGT")
rmse.Rlat.bud <- rmse.Rlat.bud %>% select(site_id, latitude, longitude, species_id, RMSE) %>% mutate(model="Rlat")
rmse.Lat.bud <- rmse.Lat.bud %>% select(site_id, latitude, longitude, species_id, RMSE) %>% mutate(model="Lat")

#Combining the above df's into one for comparison

bud.model.rmse <- rbind(rmse.first.bud, rmse.GT.bud, rmse.RGT.bud, rmse.Rlat.bud, rmse.Lat.bud)

#RMSE vs Latitude
png(width = 800, filename= file.path(path.figures, paste0('RMSE vs Lat Bud Model Comparison', '.png')))
ggplot(bud.model.rmse, aes(x = latitude, y = RMSE, color = model))+
  geom_smooth(method='lm', se = TRUE, alpha=0.2, aes(fill=model, color=model))+
  theme_cowplot(12) +
  geom_jitter(alpha=0.75, size=3, aes(shape=model)) +
  scale_color_manual(values=c("black", "#440154", "#238A8D", "#55C667", "#FDE725")) +
  scale_fill_manual(values=c("black", "#440154", "#238A8D", "#55C667", "#FDE725")) +
  ggtitle('RMSE vs. Latitude Budburst Model Comparison') +
  xlab("Latitude")+
  ylab("RMSE")
dev.off()

#RMSE vs Longitude
png(width = 800, filename= file.path(path.figures, paste0('RMSE vs Long Bud Model Comparison', '.png')))
ggplot(bud.model.rmse, aes(x = longitude, y = RMSE, color = model))+
  geom_smooth(method='lm', se = FALSE, linetype = "dashed")+
  geom_line() +
  geom_point(alpha=0.75) +
  #facet_wrap(~species) +
  #geom_abline(intercept = 0, slope = 1)+
  ggtitle('RMSE vs. Longitude Budburst Model Comparison') +
  xlab("Longitude")+
  ylab("RMSE")
dev.off()

#Grouping by species rather than site

species.rmse.first.bud <- first.comb.burst %>% group_by(species) %>% mutate_each(funs(mean)) %>% distinct %>% mutate(RMSE = sqrt(expdiff))
species.rmse.GT.bud <- GT.comb.burst %>% group_by(species) %>% mutate_each(funs(mean)) %>% distinct %>% mutate(RMSE = sqrt(expdiff))
species.rmse.RGT.bud <- RGT.comb.burst %>% group_by(species) %>% mutate_each(funs(mean)) %>% distinct %>% mutate(RMSE = sqrt(expdiff))
species.rmse.Rlat.bud <- Rlat.comb.burst %>% group_by(species) %>% mutate_each(funs(mean)) %>% distinct %>% mutate(RMSE = sqrt(expdiff))
species.rmse.Lat.bud <- Lat.comb.burst %>% group_by(species) %>% mutate_each(funs(mean)) %>% distinct %>% mutate(RMSE = sqrt(expdiff))

#Selecting only the columns which we need so that columns will match when combining df's; adding model name columns

species.rmse.first.bud <- species.rmse.first.bud %>% select(site_id, latitude, longitude, species, RMSE) %>% mutate(model="first")
species.rmse.GT.bud <- species.rmse.GT.bud %>% select(site_id, latitude, longitude, species, RMSE) %>% mutate(model="GT")
species.rmse.RGT.bud <- species.rmse.RGT.bud %>% select(site_id, latitude, longitude, species, RMSE) %>% mutate(model="RGT")
species.rmse.Rlat.bud <- species.rmse.Rlat.bud %>% select(site_id, latitude, longitude, species, RMSE) %>% mutate(model="Rlat")
species.rmse.Lat.bud <- species.rmse.Lat.bud %>% select(site_id, latitude, longitude, species, RMSE) %>% mutate(model="Lat")

#Combining the above df's into one for comparison

bud.species.model.rmse <- rbind(species.rmse.first.bud, species.rmse.Lat.bud, species.rmse.GT.bud, species.rmse.RGT.bud, species.rmse.Rlat.bud)
names(bud.species.model.rmse)[2] <- "avg_latitude"

#RMSE by Species
png(width = 800, filename= file.path(path.figures, paste0('Species RMSE and Lat Bud Model Comparison', '.png')))
ggplot(data=bud.species.model.rmse, aes(x= species, y=RMSE, color=avg_latitude))+
  geom_point(size=2) +
  facet_wrap(~model) +
  scale_color_continuous(type = "viridis", option = "C") +
  ggtitle('RMSE by Species Budburst Model Comparison') +
  xlab("Species")+
  ylab("RMSE")
dev.off()

#Alternate Version of RMSE by Species
png(width = 900, filename= file.path(path.figures, paste0('Species RMSE Bud Model Comparison', '.png')))
ggplot(data=bud.species.model.rmse, aes(x= species, y=RMSE, color=model))+
  geom_jitter(alpha=1, size=4, aes(shape=model)) +
  theme_cowplot(12)+
  scale_color_manual(values=c("black", "#482677", "#238A8D", "#55C667", "#FDE725")) +
  ggtitle('RMSE by Species Budburst Model Comparison') +
  xlab("Species")+
  ylab("RMSE")
dev.off()

#RMSE Budburst Map
map.us <- map_data("state")
png(filename= file.path(path.figures, paste0('RMSE Bud Map', '.png', sep="")), height=6, width=8, units="in", res=180)
ggplot() +
  coord_fixed(1.3) +
  ggtitle(paste("RMSE in Budburst Prediction by Site", sep=" ")) +
  geom_polygon(data=map.us, aes(x=long, y=lat, group=group), fill=NA, color="black") +
  geom_point(data=bud.model.rmse, aes(x=longitude, y=latitude, color=RMSE), alpha=1) +
  facet_wrap(~model)+
  scale_color_continuous(type = "viridis", option = "C") +
  scale_size_continuous()+
  labs(color = "RMSE",size="Number of Observations") +
  theme(panel.background = element_blank(),
        panel.grid = element_blank(),
        axis.text=element_blank(),
        axis.title=element_blank(),
        axis.ticks = element_blank())
dev.off()

#Rearranging the x-axis for the following figure

bud.species.model.rmse$model <- factor(bud.species.model.rmse$model, levels = c("first", "Lat", "GT", "RGT", "Rlat"))

#RMSE Boxplot
png(width = 800, filename= file.path(path.figures, paste0('RMSE Boxplot Bud', '.png')))
ggplot(data=bud.species.model.rmse, aes(x= model, y=RMSE))+
  geom_boxplot() +
  theme_cowplot(12) +
  ylim(0, 45) +
  ggtitle('Budburst Model RMSE Comparison') +
  xlab("Model")+
  ylab("RMSE")
dev.off()

#--------------------------------------------------------------------------------------------#

#Leafout section

#RMSE by Site

#Calculating RMSE by site and adding an RMSE column to each model's dataframe

rmse.first.leaf <- first.comb.leaf %>% group_by(site_id) %>% mutate_each(funs(mean)) %>% distinct %>% mutate(RMSE = sqrt(expdiff))
rmse.GT.leaf <- GT.comb.leaf %>% group_by(site_id) %>% mutate_each(funs(mean)) %>% distinct %>% mutate(RMSE = sqrt(expdiff))
rmse.RGT.leaf <- RGT.comb.leaf %>% group_by(site_id) %>% mutate_each(funs(mean)) %>% distinct %>% mutate(RMSE = sqrt(expdiff))
rmse.Rlat.leaf <- Rlat.comb.leaf %>% group_by(site_id) %>% mutate_each(funs(mean)) %>% distinct %>% mutate(RMSE = sqrt(expdiff))
rmse.Lat.leaf <- Lat.comb.leaf %>% group_by(site_id) %>% mutate_each(funs(mean)) %>% distinct %>% mutate(RMSE = sqrt(expdiff))

#Selecting only the columns which we need so that columns will match when combining df's; adding model name columns

rmse.first.leaf <- rmse.first.leaf %>% select(site_id, latitude, longitude, species_id, RMSE) %>% mutate(model="first")
rmse.GT.leaf <- rmse.GT.leaf %>% select(site_id, latitude, longitude, species_id, RMSE) %>% mutate(model="GT")
rmse.RGT.leaf <- rmse.RGT.leaf %>% select(site_id, latitude, longitude, species_id, RMSE) %>% mutate(model="RGT")
rmse.Rlat.leaf <- rmse.Rlat.leaf %>% select(site_id, latitude, longitude, species_id, RMSE) %>% mutate(model="Rlat")
rmse.Lat.leaf <- rmse.Lat.leaf %>% select(site_id, latitude, longitude, species_id, RMSE) %>% mutate(model="Lat")

#Combining the above df's into one for comparison

leaf.model.rmse <- rbind(rmse.first.leaf, rmse.GT.leaf, rmse.RGT.leaf, rmse.Rlat.leaf, rmse.Lat.leaf)

#RMSE vs Latitude
png(width = 800, filename= file.path(path.figures, paste0('RMSE vs Lat Leaf Model Comparison', '.png')))
ggplot(leaf.model.rmse, aes(x = latitude, y = RMSE, color = model))+
  geom_smooth(method='lm', se = TRUE, alpha=0.2, aes(fill=model, color=model))+
  theme_cowplot(12) +
  geom_jitter(alpha=0.75, size=3, aes(shape=model)) +
  scale_color_manual(values=c("black", "#440154", "#238A8D", "#55C667", "#FDE725")) +
  scale_fill_manual(values=c("black", "#440154", "#238A8D", "#55C667", "#FDE725")) +
  ggtitle('RMSE vs. Latitude Budburst Model Comparison') +
  xlab("Latitude")+
  ylab("RMSE")
dev.off()

#RMSE vs Longitude
png(width = 800, filename= file.path(path.figures, paste0('RMSE vs Long Leaf Model Comparison', '.png')))
ggplot(data=leaf.model.rmse, aes(x = longitude, y = RMSE, color = model))+
  geom_smooth(method='lm', se = FALSE, linetype = "dashed")+
  geom_line() +
  geom_point(alpha=0.75) +
  #facet_wrap(~species) +
  #geom_abline(intercept = 0, slope = 1)+
  ggtitle('RMSE vs. Longitude Leafout Model Comparison') +
  xlab("Longitude")+
  ylab("RMSE")
dev.off()

#Grouping by species rather than site

species.rmse.first.leaf <- first.comb.leaf %>% group_by(species) %>% mutate_each(funs(mean)) %>% distinct %>% mutate(RMSE = sqrt(expdiff))
species.rmse.GT.leaf <- GT.comb.leaf %>% group_by(species) %>% mutate_each(funs(mean)) %>% distinct %>% mutate(RMSE = sqrt(expdiff))
species.rmse.RGT.leaf <- RGT.comb.leaf %>% group_by(species) %>% mutate_each(funs(mean)) %>% distinct %>% mutate(RMSE = sqrt(expdiff))
species.rmse.Rlat.leaf <- Rlat.comb.leaf %>% group_by(species) %>% mutate_each(funs(mean)) %>% distinct %>% mutate(RMSE = sqrt(expdiff))
species.rmse.Lat.leaf <- Lat.comb.leaf %>% group_by(species) %>% mutate_each(funs(mean)) %>% distinct %>% mutate(RMSE = sqrt(expdiff))

#Selecting only the columns which we need so that columns will match when combining df's; adding model name columns

species.rmse.first.leaf <- species.rmse.first.leaf %>% select(site_id, latitude, longitude, species, RMSE) %>% mutate(model="first")
species.rmse.GT.leaf <- species.rmse.GT.leaf %>% select(site_id, latitude, longitude, species, RMSE) %>% mutate(model="GT")
species.rmse.RGT.leaf <- species.rmse.RGT.leaf %>% select(site_id, latitude, longitude, species, RMSE) %>% mutate(model="RGT")
species.rmse.Rlat.leaf <- species.rmse.Rlat.leaf %>% select(site_id, latitude, longitude, species, RMSE) %>% mutate(model="Rlat")
species.rmse.Lat.leaf <- species.rmse.Lat.leaf %>% select(site_id, latitude, longitude, species, RMSE) %>% mutate(model="Lat")

#Combining the above df's into one for comparison

leaf.species.model.rmse <- rbind(species.rmse.first.leaf, species.rmse.GT.leaf, species.rmse.RGT.leaf, species.rmse.Rlat.leaf, species.rmse.Lat.leaf)
names(leaf.species.model.rmse)[2] <- "avg_latitude"

#RMSE by Species
png(width = 800, filename= file.path(path.figures, paste0('Species RMSE and Lat Leaf Model Comparison', '.png')))
ggplot(data=leaf.species.model.rmse, aes(x= species, y=RMSE, color=avg_latitude))+
  geom_point(size=2) +
  facet_wrap(~model) +
  scale_color_continuous(type = "viridis", option = "C") +
  ggtitle('RMSE by Species Leafout Model Comparison') +
  xlab("Species")+
  ylab("RMSE")
dev.off()

#Alternate Version of RMSE by Species
png(width = 800, filename= file.path(path.figures, paste0('Species RMSE Leaf Model Comparison', '.png')))
ggplot(data=leaf.species.model.rmse, aes(x= species, y=RMSE, color=model))+
  geom_jitter(alpha=1, size=4, aes(shape=model)) +
  theme_cowplot(12)+
  scale_color_manual(values=c("black", "#482677", "#238A8D", "#55C667", "#FDE725")) +
  ggtitle('RMSE by Species Budburst Model Comparison') +
  xlab("Species")+
  ylab("RMSE")
dev.off()

#RMSE Leafout Map
map.us <- map_data("state")
png(filename= file.path(path.figures, paste0('RMSE Leaf Map', '.png', sep="")), height=6, width=8, units="in", res=180)
ggplot() +
  coord_fixed(1.3) +
  ggtitle(paste("RMSE in Leafout Prediction by Site", sep=" ")) +
  geom_polygon(data=map.us, aes(x=long, y=lat, group=group), fill=NA, color="black") +
  geom_point(data=leaf.model.rmse, aes(x=longitude, y=latitude, color=RMSE), alpha=1) +
  facet_wrap(~model)+
  scale_color_continuous(type = "viridis", option = "C") +
  scale_size_continuous()+
  labs(color = "RMSE",size="Number of Observations") +
  theme(panel.background = element_blank(),
        panel.grid = element_blank(),
        axis.text=element_blank(),
        axis.title=element_blank(),
        axis.ticks = element_blank())
dev.off()

#Rearranging the x-axis for the following figure

leaf.species.model.rmse$model <- factor(leaf.species.model.rmse$model, levels = c("first", "Lat", "GT", "RGT", "Rlat"))

#RMSE Boxplot
png(width = 800, filename= file.path(path.figures, paste0('RMSE Boxplot Leaf', '.png')))
  ggplot(data=leaf.species.model.rmse, aes(x= model, y=RMSE))+
  geom_boxplot() +
  theme_cowplot(12)+
  ylim(0, 45) +
  ggtitle('Leafout Model RMSE Comparison') +
  xlab("Model")+
  ylab("RMSE")
dev.off()

#-------------------------------------------------------------------------------------------------#

#Combined Bud and Leaf Figures

cow1 <- ggplot(data=bud.species.model.rmse, aes(x= model, y=RMSE))+
  geom_boxplot(aes(fill=model)) +
  theme_cowplot(12) +
  ylim(0, 45) +
  theme(legend.position = "none") +
  scale_fill_manual(values=c("black", "#440154", "#238A8D", "#55C667", "#FDE725")) +
  ggtitle('Budburst and Leafout Model RMSE Comparison') +
  xlab("Model")+
  ylab("RMSE (days)")

cow2 <- ggplot(data=leaf.species.model.rmse, aes(x= model, y=RMSE))+
  geom_boxplot(aes(fill=model)) +
  theme_cowplot(12)+
  scale_fill_manual(values=c("black", "#440154", "#238A8D", "#55C667", "#FDE725")) +
  theme(legend.position = "none") +
  ylim(0, 45) +
  #ggtitle('Leafout Model RMSE Comparison') +
  xlab("Model")+
  ylab("RMSE (days)")

png(width = 500, height=600, filename= file.path(path.figures, paste0('Stacked RMSE Bud and Leaf', '.png')))
plot_grid(cow1, cow2, labels = c('A', 'B'), align = "v", nrow=2, label_size = 12)
dev.off()

#Stacked RMSE vs Latitude

cow3 <- ggplot(bud.model.rmse, aes(x = latitude, y = RMSE, color = model))+
  geom_smooth(method='lm', se = TRUE, alpha=0.2, aes(fill=model, color=model))+
  theme_cowplot(12) +
  geom_jitter(alpha=0.75, size=3, aes(shape=model)) +
  scale_color_manual(values=c("black", "#440154", "#238A8D", "#55C667", "#FDE725")) +
  scale_fill_manual(values=c("black", "#440154", "#238A8D", "#55C667", "#FDE725")) +
  ggtitle('RMSE vs. Latitude Budburst Model Comparison') +
  xlab("Latitude")+
  ylab("RMSE")

cow4 <- ggplot(leaf.model.rmse, aes(x = latitude, y = RMSE, color = model))+
  geom_smooth(method='lm', se = TRUE, alpha=0.2, aes(fill=model, color=model))+
  theme_cowplot(12) +
  geom_jitter(alpha=0.75, size=3, aes(shape=model)) +
  scale_color_manual(values=c("black", "#440154", "#238A8D", "#55C667", "#FDE725")) +
  scale_fill_manual(values=c("black", "#440154", "#238A8D", "#55C667", "#FDE725")) +
  #ggtitle('RMSE vs. Latitude Budburst Model Comparison') +
  xlab("Latitude")+
  ylab("RMSE")

png(width = 500, height=600, filename= file.path(path.figures, paste0('Stacked RMSE vs Lat Bud and Leaf', '.png')))
plot_grid(cow3, cow4, labels = c('A', 'B'), align = "v", nrow=2, label_size = 12)
dev.off()
