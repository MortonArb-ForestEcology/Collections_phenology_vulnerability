#----------------------------------------------------------------------------------------------------------------------------------#
# Script by: Lucien Fitzpatrick
# Project: Collection phenology vulnerability
# Purpose: This script creates dataframees and figures comparing our different bias correction models
# Inputs: The original non-bias corrected model output created by script 4
#         All of the bias corrected model outputs created by their various scripts
#         Currently:  Relative latitude, Growing season mean, and Relative growing season mean
# Outputs: Visulizations and dataframes comparing our different models to the null
# Notes: 
#-----------------------------------------------------------------------------------------------------------------------------------#
library(ggplot2)
path.data <- "../data_processed"
#Reading in originial predicitons
first.burst.diff <- read.csv(file.path(path.data, paste0('First Budburst Prediction summary.csv')))

first.comb.burst <- read.csv(file.path(path.data, paste0('First_Budburst_Prediction_Evaluation_all.csv')))

#Reading in mean growing season temp
GT.burst.diff <- read.csv(file.path(path.data, paste0('GTmean Budburst Prediction summary.csv')))

GT.comb.burst <- read.csv(file.path(path.data, paste0('GTmean_Budburst_Prediction_Evaluation_all.csv')))


#Reding in relative mean growing season temp 
RGT.burst.diff <- read.csv(file.path(path.data, paste0('Rel_GTmean Budburst Prediction summary.csv')))

RGT.comb.burst <- read.csv(file.path(path.data, paste0('Rel_GTmean_Budburst_Prediction_Evaluation_all.csv')))


#Reading in relative latitude
Rlat.burst.diff <- read.csv(file.path(path.data, paste0('Rel_Lat Budburst Prediction summary.csv')))

Rlat.comb.burst <- read.csv(file.path(path.data, paste0('Rel_Lat_Budburst_Prediction_Evaluation_all.csv')))

#Reading in latitiude
Lat.burst.diff <- read.csv(file.path(path.data, paste0('Lat Budburst Prediction summary.csv')))

Lat.comb.burst <- read.csv(file.path(path.data, paste0('Lat_Budburst_Prediction_Evaluation_all.csv')))

#Simply looking at them.
#Will want these to become a data frame with RMSE
first.burst.diff; GT.burst.diff; RGT.burst.diff; Lat.burst.diff; Rlat.burst.diff

first.burst.diff <- first.burst.diff[first.burst.diff$species != "Oaks",]
GT.burst.diff <- GT.burst.diff[GT.burst.diff$species != "Oaks",]
RGT.burst.diff <- RGT.burst.diff[RGT.burst.diff$species != "Oaks",]
Lat.burst.diff <- Lat.burst.diff[Lat.burst.diff$species != "Oaks",]
Rlat.burst.diff <- Rlat.burst.diff[Rlat.burst.diff$species != "Oaks",]

GT.t <- t.test(first.burst.diff$RMSE, GT.burst.diff$RMSE, paired = TRUE)
RGT.t <- t.test(first.burst.diff$RMSE, RGT.burst.diff$RMSE, paired = TRUE)
Rlat.t <- t.test(first.burst.diff$RMSE, Rlat.burst.diff$RMSE, paired = TRUE)
Lat.t <- t.test(first.burst.diff$RMSE, Lat.burst.diff$RMSE, paired = TRUE)

full.t.test <- data.frame()

t.table <- matrix(c(as.numeric(GT.t[1]), as.numeric(GT.t[3]), as.numeric(GT.t[5]), as.numeric(GT.t[7]),
                  as.numeric(RGT.t[1]), as.numeric(RGT.t[3]), as.numeric(RGT.t[5]), as.numeric(RGT.t[7]),
                  as.numeric(Lat.t[1]), as.numeric(Lat.t[3]), as.numeric(Lat.t[5]), as.numeric(Lat.t[7]),
                  as.numeric(Rlat.t[1]), as.numeric(Rlat.t[3]), as.numeric(Rlat.t[5]),as.numeric(Rlat.t[7])), ncol=4, byrow=TRUE)

colnames(t.table) <- c("t value", "p value", "mean of diff", "SE of diff")
rownames(t.table) <- c("GT", "RGT", "Lat", "Rlat")

write.csv(t.table, paste0(path.data, "/Bud_t_test.csv"))

first.burst.diff$RMSE - GT.burst.diff$RMSE
#Exploratory plot of error rate
ggplot(comb.burst, aes(x = error))+
  facet_wrap(~species) +
  geom_histogram() 

#Histogram of distirubtion of difference between observed and predicted
path.figures <- "../figures/Arb_pheno/"
png(width= 750, filename= file.path(path.figures, paste0('Budburst NPN Validation Yday diff', '.png')))
ggplot(comb.burst, aes(x = diff))+
  facet_wrap(~species) +
  geom_histogram() +
  ggtitle('Difference in Observed Yday from Predicted Yday')
dev.off()

#same histogram but with absolute difference
ggplot(comb.burst, aes(x = absdiff))+
  facet_wrap(~species) +
  geom_histogram() 

#Scatter plot to compare 1:1 line between Prediction and Yday
png(width= 750, filename= file.path(path.figures, paste0('NPN Validation scatter budburst', '.png')))
ggplot(Rlat.comb.burst, aes(x = Yday, y = mid))+
  facet_wrap(~species) +
  geom_point(aes(color = latitude)) +
  geom_errorbar(aes(ymin=tail, ymax=head), width=.2,
                position=position_dodge(0.05))+
  geom_smooth(method='lm', se = FALSE, linetype = "dashed")+
  geom_abline(intercept = 0, slope = 1)+
  scale_color_continuous(type = "viridis")+
  xlim(0, 220)+ylim(0, 220)+
  ggtitle('Rlat Observed Yday of budburst vs. predicted') +
  xlab("Observed Yday")+
  ylab("Predicted Yday")
dev.off()

#Map of where the sites in our data are located
map.us <- map_data("state")
png(paste0(path.figures, "NPN Quercus Map BudBurst.png", sep=""), height=6, width=8, units="in", res=180)
ggplot() +
  coord_fixed(1.3) +
  ggtitle(paste("NPN Quercus Breaking Leaf Buds", sep=" ")) +
  geom_polygon(data=map.us, aes(x=long, y=lat, group=group), fill=NA, color="black") +
  geom_point(data=dat.budburst, aes(x=longitude, y=latitude, color=species), alpha=0.75) +
  facet_wrap(~species)+
  #scale_color_continuous(type = "viridis") +
  #scale_size_continuous()+
  labs(color = "Log of GDD5.cum THreshold",size="Number of Observations") +
  theme(panel.background = element_blank(),
        panel.grid = element_blank(),
        axis.text=element_blank(),
        axis.title=element_blank(),
        axis.ticks = element_blank())
dev.off()

png(paste0(path.figures, "NPN Quercus Map BudBurst Resid.png", sep=""), height=6, width=8, units="in", res=180)
ggplot() +
  coord_fixed(1.3) +
  ggtitle(paste("NPN Quercus Breaking Leaf Buds", sep=" ")) +
  geom_polygon(data=map.us, aes(x=long, y=lat, group=group), fill="gray50", color="black") +
  geom_point(data=comb.burst, aes(x=longitude, y=latitude, color=diff), alpha=0.75) +
  facet_wrap(~species)+
  scale_color_gradient2(low="#fc8d59", high="#91bfdb", mid="#ffffbf") +
  #scale_color_continuous(type = "viridis") +
  #scale_size_continuous()+
  labs(color = "Resid") +
  theme(panel.background = element_blank(),
        panel.grid = element_blank(),
        axis.text=element_blank(),
        axis.title=element_blank(),
        axis.ticks = element_blank())
dev.off()

#--------------------------------------------------------------------#
#Here begins the leaf out section#
#--------------------------------------------------------------------#

#Reading in originial predicitons
first.leaf.diff <- read.csv(file.path(path.data, paste0('First Leaf Prediction summary.csv')))

first.comb.leaf <- read.csv(file.path(path.data, paste0('First_Leaf_Prediction_Evaluation_all.csv')))

#Reading in mean growing season temp
GT.leaf.diff <- read.csv(file.path(path.data, paste0('GTmean Leaf Prediction summary.csv')))

GT.comb.leaf <- read.csv(file.path(path.data, paste0('GTmean_Leaf_Prediction_Evaluation_all.csv')))

#Reading in relative growing season mean
RGT.leaf.diff <- read.csv(file.path(path.data, paste0('Rel_GTmean Leaf Prediction summary.csv')))

RGT.comb.leaf <- read.csv(file.path(path.data, paste0('Rel_GTmean_Leaf_Prediction_Evaluation_all.csv')))

#Reading in relative latitude
Rlat.leaf.diff <- read.csv(file.path(path.data, paste0('Rel_Lat Leaf Prediction summary.csv')))

Rlat.comb.leaf <- read.csv(file.path(path.data, paste0('Rel_Lat_Leaf_Prediction_Evaluation_all.csv')))

#Reading in relative latitude
Lat.leaf.diff <- read.csv(file.path(path.data, paste0('Lat Leaf Prediction summary.csv')))

Lat.comb.leaf <- read.csv(file.path(path.data, paste0('Lat_Leaf_Prediction_Evaluation_all.csv')))

#Simply looking at them.
#Will want these to become a data frame with RMSE
first.leaf.diff; GT.leaf.diff; RGT.leaf.diff;Lat.leaf.diff; Rlat.leaf.diff

first.leaf.diff <- first.leaf.diff[first.leaf.diff$species != "Oaks",]
GT.leaf.diff <- GT.leaf.diff[GT.leaf.diff$species != "Oaks",]
RGT.leaf.diff <- RGT.leaf.diff[RGT.leaf.diff$species != "Oaks",]
Lat.leaf.diff <- Lat.leaf.diff[Lat.leaf.diff$species != "Oaks",]
Rlat.leaf.diff <- Rlat.leaf.diff[Rlat.leaf.diff$species != "Oaks",]

GT.t <- t.test(first.leaf.diff$RMSE, GT.leaf.diff$RMSE, paired = TRUE)
RGT.t <- t.test(first.leaf.diff$RMSE, RGT.leaf.diff$RMSE, paired = TRUE)
Rlat.t <- t.test(first.leaf.diff$RMSE, Rlat.leaf.diff$RMSE, paired = TRUE)
Lat.t <- t.test(first.leaf.diff$RMSE, Lat.leaf.diff$RMSE, paired = TRUE)

full.t.test <- data.frame()

t.table <- matrix(c(as.numeric(GT.t[1]), as.numeric(GT.t[3]), as.numeric(GT.t[5]), as.numeric(GT.t[7]),
                    as.numeric(RGT.t[1]), as.numeric(RGT.t[3]), as.numeric(RGT.t[5]), as.numeric(RGT.t[7]),
                    as.numeric(Lat.t[1]), as.numeric(Lat.t[3]), as.numeric(Lat.t[5]), as.numeric(Lat.t[7]),
                    as.numeric(Rlat.t[1]), as.numeric(Rlat.t[3]), as.numeric(Rlat.t[5]),as.numeric(Rlat.t[7])), ncol=4, byrow=TRUE)

colnames(t.table) <- c("t value", "p value", "mean of diff", "SE of diff")
rownames(t.table) <- c("GT", "RGT", "Lat", "Rlat")

write.csv(t.table, paste0(path.data, "/Leaf_t_test.csv"))


#Exploratory plot of error rate
ggplot(comb.leaf, aes(x = error))+
  facet_wrap(~species) +
  geom_histogram() 

#Histogram of distirubtion of difference between observed and predicted
path.figures <- "../figures/Arb_pheno/"
png(width= 750, filename= file.path(path.figures, paste0('leaf NPN Validation Yday diff', '.png')))
ggplot(comb.leaf, aes(x = diff))+
  facet_wrap(~species) +
  geom_histogram() +
  ggtitle('Difference in Observed Yday from Predicted Yday')
dev.off()

#same histogram but with absolute difference
ggplot(comb.leaf, aes(x = absdiff))+
  facet_wrap(~species) +
  geom_histogram() 

#Scatter plot to compare 1:1 line between Prediction and Yday
png(width= 750, filename= file.path(path.figures, paste0('NPN Validation scatter leaf', '.png')))
ggplot(Rlat.comb.leaf, aes(x = Yday, y = mid))+
  facet_wrap(~species) +
  geom_point(aes(color = latitude)) +
  geom_errorbar(aes(ymin=tail, ymax=head), width=.2,
                position=position_dodge(0.05))+
  geom_smooth(method='lm', se = FALSE, linetype = "dashed")+
  geom_abline(intercept = 0, slope = 1)+
  scale_color_continuous(type = "viridis")+
  xlim(0, 220)+ylim(0, 220)+
  ggtitle('Rlat Observed Yday of leaf vs. predicted') +
  xlab("Observed Yday")+
  ylab("Predicted Yday")
dev.off()

#Map of where the sites in our data are located
map.us <- map_data("state")
png(paste0(path.figures, "NPN Quercus Map leaf.png", sep=""), height=6, width=8, units="in", res=180)
ggplot() +
  coord_fixed(1.3) +
  ggtitle(paste("NPN Quercus Breaking Leaf Buds", sep=" ")) +
  geom_polygon(data=map.us, aes(x=long, y=lat, group=group), fill=NA, color="black") +
  geom_point(data=dat.leaf, aes(x=longitude, y=latitude, color=species), alpha=0.75) +
  facet_wrap(~species)+
  #scale_color_continuous(type = "viridis") +
  #scale_size_continuous()+
  labs(color = "Log of GDD5.cum THreshold",size="Number of Observations") +
  theme(panel.background = element_blank(),
        panel.grid = element_blank(),
        axis.text=element_blank(),
        axis.title=element_blank(),
        axis.ticks = element_blank())
dev.off()

png(paste0(path.figures, "NPN Quercus Map leaf Resid.png", sep=""), height=6, width=8, units="in", res=180)
ggplot() +
  coord_fixed(1.3) +
  ggtitle(paste("NPN Quercus Breaking Leaf Buds", sep=" ")) +
  geom_polygon(data=map.us, aes(x=long, y=lat, group=group), fill="gray50", color="black") +
  geom_point(data=comb.leaf, aes(x=longitude, y=latitude, color=diff), alpha=0.75) +
  facet_wrap(~species)+
  scale_color_gradient2(low="#fc8d59", high="#91bfdb", mid="#ffffbf") +
  #scale_color_continuous(type = "viridis") +
  #scale_size_continuous()+
  labs(color = "Resid") +
  theme(panel.background = element_blank(),
        panel.grid = element_blank(),
        axis.text=element_blank(),
        axis.title=element_blank(),
        axis.ticks = element_blank())
dev.off()

PI <- aggregate(THRESH~species, data=leaf.stats,
                FUN=function(x) quantile(x,c(0.025, 0.5, 0.975)), na.action = na.omit)

PI$tail <- PI$THRESH[,1]
PI$mid <- PI$THRESH[,2]
PI$head <- PI$THRESH[,3]

PI$range <- PI$head - PI$tail


leaf.eval %>% 
  group_by(species) %>% 
  do({
    mod = lm(diff ~ latitude, data = .)
    data.frame(Intercept = coef(mod)[1],
               Slope = coef(mod)[2])
  })

t <- lm(formula = diff ~ latitude, data = leaf.eval)


bud.model <- bud.model[bud.model$species %in% spp.valid, ]
leaf.model <- leaf.model[leaf.model$species %in% spp.valid, ]

PI <- aggregate(-RMSE.diff~model, data=bud.model,
                FUN=function(x) quantile(x,c(0.025, 0.5, 0.975)), na.action = na.omit)

colnames(PI) <- c("model", "RMSE.diff")

PI$tail <- PI$RMSE.diff[,1]
PI$mid <- PI$RMSE.diff[,2]
PI$head <- PI$RMSE.diff[,3]


PI <- aggregate(-RMSE.diff~model, data=leaf.model,
                FUN=function(x) quantile(x,c(0.025, 0.5, 0.975)), na.action = na.omit)

colnames(PI) <- c("model", "RMSE.diff")

PI$tail <- PI$RMSE.diff[,1]
PI$mid <- PI$RMSE.diff[,2]
PI$head <- PI$RMSE.diff[,3]


GT.comb.burst$model <- "GT"
RGT.comb.burst$model <- "RGT"
Rlat.comb.burst$model <- "Rlat"
Lat.comb.burst$model <- "Lat"


burst.model <- rbind(GT.comb.burst, RGT.comb.burst, Lat.comb.burst, Rlat.comb.burst)

Yday.range <- aggregate(mid~model+site_id+species, data=burst.model,
                              FUN=mean, na.action = na.omit)

Yday.range <- aggregate(burst.model[,c("tail", "head")],
                        by=list(burst.model$model, burst.model$site_id, burst.model$species),
                        FUN=mean, na.action = na.omit)

colnames(Yday.range) <- c("model", "site_id", "species", "tail", "head")

Yday.mean <- aggregate(Yday.range[,c("tail", "head")],
                       by=list(Yday.range$model, Yday.range$species),
                       FUN=mean, na.action = na.omit)

colnames(Yday.mean) <- c("model", "species", "tail", "head")

Yday.sd <- aggregate(Yday.range[,c("tail", "head")],
                     by=list(Yday.range$model, Yday.range$species),
                     FUN=sd)

write.csv(Yday.mean, "../data_processed/Bud_Yday_range.csv", row.names = F)
