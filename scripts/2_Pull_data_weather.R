#----------------------------------------------------------------------------------------------------------------------------------#
# Script by : Lucien Fitzpatrick
# Project: Collection phenology vulnerability
# Purpose: This script serves as the download of weather data and the calculation of relevant weather statistics
# Inputs: The weather_calc.r script which defines the weather_calc function.
# Outputs: met.all dataframe that can be used to match weather to phenological events
# Notes:  This is the script is not neccessary to run as the outputs are stored on the repository
#-----------------------------------------------------------------------------------------------------------------------------------#

#-------------------------------------------------#
#This section is for downloaded the met data, pulling out data of interest, and calculating growing degree days
#-------------------------------------------------#

path.g <- "G:/My Drive"

path.hub <- "C:/Users/lucie/Documents/GitHub/Collections_phenology_vulnerability"

#Setting a shared file path for where the data are
path.met <- file.path(path.g, "Arboretum Met Data/GHCN-Daily")

# Read in the older dataset. This is because the GHCND at the arboretum changed in 2007 and we need to pull from both
met.old <- read.csv(file.path(path.met, "MortonArb_GHCND-USC00119221_1895-2007.csv"))
met.old$DATE <- as.Date(met.old$DATE) # Convert this column to a special datatype that's recognized as a date
summary(met.old)

# Read in the newer dataset
met.new <- read.csv(file.path(path.met, "MortonArb_GHCND-USC00115097_2007-04-01_2019-12-31.csv"))
met.new$DATE <- as.Date(met.new$DATE) # Convert this column to a special datatype that's recognized as a date
summary(met.new)

# Check to make sure we're in metric (earlier I had a mixture of units and that was bad)
range(met.old$TMAX, na.rm=T)
range(met.new$TMAX, na.rm=T)

# Combine the old and the new datasets into a new data frame.  We don't want all columns, so just take the ones we care about
met.all <- rbind(met.old[,c("STATION", "DATE", "PRCP", "SNOW", "SNWD", "TMAX", "TMIN")],
                 met.new[,c("STATION", "DATE", "PRCP", "SNOW", "SNWD", "TMAX", "TMIN")])

#These names help match daymet data so we can have one funciton to transform both
#These temp names are bulkier the products use clear names regardless
colnames(met.all) <- c("Station", "Date", "PRCP", "SNOW", "SNWD", "tmax..deg.c.", "tmin..deg.c.")


#Pulling out useful date statistics. Only YDAY and YEAR are used in this function but others are added to the output data frame for future use
met.all$year <- lubridate::year(met.all$Date)
met.all$yday <- lubridate::yday(met.all$Date)

y_start <- 1975
y_end <- 2019

#Subsetting to a useful range of years. Currently the max so doesn't do much
met.all <- met.all[met.all$year>=y_start & met.all$year<=y_end,]


#Reading in our function for calculating weather statistics of interest
source(file.path(path.hub, "scripts/Weather_calc.R"))

#Running our function to calculate weather statistics. Default year range is 1975-2019. Growing season is yday 1 to 120
met.all <- weather_calc(met.all)

write.csv(met.all, paste0(path.hub, "/data/GHCN_met_all.csv"), row.names=F)
