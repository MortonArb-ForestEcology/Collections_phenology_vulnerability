#----------------------------------------------------------------------------------------------------------------------------------#
# Script by: Lucien Fitzpatrick
# Project: Collection phenology vulnerability
# Purpose: This script fits our growing season model 
# Inputs: Daymet_clean_data.csv
#         Full_Bud_Obs.csv
#         RevGT_model_budburst.csv
#         Raw_Phenology_NPN_combined_budburst.csv
#         Full_Leaf_Obs.csv
#         RevGT_model_leaf.csv
#         Raw_Phenology_NPN_combined_leaf.csv
# Outputs:RevGT_Budburst_Phenology_NPN_prediction.csv
#         RevGT_Leaf_Phenology_NPN_prediction.csv
# Notes: 
#-----------------------------------------------------------------------------------------------------------------------------------#
library(rnpn)
library(dplyr)


#Reading in the weather data
dat.met <- read.csv("../data_processed/Daymet_clean_data.csv")
dat.met$Freeze <- ifelse(dat.met$tmin..deg.c.<0, 1, 0)
dat.met$site <- as.character(dat.met$site)
dat.met$Date <- as.Date(dat.met$Date)

#model output
burst.df <- read.csv(file.path("../data_processed/model_output/RevGT_model_budburst.csv"))

#Full pheno list to match species names to output
dat.budcomb <- read.csv("../data_processed/Full_Bud_Obs.csv")

b.slope <- burst.df$bias.loc
b.int <- burst.df$int.loc

# Subset to just the species parameters
burst.df <- burst.df[,grep("Spbias", names(burst.df))]
colnames(burst.df) <- unlist(lapply(strsplit(names(burst.df), "[.]"), FUN=function(x)x[2]))

burst.long <- data.table::melt(burst.df, variable.name = "Species")

burst.long$slope <- b.slope
burst.long$int <- b.int
summary(burst.long)

#Reading in NPN so we can pull out our validation species
dat.burst <- read.csv("../data_raw/Raw_Phenology_NPN_combined_budburst.csv")
dat.burst <- dat.burst[!dat.burst$flag.4sig,]

dat.burst$Date <- as.Date(dat.burst$Date)



#Calculting the number of sites so we can filter for our second step of evaluation
for(SP in unique(dat.burst$species)){
  dat.sp <- dat.burst[dat.burst$species == SP,]
  dat.burst[dat.burst$species == SP, "nsites"] <- length(unique(dat.sp$site_id))
}

#dat.burst <- dat.burst[dat.burst$nsites < 10,]


pred.list <- list()
set.seed(524)
for(YR in unique(dat.burst$year)){
  for(LOC in unique(dat.burst[dat.burst$year==YR, "site_id"])){
    #Pulling out daymet data matching the year and site
    met.now <- dat.met[dat.met$year==YR & dat.met$site==LOC,]
    dat.loc <- dat.burst[dat.burst$year == YR & dat.burst$site_id == LOC,]
    for(SP in unique(dat.loc$species)){
      #Pulling out the posterior distribution for our species
      dat.sp <- dat.loc[dat.loc$species ==SP,]
      bud.SP <- burst.long[burst.long$Species == SP,]
      for(IND in unique(dat.sp$individual_id)){
        #Randomly sample 500 from that distribution
        dat.ind <- dat.sp[dat.sp$individual_id == IND,]
        SP.samp <- bud.SP[sample(1:nrow(bud.SP), 250),]
        SP.samp$GDD <- SP.samp$value + (SP.samp$slope * unique(met.now$GTmean) + SP.samp$int) 
        pred.list[[paste(YR, LOC, SP, IND, sep="-")]] <- SP.samp
        pred.list[[paste(YR, LOC, SP, IND, sep="-")]]$yday <- apply(SP.samp, 1, FUN=function(x){min(met.now[met.now$GDD5.cum>=as.numeric(x["GDD"]), "yday"])})
        pred.list[[paste(YR, LOC, SP, IND, sep="-")]]$year <- as.factor(YR)
        pred.list[[paste(YR, LOC, SP, IND, sep="-")]]$site <- as.factor(LOC)
        pred.list[[paste(YR, LOC, SP, IND, sep="-")]]$species <- as.factor(SP)
        pred.list[[paste(YR, LOC, SP, IND, sep="-")]]$ind <- as.factor(IND)
        pred.list[[paste(YR, LOC, SP, IND, sep="-")]]$GTmean <- unique(met.now$GTmean)
      }
    }
  }
}
pred.burst <- dplyr::bind_rows(pred.list)
summary(pred.burst)

# Save dat.burst
write.csv(pred.burst, "../data_processed/RevGT_Budburst_Phenology_NPN_prediction.csv", row.names=F)


#-------------------------------------------------------------------#
#Leafout section
#-------------------------------------------------------------------#
#model output
leaf.df <- read.csv(file.path("../data_processed/model_output/RevGT_model_leaf.csv"))

#Full pheno list to match species names to output
dat.leafcomb <- read.csv("../data_processed/Full_Leaf_Obs.csv")

l.slope <- leaf.df$bias.loc

l.int <- leaf.df$int.loc

# Subset to just the species parameters
leaf.df <- leaf.df[,grep("Spbias", names(leaf.df))]
colnames(leaf.df) <- unlist(lapply(strsplit(names(leaf.df), "[.]"), FUN=function(x)x[2]))

leaf.long <- data.table::melt(leaf.df, variable.name = "Species")

leaf.long$slope <- l.slope
leaf.long$int <- l.int
summary(leaf.long)

#Reading in NPN so we can pull out our validation species
dat.leaf <- read.csv("../data_raw/Raw_Phenology_NPN_combined_leaf.csv")
dat.leaf <- dat.leaf[!dat.leaf$flag.4sig,]

dat.leaf$Date <- as.Date(dat.leaf$Date)


#Calculting the number of sites so we can filter for our second step of evaluation
for(SP in unique(dat.leaf$species)){
  dat.sp <- dat.leaf[dat.leaf$species == SP,]
  dat.leaf[dat.leaf$species == SP, "nsites"] <- length(unique(dat.sp$site_id))
}

#dat.leaf <- dat.leaf[dat.leaf$nsites < 10,]


pred.list <- list()
set.seed(1724)
for(YR in unique(dat.leaf$year)){
  for(LOC in unique(dat.leaf[dat.leaf$year==YR, "site_id"])){
    #Pulling out daymet data matching the year and site
    met.now <- dat.met[dat.met$year==YR & dat.met$site==LOC,]
    dat.loc <- dat.leaf[dat.leaf$year == YR & dat.leaf$site_id == LOC,]
    for(SP in unique(dat.loc$species)){
      #Pulling out the posterior distribution for our species
      dat.sp <- dat.loc[dat.loc$species ==SP,]
      leaf.SP <- leaf.long[leaf.long$Species == SP,]
      for(IND in unique(dat.sp$individual_id)){
        #Randomly sample 500 from that distribution
        dat.ind <- dat.sp[dat.sp$individual_id == IND,]
        SP.samp <- leaf.SP[sample(1:nrow(leaf.SP), 50),]
        SP.samp$GDD <- SP.samp$value + (SP.samp$slope * unique(met.now$GTmean)  + SP.samp$int) 
        pred.list[[paste(YR, LOC, SP, IND, sep="-")]] <- SP.samp
        pred.list[[paste(YR, LOC, SP, IND, sep="-")]]$yday <- apply(SP.samp, 1, FUN=function(x){min(met.now[met.now$GDD5.cum>=as.numeric(x["GDD"]), "yday"])})
        pred.list[[paste(YR, LOC, SP, IND, sep="-")]]$year <- as.factor(YR)
        pred.list[[paste(YR, LOC, SP, IND, sep="-")]]$site <- as.factor(LOC)
        pred.list[[paste(YR, LOC, SP, IND, sep="-")]]$species <- as.factor(SP)
        pred.list[[paste(YR, LOC, SP, IND, sep="-")]]$ind <- as.factor(IND)
        pred.list[[paste(YR, LOC, SP, IND, sep="-")]]$GTmean <- unique(met.now$GTmean)
      }
    }
  }
}
pred.leaf <- dplyr::bind_rows(pred.list)
summary(pred.leaf)

# Save dat.leaf
write.csv(pred.leaf, "../data_processed/RevGT_Leaf_Phenology_NPN_prediction.csv", row.names=F)

