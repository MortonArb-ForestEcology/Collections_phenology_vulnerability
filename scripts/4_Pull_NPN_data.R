#----------------------------------------------------------------------------------------------------------------------------------#
# Script by: Lucien Fitzpatrick
# Project: Collection phenology vulnerability
# Purpose: This script downloads the NPN data for our chosen oaks and cleans them
# Inputs: Arb budburst data frame as made by script 3
#         Arb leaf out data frame as made by script 3
# Outputs: Data frame containing all NPN data for our oak species
# Notes: 
#-----------------------------------------------------------------------------------------------------------------------------------#
library(rnpn)
library(ggplot2)
#Reading in the arb pheno data as a reference  for our chosen species
# dat.b <- read.csv("../data_processed/Oak_collection_budburst.csv")
# 
# dat.b <- tidyr::separate(dat.b, col = "Species", into=c("Genus", "Species"))
oaks.arb <- c("alba", "gambelii", "ilicifolia", "imbricaria", "macrocarpa", "marilandica", "montana", "palustris", "rubra", "shumardii", "stellata", "velutina")


npn.species <- npn_species()
npn.oak <- npn.species[npn.species$genus == "Quercus", ]

# Get just the IDs for the oaks we want to work with
oak.ids <- npn.oak[npn.oak$species %in% oaks.arb, "species_id"]$species_id


#Retrieving npn data
#The Genus ID is currently for Quercus respectively. Phenophase is breaking leaf buds
#rnpn packages has tools to show the corresponding id's for these queries. Request source is your name/affiliation

raw.npn <- npn_download_individual_phenometrics(phenophase_ids =c(371, 483),  years=2000:2019, species_ids = oak.ids, request_source="The Morton Arboretum")
raw.npn[raw.npn==-9999] <- NA

raw.npn$species <- as.factor(raw.npn$species)
raw.npn$species_id <- as.factor(raw.npn$species_id)
raw.npn$individual_id <- as.factor(raw.npn$individual_id)
raw.npn$phenophase_id <- as.factor(raw.npn$phenophase_id)
raw.npn$phenophase_description <- as.factor(raw.npn$phenophase_description)
raw.npn$location <- as.factor(ifelse(raw.npn$site_id==26202, "MortonArb", "Other"))
summary(raw.npn)

png(filename = "../figures/NPNData_Raw0_YDAY_distribution_Buds.png", height=6, width=8, units="in", res=220)
ggplot(data=raw.npn[raw.npn$phenophase_description=="Breaking leaf buds",]) +
  ggtitle("First Breaking Leaf Buds - RAW") +
  facet_wrap(~species) +
  geom_histogram(aes(x=first_yes_doy, fill=location))
dev.off()

# Adding a label on whether this data is from the Arb or not
#Pulling in names for use
# ------------------------------------------
# Deciding what data is "good" or "bad"
# ------------------------------------------
# Using a 10-day thresholds since prior/next no as an indicator of questionable data  or if there is no value for that (first obs of the year)
# if the days since last no is greather than 10 OR (| mean OR) there is no "no" observation before a yes
dat.npn <- raw.npn[!is.na(raw.npn$numdays_since_prior_no) & raw.npn$numdays_since_prior_no<=10,]

png(filename = "../figures/NPNData_Raw0_YDAY_distribution_Leaves.png", height=6, width=8, units="in", res=220)
ggplot(data=dat.npn[dat.npn$phenophase_description=="Leaves",]) +
  ggtitle("First Leaves - RAW") +
  facet_wrap(~species) +
  geom_histogram(aes(x=first_yes_doy, fill=location))
dev.off()

# Exploratory graph of distribution of raw dates
png(filename = "../figures/NPNData_Raw1_YDAY_distribution_Buds.png", height=6, width=8, units="in", res=220)
ggplot(data=dat.npn[dat.npn$phenophase_description=="Breaking leaf buds",]) +
  ggtitle("First Breaking Leaf Buds - window filtered") +
  facet_wrap(~species) +
  geom_histogram(aes(x=first_yes_doy, fill=location))
dev.off()

png(filename = "../figures/NPNData_Raw1_YDAY_distribution_Leaves.png", height=6, width=8, units="in", res=220)
ggplot(data=dat.npn[dat.npn$phenophase_description=="Leaves",]) +
  ggtitle("First Leaves - window filtered") +
  facet_wrap(~species) +
  geom_histogram(aes(x=first_yes_doy, fill=location))
dev.off()

#--------------------------------------------------#
# Aggregating to the first observation of each individual
#--------------------------------------------------#
npn.first <- aggregate(first_yes_doy ~ location + site_id + latitude + longitude + elevation_in_meters + species_id + species + individual_id + phenophase_id + phenophase_description + first_yes_year, data=dat.npn, FUN=min)
summary(npn.first)

png(filename = "../figures/NPNData_Raw2_YDAY_distribution_Buds.png", height=6, width=8, units="in", res=220)
ggplot(data=npn.first[npn.first$phenophase_description=="Breaking leaf buds",]) +
  ggtitle("First Breaking Leaf Buds - Raw Individual First") +
  facet_wrap(~species) +
  geom_histogram(aes(x=first_yes_doy, fill=location))
dev.off()

png(filename = "../figures/NPNData_Raw2_YDAY_distribution_Leaves.png", height=6, width=8, units="in", res=220)
ggplot(data=npn.first[npn.first$phenophase_description=="Leaves",]) +
  ggtitle("First Leaves -  Raw Individual First") +
  facet_wrap(~species) +
  geom_histogram(aes(x=first_yes_doy, fill=location))
dev.off()
#--------------------------------------------------#


#--------------------------------------------------#
# Cleaning up outlier data; not based on DOY
#--------------------------------------------------#
summary(npn.first[npn.first$phenophase_description=="Breaking leaf buds",])
summary(npn.first[npn.first$phenophase_description=="Leaves",])

# Looking at jsut sp
# Filter by the summer equinox: June 21 (day 172)
npn.filter <- npn.first[npn.first$first_yes_doy<172,]
npn.filter$year <- npn.filter$first_yes_year
npn.filter$yday <- npn.filter$first_yes_doy
summary(npn.filter)

summary(npn.filter$species)
npn.filter$flag.3sig <- NA
npn.filter$flag.4sig <- NA
for(PHENO in unique(npn.filter$phenophase_id)){
  for(SPP in unique(npn.filter$species[npn.filter$phenophase_id==PHENO])){
    row.spp <- which(npn.filter$phenophase_id==PHENO & npn.filter$species==SPP)
    
    spp.mean <- mean(npn.filter$yday[row.spp])
    spp.sd <- sd(npn.filter$yday[row.spp])
    
    npn.filter$flag.3sig[row.spp] <- ifelse(npn.filter$yday[row.spp]<spp.mean-3*spp.sd | npn.filter$yday[row.spp]>spp.mean+3*spp.sd, T, F)
    npn.filter$flag.4sig[row.spp] <- ifelse(npn.filter$yday[row.spp]<spp.mean-4*spp.sd | npn.filter$yday[row.spp]>spp.mean+4*spp.sd, T, F)
    
    
  }
}
summary(npn.filter)
#--------------------------------------------------#


#--------------------------------------------------#
# Reducing to what we have at the arb
#--------------------------------------------------#
# Looking at what species we have left at the arb now
spp.arb <- unique(npn.filter$species[npn.filter$location=="MortonArb"])
spp.arb.lo <- unique(npn.filter$species[npn.filter$location=="MortonArb" & npn.filter$phenophase_description=="Leaves"])


# Getting some individual stats for The Morton Arb
arb.obs <- aggregate(yday~location + species, data=npn.filter[npn.filter$phenophase_description=="Breaking leaf buds" & npn.filter$location=="MortonArb",], FUN=length)

arb.ind <- aggregate(yday~location + individual_id + species, data=npn.filter[npn.filter$phenophase_description=="Breaking leaf buds" & npn.filter$location=="MortonArb",], FUN=length)
arb.spp <- aggregate(yday~location + species, data=arb.ind, FUN=length)
summary(arb.ind)


# Looking at #species at sites in all of NPN 
npn.site.spp <- aggregate(yday ~ location + site_id + species, data=npn.filter[npn.filter$species %in% spp.arb,], FUN=length)
npn.spp <- aggregate(yday ~ location + site_id, data=npn.site.spp, FUN=length)
summary(npn.spp)
npn.spp[npn.spp$yday>3,]

npn.site <- aggregate(yday ~ species, data=npn.site.spp[npn.site.spp$location!="MortonArb",], FUN=length)
npn.site <- npn.site[order(npn.site$yday, decreasing = T),]
npn.site

summary(npn.first[npn.first$location=="MortonArb",])
#--------------------------------------------------#


# Cleaning -- budburst has to happen on the same day or before leaves

#--------------------------------------------------#



#--------------------------------------------------#
#Here we split apart budburst and leaf out
#This is the budburst section
#--------------------------------------------------#
dat.budburst <- dat.npn[dat.npn$phenophase_id == '371',]

# Aggregateing using a formula; in R, y=mx+b is y ~ m*x + b 
dat.budburst <- data.frame(individual_id=rep(unique(dat.budburst$individual_id), each=length(unique(dat.budburst$first_yes_year))),
                           year=unique(dat.budburst$first_yes_year))
summary(dat.budburst)                           

for(IND in unique(dat.budburst$individual_id)){
  # adding some individual metadata -- this only needs to be done for each tree; we dont' care about which year it is
  dat.budburst[dat.budburst$individual_id==IND, c("site_id", "latitude", "longitude", "species_id", "genus", "species", "common_name")] <- unique(dat.npn[dat.npn$individual_id==IND,c("site_id", "latitude", "longitude", "species_id", "genus", "species", "common_name")])
  
  for(YR in unique(dat.budburst$year[dat.budburst$individual_id==IND])){
    # creating a handy index for what row we're working with
    row.now <- which(dat.budburst$individual_id==IND & dat.budburst$year==YR)
    
    # Just narrowing the data frame down to just the part we want to work with
    dat.tmp <- dat.npn[dat.npn$individual_id==IND & dat.npn$first_yes_year==YR,]
    
    if(nrow(dat.tmp)==0) next # skips through if there's no data
    
    if(nrow(dat.tmp)==1){
      dat.budburst[row.now, c("first.mean", "first.min", "first.max")] <- dat.tmp$first_yes_doy
      dat.budburst[row.now, c("last.mean", "last.min", "last.max")] <- dat.tmp$last_yes_doy
    } else {
      dat.budburst[row.now, "first.mean"] <- mean(dat.tmp$first_yes_doy, na.rm=T)
      dat.budburst[row.now, "first.min" ] <- min(dat.tmp$first_yes_doy, na.rm=T)
      dat.budburst[row.now, "first.max" ] <- max(dat.tmp$first_yes_doy, na.rm=T)
      
      dat.budburst[row.now, "last.mean"] <- mean(dat.tmp$last_yes_doy, na.rm=T)
      dat.budburst[row.now, "last.min" ] <- min(dat.tmp$last_yes_doy, na.rm=T)
      dat.budburst[row.now, "last.max" ] <- max(dat.tmp$last_yes_doy, na.rm=T)
    }
  }
}

dat.budburst$Yday <- dat.budburst$first.min

dat.budburst <- dat.budburst[!is.na(dat.budburst$Yday),]
dat.budburst <- dat.budburst[!is.infinite(dat.budburst$Yday),]

#This loop freezes at the end and needs to be manually stopped but also fully works?
for(YR in dat.budburst$year){
  start <- paste(as.character(dat.budburst$year), "-01-01", sep="")
  dat.budburst$Date <- as.Date((dat.budburst$Yday-1), origin = start)
}

#---------------------------------------#
#Here begins the leaf section
#----------------------------------------#

dat.leaf <- dat.npn[dat.npn$phenophase_id == '483',]

# Aggregateing using a formula; in R, y=mx+b is y ~ m*x + b 
dat.leaf <- data.frame(individual_id=rep(unique(dat.leaf$individual_id), each=length(unique(dat.leaf$first_yes_year))),
                           year=unique(dat.leaf$first_yes_year))
summary(dat.leaf)                           

for(IND in unique(dat.leaf$individual_id)){
  # adding some individual metadata -- this only needs to be done for each tree; we dont' care about which year it is
  dat.leaf[dat.leaf$individual_id==IND, c("site_id", "latitude", "longitude", "species_id", "genus", "species", "common_name")] <- unique(dat.npn[dat.npn$individual_id==IND,c("site_id", "latitude", "longitude", "species_id", "genus", "species", "common_name")])
  
  for(YR in unique(dat.leaf$year[dat.leaf$individual_id==IND])){
    # creating a handy index for what row we're working with
    row.now <- which(dat.leaf$individual_id==IND & dat.leaf$year==YR)
    
    # Just narrowing the data frame down to just the part we want to work with
    dat.tmp <- dat.npn[dat.npn$individual_id==IND & dat.npn$first_yes_year==YR,]
    
    if(nrow(dat.tmp)==0) next # skips through if there's no data
    
    if(nrow(dat.tmp)==1){
      dat.leaf[row.now, c("first.mean", "first.min", "first.max")] <- dat.tmp$first_yes_doy
      dat.leaf[row.now, c("last.mean", "last.min", "last.max")] <- dat.tmp$last_yes_doy
    } else {
      dat.leaf[row.now, "first.mean"] <- mean(dat.tmp$first_yes_doy, na.rm=T)
      dat.leaf[row.now, "first.min" ] <- min(dat.tmp$first_yes_doy, na.rm=T)
      dat.leaf[row.now, "first.max" ] <- max(dat.tmp$first_yes_doy, na.rm=T)
      
      dat.leaf[row.now, "last.mean"] <- mean(dat.tmp$last_yes_doy, na.rm=T)
      dat.leaf[row.now, "last.min" ] <- min(dat.tmp$last_yes_doy, na.rm=T)
      dat.leaf[row.now, "last.max" ] <- max(dat.tmp$last_yes_doy, na.rm=T)
    }
  }
}

dat.leaf$Yday <- dat.leaf$first.min
dat.leaf <- dat.leaf[!is.na(dat.leaf$Yday),]
dat.leaf <- dat.leaf[!is.infinite(dat.leaf$Yday),]

#This loop freezes at the end and needs to be manuall stopped but also fully works?
for(YR in dat.leaf$year){
  start <- paste(as.character(dat.leaf$year), "-01-01", sep="")
  dat.leaf$Date <- as.Date((dat.leaf$Yday-1), origin = start)
}

# Read these in if you just need to add the flags
# dat.leaf <- read.csv("../data_raw/Raw_Phenology_NPN_combined_leaf.csv")
# dat.budburst<- read.csv("../data_raw/Raw_Phenology_NPN_combined_budburst.csv")

dat.budburst <- dat.budburst[dat.budburst$Yday < 181,]
dat.budburst <- dat.budburst[!is.na(dat.budburst$Yday),]
dat.budburst <- dat.budburst[!is.infinite(dat.budburst$Yday),]

dat.leaf <- dat.leaf[dat.leaf$Yday < 213,]
dat.leaf <- dat.leaf[!is.na(dat.leaf$Yday),]
dat.leaf <- dat.leaf[!is.infinite(dat.leaf$Yday),]


dat.budburst$flag.4sig <- NA
dat.budburst$flag.6sig <- NA
for(SPP in unique(dat.budburst$species)){
  row.spp <- which(dat.budburst$species==SPP)
  spp.mean <- mean(dat.budburst$Yday[row.spp])
  spp.sd <- sd(dat.budburst$Yday[dat.budburst$species==SPP])
  
  dat.budburst$flag.4sig[row.spp] <- ifelse(dat.budburst$Yday[row.spp]<spp.mean-4*spp.sd | dat.budburst$Yday[row.spp]>spp.mean+4*spp.sd, T, F)
  dat.budburst$flag.6sig[row.spp] <- ifelse(dat.budburst$Yday[row.spp]<spp.mean-6*spp.sd | dat.budburst$Yday[row.spp]>spp.mean+6*spp.sd, T, F)
}
summary(dat.budburst)
summary(dat.budburst[!dat.budburst$flag.4sig,])
# dat.budburst <- dat.budburst[!dat.budburst$flag.4sig,]

dat.leaf$flag.4sig <- NA
dat.leaf$flag.6sig <- NA
for(SPP in unique(dat.leaf$species)){
  row.spp <- which(dat.leaf$species==SPP)
  spp.mean <- mean(dat.leaf$Yday[row.spp])
  spp.sd <- sd(dat.leaf$Yday[dat.leaf$species==SPP])
  
  dat.leaf$flag.4sig[row.spp] <- ifelse(dat.leaf$Yday[row.spp]<spp.mean-4*spp.sd | dat.leaf$Yday[row.spp]>spp.mean+4*spp.sd, T, F)
  dat.leaf$flag.6sig[row.spp] <- ifelse(dat.leaf$Yday[row.spp]<spp.mean-6*spp.sd | dat.leaf$Yday[row.spp]>spp.mean+6*spp.sd, T, F)
}
summary(dat.leaf)
summary(dat.leaf[!dat.leaf$flag.4sig,])


write.csv(dat.leaf, "../data_raw/Raw_Phenology_NPN_combined_leaf.csv", row.names=F)
write.csv(dat.budburst, "../data_raw/Raw_Phenology_NPN_combined_budburst.csv", row.names=F)
